<!DOCTYPE html>
<html lang="en-ZA">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>EasyPO – Purchase Order Generator | Easy Suite</title>
  <meta name="description" content="Create professional purchase orders with suppliers, items, approvals, VAT, attachments, exports (PDF/CSV/JSON), and offline templates." />

  <!-- Favicon -->
  <link rel="icon" href="icon.png" type="image/png">
  <link rel="apple-touch-icon" href="icon.png">

  <!-- Tailwind CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root{
      --primary:#2563eb;
      --primary2:#1d4ed8;
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --danger:#dc2626;
      --success:#16a34a;
      --warning:#f59e0b;
      --shadow:0 10px 25px rgba(2,6,23,.05);
    }
    body{background:var(--bg); color:var(--text);}
    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow);}
    .btn{display:inline-flex; align-items:center; justify-content:center; gap:.55rem; padding:.7rem 1rem; border-radius:10px; font-weight:800; transition: all .2s ease; border:1px solid transparent; user-select:none;}
    .btn:hover{transform:translateY(-1px);}
    .btn:active{transform:translateY(0px);}
    .btn-primary{background:var(--primary); color:#fff;}
    .btn-primary:hover{background:var(--primary2);}
    .btn-outline{background:#fff; border-color:var(--border); color:var(--text);}
    .btn-outline:hover{border-color:#cbd5e1; background:#f8fafc;}
    .btn-danger{background:var(--danger); color:#fff;}
    .btn-danger:hover{filter:brightness(.95);}
    .btn-success{background:var(--success); color:#fff;}
    .btn-success:hover{filter:brightness(.95);}
    .badge{display:inline-flex; align-items:center; gap:.4rem; padding:.25rem .65rem; border-radius:999px; font-weight:900; font-size:.75rem;}
    .badge-draft{background:#eef2ff; color:#3730a3;}
    .badge-issued{background:#ecfeff; color:#155e75;}
    .badge-approved{background:#dcfce7; color:#166534;}
    .badge-cancelled{background:#fee2e2; color:#991b1b;}
    .mono {font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .responsive-table {overflow-x:auto; -webkit-overflow-scrolling:touch;}

    input:focus, textarea:focus, select:focus{
      outline:none!important;
      border-color: rgba(37, 99, 235, .8)!important;
      box-shadow:0 0 0 3px rgba(37,99,235,.15)!important;
    }

    /* Print-friendly manual style */
    @media print{
      .no-print{display:none!important;}
      .print-only{display:block!important;}
      body{background:#fff!important;}
      .card{box-shadow:none!important; border:none!important;}
      .manual-print{max-width:210mm; margin:0 auto; padding:0;}
      thead{display:table-header-group;}
      tfoot{display:table-footer-group;}
      tr{page-break-inside:avoid;}
      .print-area{padding:0!important;}
    }

    /* Dark mode (toggle via [data-theme="dark"]) */
    [data-theme="dark"]{
      --bg:#0b1220;
      --card:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:#1f2937;
      --shadow:0 10px 25px rgba(0,0,0,.35);
    }
    [data-theme="dark"] .btn-outline{background:#0f172a; border-color:#243041; color:#e5e7eb;}
    [data-theme="dark"] .btn-outline:hover{background:#111c31; border-color:#2b3a52;}
    [data-theme="dark"] .text-gray-500{color:var(--muted)!important;}
    [data-theme="dark"] .bg-white{background:var(--card)!important;}
    [data-theme="dark"] .border-gray-200{border-color:var(--border)!important;}
  </style>
</head>

<body class="min-h-screen flex flex-col" data-theme="light">

  <!-- Easy Suite Navigation -->
  <nav class="bg-blue-600 text-white py-4 no-print">
    <div class="container mx-auto px-4 flex flex-wrap items-center gap-4">
      <a href="index.html" class="font-bold text-xl mr-4">Easy&nbsp;Suite</a>
      <a href="easy-quote.html" class="hover:underline">Quote</a>
      <a href="easy-invoice.html" class="hover:underline">Invoice</a>
      <a href="easy-purchase-order.html" class="underline font-semibold">Purchase&nbsp;Order</a>
      <a href="easy-sales-order.html" class="hover:underline">Sales&nbsp;Order</a>
      <a href="easy-receipt.html" class="hover:underline">Receipt</a>
      <a href="easy-statement.html" class="hover:underline">Statement</a>
      <a href="easy-job-card.html" class="hover:underline">Job&nbsp;Card</a>
      <a href="easy-payroll.html" class="hover:underline">Payroll</a>
      <a href="easy-inventory.html" class="hover:underline">Inventory</a>
      <a href="easy-crm.html" class="hover:underline">CRM</a>

      <button class="ml-auto btn btn-outline !py-2 !px-3" id="btnTheme" title="Toggle dark mode">
        <i class="fa-solid fa-moon"></i> Theme
      </button>
    </div>
  </nav>

  <!-- Header -->
  <header class="bg-white border-b border-gray-200 no-print">
    <div class="container mx-auto px-4 py-4 flex flex-col lg:flex-row gap-4 lg:gap-0 items-start lg:items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-xl bg-blue-600 text-white flex items-center justify-center font-black">PO</div>
        <div>
          <h1 class="text-2xl font-extrabold text-blue-700">EasyPO</h1>
          <p class="text-sm text-gray-500">Purchase Order Generator (Offline-ready)</p>
        </div>
      </div>

      <div class="flex flex-wrap items-center gap-2">
        <a class="btn btn-outline" href="index.html" title="Back to dashboard">
          <i class="fa-solid fa-grid-2"></i> Dashboard
        </a>

        <button class="btn btn-outline" id="btnNewPO" title="Generate a new PO number and reset current PO fields">
          <i class="fa-solid fa-file-circle-plus"></i> New PO
        </button>

        <button class="btn btn-outline" id="btnSaveTemplate" title="Save this PO as a template (local)">
          <i class="fa-solid fa-floppy-disk"></i> Save
        </button>
        <button class="btn btn-outline" id="btnLoadTemplate" title="Load a saved template (local)">
          <i class="fa-solid fa-folder-open"></i> Load
        </button>

        <button class="btn btn-outline" id="btnExportJSON" title="Export this PO as JSON">
          <i class="fa-solid fa-code"></i> JSON
        </button>

        <button class="btn btn-outline" id="btnExportCSV" title="Export line items as CSV">
          <i class="fa-solid fa-file-csv"></i> CSV
        </button>

        <button class="btn btn-outline" id="btnPrint" title="Print / Save as PDF">
          <i class="fa-solid fa-print"></i> Print/PDF
        </button>

        <button class="btn btn-danger" id="btnReset" title="Reset the form (keeps templates)">
          <i class="fa-solid fa-rotate-left"></i> Reset
        </button>

        <span class="ml-0 lg:ml-4 text-xs text-gray-500">
          Autosave: <span class="font-bold" id="autosaveStatus">On</span>
          <span class="mx-2">•</span>
          <span class="mono" id="autosaveTime">—</span>
        </span>
      </div>
    </div>
  </header>

  <main class="flex-grow container mx-auto px-4 py-6 md:py-8">

    <!-- Tips -->
    <div class="card p-4 mb-6 no-print">
      <div class="flex gap-3">
        <div class="text-blue-600 pt-0.5"><i class="fa-solid fa-circle-info"></i></div>
        <div class="flex-1">
          <h3 class="text-sm font-extrabold">Quick flow</h3>
          <div class="text-sm mt-1" style="color:var(--muted)">
            1) Company + supplier → 2) Set PO details → 3) Add/import items → 4) Review totals + VAT → 5) Approve + export/print.
          </div>
        </div>
        <div class="hidden md:block">
          <span class="badge badge-draft" id="statusBadge"><i class="fa-solid fa-pen-to-square"></i> Draft</span>
        </div>
      </div>
    </div>

    <!-- Layout -->
    <div class="grid grid-cols-1 xl:grid-cols-12 gap-6">

      <!-- Left: Company + Supplier -->
      <section class="xl:col-span-4 space-y-6">

        <div class="card p-5">
          <div class="flex items-center justify-between gap-3">
            <h2 class="text-lg font-extrabold">Company (Buyer)</h2>
            <button class="btn btn-outline !py-2 !px-3 no-print" id="btnUseDemoCompany" title="Fill with demo company info">
              <i class="fa-solid fa-wand-magic-sparkles"></i> Demo
            </button>
          </div>

          <div class="mt-4 grid grid-cols-1 gap-3">
            <div>
              <label class="text-xs font-bold" style="color:var(--muted)">Company Name</label>
              <input id="cName" class="w-full mt-1 border rounded-lg p-2" placeholder="Skunkworks (Pty) Ltd" />
            </div>

            <div>
              <label class="text-xs font-bold" style="color:var(--muted)">Registration / VAT No.</label>
              <input id="cRegVat" class="w-full mt-1 border rounded-lg p-2" placeholder="Reg: … • VAT: …" />
            </div>

            <div>
              <label class="text-xs font-bold" style="color:var(--muted)">Address</label>
              <textarea id="cAddress" class="w-full mt-1 border rounded-lg p-2" rows="3" placeholder="Street, Suburb, City, Code"></textarea>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div>
                <label class="text-xs font-bold" style="color:var(--muted)">Email</label>
                <input id="cEmail" type="email" class="w-full mt-1 border rounded-lg p-2" placeholder="accounts@company.co.za" />
              </div>
              <div>
                <label class="text-xs font-bold" style="color:var(--muted)">Phone</label>
                <input id="cPhone" class="w-full mt-1 border rounded-lg p-2" placeholder="+27 ..." />
              </div>
            </div>

            <div>
              <label class="text-xs font-bold" style="color:var(--muted)">Logo</label>
              <div class="mt-1 flex items-center gap-3">
                <input id="logoInput" type="file" accept="image/*" class="w-full border rounded-lg p-2" />
                <button class="btn btn-outline !py-2 !px-3" id="btnClearLogo" title="Remove logo">
                  <i class="fa-solid fa-trash"></i>
                </button>
              </div>
              <div class="mt-3">
                <img id="logoPreview" alt="Logo preview" class="max-h-16 hidden rounded-lg border" />
              </div>
            </div>
          </div>
        </div>

        <div class="card p-5">
          <div class="flex items-center justify-between gap-3">
            <h2 class="text-lg font-extrabold">Supplier (Vendor)</h2>
            <button class="btn btn-outline !py-2 !px-3 no-print" id="btnUseDemoSupplier" title="Fill with demo supplier info">
              <i class="fa-solid fa-wand-magic-sparkles"></i> Demo
            </button>
          </div>

          <div class="mt-4 grid grid-cols-1 gap-3">
            <div>
              <label class="text-xs font-bold" style="color:var(--muted)">Supplier Name</label>
              <input id="sName" class="w-full mt-1 border rounded-lg p-2" placeholder="Supplier / Vendor name" />
            </div>

            <div>
              <label class="text-xs font-bold" style="color:var(--muted)">Contact Person</label>
              <input id="sContact" class="w-full mt-1 border rounded-lg p-2" placeholder="Contact name" />
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div>
                <label class="text-xs font-bold" style="color:var(--muted)">Email</label>
                <input id="sEmail" type="email" class="w-full mt-1 border rounded-lg p-2" placeholder="sales@supplier.co.za" />
              </div>
              <div>
                <label class="text-xs font-bold" style="color:var(--muted)">Phone</label>
                <input id="sPhone" class="w-full mt-1 border rounded-lg p-2" placeholder="+27 ..." />
              </div>
            </div>

            <div>
              <label class="text-xs font-bold" style="color:var(--muted)">Address</label>
              <textarea id="sAddress" class="w-full mt-1 border rounded-lg p-2" rows="3" placeholder="Street, Suburb, City, Code"></textarea>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div>
                <label class="text-xs font-bold" style="color:var(--muted)">VAT No. (optional)</label>
                <input id="sVat" class="w-full mt-1 border rounded-lg p-2" placeholder="VAT..." />
              </div>
              <div>
                <label class="text-xs font-bold" style="color:var(--muted)">Supplier Code (optional)</label>
                <input id="sCode" class="w-full mt-1 border rounded-lg p-2" placeholder="SUP-001" />
              </div>
            </div>
          </div>
        </div>

        <!-- Approvals -->
        <div class="card p-5">
          <h2 class="text-lg font-extrabold">Approvals</h2>
          <div class="mt-4 grid grid-cols-1 gap-3">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div>
                <label class="text-xs font-bold" style="color:var(--muted)">Requested By</label>
                <input id="reqBy" class="w-full mt-1 border rounded-lg p-2" placeholder="Name" />
              </div>
              <div>
                <label class="text-xs font-bold" style="color:var(--muted)">Approved By</label>
                <input id="appBy" class="w-full mt-1 border rounded-lg p-2" placeholder="Name" />
              </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div>
                <label class="text-xs font-bold" style="color:var(--muted)">Approval Status</label>
                <select id="poStatus" class="w-full mt-1 border rounded-lg p-2">
                  <option value="Draft">Draft</option>
                  <option value="Issued">Issued</option>
                  <option value="Approved">Approved</option>
                  <option value="Cancelled">Cancelled</option>
                </select>
              </div>
              <div>
                <label class="text-xs font-bold" style="color:var(--muted)">Priority</label>
                <select id="priority" class="w-full mt-1 border rounded-lg p-2">
                  <option value="Normal">Normal</option>
                  <option value="Urgent">Urgent</option>
                  <option value="Critical">Critical</option>
                </select>
              </div>
            </div>

            <div class="flex flex-wrap gap-2 no-print">
              <button class="btn btn-primary" id="btnMarkIssued"><i class="fa-solid fa-paper-plane"></i> Mark Issued</button>
              <button class="btn btn-success" id="btnMarkApproved"><i class="fa-solid fa-circle-check"></i> Mark Approved</button>
              <button class="btn btn-danger" id="btnMarkCancelled"><i class="fa-solid fa-ban"></i> Cancel</button>
            </div>

            <div class="text-xs" style="color:var(--muted)">
              Tip: “Approved” status locks totals and discourages edits (you can still unlock via “Draft”).
            </div>
          </div>
        </div>

      </section>

      <!-- Right: PO Details + Items + Totals -->
      <section class="xl:col-span-8 space-y-6">

        <!-- PO Details -->
        <div class="card p-5">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <h2 class="text-lg font-extrabold">Purchase Order Details</h2>
            <div class="flex flex-wrap items-center gap-2">
              <span class="text-xs" style="color:var(--muted)">PO No.</span>
              <span class="mono font-extrabold text-blue-700" id="poNumberView">PO-000001</span>
              <span class="text-xs ml-2" style="color:var(--muted)">Currency</span>
              <select id="currency" class="border rounded-lg p-2 text-sm">
                <option value="ZAR" selected>ZAR (R)</option>
                <option value="USD">USD ($)</option>
                <option value="EUR">EUR (€)</option>
                <option value="GBP">GBP (£)</option>
              </select>
            </div>
          </div>

          <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-xs font-bold" style="color:var(--muted)">PO Date</label>
              <input id="poDate" type="date" class="w-full mt-1 border rounded-lg p-2" />
            </div>

            <div>
              <label class="text-xs font-bold" style="color:var(--muted)">Required By</label>
              <input id="requiredBy" type="date" class="w-full mt-1 border rounded-lg p-2" />
            </div>

            <div>
              <label class="text-xs font-bold" style="color:var(--muted)">Reference (optional)</label>
              <input id="poRef" class="w-full mt-1 border rounded-lg p-2" placeholder="Internal reference / project code" />
            </div>

            <div>
              <label class="text-xs font-bold" style="color:var(--muted)">Delivery Method</label>
              <select id="deliveryMethod" class="w-full mt-1 border rounded-lg p-2">
                <option>Delivery</option>
                <option>Collection</option>
                <option>Courier</option>
                <option>Digital / License</option>
              </select>
            </div>

            <div class="md:col-span-2">
              <label class="text-xs font-bold" style="color:var(--muted)">Delivery Address</label>
              <textarea id="deliveryAddress" class="w-full mt-1 border rounded-lg p-2" rows="3" placeholder="Where supplier should deliver"></textarea>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 md:col-span-2">
              <div>
                <label class="text-xs font-bold" style="color:var(--muted)">Payment Terms</label>
                <select id="paymentTerms" class="w-full mt-1 border rounded-lg p-2">
                  <option value="COD">COD (Cash on Delivery)</option>
                  <option value="EFT">EFT / Bank Transfer</option>
                  <option value="7 Days">7 Days</option>
                  <option value="14 Days">14 Days</option>
                  <option value="30 Days" selected>30 Days</option>
                  <option value="60 Days">60 Days</option>
                </select>
              </div>

              <div>
                <label class="text-xs font-bold" style="color:var(--muted)">VAT Mode</label>
                <select id="vatMode" class="w-full mt-1 border rounded-lg p-2">
                  <option value="exclusive" selected>Prices are VAT Exclusive</option>
                  <option value="inclusive">Prices are VAT Inclusive</option>
                  <option value="none">No VAT</option>
                </select>
              </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 md:col-span-2">
              <div>
                <label class="text-xs font-bold" style="color:var(--muted)">VAT %</label>
                <input id="vatRate" type="number" min="0" step="0.01" class="w-full mt-1 border rounded-lg p-2" value="15" />
              </div>
              <div>
                <label class="text-xs font-bold" style="color:var(--muted)">Discount (global)</label>
                <input id="globalDiscount" type="number" min="0" step="0.01" class="w-full mt-1 border rounded-lg p-2" value="0" />
                <div class="text-[11px] mt-1" style="color:var(--muted)">Applied to subtotal (before VAT)</div>
              </div>
              <div>
                <label class="text-xs font-bold" style="color:var(--muted)">Shipping / Handling</label>
                <input id="shipping" type="number" min="0" step="0.01" class="w-full mt-1 border rounded-lg p-2" value="0" />
              </div>
            </div>
          </div>
        </div>

        <!-- Items -->
        <div class="card p-5">
          <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
            <div>
              <h2 class="text-lg font-extrabold">Line Items</h2>
              <p class="text-sm" style="color:var(--muted)">Add products/services. Totals update live. Import/Export available.</p>
            </div>

            <div class="flex flex-wrap gap-2 no-print">
              <button class="btn btn-primary" id="btnAddItem"><i class="fa-solid fa-plus"></i> Add Item</button>
              <label class="btn btn-outline cursor-pointer" title="Import items from CSV (Description,Qty,UnitPrice,VATFlag)">
                <i class="fa-solid fa-file-import"></i> Import CSV
                <input id="csvInput" type="file" accept=".csv,text/csv" class="hidden" />
              </label>
              <button class="btn btn-outline" id="btnAddDemoItems"><i class="fa-solid fa-wand-magic-sparkles"></i> Demo Items</button>
              <button class="btn btn-danger" id="btnClearItems"><i class="fa-solid fa-trash"></i> Clear Items</button>
            </div>
          </div>

          <div class="mt-4 responsive-table">
            <table class="w-full text-sm">
              <thead>
                <tr class="text-left border-b">
                  <th class="py-2 pr-2 w-12">#</th>
                  <th class="py-2 pr-2 min-w-[220px]">Description</th>
                  <th class="py-2 pr-2 w-28">SKU</th>
                  <th class="py-2 pr-2 w-24">Qty</th>
                  <th class="py-2 pr-2 w-36">Unit Price</th>
                  <th class="py-2 pr-2 w-28">VAT</th>
                  <th class="py-2 pr-2 w-40 text-right">Line Total</th>
                  <th class="py-2 pr-2 w-20 no-print">Actions</th>
                </tr>
              </thead>
              <tbody id="itemsBody">
                <!-- rows injected -->
              </tbody>
            </table>
          </div>

          <div class="mt-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div class="text-xs" style="color:var(--muted)">
              CSV import format: <span class="mono">Description,Qty,UnitPrice,VAT</span> (VAT can be <span class="mono">yes/no</span>).
            </div>
            <div class="flex items-center gap-2 no-print">
              <button class="btn btn-outline !py-2 !px-3" id="btnRecalc"><i class="fa-solid fa-arrows-rotate"></i> Recalc</button>
              <button class="btn btn-outline !py-2 !px-3" id="btnSortItems" title="Sort items by description"><i class="fa-solid fa-arrow-down-a-z"></i> Sort</button>
            </div>
          </div>
        </div>

        <!-- Notes & Terms -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="card p-5">
            <h2 class="text-lg font-extrabold">Notes</h2>
            <textarea id="notes" class="w-full mt-3 border rounded-lg p-2" rows="6" placeholder="Additional notes for supplier (delivery instructions, contact details, etc.)"></textarea>

            <div class="mt-3 flex flex-wrap gap-2 no-print">
              <button class="btn btn-outline !py-2 !px-3" id="btnInsertStdNotes"><i class="fa-solid fa-bolt"></i> Insert Standard Notes</button>
              <button class="btn btn-outline !py-2 !px-3" id="btnClearNotes"><i class="fa-solid fa-eraser"></i> Clear</button>
            </div>
          </div>

          <div class="card p-5">
            <h2 class="text-lg font-extrabold">Terms</h2>
            <textarea id="terms" class="w-full mt-3 border rounded-lg p-2" rows="6" placeholder="Terms and conditions (PO binding terms, warranty, returns, etc.)"></textarea>

            <div class="mt-3 flex flex-wrap gap-2 no-print">
              <button class="btn btn-outline !py-2 !px-3" id="btnInsertStdTerms"><i class="fa-solid fa-bolt"></i> Insert Standard Terms</button>
              <button class="btn btn-outline !py-2 !px-3" id="btnClearTerms"><i class="fa-solid fa-eraser"></i> Clear</button>
            </div>
          </div>
        </div>

        <!-- Totals + Actions -->
        <div class="card p-5">
          <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-6">
            <div class="flex-1">
              <h2 class="text-lg font-extrabold">Totals</h2>
              <p class="text-sm mt-1" style="color:var(--muted)">Review subtotal, discount, VAT and grand total.</p>

              <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div class="p-4 rounded-xl border" style="border-color:var(--border)">
                  <div class="text-xs font-bold" style="color:var(--muted)">Subtotal</div>
                  <div class="text-2xl font-extrabold" id="subtotalView">R 0.00</div>
                </div>
                <div class="p-4 rounded-xl border" style="border-color:var(--border)">
                  <div class="text-xs font-bold" style="color:var(--muted)">Discount</div>
                  <div class="text-2xl font-extrabold" id="discountView">R 0.00</div>
                </div>
                <div class="p-4 rounded-xl border" style="border-color:var(--border)">
                  <div class="text-xs font-bold" style="color:var(--muted)">VAT</div>
                  <div class="text-2xl font-extrabold" id="vatView">R 0.00</div>
                </div>
                <div class="p-4 rounded-xl border" style="border-color:var(--border)">
                  <div class="text-xs font-bold" style="color:var(--muted)">Grand Total</div>
                  <div class="text-2xl font-extrabold text-blue-700" id="grandView">R 0.00</div>
                </div>
              </div>

              <div class="mt-4 text-xs" style="color:var(--muted)">
                VAT calculation respects <span class="mono">VAT Mode</span>: exclusive / inclusive / none.
              </div>
            </div>

            <div class="w-full lg:w-[360px]">
              <h2 class="text-lg font-extrabold">Send / Share</h2>
              <p class="text-sm mt-1" style="color:var(--muted)">Quick actions to send PO details.</p>

              <div class="mt-4 space-y-2 no-print">
                <button class="btn btn-primary w-full" id="btnEmailSupplier">
                  <i class="fa-solid fa-envelope"></i> Email Supplier (mailto)
                </button>
                <button class="btn btn-outline w-full" id="btnCopySummary">
                  <i class="fa-solid fa-copy"></i> Copy PO Summary
                </button>
                <button class="btn btn-outline w-full" id="btnDownloadJSON">
                  <i class="fa-solid fa-download"></i> Download PO JSON
                </button>
                <button class="btn btn-outline w-full" id="btnDownloadCSV">
                  <i class="fa-solid fa-download"></i> Download Items CSV
                </button>
              </div>

              <div class="mt-4 p-4 rounded-xl border text-xs" style="border-color:var(--border); color:var(--muted)">
                <div class="font-extrabold text-sm mb-1">Compliance notes</div>
                <ul class="list-disc pl-5 space-y-1">
                  <li>Keep supplier VAT and your VAT fields accurate if VAT is claimed.</li>
                  <li>Use “Approved” when PO is locked for audit trail.</li>
                  <li>Print/PDF produces a clean document layout.</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <!-- Print-only footer -->
        <div class="print-only hidden">
          <div class="manual-print">
            <hr class="my-6" />
            <div class="text-xs text-gray-500">
              Generated by Easy Suite • EasyPO • Offline document generator
            </div>
          </div>
        </div>

      </section>
    </div>

    <!-- Printable Document -->
    <section class="mt-6 card p-5 print-area" id="printDoc">
      <div class="manual-print">
        <div class="flex items-start justify-between gap-4">
          <div class="flex items-start gap-4">
            <img id="logoPrint" class="hidden max-h-16 rounded-lg border" alt="Logo" />
            <div>
              <div class="text-2xl font-extrabold">PURCHASE ORDER</div>
              <div class="text-sm" style="color:var(--muted)">
                PO No: <span class="mono font-bold" id="poNumberPrint">PO-000001</span>
                <span class="mx-2">•</span>
                Status: <span class="font-bold" id="poStatusPrint">Draft</span>
              </div>
            </div>
          </div>

          <div class="text-right">
            <div class="text-sm">
              <div><span class="font-bold">PO Date:</span> <span id="poDatePrint">—</span></div>
              <div><span class="font-bold">Required By:</span> <span id="requiredByPrint">—</span></div>
              <div><span class="font-bold">Reference:</span> <span id="poRefPrint">—</span></div>
              <div><span class="font-bold">Payment:</span> <span id="termsPrint">—</span></div>
            </div>
          </div>
        </div>

        <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="border rounded-xl p-4" style="border-color:var(--border)">
            <div class="text-xs font-extrabold" style="color:var(--muted)">BUYER</div>
            <div class="font-extrabold mt-1" id="cNamePrint">—</div>
            <div class="text-sm mt-1 whitespace-pre-line" id="cAddressPrint">—</div>
            <div class="text-sm mt-2" id="cContactPrint">—</div>
            <div class="text-sm mt-1" id="cRegVatPrint">—</div>
          </div>

          <div class="border rounded-xl p-4" style="border-color:var(--border)">
            <div class="text-xs font-extrabold" style="color:var(--muted)">SUPPLIER</div>
            <div class="font-extrabold mt-1" id="sNamePrint">—</div>
            <div class="text-sm mt-1 whitespace-pre-line" id="sAddressPrint">—</div>
            <div class="text-sm mt-2" id="sContactPrint">—</div>
            <div class="text-sm mt-1" id="sVatPrint">—</div>
          </div>
        </div>

        <div class="mt-6 border rounded-xl p-4" style="border-color:var(--border)">
          <div class="text-xs font-extrabold" style="color:var(--muted)">DELIVERY</div>
          <div class="text-sm mt-1"><span class="font-bold">Method:</span> <span id="deliveryMethodPrint">—</span></div>
          <div class="text-sm mt-1 whitespace-pre-line" id="deliveryAddressPrint">—</div>
        </div>

        <div class="mt-6 responsive-table">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b">
                <th class="py-2 pr-2 w-12">#</th>
                <th class="py-2 pr-2">Description</th>
                <th class="py-2 pr-2 w-28">SKU</th>
                <th class="py-2 pr-2 w-20">Qty</th>
                <th class="py-2 pr-2 w-32">Unit</th>
                <th class="py-2 pr-2 w-20">VAT</th>
                <th class="py-2 pr-2 w-36 text-right">Line Total</th>
              </tr>
            </thead>
            <tbody id="printItemsBody"></tbody>
          </table>
        </div>

        <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="border rounded-xl p-4" style="border-color:var(--border)">
            <div class="text-xs font-extrabold" style="color:var(--muted)">NOTES</div>
            <div class="text-sm mt-2 whitespace-pre-line" id="notesPrint">—</div>
          </div>

          <div class="border rounded-xl p-4" style="border-color:var(--border)">
            <div class="text-xs font-extrabold" style="color:var(--muted)">TOTALS</div>
            <div class="text-sm mt-2 flex justify-between"><span>Subtotal</span><span class="mono" id="subtotalPrint">—</span></div>
            <div class="text-sm mt-1 flex justify-between"><span>Discount</span><span class="mono" id="discountPrint">—</span></div>
            <div class="text-sm mt-1 flex justify-between"><span>VAT</span><span class="mono" id="vatPrint">—</span></div>
            <div class="text-sm mt-2 pt-2 border-t flex justify-between font-extrabold" style="border-color:var(--border)">
              <span>Grand Total</span><span class="mono" id="grandPrint">—</span>
            </div>
            <div class="text-xs mt-2" style="color:var(--muted)">
              VAT Mode: <span class="mono" id="vatModePrint">—</span>
            </div>
          </div>
        </div>

        <div class="mt-6 border rounded-xl p-4" style="border-color:var(--border)">
          <div class="text-xs font-extrabold" style="color:var(--muted)">TERMS</div>
          <div class="text-sm mt-2 whitespace-pre-line" id="termsBodyPrint">—</div>
        </div>

        <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="border rounded-xl p-4" style="border-color:var(--border)">
            <div class="text-xs font-extrabold" style="color:var(--muted)">Requested By</div>
            <div class="text-sm mt-2" id="reqByPrint">—</div>
            <div class="text-xs mt-8" style="color:var(--muted)">Signature</div>
            <div class="border-b mt-2" style="border-color:var(--border)"></div>
          </div>
          <div class="border rounded-xl p-4" style="border-color:var(--border)">
            <div class="text-xs font-extrabold" style="color:var(--muted)">Approved By</div>
            <div class="text-sm mt-2" id="appByPrint">—</div>
            <div class="text-xs mt-8" style="color:var(--muted)">Signature</div>
            <div class="border-b mt-2" style="border-color:var(--border)"></div>
          </div>
          <div class="border rounded-xl p-4" style="border-color:var(--border)">
            <div class="text-xs font-extrabold" style="color:var(--muted)">Supplier Acceptance</div>
            <div class="text-xs mt-2" style="color:var(--muted)">Confirm availability, pricing, and delivery.</div>
            <div class="text-xs mt-8" style="color:var(--muted)">Signature / Stamp</div>
            <div class="border-b mt-2" style="border-color:var(--border)"></div>
          </div>
        </div>

      </div>
    </section>
  </main>

  <!-- Modals -->
  <div class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 no-print" id="modalBackdrop" aria-hidden="true"></div>

  <div class="fixed inset-0 hidden items-center justify-center p-4 no-print" id="templateModal" role="dialog" aria-modal="true" aria-labelledby="templateTitle">
    <div class="card w-full max-w-2xl p-5">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h3 class="text-lg font-extrabold" id="templateTitle">Templates</h3>
          <p class="text-sm mt-1" style="color:var(--muted)">Save and load templates stored in your browser.</p>
        </div>
        <button class="btn btn-outline !py-2 !px-3" id="btnCloseModal"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <div class="mt-4 flex flex-col sm:flex-row gap-3">
        <input id="templateName" class="flex-1 border rounded-lg p-2" placeholder="Template name (e.g., Supplier A – monthly)" />
        <button class="btn btn-primary" id="btnConfirmSave"><i class="fa-solid fa-floppy-disk"></i> Save</button>
      </div>

      <div class="mt-4 border rounded-xl" style="border-color:var(--border)">
        <div class="p-3 text-xs font-extrabold" style="color:var(--muted)">Saved templates</div>
        <div class="max-h-64 overflow-auto" id="templatesList"></div>
      </div>

      <div class="mt-4 flex flex-wrap gap-2">
        <button class="btn btn-outline" id="btnExportAllTemplates"><i class="fa-solid fa-box-archive"></i> Export Templates</button>
        <label class="btn btn-outline cursor-pointer">
          <i class="fa-solid fa-file-import"></i> Import Templates
          <input id="templatesImport" type="file" accept="application/json" class="hidden" />
        </label>
        <button class="btn btn-danger ml-auto" id="btnDeleteAllTemplates"><i class="fa-solid fa-trash"></i> Delete All</button>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * EasyPO – Full Offline App
     * - LocalStorage autosave
     * - Templates save/load/export/import
     * - Items table with add/edit/remove
     * - VAT modes: exclusive/inclusive/none
     * - CSV import/export
     * - JSON export/download
     * - Print/PDF (browser print)
     * - Email supplier (mailto)
     * - Dark mode toggle
     ************************/

    // Storage keys
    const KEY_AUTOSAVE = "EASYPO_AUTOSAVE_V1";
    const KEY_TEMPLATES = "EASYPO_TEMPLATES_V1";
    const KEY_POSEQ = "EASYPO_POSEQ_V1";
    const KEY_THEME = "EASYPO_THEME_V1";

    // DOM helpers
    const $ = (id) => document.getElementById(id);
    const fmtDate = (d) => {
      if(!d) return "—";
      const dt = new Date(d + "T00:00:00");
      return dt.toLocaleDateString("en-ZA", { year:"numeric", month:"short", day:"2-digit" });
    };

    const currencySymbol = (cur) => ({ZAR:"R", USD:"$", EUR:"€", GBP:"£"}[cur] || cur);
    const money = (val, cur) => {
      const sym = currencySymbol(cur);
      const n = Number(val || 0);
      return `${sym} ${n.toFixed(2)}`;
    };

    // State
    let state = {
      meta: {
        poNumber: "PO-000001",
        status: "Draft",
        priority: "Normal",
        currency: "ZAR",
        poDate: "",
        requiredBy: "",
        poRef: "",
        deliveryMethod: "Delivery",
        deliveryAddress: "",
        paymentTerms: "30 Days",
        vatMode: "exclusive",
        vatRate: 15,
        globalDiscount: 0,
        shipping: 0,
      },
      company: {
        name: "",
        regVat: "",
        address: "",
        email: "",
        phone: "",
        logoDataUrl: ""
      },
      supplier: {
        name: "",
        contact: "",
        email: "",
        phone: "",
        address: "",
        vat: "",
        code: ""
      },
      approvals: {
        requestedBy: "",
        approvedBy: ""
      },
      notes: "",
      terms: "",
      items: []
    };

    // Item factory
    const newItem = () => ({
      id: cryptoRandomId(),
      description: "",
      sku: "",
      qty: 1,
      unitPrice: 0,
      vat: true
    });

    function cryptoRandomId(){
      // safe fallback
      if (window.crypto && crypto.getRandomValues){
        const a = new Uint32Array(2);
        crypto.getRandomValues(a);
        return "i_" + a[0].toString(16) + a[1].toString(16);
      }
      return "i_" + Math.random().toString(16).slice(2);
    }

    // Init
    function init(){
      // Theme
      const savedTheme = localStorage.getItem(KEY_THEME);
      if(savedTheme) setTheme(savedTheme);

      // Defaults: dates
      const today = new Date();
      const iso = today.toISOString().slice(0,10);
      state.meta.poDate = iso;

      // Load autosave if present
      const autosaved = localStorage.getItem(KEY_AUTOSAVE);
      if(autosaved){
        try{
          const parsed = JSON.parse(autosaved);
          state = normalizeState(parsed);
        }catch(e){}
      }else{
        // Ensure at least 1 item
        state.items = [newItem()];
        // Ensure PO number sequence
        ensurePOSequence();
        state.meta.poNumber = nextPONumber(false); // do not increment (read current)
      }

      bindInputs();
      renderAll();
      setupAutosave();
    }

    function normalizeState(s){
      // Merge with default shape (forward-compatible)
      const base = JSON.parse(JSON.stringify(state));
      const merged = {
        meta: {...base.meta, ...(s.meta||{})},
        company: {...base.company, ...(s.company||{})},
        supplier: {...base.supplier, ...(s.supplier||{})},
        approvals: {...base.approvals, ...(s.approvals||{})},
        notes: s.notes ?? base.notes,
        terms: s.terms ?? base.terms,
        items: Array.isArray(s.items) && s.items.length ? s.items.map(it => ({
          id: it.id || cryptoRandomId(),
          description: it.description || "",
          sku: it.sku || "",
          qty: clampNumber(it.qty, 0, 1e9, 1),
          unitPrice: clampNumber(it.unitPrice, 0, 1e12, 0),
          vat: (it.vat !== false) // default true
        })) : [newItem()]
      };
      ensurePOSequence();
      if(!merged.meta.poNumber) merged.meta.poNumber = nextPONumber(false);
      return merged;
    }

    function clampNumber(v, min, max, fallback){
      const n = Number(v);
      if(Number.isNaN(n)) return fallback;
      return Math.max(min, Math.min(max, n));
    }

    function ensurePOSequence(){
      if(!localStorage.getItem(KEY_POSEQ)){
        localStorage.setItem(KEY_POSEQ, String(1));
      }
    }

    function nextPONumber(increment=true){
      ensurePOSequence();
      let seq = Number(localStorage.getItem(KEY_POSEQ) || "1");
      if(increment){
        seq += 1;
        localStorage.setItem(KEY_POSEQ, String(seq));
      }
      const padded = String(seq).padStart(6, "0");
      return `PO-${padded}`;
    }

    // Bind UI to state
    function bindInputs(){
      // Header buttons
      $("btnPrint").addEventListener("click", () => { syncPrint(); window.print(); });
      $("btnReset").addEventListener("click", resetFormKeepTemplates);
      $("btnNewPO").addEventListener("click", newPO);

      $("btnSaveTemplate").addEventListener("click", () => openTemplateModal("save"));
      $("btnLoadTemplate").addEventListener("click", () => openTemplateModal("load"));

      $("btnExportJSON").addEventListener("click", () => downloadJSON(getExportName()+".json", state));
      $("btnExportCSV").addEventListener("click", () => downloadCSV(getExportName()+"-items.csv", itemsToCSV(state)));

      $("btnEmailSupplier").addEventListener("click", emailSupplier);
      $("btnCopySummary").addEventListener("click", copySummary);
      $("btnDownloadJSON").addEventListener("click", () => downloadJSON(getExportName()+".json", state));
      $("btnDownloadCSV").addEventListener("click", () => downloadCSV(getExportName()+"-items.csv", itemsToCSV(state)));

      $("btnTheme").addEventListener("click", toggleTheme);

      // Demo fillers
      $("btnUseDemoCompany").addEventListener("click", fillDemoCompany);
      $("btnUseDemoSupplier").addEventListener("click", fillDemoSupplier);

      // Approvals quick buttons
      $("btnMarkIssued").addEventListener("click", () => setStatus("Issued"));
      $("btnMarkApproved").addEventListener("click", () => setStatus("Approved"));
      $("btnMarkCancelled").addEventListener("click", () => setStatus("Cancelled"));

      // Items buttons
      $("btnAddItem").addEventListener("click", () => { state.items.push(newItem()); renderItems(); recalc(); autosave(); });
      $("btnClearItems").addEventListener("click", () => { if(confirm("Clear all line items?")){ state.items = [newItem()]; renderItems(); recalc(); autosave(); }});
      $("btnAddDemoItems").addEventListener("click", addDemoItems);
      $("btnRecalc").addEventListener("click", () => { recalc(); toast("Recalculated."); });
      $("btnSortItems").addEventListener("click", () => { state.items.sort((a,b)=> (a.description||"").localeCompare(b.description||"")); renderItems(); recalc(); autosave(); });

      // CSV import
      $("csvInput").addEventListener("change", (e) => handleCSVImport(e.target.files && e.target.files[0]));

      // Notes/terms helpers
      $("btnInsertStdNotes").addEventListener("click", () => {
        const std = [
          "Please quote PO number on your invoice and delivery note.",
          "Delivery hours: Mon–Fri 08:00–16:30.",
          "Contact on arrival: " + (state.company.phone || state.company.email || "—"),
        ].join("\n");
        $("notes").value = std;
        state.notes = std;
        recalc(); autosave(); syncPrint();
      });
      $("btnClearNotes").addEventListener("click", () => { $("notes").value=""; state.notes=""; autosave(); syncPrint(); });

      $("btnInsertStdTerms").addEventListener("click", () => {
        const std = [
          "1) This Purchase Order constitutes an offer to purchase the goods/services listed.",
          "2) Supplier must confirm availability, lead time and final pricing in writing.",
          "3) Prices and VAT treatment must match this PO unless approved in writing.",
          "4) Warranty/returns per supplier standard terms unless otherwise agreed.",
          "5) Payment terms as indicated on this PO, subject to correct tax invoice."
        ].join("\n");
        $("terms").value = std;
        state.terms = std;
        autosave(); syncPrint();
      });
      $("btnClearTerms").addEventListener("click", () => { $("terms").value=""; state.terms=""; autosave(); syncPrint(); });

      // Modal
      $("btnCloseModal").addEventListener("click", closeTemplateModal);
      $("modalBackdrop").addEventListener("click", closeTemplateModal);
      $("btnConfirmSave").addEventListener("click", saveTemplateFromModal);
      $("btnExportAllTemplates").addEventListener("click", exportTemplates);
      $("templatesImport").addEventListener("change", (e) => importTemplatesFile(e.target.files && e.target.files[0]));
      $("btnDeleteAllTemplates").addEventListener("click", deleteAllTemplates);

      // Field bindings
      bindField("currency", (v)=> state.meta.currency=v, true);
      bindField("poDate", (v)=> state.meta.poDate=v, true);
      bindField("requiredBy", (v)=> state.meta.requiredBy=v, true);
      bindField("poRef", (v)=> state.meta.poRef=v, true);
      bindField("deliveryMethod", (v)=> state.meta.deliveryMethod=v, true);
      bindField("deliveryAddress", (v)=> state.meta.deliveryAddress=v, true);
      bindField("paymentTerms", (v)=> state.meta.paymentTerms=v, true);
      bindField("vatMode", (v)=> state.meta.vatMode=v, true);
      bindField("vatRate", (v)=> state.meta.vatRate=clampNumber(v,0,100,15), true);
      bindField("globalDiscount", (v)=> state.meta.globalDiscount=clampNumber(v,0,1e12,0), true);
      bindField("shipping", (v)=> state.meta.shipping=clampNumber(v,0,1e12,0), true);
      bindField("poStatus", (v)=> state.meta.status=v, true);
      bindField("priority", (v)=> state.meta.priority=v, true);

      bindField("cName", (v)=> state.company.name=v, true);
      bindField("cRegVat", (v)=> state.company.regVat=v, true);
      bindField("cAddress", (v)=> state.company.address=v, true);
      bindField("cEmail", (v)=> state.company.email=v, true);
      bindField("cPhone", (v)=> state.company.phone=v, true);

      bindField("sName", (v)=> state.supplier.name=v, true);
      bindField("sContact", (v)=> state.supplier.contact=v, true);
      bindField("sEmail", (v)=> state.supplier.email=v, true);
      bindField("sPhone", (v)=> state.supplier.phone=v, true);
      bindField("sAddress", (v)=> state.supplier.address=v, true);
      bindField("sVat", (v)=> state.supplier.vat=v, true);
      bindField("sCode", (v)=> state.supplier.code=v, true);

      bindField("reqBy", (v)=> state.approvals.requestedBy=v, true);
      bindField("appBy", (v)=> state.approvals.approvedBy=v, true);

      bindField("notes", (v)=> state.notes=v, false);
      bindField("terms", (v)=> state.terms=v, false);

      // Logo upload
      $("logoInput").addEventListener("change", async (e) => {
        const f = e.target.files && e.target.files[0];
        if(!f) return;
        const dataUrl = await fileToDataUrl(f);
        state.company.logoDataUrl = dataUrl;
        renderLogo();
        autosave();
        syncPrint();
      });
      $("btnClearLogo").addEventListener("click", () => {
        state.company.logoDataUrl = "";
        $("logoInput").value = "";
        renderLogo();
        autosave();
        syncPrint();
      });
    }

    function bindField(id, setter, recalcOnChange){
      const el = $(id);
      if(!el) return;
      el.addEventListener("input", () => {
        setter(el.value);
        if(recalcOnChange) recalc();
        autosave();
        syncPrint();
      });
    }

    function fileToDataUrl(file){
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    // Render
    function renderAll(){
      // Fill inputs
      $("poNumberView").textContent = state.meta.poNumber;
      $("currency").value = state.meta.currency;

      $("poDate").value = state.meta.poDate || "";
      $("requiredBy").value = state.meta.requiredBy || "";
      $("poRef").value = state.meta.poRef || "";
      $("deliveryMethod").value = state.meta.deliveryMethod || "Delivery";
      $("deliveryAddress").value = state.meta.deliveryAddress || "";
      $("paymentTerms").value = state.meta.paymentTerms || "30 Days";
      $("vatMode").value = state.meta.vatMode || "exclusive";
      $("vatRate").value = String(state.meta.vatRate ?? 15);
      $("globalDiscount").value = String(state.meta.globalDiscount ?? 0);
      $("shipping").value = String(state.meta.shipping ?? 0);
      $("poStatus").value = state.meta.status || "Draft";
      $("priority").value = state.meta.priority || "Normal";

      $("cName").value = state.company.name || "";
      $("cRegVat").value = state.company.regVat || "";
      $("cAddress").value = state.company.address || "";
      $("cEmail").value = state.company.email || "";
      $("cPhone").value = state.company.phone || "";

      $("sName").value = state.supplier.name || "";
      $("sContact").value = state.supplier.contact || "";
      $("sEmail").value = state.supplier.email || "";
      $("sPhone").value = state.supplier.phone || "";
      $("sAddress").value = state.supplier.address || "";
      $("sVat").value = state.supplier.vat || "";
      $("sCode").value = state.supplier.code || "";

      $("reqBy").value = state.approvals.requestedBy || "";
      $("appBy").value = state.approvals.approvedBy || "";

      $("notes").value = state.notes || "";
      $("terms").value = state.terms || "";

      renderLogo();
      renderItems();
      recalc();
      setStatus(state.meta.status || "Draft", true);
      syncPrint();
    }

    function renderLogo(){
      const has = !!state.company.logoDataUrl;
      const prev = $("logoPreview");
      const p = $("logoPrint");
      if(has){
        prev.src = state.company.logoDataUrl;
        prev.classList.remove("hidden");
        p.src = state.company.logoDataUrl;
        p.classList.remove("hidden");
      }else{
        prev.classList.add("hidden");
        p.classList.add("hidden");
      }
    }

    function renderItems(){
      const body = $("itemsBody");
      body.innerHTML = "";
      state.items.forEach((it, idx) => {
        const tr = document.createElement("tr");
        tr.className = "border-b";
        tr.innerHTML = `
          <td class="py-2 pr-2 align-top font-bold">${idx+1}</td>
          <td class="py-2 pr-2 align-top">
            <input class="w-full border rounded-lg p-2" placeholder="Item description" value="${escapeHtml(it.description)}" data-k="description" data-id="${it.id}">
            <div class="text-[11px] mt-1" style="color:var(--muted)">Tip: Use clear specs (model, qty, term, SKU).</div>
          </td>
          <td class="py-2 pr-2 align-top">
            <input class="w-full border rounded-lg p-2 mono" placeholder="SKU" value="${escapeHtml(it.sku)}" data-k="sku" data-id="${it.id}">
          </td>
          <td class="py-2 pr-2 align-top">
            <input type="number" min="0" step="0.01" class="w-full border rounded-lg p-2" value="${Number(it.qty||0)}" data-k="qty" data-id="${it.id}">
          </td>
          <td class="py-2 pr-2 align-top">
            <input type="number" min="0" step="0.01" class="w-full border rounded-lg p-2" value="${Number(it.unitPrice||0)}" data-k="unitPrice" data-id="${it.id}">
          </td>
          <td class="py-2 pr-2 align-top">
            <select class="w-full border rounded-lg p-2" data-k="vat" data-id="${it.id}">
              <option value="yes" ${it.vat ? "selected":""}>Yes</option>
              <option value="no" ${!it.vat ? "selected":""}>No</option>
            </select>
          </td>
          <td class="py-2 pr-2 align-top text-right font-extrabold">
            <span class="mono" id="line_${it.id}">—</span>
          </td>
          <td class="py-2 pr-2 align-top no-print">
            <div class="flex gap-2">
              <button class="btn btn-outline !py-2 !px-3" title="Duplicate" data-act="dup" data-id="${it.id}">
                <i class="fa-solid fa-clone"></i>
              </button>
              <button class="btn btn-danger !py-2 !px-3" title="Remove" data-act="del" data-id="${it.id}">
                <i class="fa-solid fa-trash"></i>
              </button>
            </div>
          </td>
        `;
        body.appendChild(tr);
      });

      // Bind item inputs
      body.querySelectorAll("input[data-k], select[data-k]").forEach(el => {
        el.addEventListener("input", () => {
          const id = el.getAttribute("data-id");
          const k = el.getAttribute("data-k");
          const item = state.items.find(x => x.id === id);
          if(!item) return;

          if(k === "qty") item.qty = clampNumber(el.value, 0, 1e9, 1);
          else if(k === "unitPrice") item.unitPrice = clampNumber(el.value, 0, 1e12, 0);
          else if(k === "vat") item.vat = (el.value === "yes");
          else item[k] = el.value;

          recalc();
          autosave();
          syncPrint();
        });
      });

      // Bind actions
      body.querySelectorAll("button[data-act]").forEach(btn => {
        btn.addEventListener("click", () => {
          const act = btn.getAttribute("data-act");
          const id = btn.getAttribute("data-id");
          if(act === "del"){
            if(state.items.length === 1){
              toast("At least one item is required.");
              return;
            }
            state.items = state.items.filter(x => x.id !== id);
          }
          if(act === "dup"){
            const item = state.items.find(x => x.id === id);
            if(item){
              const copy = {...item, id: cryptoRandomId()};
              state.items.push(copy);
            }
          }
          renderItems();
          recalc();
          autosave();
          syncPrint();
        });
      });

      recalc();
    }

    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // Calculations
    function recalc(){
      const cur = state.meta.currency;
      const vatMode = state.meta.vatMode;
      const vatRate = clampNumber(state.meta.vatRate, 0, 100, 15) / 100;

      let subtotal = 0;
      let vatTotal = 0;

      // For each item compute line total excluding/including VAT depending on mode
      state.items.forEach(it => {
        const qty = clampNumber(it.qty, 0, 1e9, 0);
        const unit = clampNumber(it.unitPrice, 0, 1e12, 0);
        const baseLine = qty * unit;

        let lineExVat = baseLine;
        let lineVat = 0;

        if(vatMode === "none" || !it.vat){
          lineVat = 0;
          lineExVat = baseLine;
        }else if(vatMode === "exclusive"){
          lineVat = baseLine * vatRate;
          lineExVat = baseLine;
        }else if(vatMode === "inclusive"){
          // baseLine is VAT-inclusive, extract VAT
          const ex = baseLine / (1 + vatRate);
          lineVat = baseLine - ex;
          lineExVat = ex;
        }

        subtotal += lineExVat;
        vatTotal += lineVat;

        const lineTotalDisplay = (vatMode === "inclusive" && it.vat) ? baseLine : (lineExVat + lineVat);
        const el = $("line_" + it.id);
        if(el) el.textContent = money(lineTotalDisplay, cur);
      });

      // Global discount applies to subtotal (before VAT)
      const discount = clampNumber(state.meta.globalDiscount, 0, subtotal, 0);
      const shipping = clampNumber(state.meta.shipping, 0, 1e12, 0);

      const discountedSubtotal = Math.max(0, subtotal - discount);

      // Recompute VAT if discount should reduce VAT proportionally:
      // For exclusive mode and VAT applicable items, VAT should reduce with discount.
      // We apply discount proportionally across VAT-applicable base (subtotal already is exVAT where VAT applies).
      if(vatMode !== "none" && vatMode !== "inclusive"){
        // Exclusive VAT: vatTotal calculated on pre-discount base. Adjust vatTotal by discount ratio on VAT-applicable lines.
        const pre = subtotal;
        const ratio = pre > 0 ? (discountedSubtotal / pre) : 1;
        vatTotal = vatTotal * ratio;
      } else if(vatMode === "inclusive"){
        // Inclusive: if prices are inclusive, discount reduces total and VAT reduces proportionally
        const pre = subtotal + vatTotal; // grand before discount/shipping (excluding shipping)
        const preDiscountTotal = pre;
        const ratio = preDiscountTotal > 0 ? ((preDiscountTotal - discount) / preDiscountTotal) : 1;
        subtotal = subtotal * ratio;
        vatTotal = vatTotal * ratio;
      }

      const grand = discountedSubtotal + vatTotal + shipping;

      // Update totals
      $("subtotalView").textContent = money(subtotal, cur);
      $("discountView").textContent = money(discount, cur);
      $("vatView").textContent = money(vatTotal, cur);
      $("grandView").textContent = money(grand, cur);

      // Print totals
      $("subtotalPrint").textContent = money(subtotal, cur);
      $("discountPrint").textContent = money(discount, cur);
      $("vatPrint").textContent = money(vatTotal, cur);
      $("grandPrint").textContent = money(grand, cur);

      // Save computed for email/summary convenience
      state._computed = { subtotal, discount, vatTotal, shipping, grand };
    }

    // Print sync
    function syncPrint(){
      $("poNumberPrint").textContent = state.meta.poNumber;
      $("poNumberView").textContent = state.meta.poNumber;
      $("poStatusPrint").textContent = state.meta.status;
      $("poDatePrint").textContent = fmtDate(state.meta.poDate);
      $("requiredByPrint").textContent = fmtDate(state.meta.requiredBy);
      $("poRefPrint").textContent = state.meta.poRef || "—";
      $("termsPrint").textContent = state.meta.paymentTerms || "—";

      $("cNamePrint").textContent = state.company.name || "—";
      $("cAddressPrint").textContent = state.company.address || "—";
      $("cContactPrint").textContent = [state.company.email, state.company.phone].filter(Boolean).join(" • ") || "—";
      $("cRegVatPrint").textContent = state.company.regVat || "—";

      $("sNamePrint").textContent = state.supplier.name || "—";
      $("sAddressPrint").textContent = state.supplier.address || "—";
      const sContact = [state.supplier.contact, state.supplier.email, state.supplier.phone].filter(Boolean).join(" • ");
      $("sContactPrint").textContent = sContact || "—";
      const sVatLine = [state.supplier.vat ? ("VAT: "+state.supplier.vat) : "", state.supplier.code ? ("Code: "+state.supplier.code) : ""].filter(Boolean).join(" • ");
      $("sVatPrint").textContent = sVatLine || "—";

      $("deliveryMethodPrint").textContent = state.meta.deliveryMethod || "—";
      $("deliveryAddressPrint").textContent = state.meta.deliveryAddress || "—";

      $("notesPrint").textContent = state.notes || "—";
      $("termsBodyPrint").textContent = state.terms || "—";

      $("reqByPrint").textContent = state.approvals.requestedBy || "—";
      $("appByPrint").textContent = state.approvals.approvedBy || "—";

      $("vatModePrint").textContent = state.meta.vatMode || "—";

      // Items for print
      const pb = $("printItemsBody");
      pb.innerHTML = "";
      const cur = state.meta.currency;
      const vatMode = state.meta.vatMode;
      const vatRate = clampNumber(state.meta.vatRate,0,100,15)/100;

      state.items.forEach((it, idx) => {
        const qty = clampNumber(it.qty,0,1e9,0);
        const unit = clampNumber(it.unitPrice,0,1e12,0);
        const base = qty * unit;

        let lineVat = 0, lineEx = base, total = base;
        if(vatMode === "none" || !it.vat){
          lineVat = 0; lineEx = base; total = base;
        }else if(vatMode === "exclusive"){
          lineVat = base * vatRate; lineEx = base; total = lineEx + lineVat;
        }else{
          const ex = base / (1+vatRate); lineVat = base - ex; lineEx = ex; total = base;
        }

        const tr = document.createElement("tr");
        tr.className = "border-b";
        tr.innerHTML = `
          <td class="py-2 pr-2">${idx+1}</td>
          <td class="py-2 pr-2">${escapeHtml(it.description || "")}</td>
          <td class="py-2 pr-2 mono">${escapeHtml(it.sku || "")}</td>
          <td class="py-2 pr-2">${qty}</td>
          <td class="py-2 pr-2 mono">${money(unit, cur)}</td>
          <td class="py-2 pr-2">${(vatMode==="none" || !it.vat) ? "No" : "Yes"}</td>
          <td class="py-2 pr-2 text-right mono font-bold">${money(total, cur)}</td>
        `;
        pb.appendChild(tr);
      });
    }

    // Autosave
    function setupAutosave(){
      autosave(); // initial
      // Periodic save in case of non-input changes
      setInterval(() => autosave(false), 5000);
    }

    function autosave(showToast=false){
      try{
        localStorage.setItem(KEY_AUTOSAVE, JSON.stringify(state));
        $("autosaveTime").textContent = new Date().toLocaleTimeString("en-ZA", {hour:"2-digit", minute:"2-digit", second:"2-digit"});
        $("autosaveStatus").textContent = "On";
        if(showToast) toast("Saved.");
      }catch(e){
        $("autosaveStatus").textContent = "Off (storage blocked)";
      }
    }

    // New PO
    function newPO(){
      // Create new number (increment)
      state.meta.poNumber = nextPONumber(true);
      // Reset only PO details + items + notes/terms (keep company/supplier optionally)
      state.meta.status = "Draft";
      $("poStatus").value = "Draft";
      setStatus("Draft", true);

      // Reset items and commercial fields
      state.items = [newItem()];
      state.meta.poRef = "";
      state.meta.requiredBy = "";
      state.meta.globalDiscount = 0;
      state.meta.shipping = 0;
      state.meta.vatMode = "exclusive";
      state.meta.vatRate = 15;
      state.notes = "";
      state.terms = "";
      state.approvals.requestedBy = "";
      state.approvals.approvedBy = "";

      renderAll();
      autosave(true);
      toast("New PO created: " + state.meta.poNumber);
    }

    // Reset form but keep templates
    function resetFormKeepTemplates(){
      if(!confirm("Reset this PO (templates are kept)?")) return;
      // Keep sequence and templates, reset autosave state
      const keepTemplates = localStorage.getItem(KEY_TEMPLATES);
      const keepSeq = localStorage.getItem(KEY_POSEQ);
      const keepTheme = localStorage.getItem(KEY_THEME);

      localStorage.removeItem(KEY_AUTOSAVE);
      if(keepTemplates !== null) localStorage.setItem(KEY_TEMPLATES, keepTemplates);
      if(keepSeq !== null) localStorage.setItem(KEY_POSEQ, keepSeq);
      if(keepTheme !== null) localStorage.setItem(KEY_THEME, keepTheme);

      // Reinit state
      state = {
        meta: {
          poNumber: nextPONumber(false),
          status: "Draft",
          priority: "Normal",
          currency: "ZAR",
          poDate: new Date().toISOString().slice(0,10),
          requiredBy: "",
          poRef: "",
          deliveryMethod: "Delivery",
          deliveryAddress: "",
          paymentTerms: "30 Days",
          vatMode: "exclusive",
          vatRate: 15,
          globalDiscount: 0,
          shipping: 0,
        },
        company: { name:"", regVat:"", address:"", email:"", phone:"", logoDataUrl:"" },
        supplier: { name:"", contact:"", email:"", phone:"", address:"", vat:"", code:"" },
        approvals: { requestedBy:"", approvedBy:"" },
        notes: "",
        terms: "",
        items: [newItem()]
      };

      renderAll();
      autosave(true);
      toast("Reset complete.");
    }

    // Status handling
    function setStatus(status, silent=false){
      state.meta.status = status;
      $("poStatus").value = status;

      const badge = $("statusBadge");
      badge.className = "badge";

      if(status === "Draft"){
        badge.classList.add("badge-draft");
        badge.innerHTML = '<i class="fa-solid fa-pen-to-square"></i> Draft';
      }else if(status === "Issued"){
        badge.classList.add("badge-issued");
        badge.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Issued';
      }else if(status === "Approved"){
        badge.classList.add("badge-approved");
        badge.innerHTML = '<i class="fa-solid fa-circle-check"></i> Approved';
      }else{
        badge.classList.add("badge-cancelled");
        badge.innerHTML = '<i class="fa-solid fa-ban"></i> Cancelled';
      }

      // Soft-lock editing when Approved
      const lock = (status === "Approved");
      document.querySelectorAll("#itemsBody input, #itemsBody select, #vatMode, #vatRate, #globalDiscount, #shipping").forEach(el=>{
        el.disabled = lock;
        if(lock) el.classList.add("opacity-60");
        else el.classList.remove("opacity-60");
      });

      if(!silent){
        recalc(); autosave(true); syncPrint();
        toast("Status set to " + status);
      }
    }

    // Demo fillers
    function fillDemoCompany(){
      state.company.name = "Skunkworks (Pty) Ltd";
      state.company.regVat = "Reg: 20XX/XXXXX/07 • VAT: 4XXXXXXXXX";
      state.company.address = "Johannesburg, Gauteng\nSouth Africa";
      state.company.email = "accounts@skunkworks.africa";
      state.company.phone = "+27 83 380 7950";
      renderAll();
      autosave(true);
      toast("Demo company filled.");
    }

    function fillDemoSupplier(){
      state.supplier.name = "Example Supplier (Pty) Ltd";
      state.supplier.contact = "Sales Desk";
      state.supplier.email = "sales@example-supplier.co.za";
      state.supplier.phone = "+27 11 000 0000";
      state.supplier.address = "1 Supplier Road\nSandton\nJohannesburg\n2196";
      state.supplier.vat = "4XXXXXXXXX";
      state.supplier.code = "SUP-001";
      renderAll();
      autosave(true);
      toast("Demo supplier filled.");
    }

    function addDemoItems(){
      const items = [
        {description:"Microsoft 365 Business Premium – Monthly (12 months)", sku:"M365-BP-M", qty:25, unitPrice: 626.09, vat:true},
        {description:"Professional Services – Setup & Onboarding", sku:"PS-ONBOARD", qty:1, unitPrice: 2500.00, vat:true},
        {description:"Delivery / Courier", sku:"SHIP", qty:1, unitPrice: 0.00, vat:false},
      ].map(x => ({id:cryptoRandomId(), ...x}));
      state.items = items;
      renderItems();
      recalc();
      autosave(true);
      toast("Demo items added.");
    }

    // CSV import/export
    function handleCSVImport(file){
      if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const text = String(reader.result || "");
          const parsed = parseCSV(text);
          if(!parsed.length){
            toast("No rows found in CSV.");
            return;
          }
          // Expect columns: Description,Qty,UnitPrice,VAT,SKU (SKU optional)
          const rows = parsed.filter(r => r.some(c => String(c||"").trim() !== ""));
          const imported = rows.map(r => {
            const desc = (r[0]||"").trim();
            const qty = clampNumber(r[1], 0, 1e9, 1);
            const unitPrice = clampNumber(r[2], 0, 1e12, 0);
            const vat = String(r[3]||"yes").trim().toLowerCase();
            const sku = (r[4]||"").trim();
            return {
              id: cryptoRandomId(),
              description: desc,
              sku,
              qty,
              unitPrice,
              vat: !(vat === "no" || vat === "false" || vat === "0")
            };
          });
          state.items = imported.length ? imported : [newItem()];
          renderItems();
          recalc();
          autosave(true);
          toast("CSV imported: " + imported.length + " items.");
        }catch(e){
          toast("CSV import failed.");
        }finally{
          $("csvInput").value = "";
        }
      };
      reader.readAsText(file);
    }

    // Minimal CSV parser (handles quoted values)
    function parseCSV(text){
      const rows = [];
      let row = [];
      let cur = "";
      let inQuotes = false;

      for(let i=0;i<text.length;i++){
        const ch = text[i];
        const next = text[i+1];

        if(ch === '"' && inQuotes && next === '"'){
          cur += '"'; i++; continue;
        }
        if(ch === '"'){
          inQuotes = !inQuotes;
          continue;
        }
        if(ch === "," && !inQuotes){
          row.push(cur); cur=""; continue;
        }
        if((ch === "\n" || ch === "\r") && !inQuotes){
          if(ch === "\r" && next === "\n") i++;
          row.push(cur); cur="";
          // skip empty trailing row
          if(row.length && !(row.length===1 && row[0].trim()==="")) rows.push(row);
          row = [];
          continue;
        }
        cur += ch;
      }
      // last
      if(cur.length || row.length){
        row.push(cur);
        if(!(row.length===1 && row[0].trim()==="")) rows.push(row);
      }
      return rows;
    }

    function itemsToCSV(s){
      const header = ["Description","Qty","UnitPrice","VAT","SKU"];
      const lines = [header.join(",")];
      (s.items||[]).forEach(it => {
        const row = [
          csvEscape(it.description||""),
          csvEscape(String(it.qty ?? 0)),
          csvEscape(String(it.unitPrice ?? 0)),
          csvEscape(it.vat ? "yes" : "no"),
          csvEscape(it.sku||"")
        ];
        lines.push(row.join(","));
      });
      return lines.join("\n");
    }

    function csvEscape(v){
      const s = String(v ?? "");
      if(/[",\n\r]/.test(s)) return `"${s.replaceAll('"','""')}"`;
      return s;
    }

    function downloadCSV(filename, csvText){
      const blob = new Blob([csvText], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("CSV downloaded.");
    }

    function downloadJSON(filename, obj){
      const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("JSON downloaded.");
    }

    function getExportName(){
      const num = state.meta.poNumber || "PO";
      const sup = (state.supplier.name || "Supplier").replace(/\s+/g,"-").replace(/[^\w\-]/g,"").slice(0,30);
      return `${num}-${sup}`;
    }

    // Email + clipboard
    function emailSupplier(){
      syncPrint();
      const to = state.supplier.email || "";
      const subject = encodeURIComponent(`Purchase Order ${state.meta.poNumber}`);
      const lines = buildSummaryLines();
      const body = encodeURIComponent(lines.join("\n"));
      const href = `mailto:${encodeURIComponent(to)}?subject=${subject}&body=${body}`;
      window.location.href = href;
    }

    function buildSummaryLines(){
      const cur = state.meta.currency;
      const comp = state.company.name || "Buyer";
      const sup = state.supplier.name || "Supplier";
      const totals = state._computed || {};
      const lines = [];
      lines.push(`PURCHASE ORDER: ${state.meta.poNumber}`);
      lines.push(`Status: ${state.meta.status} • Priority: ${state.meta.priority}`);
      lines.push(`Buyer: ${comp}`);
      lines.push(`Supplier: ${sup}`);
      lines.push(`PO Date: ${fmtDate(state.meta.poDate)} • Required By: ${fmtDate(state.meta.requiredBy)}`);
      if(state.meta.poRef) lines.push(`Reference: ${state.meta.poRef}`);
      lines.push("");
      lines.push("ITEMS:");
      state.items.forEach((it, idx) => {
        const q = Number(it.qty||0);
        const u = Number(it.unitPrice||0);
        lines.push(`${idx+1}. ${it.description || "(no description)"}${it.sku ? " (SKU: "+it.sku+")":""} — Qty ${q} @ ${money(u, cur)} — VAT ${it.vat ? "Yes":"No"}`);
      });
      lines.push("");
      lines.push(`Subtotal: ${money(totals.subtotal ?? 0, cur)}`);
      lines.push(`Discount: ${money(totals.discount ?? 0, cur)}`);
      lines.push(`VAT: ${money(totals.vatTotal ?? 0, cur)}`);
      lines.push(`Shipping: ${money(totals.shipping ?? 0, cur)}`);
      lines.push(`Grand Total: ${money(totals.grand ?? 0, cur)}`);
      lines.push("");
      lines.push(`Payment Terms: ${state.meta.paymentTerms}`);
      lines.push(`Delivery: ${state.meta.deliveryMethod}`);
      if(state.meta.deliveryAddress) lines.push(`Delivery Address:\n${state.meta.deliveryAddress}`);
      if(state.notes) lines.push(`\nNotes:\n${state.notes}`);
      return lines;
    }

    async function copySummary(){
      const text = buildSummaryLines().join("\n");
      try{
        await navigator.clipboard.writeText(text);
        toast("PO summary copied.");
      }catch(e){
        // fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        toast("PO summary copied.");
      }
    }

    // Templates modal
    let modalMode = "save";
    function openTemplateModal(mode){
      modalMode = mode;
      $("templateTitle").textContent = (mode === "save") ? "Save Template" : "Load Template";
      $("templateName").classList.toggle("hidden", mode !== "save");
      $("btnConfirmSave").classList.toggle("hidden", mode !== "save");
      renderTemplatesList();
      showModal();
    }

    function showModal(){
      $("modalBackdrop").classList.remove("hidden");
      $("modalBackdrop").classList.add("flex");
      $("templateModal").classList.remove("hidden");
      $("templateModal").classList.add("flex");
      $("modalBackdrop").setAttribute("aria-hidden","false");
      $("templateName").value = "";
      $("templateName").focus();
    }

    function closeTemplateModal(){
      $("modalBackdrop").classList.add("hidden");
      $("modalBackdrop").classList.remove("flex");
      $("templateModal").classList.add("hidden");
      $("templateModal").classList.remove("flex");
      $("modalBackdrop").setAttribute("aria-hidden","true");
    }

    function getTemplates(){
      try{
        return JSON.parse(localStorage.getItem(KEY_TEMPLATES) || "[]");
      }catch(e){ return []; }
    }

    function setTemplates(list){
      localStorage.setItem(KEY_TEMPLATES, JSON.stringify(list));
    }

    function saveTemplateFromModal(){
      const name = $("templateName").value.trim();
      if(!name){
        toast("Template name required.");
        return;
      }
      const templates = getTemplates();
      const now = new Date().toISOString();
      const payload = JSON.parse(JSON.stringify(state));
      // Keep current PO number but templates should not force PO seq - still okay
      const entry = { id: cryptoRandomId(), name, createdAt: now, data: payload };
      templates.unshift(entry);
      setTemplates(templates);
      renderTemplatesList();
      autosave(true);
      toast("Template saved.");
    }

    function renderTemplatesList(){
      const wrap = $("templatesList");
      const templates = getTemplates();
      wrap.innerHTML = "";

      if(!templates.length){
        wrap.innerHTML = `<div class="p-4 text-sm" style="color:var(--muted)">No templates yet.</div>`;
        return;
      }

      templates.forEach(t => {
        const row = document.createElement("div");
        row.className = "p-3 border-t flex items-center gap-3";
        row.style.borderColor = "var(--border)";
        row.innerHTML = `
          <div class="flex-1">
            <div class="font-extrabold">${escapeHtml(t.name)}</div>
            <div class="text-xs" style="color:var(--muted)">${new Date(t.createdAt).toLocaleString("en-ZA")}</div>
          </div>
          <div class="flex gap-2">
            <button class="btn btn-outline !py-2 !px-3" data-act="load" data-id="${t.id}">
              <i class="fa-solid fa-arrow-up-right-from-square"></i> ${modalMode==="load" ? "Load" : "Preview"}
            </button>
            <button class="btn btn-danger !py-2 !px-3" data-act="del" data-id="${t.id}">
              <i class="fa-solid fa-trash"></i>
            </button>
          </div>
        `;
        wrap.appendChild(row);
      });

      wrap.querySelectorAll("button[data-act]").forEach(btn => {
        btn.addEventListener("click", () => {
          const act = btn.getAttribute("data-act");
          const id = btn.getAttribute("data-id");
          const templates = getTemplates();
          const entry = templates.find(x => x.id === id);
          if(!entry) return;

          if(act === "del"){
            if(!confirm(`Delete template "${entry.name}"?`)) return;
            const next = templates.filter(x => x.id !== id);
            setTemplates(next);
            renderTemplatesList();
            toast("Template deleted.");
            return;
          }

          if(act === "load"){
            // Load template data into current state
            const loaded = normalizeState(entry.data || {});
            // Keep current PO number unless user wants to overwrite — best practice: keep current PO number
            loaded.meta.poNumber = state.meta.poNumber;
            state = loaded;

            renderAll();
            autosave(true);
            closeTemplateModal();
            toast("Template loaded.");
          }
        });
      });
    }

    function exportTemplates(){
      const templates = getTemplates();
      downloadJSON("easy-po-templates.json", templates);
    }

    function importTemplatesFile(file){
      if(!file) return;
      const r = new FileReader();
      r.onload = () => {
        try{
          const parsed = JSON.parse(String(r.result || "[]"));
          if(!Array.isArray(parsed)) throw new Error("Invalid");
          const existing = getTemplates();
          // Merge, prefer new import first
          const merged = [...parsed, ...existing].slice(0, 200);
          setTemplates(merged);
          renderTemplatesList();
          toast("Templates imported.");
        }catch(e){
          toast("Template import failed.");
        }finally{
          $("templatesImport").value = "";
        }
      };
      r.readAsText(file);
    }

    function deleteAllTemplates(){
      if(!confirm("Delete ALL templates? This cannot be undone.")) return;
      setTemplates([]);
      renderTemplatesList();
      toast("All templates deleted.");
    }

    // Theme
    function toggleTheme(){
      const cur = document.body.getAttribute("data-theme") || "light";
      setTheme(cur === "light" ? "dark" : "light");
    }

    function setTheme(theme){
      document.body.setAttribute("data-theme", theme);
      localStorage.setItem(KEY_THEME, theme);
      $("btnTheme").innerHTML = theme === "dark"
        ? '<i class="fa-solid fa-sun"></i> Theme'
        : '<i class="fa-solid fa-moon"></i> Theme';
    }

    // Toast (simple)
    let toastTimer = null;
    function toast(msg){
      clearTimeout(toastTimer);
      let el = document.getElementById("toast");
      if(!el){
        el = document.createElement("div");
        el.id = "toast";
        el.className = "fixed bottom-4 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-xl text-white font-extrabold shadow-lg no-print";
        el.style.background = "rgba(2,6,23,.9)";
        el.style.zIndex = "50";
        document.body.appendChild(el);
      }
      el.textContent = msg;
      el.style.opacity = "1";
      toastTimer = setTimeout(() => { el.style.opacity = "0"; }, 2200);
    }

    // Start
    init();
  </script>
</body>
</html>
