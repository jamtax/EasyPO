<!DOCTYPE html>
<html lang="en-ZA">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Easy Inventory</title>
  <meta name="description" content="Track stock levels, stock movements, and inventory value with Easy Inventory." />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">

  <style>
    :root { --primary:#2563eb; --danger:#dc2626; --success:#16a34a; --muted:#64748b; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:14px; box-shadow:0 10px 25px rgba(2,6,23,.05); }
    .btn { display:inline-flex; align-items:center; justify-content:center; gap:.5rem; padding:.6rem 1rem; border-radius:10px; font-weight:800; border:1px solid transparent; transition:.15s; }
    .btn:hover { transform: translateY(-1px); }
    .btn-primary { background: var(--primary); color:#fff; }
    .btn-primary:hover { filter: brightness(.95); }
    .btn-outline { background:#fff; border-color:#e5e7eb; color:#0f172a; }
    .btn-outline:hover { background:#f8fafc; }
    .btn-danger { background: var(--danger); color:#fff; }
    .btn-success { background: var(--success); color:#fff; }
    .pill { display:inline-flex; align-items:center; padding:.2rem .6rem; border-radius:999px; font-weight:800; font-size:.75rem; }
    .pill-low { background:#fee2e2; color:#991b1b; }
    .pill-ok { background:#dcfce7; color:#166534; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .toast { position: fixed; right: 16px; bottom: 16px; z-index: 9999; }
    .toast > div { background: rgba(2,6,23,.92); color: #fff; border-radius: 12px; padding: 12px 14px; max-width: 360px; }
    .modal-backdrop { background: rgba(2,6,23,.65); }
    .responsive-table { overflow-x:auto; -webkit-overflow-scrolling: touch; }

    @media print {
      .no-print { display:none !important; }
      body { background:#fff !important; }
      .card { box-shadow:none !important; border:none !important; }
      table { page-break-inside:auto; }
      tr { page-break-inside:avoid; page-break-after:auto; }
      thead { display:table-header-group; }
      tfoot { display:table-footer-group; }
    }
  </style>
</head>

<body class="bg-gray-100 min-h-screen">

  <!-- NAV -->
  <nav class="bg-blue-600 text-white py-4 no-print">
    <div class="container mx-auto px-4 flex flex-wrap items-center gap-4">
      <a data-safe-link href="index.html" class="font-bold text-xl mr-4">Easy&nbsp;Suite</a>
      <a data-safe-link href="easy-quote.html" class="hover:underline">Quote</a>
      <a data-safe-link href="easy-invoice.html" class="hover:underline">Invoice</a>
      <a data-safe-link href="easy-purchase-order.html" class="hover:underline">Purchase&nbsp;Order</a>
      <a data-safe-link href="easy-sales-order.html" class="hover:underline">Sales&nbsp;Order</a>
      <a data-safe-link href="easy-reciept.html" class="hover:underline">Receipt</a>
      <a data-safe-link href="easy-statement.html" class="hover:underline">Statement</a>
      <a data-safe-link href="easy-job-card.html" class="hover:underline">Job&nbsp;Card</a>
      <a data-safe-link href="easy-payroll.html" class="hover:underline">Payroll</a>
      <a data-safe-link href="easy-inventory.html" class="underline font-extrabold">Inventory</a>
      <a data-safe-link href="easy-crm.html" class="hover:underline">CRM</a>
    </div>
  </nav>

  <main class="container mx-auto px-4 py-8">

    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-6">
      <div>
        <h1 class="text-3xl font-extrabold text-slate-900">Easy Inventory</h1>
        <p class="text-sm text-slate-600 mt-1">
          Product master + stock movements + valuation. Works offline (LocalStorage).
        </p>
      </div>

      <div class="flex flex-wrap gap-2 no-print">
        <button class="btn btn-outline" id="btnSeed">Seed Demo Data</button>
        <button class="btn btn-outline" id="btnImport">Import CSV</button>
        <input class="hidden" type="file" id="csvFile" accept=".csv" />
        <button class="btn btn-outline" id="btnExport">Export CSV</button>
        <button class="btn btn-outline" id="btnPrint">Print Report</button>
        <button class="btn btn-primary" id="btnAdd">Add Product</button>
      </div>
    </div>

    <!-- SUMMARY -->
    <section class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="card p-5">
        <div class="text-xs text-slate-500 font-black">PRODUCTS</div>
        <div id="kpiProducts" class="text-2xl font-black text-blue-700 mt-1">0</div>
      </div>
      <div class="card p-5">
        <div class="text-xs text-slate-500 font-black">TOTAL UNITS</div>
        <div id="kpiUnits" class="text-2xl font-black text-emerald-700 mt-1">0</div>
      </div>
      <div class="card p-5">
        <div class="text-xs text-slate-500 font-black">COST VALUE</div>
        <div id="kpiCost" class="text-2xl font-black text-indigo-700 mt-1">R0.00</div>
      </div>
      <div class="card p-5">
        <div class="text-xs text-slate-500 font-black">LOW STOCK</div>
        <div id="kpiLow" class="text-2xl font-black text-rose-700 mt-1">0</div>
      </div>
    </section>

    <!-- FILTERS -->
    <section class="card p-4 mb-6 no-print">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
        <div>
          <label class="text-xs font-black text-slate-600">Search</label>
          <input id="q" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="SKU, name, category..." />
        </div>
        <div>
          <label class="text-xs font-black text-slate-600">Category</label>
          <select id="cat" class="w-full border border-gray-200 rounded-lg px-3 py-2">
            <option value="">All categories</option>
          </select>
        </div>
        <div>
          <label class="text-xs font-black text-slate-600">Low stock threshold</label>
          <input id="threshold" type="number" min="0" step="1" class="w-full border border-gray-200 rounded-lg px-3 py-2" value="5" />
        </div>
        <div class="flex items-end gap-2">
          <button class="btn btn-outline w-full" id="btnClear">Clear Filters</button>
        </div>
      </div>
    </section>

    <!-- TABLE -->
    <section class="card p-0 overflow-hidden">
      <div class="responsive-table">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-50 text-slate-600">
            <tr>
              <th class="p-3 text-left">SKU</th>
              <th class="p-3 text-left">Name</th>
              <th class="p-3 text-left">Category</th>
              <th class="p-3 text-right">Cost</th>
              <th class="p-3 text-right">Price</th>
              <th class="p-3 text-right">Stock</th>
              <th class="p-3 text-right">Value (Cost)</th>
              <th class="p-3 text-left">Status</th>
              <th class="p-3 text-center no-print">Actions</th>
            </tr>
          </thead>
          <tbody id="rows" class="divide-y divide-gray-100"></tbody>
        </table>
      </div>

      <div class="p-4 text-xs text-slate-500">
        Tip: Use <span class="mono">Adjust</span> for Stock In/Out to keep a movement log.
      </div>
    </section>

    <!-- MOVEMENTS -->
    <section class="card p-5 mt-6">
      <div class="flex items-center justify-between gap-3 mb-3">
        <div>
          <h2 class="text-lg font-black text-slate-900">Stock Movements</h2>
          <p class="text-xs text-slate-500">Last 50 movements (local)</p>
        </div>
        <button class="btn btn-outline no-print" id="btnClearMoves">Clear Movements</button>
      </div>

      <div class="responsive-table">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-50 text-slate-600">
            <tr>
              <th class="p-3 text-left">Time</th>
              <th class="p-3 text-left">SKU</th>
              <th class="p-3 text-left">Type</th>
              <th class="p-3 text-right">Qty</th>
              <th class="p-3 text-left">Note</th>
            </tr>
          </thead>
          <tbody id="moves" class="divide-y divide-gray-100"></tbody>
        </table>
      </div>
    </section>

  </main>

  <!-- ADD/EDIT MODAL -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center p-4 z-50 no-print">
    <div class="modal-backdrop absolute inset-0"></div>
    <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-2xl p-5">
      <div class="flex items-start justify-between gap-3">
        <div>
          <h3 id="modalTitle" class="text-xl font-black text-slate-900">Add Product</h3>
          <p class="text-xs text-slate-500">SKU must be unique.</p>
        </div>
        <button id="btnClose" class="text-slate-500 hover:text-slate-900 text-xl font-black">×</button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">
        <div>
          <label class="text-xs font-black text-slate-600">SKU</label>
          <input id="fSku" class="w-full border border-gray-200 rounded-lg px-3 py-2 mono" placeholder="SKU001" />
        </div>
        <div>
          <label class="text-xs font-black text-slate-600">Category</label>
          <input id="fCat" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Hardware / Licenses / Services" />
        </div>

        <div class="md:col-span-2">
          <label class="text-xs font-black text-slate-600">Name</label>
          <input id="fName" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Product name" />
        </div>

        <div>
          <label class="text-xs font-black text-slate-600">Cost Price</label>
          <input id="fCost" type="number" min="0" step="0.01" class="w-full border border-gray-200 rounded-lg px-3 py-2" />
        </div>
        <div>
          <label class="text-xs font-black text-slate-600">Selling Price</label>
          <input id="fPrice" type="number" min="0" step="0.01" class="w-full border border-gray-200 rounded-lg px-3 py-2" />
        </div>

        <div>
          <label class="text-xs font-black text-slate-600">Opening Stock</label>
          <input id="fStock" type="number" min="0" step="1" class="w-full border border-gray-200 rounded-lg px-3 py-2" />
        </div>
        <div>
          <label class="text-xs font-black text-slate-600">Reorder Level</label>
          <input id="fReorder" type="number" min="0" step="1" class="w-full border border-gray-200 rounded-lg px-3 py-2" value="5" />
        </div>
      </div>

      <div class="flex flex-wrap justify-end gap-2 mt-5">
        <button class="btn btn-outline" id="btnCancel">Cancel</button>
        <button class="btn btn-primary" id="btnSave">Save</button>
      </div>
    </div>
  </div>

  <!-- ADJUST MODAL -->
  <div id="adjModal" class="fixed inset-0 hidden items-center justify-center p-4 z-50 no-print">
    <div class="modal-backdrop absolute inset-0"></div>
    <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-xl p-5">
      <div class="flex items-start justify-between gap-3">
        <div>
          <h3 class="text-xl font-black text-slate-900">Adjust Stock</h3>
          <p id="adjSku" class="text-xs text-slate-500 mono"></p>
        </div>
        <button id="adjClose" class="text-slate-500 hover:text-slate-900 text-xl font-black">×</button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">
        <div>
          <label class="text-xs font-black text-slate-600">Type</label>
          <select id="adjType" class="w-full border border-gray-200 rounded-lg px-3 py-2">
            <option value="IN">Stock In</option>
            <option value="OUT">Stock Out</option>
          </select>
        </div>
        <div>
          <label class="text-xs font-black text-slate-600">Quantity</label>
          <input id="adjQty" type="number" min="1" step="1" class="w-full border border-gray-200 rounded-lg px-3 py-2" value="1" />
        </div>
        <div class="md:col-span-2">
          <label class="text-xs font-black text-slate-600">Note (optional)</label>
          <input id="adjNote" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="GRN #, Invoice #, reason..." />
        </div>
      </div>

      <div class="flex flex-wrap justify-end gap-2 mt-5">
        <button class="btn btn-outline" id="adjCancel">Cancel</button>
        <button class="btn btn-success" id="adjApply">Apply</button>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div class="toast hidden" id="toast"><div id="toastMsg"></div></div>

<script>
/**
 * Multi-page navigation depends on correct relative paths.
 * For files in the same folder, `href="file.html"` is the correct approach. :contentReference[oaicite:3]{index=3}
 */

const STORE_KEY = "easy.inventory.v2";
const MOVES_KEY = "easy.inventory.moves.v1";

const $ = (id) => document.getElementById(id);

function toast(msg){
  $("toastMsg").textContent = msg;
  $("toast").classList.remove("hidden");
  setTimeout(()=> $("toast").classList.add("hidden"), 2800);
}

function money(n){
  const x = Number(n || 0);
  return "R" + x.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

function nowISO(){
  return new Date().toISOString();
}

function load(){
  try { return JSON.parse(localStorage.getItem(STORE_KEY) || "[]"); }
  catch { return []; }
}
function save(data){
  localStorage.setItem(STORE_KEY, JSON.stringify(data));
}
function loadMoves(){
  try { return JSON.parse(localStorage.getItem(MOVES_KEY) || "[]"); }
  catch { return []; }
}
function saveMoves(m){
  localStorage.setItem(MOVES_KEY, JSON.stringify(m.slice(0,50)));
}

let inventory = load();
let movements = loadMoves();

function normalizeSku(s){ return String(s||"").trim().toUpperCase(); }

function rebuildCategoryOptions(){
  const cats = Array.from(new Set(inventory.map(x => (x.category||"").trim()).filter(Boolean))).sort();
  const sel = $("cat");
  const cur = sel.value || "";
  sel.innerHTML = `<option value="">All categories</option>` + cats.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
  sel.value = cats.includes(cur) ? cur : "";
}

function escapeHtml(str){
  return String(str || "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
  }[m]));
}

function computeKPIs(){
  const threshold = Number($("threshold").value || 0);
  const products = inventory.length;
  const totalUnits = inventory.reduce((a,x)=> a + Number(x.stock||0), 0);
  const costValue = inventory.reduce((a,x)=> a + (Number(x.stock||0)*Number(x.cost||0)), 0);
  const low = inventory.filter(x => Number(x.stock||0) <= Number(x.reorder||threshold)).length;

  $("kpiProducts").textContent = String(products);
  $("kpiUnits").textContent = String(totalUnits);
  $("kpiCost").textContent = money(costValue);
  $("kpiLow").textContent = String(low);
}

function render(){
  rebuildCategoryOptions();
  computeKPIs();

  const q = ($("q").value || "").trim().toLowerCase();
  const cat = ($("cat").value || "").trim().toLowerCase();
  const threshold = Number($("threshold").value || 0);

  const rows = $("rows");
  rows.innerHTML = "";

  const filtered = inventory.filter(x => {
    const hay = `${x.sku} ${x.name} ${x.category}`.toLowerCase();
    if(q && !hay.includes(q)) return false;
    if(cat && String(x.category||"").toLowerCase() !== cat) return false;
    return true;
  });

  filtered.sort((a,b)=> String(a.sku).localeCompare(String(b.sku)));

  if(!filtered.length){
    rows.innerHTML = `<tr><td colspan="9" class="p-6 text-center text-slate-500">No products found.</td></tr>`;
    return;
  }

  filtered.forEach(item => {
    const value = Number(item.stock||0) * Number(item.cost||0);
    const isLow = Number(item.stock||0) <= Number(item.reorder||threshold);

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="p-3 mono">${escapeHtml(item.sku)}</td>
      <td class="p-3">${escapeHtml(item.name)}</td>
      <td class="p-3">${escapeHtml(item.category || "")}</td>
      <td class="p-3 text-right mono">${money(item.cost)}</td>
      <td class="p-3 text-right mono">${money(item.price)}</td>
      <td class="p-3 text-right mono">${Number(item.stock||0)}</td>
      <td class="p-3 text-right mono">${money(value)}</td>
      <td class="p-3">
        ${isLow ? `<span class="pill pill-low">LOW</span>` : `<span class="pill pill-ok">OK</span>`}
      </td>
      <td class="p-3 text-center no-print">
        <div class="flex justify-center gap-2 flex-wrap">
          <button class="btn btn-outline" data-edit="${escapeHtml(item.sku)}">Edit</button>
          <button class="btn btn-outline" data-adjust="${escapeHtml(item.sku)}">Adjust</button>
          <button class="btn btn-danger" data-del="${escapeHtml(item.sku)}">Delete</button>
        </div>
      </td>
    `;
    rows.appendChild(tr);
  });

  // wire actions (delegated)
  rows.querySelectorAll("[data-edit]").forEach(b => b.addEventListener("click", () => openEdit(b.getAttribute("data-edit"))));
  rows.querySelectorAll("[data-adjust]").forEach(b => b.addEventListener("click", () => openAdjust(b.getAttribute("data-adjust"))));
  rows.querySelectorAll("[data-del]").forEach(b => b.addEventListener("click", () => removeSku(b.getAttribute("data-del"))));
}

function renderMoves(){
  const tb = $("moves");
  tb.innerHTML = "";
  const list = movements.slice(0,50);
  if(!list.length){
    tb.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-slate-500">No movements yet.</td></tr>`;
    return;
  }
  list.forEach(m => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="p-3 mono">${escapeHtml(new Date(m.ts).toLocaleString())}</td>
      <td class="p-3 mono">${escapeHtml(m.sku)}</td>
      <td class="p-3">${m.type === "IN" ? `<span class="pill pill-ok">IN</span>` : `<span class="pill pill-low">OUT</span>`}</td>
      <td class="p-3 text-right mono">${Number(m.qty||0)}</td>
      <td class="p-3">${escapeHtml(m.note||"")}</td>
    `;
    tb.appendChild(tr);
  });
}

function openModal(){
  $("modal").classList.remove("hidden");
  $("modal").classList.add("flex");
}
function closeModal(){
  $("modal").classList.add("hidden");
  $("modal").classList.remove("flex");
}
function openAdj(){
  $("adjModal").classList.remove("hidden");
  $("adjModal").classList.add("flex");
}
function closeAdj(){
  $("adjModal").classList.add("hidden");
  $("adjModal").classList.remove("flex");
}

let editMode = { on:false, sku:null };

function clearForm(){
  ["fSku","fCat","fName","fCost","fPrice","fStock","fReorder"].forEach(id => $(id).value = "");
  $("fReorder").value = "5";
}

function openAdd(){
  editMode = { on:false, sku:null };
  $("modalTitle").textContent = "Add Product";
  clearForm();
  $("fSku").disabled = false;
  openModal();
}

function openEdit(sku){
  const s = normalizeSku(sku);
  const item = inventory.find(x => x.sku === s);
  if(!item){ toast("Product not found: " + s); return; }

  editMode = { on:true, sku:s };
  $("modalTitle").textContent = "Edit Product";
  $("fSku").value = item.sku;
  $("fCat").value = item.category || "";
  $("fName").value = item.name || "";
  $("fCost").value = Number(item.cost||0);
  $("fPrice").value = Number(item.price||0);
  $("fStock").value = Number(item.stock||0);
  $("fReorder").value = Number(item.reorder||5);
  $("fSku").disabled = true;
  openModal();
}

function upsert(){
  const sku = normalizeSku($("fSku").value);
  const name = ($("fName").value || "").trim();
  const category = ($("fCat").value || "").trim();

  const cost = Number($("fCost").value || 0);
  const price = Number($("fPrice").value || 0);
  const stock = Math.max(0, Math.floor(Number($("fStock").value || 0)));
  const reorder = Math.max(0, Math.floor(Number($("fReorder").value || 0)));

  if(!sku){ toast("SKU is required."); return; }
  if(!name){ toast("Name is required."); return; }
  if(cost < 0 || price < 0){ toast("Prices must be >= 0."); return; }

  if(!editMode.on){
    if(inventory.some(x => x.sku === sku)){
      toast("SKU already exists: " + sku);
      return;
    }
    inventory.push({ sku, name, category, cost, price, stock, reorder });
    save(inventory);
    toast("Added: " + sku);
  } else {
    const i = inventory.findIndex(x => x.sku === editMode.sku);
    if(i < 0){ toast("Missing record for: " + editMode.sku); return; }
    inventory[i] = { ...inventory[i], name, category, cost, price, stock, reorder };
    save(inventory);
    toast("Updated: " + editMode.sku);
  }

  closeModal();
  render();
}

function removeSku(sku){
  const s = normalizeSku(sku);
  const idx = inventory.findIndex(x => x.sku === s);
  if(idx < 0){ toast("Not found: " + s); return; }
  if(!confirm("Delete product " + s + "?")) return;

  inventory.splice(idx, 1);
  save(inventory);
  toast("Deleted: " + s);
  render();
}

let adjTargetSku = null;

function openAdjust(sku){
  const s = normalizeSku(sku);
  const item = inventory.find(x => x.sku === s);
  if(!item){ toast("Product not found: " + s); return; }

  adjTargetSku = s;
  $("adjSku").textContent = s + " • Current stock: " + Number(item.stock||0);
  $("adjType").value = "IN";
  $("adjQty").value = "1";
  $("adjNote").value = "";
  openAdj();
}

function applyAdjust(){
  const s = adjTargetSku;
  const item = inventory.find(x => x.sku === s);
  if(!item){ toast("Product not found: " + s); return; }

  const type = $("adjType").value;
  const qty = Math.max(1, Math.floor(Number($("adjQty").value || 1)));
  const note = ($("adjNote").value || "").trim();

  if(type === "OUT" && qty > Number(item.stock||0)){
    toast("Cannot stock-out more than current stock.");
    return;
  }

  item.stock = Number(item.stock||0) + (type === "IN" ? qty : -qty);
  save(inventory);

  movements.unshift({ ts: nowISO(), sku: s, type, qty, note });
  saveMoves(movements);

  toast(`Adjusted ${s}: ${type} ${qty}`);
  closeAdj();
  render();
  renderMoves();
}

function exportCSV(){
  const header = ["SKU","Name","Category","Cost","Price","Stock","ReorderLevel"];
  const lines = inventory
    .slice()
    .sort((a,b)=> String(a.sku).localeCompare(String(b.sku)))
    .map(x => [
      x.sku, x.name, x.category||"", x.cost, x.price, x.stock, x.reorder
    ].map(v => `"${String(v ?? "").replaceAll('"','""')}"`).join(","));
  const csv = [header.join(","), ...lines].join("\n");

  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "easy-inventory.csv";
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); document.body.removeChild(a); }, 0);
}

function parseCSV(text){
  // Minimal CSV parser (handles quotes, commas in quotes)
  const rows = [];
  let i=0, field="", row=[], inQuotes=false;

  const pushField = () => { row.push(field); field=""; };
  const pushRow = () => { if(row.length) rows.push(row); row=[]; };

  while(i<text.length){
    const c = text[i];
    if(inQuotes){
      if(c === '"'){
        if(text[i+1] === '"'){ field += '"'; i++; }
        else inQuotes = false;
      } else field += c;
    } else {
      if(c === '"') inQuotes = true;
      else if(c === ',') pushField();
      else if(c === '\n'){ pushField(); pushRow(); }
      else if(c !== '\r') field += c;
    }
    i++;
  }
  pushField(); pushRow();
  return rows;
}

function importCSV(file){
  if(!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    const text = e.target.result || "";
    const rows = parseCSV(text).filter(r => r.join("").trim().length);

    if(!rows.length){ toast("CSV is empty."); return; }

    // Expect: SKU,Name,Category,Cost,Price,Stock,ReorderLevel
    let start = 0;
    const head = (rows[0][0]||"").toLowerCase();
    if(head.includes("sku")) start = 1;

    let imported = 0, updated = 0, skipped = 0;

    for(let r=start; r<rows.length; r++){
      const [skuRaw,name,category,cost,price,stock,reorder] = rows[r];
      const sku = normalizeSku(skuRaw);
      if(!sku || !String(name||"").trim()){ skipped++; continue; }

      const rec = {
        sku,
        name: String(name||"").trim(),
        category: String(category||"").trim(),
        cost: Number(cost||0),
        price: Number(price||0),
        stock: Math.max(0, Math.floor(Number(stock||0))),
        reorder: Math.max(0, Math.floor(Number(reorder||5)))
      };

      const idx = inventory.findIndex(x => x.sku === sku);
      if(idx >= 0){
        inventory[idx] = { ...inventory[idx], ...rec };
        updated++;
      } else {
        inventory.push(rec);
        imported++;
      }
    }

    save(inventory);
    toast(`Import done. New: ${imported}, Updated: ${updated}, Skipped: ${skipped}`);
    render();
  };
  reader.readAsText(file);
}

function seed(){
  if(!confirm("Seed demo data? This will ADD items (not overwrite).")) return;
  const demo = [
    { sku:"MS365-BUSPREM", name:"Microsoft 365 Business Premium (Monthly)", category:"Licenses", cost: 480, price: 720, stock: 25, reorder: 5 },
    { sku:"LENOVO-THINKPAD-14", name:"Lenovo ThinkPad 14\" (Example)", category:"Hardware", cost: 15000, price: 18900, stock: 3, reorder: 5 },
    { sku:"LABOUR-REMOTE-1H", name:"Remote Support (1 Hour)", category:"Services", cost: 0, price: 650, stock: 9999, reorder: 0 }
  ];
  demo.forEach(d => {
    if(!inventory.some(x => x.sku === d.sku)) inventory.push(d);
  });
  save(inventory);
  toast("Demo data added.");
  render();
}

function clearMoves(){
  if(!confirm("Clear movement log?")) return;
  movements = [];
  saveMoves(movements);
  renderMoves();
  toast("Movements cleared.");
}

/**
 * Safe link guard:
 * - In static hosting (GitHub Pages), navigation only works if the target file exists.
 * - This handler checks existence first; if missing, it shows a toast instead of a dead click.
 */
async function safeLinkHandler(e){
  const a = e.currentTarget;
  const href = a.getAttribute("href");
  if(!href || href.startsWith("#") || href.startsWith("http")) return;

  try{
    const res = await fetch(href, { method:"HEAD", cache:"no-store" });
    if(!res.ok) throw new Error("Missing");
    window.location.href = href;
  } catch {
    e.preventDefault();
    toast("Missing file: " + href + " (create it in the same folder).");
  }
}

function bind(){
  // links
  document.querySelectorAll("a[data-safe-link]").forEach(a => a.addEventListener("click", safeLinkHandler));

  // filters
  ["q","cat","threshold"].forEach(id => {
    $(id).addEventListener("input", render);
    $(id).addEventListener("change", render);
  });

  $("btnClear").addEventListener("click", () => {
    $("q").value = "";
    $("cat").value = "";
    render();
  });

  // top actions
  $("btnAdd").addEventListener("click", openAdd);
  $("btnSeed").addEventListener("click", seed);
  $("btnExport").addEventListener("click", exportCSV);
  $("btnPrint").addEventListener("click", () => window.print());

  $("btnImport").addEventListener("click", () => $("csvFile").click());
  $("csvFile").addEventListener("change", (e) => {
    importCSV(e.target.files[0]);
    e.target.value = "";
  });

  // modal buttons
  $("btnClose").addEventListener("click", closeModal);
  $("btnCancel").addEventListener("click", closeModal);
  $("btnSave").addEventListener("click", upsert);
  $("modal").addEventListener("click", (e) => { if(e.target === $("modal")) closeModal(); });

  // adjust modal
  $("adjClose").addEventListener("click", closeAdj);
  $("adjCancel").addEventListener("click", closeAdj);
  $("adjApply").addEventListener("click", applyAdjust);
  $("adjModal").addEventListener("click", (e) => { if(e.target === $("adjModal")) closeAdj(); });

  // moves
  $("btnClearMoves").addEventListener("click", clearMoves);
}

document.addEventListener("DOMContentLoaded", () => {
  bind();
  render();
  renderMoves();
});
</script>

</body>
</html>
