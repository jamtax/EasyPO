<!DOCTYPE html>
<html lang="en-ZA">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EasyJC – Job Card Manager</title>
  <meta name="description" content="Create and manage job cards for service and repair work. Track labour, parts and costs; preview and export summaries to PDF, Word, Excel or CSV." />

  <!-- Favicon (optional: put your icon file in the same folder or adjust path) -->
  <link rel="icon" href="icon.png" type="image/png">
  <link rel="apple-touch-icon" href="icon.png">

  <!-- Tailwind CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">

  <!-- External Libraries -->
  <!-- PDF generation library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <!-- Excel and file saver libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <!-- Word export library (docx.js) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.8.2/docx.js"></script>

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root{
      --primary:#2563eb;
      --primary2:#1d4ed8;
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --danger:#dc2626;
      --success:#16a34a;
      --warning:#f59e0b;
    }
    body{background:var(--bg); color:var(--text);}

    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:0 10px 25px rgba(2,6,23,.05);}
    .btn{display:inline-flex; align-items:center; justify-content:center; gap:.5rem; padding:.7rem 1rem; border-radius:10px; font-weight:700; transition: all .2s ease; border:1px solid transparent;}
    .btn:hover{transform:translateY(-1px);} 
    .btn-primary{background:var(--primary); color:#fff;}
    .btn-primary:hover{background:var(--primary2);} 
    .btn-outline{background:#fff; border-color:var(--border); color:var(--text);} 
    .btn-outline:hover{border-color:#cbd5e1; background:#f8fafc;} 
    .btn-danger{background:var(--danger); color:#fff;} 
    .btn-danger:hover{filter:brightness(.95);} 
    .btn-success{background:var(--success); color:#fff;} 
    .btn-success:hover{filter:brightness(.95);} 
    .badge{display:inline-flex; align-items:center; gap:.4rem; padding:.25rem .6rem; border-radius:999px; font-weight:800; font-size:.75rem;} 
    .badge-draft{background:#eef2ff; color:#3730a3;} 
    .badge-open{background:#ecfdf5; color:#065f46;} 
    .badge-progress{background:#fff7ed; color:#92400e;} 
    .badge-completed{background:#dcfce7; color:#166534;} 
    .badge-cancelled{background:#fee2e2; color:#991b1b;} 

    input:focus, textarea:focus, select:focus{
      outline:none!important;
      border-color: rgba(37, 99, 235, .8)!important;
      box-shadow:0 0 0 3px rgba(37,99,235,.15)!important;
    }

    .responsive-table {overflow-x:auto; -webkit-overflow-scrolling:touch;}
    .mono {font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    @media print {
      .no-print { display:none !important; }
      .print-only { display:block !important; }
      body { background:#fff !important; }
      .card { box-shadow:none !important; border:none !important; }
      .manual-print { max-width: 210mm; margin:0 auto; padding:0; }
      table { page-break-inside:auto; }
      tr { page-break-inside:avoid; page-break-after:auto; }
      thead { display:table-header-group; }
      tfoot { display:table-footer-group; }
    }
  </style>
</head>

<body class="min-h-screen flex flex-col">
  <nav class="bg-blue-600 text-white py-4 no-print">
  <div class="container mx-auto px-4 flex flex-wrap items-center gap-4">
    <a href="index.html" class="font-bold text-xl mr-4">Easy&nbsp;Suite</a>
    <a href="easy-quote.html" class="hover:underline">Quote</a>
    <a href="easy-invoice.html" class="hover:underline">Invoice</a>
    <a href="easy-purchase-order.html" class="hover:underline">Purchase&nbsp;Order</a>
    <a href="easy-sales-order.html" class="hover:underline">Sales&nbsp;Order</a>
    <a href="easy-receipt.html" class="hover:underline">Receipt</a>
    <a href="easy-statement.html" class="hover:underline">Statement</a>
    <a href="easy-job-card.html" class="underline font-semibold">Job&nbsp;Card</a>
    <a href="easy-payroll.html" class="hover:underline">Payroll</a>
    <a href="easy-inventory.html" class="hover:underline">Inventory</a>
    <a href="easy-crm.html" class="hover:underline">CRM</a>
  </div>
</nav>
  <!-- Header -->
  <header class="bg-white border-b border-gray-200 no-print">
    <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row gap-4 sm:gap-0 items-start sm:items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-xl bg-blue-600 text-white flex items-center justify-center font-black">JC</div>
        <div>
          <h1 class="text-2xl font-extrabold text-blue-700">EasyJC</h1>
          <p class="text-sm text-gray-500">Job Card Manager</p>
        </div>
      </div>

      <div class="flex flex-wrap items-center gap-2">
        <button class="btn btn-outline" id="btnSaveTemplate" title="Save current job card as a template">
          <i class="fa-solid fa-floppy-disk"></i> Save
        </button>
        <button class="btn btn-outline" id="btnLoadTemplate" title="Load a saved template">
          <i class="fa-solid fa-folder-open"></i> Load
        </button>
        <button class="btn btn-outline" id="btnReset" title="Reset form (keeps templates)">
          <i class="fa-solid fa-rotate-left"></i> Reset
        </button>

        <span class="ml-0 sm:ml-4 text-xs text-gray-500">
          Autosave: <span class="font-bold" id="autosaveStatus">On</span>
        </span>
      </div>
    </div>
  </header>

  <main class="flex-grow container mx-auto px-4 py-6 md:py-8">

    <!-- Tips -->
    <div class="card p-4 mb-6 no-print">
      <div class="flex gap-3">
        <div class="text-blue-600 pt-0.5"><i class="fa-solid fa-circle-info"></i></div>
        <div class="flex-1">
          <h3 class="text-sm font-extrabold text-slate-900">Quick flow</h3>
          <div class="text-sm text-slate-600 mt-1">
            1) Fill company + customer details → 2) Describe job + assign staff → 3) Add labour & parts → 4) Preview → 5) Export PDF/Word/Excel/CSV → 6) Save as template.
          </div>
        </div>
      </div>
    </div>

    <!-- Top Grid: Parties + Job Meta -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
      <!-- Company (Issuer) -->
      <section class="card p-5">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-extrabold"><i class="fa-solid fa-building text-blue-600 mr-2"></i>Company</h2>
          <span class="text-xs text-slate-500">Issuer</span>
        </div>

        <div class="space-y-3">
          <div>
            <label class="block text-sm font-bold text-slate-700 mb-1">Company Logo</label>
            <input type="file" id="companyLogo" accept="image/*"
              class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-bold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
            <div id="companyLogoPreview" class="mt-2 h-14 flex items-center">
              <p class="text-sm text-slate-400">No logo uploaded</p>
            </div>
          </div>

          <div>
            <label class="block text-sm font-bold text-slate-700 mb-1">Company Name</label>
            <input id="companyName" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Your Company (Pty) Ltd">
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">VAT Number</label>
              <input id="companyVat" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="e.g., 4080...">
            </div>
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Reg/CK</label>
              <input id="companyReg" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Optional">
            </div>
          </div>

          <div>
            <label class="block text-sm font-bold text-slate-700 mb-1">Email</label>
            <input id="companyEmail" type="email" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="accounts@yourcompany.co.za">
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Phone</label>
              <input id="companyPhone" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="+27 ...">
            </div>
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Website</label>
              <input id="companyWebsite" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="https://...">
            </div>
          </div>

          <div>
            <label class="block text-sm font-bold text-slate-700 mb-1">Address</label>
            <textarea id="companyAddress" rows="3" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Street, City, Province, Postal Code"></textarea>
          </div>

          <div class="border-t border-gray-100 pt-3">
            <label class="block text-sm font-bold text-slate-700 mb-1">Bank Details (optional)</label>
            <textarea id="companyBank" rows="3" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Bank: ...&#10;Account: ...&#10;Branch: ...&#10;Reference: Job #"></textarea>
          </div>
        </div>
      </section>

      <!-- Customer / Client -->
      <section class="card p-5">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-extrabold"><i class="fa-solid fa-user-tie text-blue-600 mr-2"></i>Customer</h2>
          <span class="text-xs text-slate-500">For whom</span>
        </div>

        <div class="space-y-3">
          <div>
            <label class="block text-sm font-bold text-slate-700 mb-1">Customer Name</label>
            <input id="clientName" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Customer Company / Person">
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Customer VAT</label>
              <input id="clientVat" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Optional">
            </div>
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Customer Reg/ID</label>
              <input id="clientReg" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Optional">
            </div>
          </div>

          <div>
            <label class="block text-sm font-bold text-slate-700 mb-1">Email</label>
            <input id="clientEmail" type="email" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="billing@client.co.za">
          </div>

          <div>
            <label class="block text-sm font-bold text-slate-700 mb-1">Phone</label>
            <input id="clientPhone" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="+27 ...">
          </div>

          <div>
            <label class="block text-sm font-bold text-slate-700 mb-1">Address</label>
            <textarea id="clientAddress" rows="4" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Street, City, Province, Postal Code"></textarea>
          </div>
        </div>
      </section>

      <!-- Job Meta -->
      <section class="card p-5">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-extrabold"><i class="fa-solid fa-clipboard-list text-blue-600 mr-2"></i>Job</h2>
          <span id="statusBadge" class="badge badge-draft"><i class="fa-solid fa-pen"></i> DRAFT</span>
        </div>

        <div class="space-y-3">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Job Card #</label>
              <input id="jobNumber" class="w-full border border-gray-200 rounded-lg px-3 py-2 mono" placeholder="JOB0000001">
            </div>
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Reference</label>
              <input id="jobReference" class="w-full border border-gray-200 rounded-lg px-3 py-2 mono" placeholder="Work order / Ticket ref">
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Start Date</label>
              <input id="jobDate" type="date" class="w-full border border-gray-200 rounded-lg px-3 py-2">
            </div>
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Due Date</label>
              <input id="dueDate" type="date" class="w-full border border-gray-200 rounded-lg px-3 py-2">
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Currency</label>
              <select id="currency" class="w-full border border-gray-200 rounded-lg px-3 py-2">
                <option value="ZAR" selected>ZAR (R)</option>
                <option value="USD">USD ($)</option>
                <option value="EUR">EUR (€)</option>
                <option value="GBP">GBP (£)</option>
              </select>
              <p class="text-xs text-slate-500 mt-1">Formatting adapts; no FX conversion.</p>
            </div>
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Status</label>
              <select id="jobStatus" class="w-full border border-gray-200 rounded-lg px-3 py-2">
                <option value="draft" selected>Draft</option>
                <option value="open">Open</option>
                <option value="progress">In Progress</option>
                <option value="completed">Completed</option>
                <option value="cancelled">Cancelled</option>
              </select>
            </div>
          </div>

          <div>
            <label class="block text-sm font-bold text-slate-700 mb-1">Job Description</label>
            <textarea id="jobDescription" rows="3" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Describe the work to be done..."></textarea>
          </div>

          <div>
            <label class="block text-sm font-bold text-slate-700 mb-1">Assigned To</label>
            <input id="jobAssigned" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Technician / Staff name">
          </div>

          <div class="border-t border-gray-100 pt-3 space-y-3">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-1">Amount Paid</label>
                <input id="amountPaid" type="number" min="0" step="0.01" value="0.00"
                  class="w-full border border-gray-200 rounded-lg px-3 py-2">
              </div>
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-1">Job Deposit</label>
                <input id="jobDeposit" type="number" min="0" step="0.01" value="0.00"
                  class="w-full border border-gray-200 rounded-lg px-3 py-2">
              </div>
            </div>

            <div class="flex items-center justify-between gap-3">
              <button class="btn btn-outline w-full" id="btnNewNumber">
                <i class="fa-solid fa-wand-magic-sparkles"></i> New Job #
              </button>
              <button class="btn btn-outline w-full" id="btnMarkCompleted">
                <i class="fa-solid fa-check"></i> Mark Completed
              </button>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- Line Items (Labour & Parts) -->
    <section class="card p-5 mb-6">
      <div class="flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between mb-4">
        <h2 class="text-lg font-extrabold"><i class="fa-solid fa-list-check text-blue-600 mr-2"></i>Labour &amp; Parts</h2>
        <div class="flex flex-wrap gap-2 no-print">
          <button class="btn btn-outline" id="btnImportCSV" title="Import lines from CSV (Description,Hours,Rate,Parts)">
            <i class="fa-solid fa-file-import"></i> Import CSV
          </button>
          <input type="file" id="csvFile" accept=".csv" class="hidden">
          <button class="btn btn-primary" id="btnAddLine">
            <i class="fa-solid fa-plus"></i> Add Line
          </button>
        </div>
      </div>

      <div class="responsive-table">
        <table class="w-full text-sm border-collapse" id="itemsTable">
          <thead>
            <tr class="bg-gray-50 text-gray-600">
              <th class="border border-gray-200 p-2 text-left">Description</th>
              <th class="border border-gray-200 p-2 text-center">Hours</th>
              <th class="border border-gray-200 p-2 text-center">Rate</th>
              <th class="border border-gray-200 p-2 text-center">Parts</th>
              <th class="border border-gray-200 p-2 text-right">Total</th>
              <th class="border border-gray-200 p-2 text-center no-print">Action</th>
            </tr>
          </thead>
          <tbody id="itemsBody"></tbody>
        </table>
      </div>
    </section>

    <!-- Notes & Terms -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
      <section class="card p-5">
        <h2 class="text-lg font-extrabold mb-3"><i class="fa-solid fa-note-sticky text-blue-600 mr-2"></i>Notes</h2>
        <textarea id="notes" rows="6" class="w-full border border-gray-200 rounded-lg px-3 py-2"
          placeholder="Additional notes or instructions..."></textarea>
      </section>

      <section class="card p-5">
        <h2 class="text-lg font-extrabold mb-3"><i class="fa-solid fa-file-contract text-blue-600 mr-2"></i>Terms</h2>
        <textarea id="terms" rows="6" class="w-full border border-gray-200 rounded-lg px-3 py-2"
          placeholder="Payment terms, warranty conditions, etc."></textarea>
      </section>
    </div>

    <!-- Totals + Actions -->
    <section class="card p-5 mb-6">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
        <div class="lg:col-span-2">
          <h2 class="text-lg font-extrabold mb-2"><i class="fa-solid fa-calculator text-blue-600 mr-2"></i>Totals</h2>
          <p class="text-sm text-slate-500">Sum of labour and parts cost. Balance due equals subtotal minus amount paid.</p>
        </div>

        <div class="lg:col-span-1">
          <div class="space-y-2 text-sm">
            <div class="flex justify-between border-t border-gray-100 pt-2">
              <span class="font-bold text-slate-700">Subtotal</span>
              <span id="tSubtotal" class="font-extrabold mono">R0.00</span>
            </div>
            <div class="flex justify-between border-t border-gray-100 pt-2">
              <span class="font-bold text-slate-700">Job Deposit</span>
              <span id="tDeposit" class="font-extrabold mono">R0.00</span>
            </div>
            <div class="flex justify-between border-t border-gray-100 pt-2">
              <span class="font-bold text-slate-700">AMOUNT PAID</span>
              <span id="tPaid" class="font-extrabold mono">R0.00</span>
            </div>
            <div class="flex justify-between border-t border-gray-200 pt-2 text-base">
              <span class="font-black text-slate-900">GRAND TOTAL</span>
              <span id="tGrand" class="font-black mono">R0.00</span>
            </div>
            <div class="flex justify-between border-t border-gray-200 pt-2 text-lg">
              <span class="font-black text-slate-900">BALANCE DUE</span>
              <span id="tBalance" class="font-black mono">R0.00</span>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-6 flex flex-wrap gap-3 justify-center no-print">
        <button class="btn btn-outline" id="btnPreview">
          <i class="fa-solid fa-eye"></i> Preview
        </button>
        <button class="btn btn-outline" id="btnPrint">
          <i class="fa-solid fa-print"></i> Print (Manual)
        </button>
        <button class="btn btn-danger" id="btnPDF">
          <i class="fa-solid fa-file-pdf"></i> Export PDF
        </button>
        <button class="btn btn-primary" id="btnWord">
          <i class="fa-solid fa-file-word"></i> Export Word
        </button>
        <button class="btn btn-success" id="btnExcel">
          <i class="fa-solid fa-file-excel"></i> Export Excel
        </button>
        <button class="btn btn-outline" id="btnCSV">
          <i class="fa-solid fa-file-csv"></i> Export CSV
        </button>
      </div>
    </section>

    <!-- Preview Modal -->
    <div id="previewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50 no-print">
      <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-screen overflow-y-auto">
        <div class="p-4 flex justify-between items-center border-b border-gray-200">
          <div>
            <h2 class="text-xl font-black text-slate-900">Job Card Preview</h2>
            <p class="text-xs text-slate-500">This is the export/print layout.</p>
          </div>
          <button id="btnClosePreview" class="text-slate-500 hover:text-slate-800">
            <i class="fa-solid fa-xmark text-xl"></i>
          </button>
        </div>

        <div id="previewContent" class="p-6"></div>

        <div class="p-4 border-t border-gray-200 flex justify-end gap-2">
          <button class="btn btn-outline" id="btnClosePreviewBottom">Close</button>
          <button class="btn btn-danger" id="btnPDF2">
            <i class="fa-solid fa-file-pdf"></i> Export PDF
          </button>
        </div>
      </div>
    </div>

    <!-- Hidden Export Template -->
    <div id="jobTemplate" class="hidden">
      <div class="manual-print max-w-4xl mx-auto bg-white p-6">
        <div class="flex items-start justify-between gap-6 mb-6">
          <div class="flex-1">
            <div id="tplLogo" class="mb-3"></div>
            <div class="text-xl font-black" id="tplCompanyName">Company</div>
            <div class="text-sm text-slate-600 mt-1 whitespace-pre-line" id="tplCompanyAddress"></div>
            <div class="text-sm text-slate-600 mt-2">
              <div><span class="font-bold">VAT:</span> <span id="tplCompanyVat"></span></div>
              <div><span class="font-bold">Reg:</span> <span id="tplCompanyReg"></span></div>
              <div><span class="font-bold">Email:</span> <span id="tplCompanyEmail"></span></div>
              <div><span class="font-bold">Phone:</span> <span id="tplCompanyPhone"></span></div>
              <div><span class="font-bold">Website:</span> <span id="tplCompanyWebsite"></span></div>
            </div>
          </div>

          <div class="w-72 text-right">
            <div class="text-3xl font-black tracking-tight">JOB CARD</div>
            <div class="mt-2 grid grid-cols-2 gap-x-2 text-sm">
              <span class="text-right font-bold">NUMBER:</span><span class="text-left mono" id="tplCardNumber"></span>
              <span class="text-right font-bold">REF:</span><span class="text-left mono" id="tplCardRef"></span>
              <span class="text-right font-bold">DATE:</span><span class="text-left" id="tplCardDate"></span>
              <span class="text-right font-bold">DUE:</span><span class="text-left" id="tplCardDue"></span>
              <span class="text-right font-bold">STATUS:</span><span class="text-left" id="tplCardStatus"></span>
              <span class="text-right font-bold">CURRENCY:</span><span class="text-left mono" id="tplCardCurrency"></span>
              <span class="text-right font-bold">ASSIGNED:</span><span class="text-left" id="tplAssigned"></span>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-6">
          <div class="border border-gray-200 rounded-lg p-4">
            <div class="text-xs text-slate-500 font-black mb-2">CUSTOMER</div>
            <div class="text-base font-black" id="tplClientName"></div>
            <div class="text-sm text-slate-600 mt-1 whitespace-pre-line" id="tplClientAddress"></div>
            <div class="text-sm text-slate-600 mt-2">
              <div><span class="font-bold">VAT:</span> <span id="tplClientVat"></span></div>
              <div><span class="font-bold">Reg/ID:</span> <span id="tplClientReg"></span></div>
              <div><span class="font-bold">Email:</span> <span id="tplClientEmail"></span></div>
              <div><span class="font-bold">Phone:</span> <span id="tplClientPhone"></span></div>
            </div>
          </div>

          <div class="border border-gray-200 rounded-lg p-4">
            <div class="text-xs text-slate-500 font-black mb-2">PAYMENT / BANK</div>
            <div class="text-sm text-slate-700 whitespace-pre-line" id="tplBank"></div>
          </div>
        </div>

        <div class="text-sm text-slate-700 mb-6">
          <div class="font-bold mb-1">Job Description:</div>
          <div id="tplJobDesc" class="whitespace-pre-line"></div>
        </div>

        <div class="responsive-table mb-5">
          <table class="w-full border-collapse text-sm">
            <thead>
              <tr class="bg-gray-50">
                <th class="border border-gray-200 p-2 text-left">Description</th>
                <th class="border border-gray-200 p-2 text-center">Hours</th>
                <th class="border border-gray-200 p-2 text-center">Rate</th>
                <th class="border border-gray-200 p-2 text-center">Parts</th>
                <th class="border border-gray-200 p-2 text-right">Total</th>
              </tr>
            </thead>
            <tbody id="tplItems"></tbody>
          </table>
        </div>

        <div class="flex justify-end mb-6">
          <div class="w-full sm:w-1/2 md:w-1/3 text-sm">
            <div class="flex justify-between border-t border-gray-200 pt-2">
              <span class="font-bold text-slate-700">Subtotal</span>
              <span class="mono" id="tplSubtotal"></span>
            </div>
            <div class="flex justify-between">
              <span class="font-bold text-slate-700">Deposit</span>
              <span class="mono" id="tplDeposit"></span>
            </div>
            <div class="flex justify-between">
              <span class="font-bold text-slate-700">Paid</span>
              <span class="mono" id="tplPaid"></span>
            </div>
            <div class="flex justify-between border-t border-b border-gray-200 py-2 font-black text-base">
              <span>GRAND TOTAL</span>
              <span class="mono" id="tplGrand"></span>
            </div>
            <div class="flex justify-between mt-2 text-lg font-black">
              <span>BALANCE DUE</span>
              <span class="mono" id="tplBalance"></span>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
          <div class="border border-gray-200 rounded-lg p-4">
            <div class="text-xs text-slate-500 font-black mb-2">NOTES</div>
            <div class="text-sm text-slate-700 whitespace-pre-line" id="tplNotes"></div>
          </div>
          <div class="border border-gray-200 rounded-lg p-4">
            <div class="text-xs text-slate-500 font-black mb-2">TERMS</div>
            <div class="text-sm text-slate-700 whitespace-pre-line" id="tplTerms"></div>
          </div>
        </div>

        <div class="mt-6 text-xs text-slate-500 text-center">
          Generated with EasyJC • Print-friendly output
        </div>
      </div>
    </div>

  </main>

<script>
  // ===========================
  // Helpers
  // ===========================
  const $ = (id) => document.getElementById(id);

  function escapeHtml(str){
    return String(str || "").replace(/[&<>"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]));
  }

  function symbolForCurrency(cur){
    switch(cur){
      case "USD": return "$";
      case "EUR": return "€";
      case "GBP": return "£";
      case "ZAR":
      default: return "R";
    }
  }

  function fmt(amount){
    const cur = $("currency").value || "ZAR";
    const sym = symbolForCurrency(cur);
    const n = Number(amount || 0);
    const fixed = n.toFixed(2);
    const withSep = fixed.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    return sym + withSep;
  }

  function formatDateISO(iso){
    if(!iso) return "";
    const [y,m,d] = iso.split("-");
    return `${d}/${m}/${y}`;
  }

  function setStatusBadge(){
    const s = $("jobStatus").value;
    const badge = $("statusBadge");
    const map = {
      draft: {cls:"badge badge-draft", icon:"fa-pen", text:"DRAFT"},
      open: {cls:"badge badge-open", icon:"fa-folder-open", text:"OPEN"},
      progress: {cls:"badge badge-progress", icon:"fa-spinner", text:"IN PROGRESS"},
      completed: {cls:"badge badge-completed", icon:"fa-check", text:"COMPLETED"},
      cancelled: {cls:"badge badge-cancelled", icon:"fa-xmark", text:"CANCELLED"},
    };
    const v = map[s] || map.draft;
    badge.className = v.cls;
    badge.innerHTML = `<i class="fa-solid ${v.icon}"></i> ${v.text}`;
  }

  function generateJobNumber(){
    const n = Math.floor(Math.random()*10000000).toString().padStart(7,"0");
    $("jobNumber").value = "JOB" + n;
  }

  // ===========================
  // Line items
  // ===========================
  let lineCounter = 0;

  function addLineItem(prefill={}){
    const tbody = $("itemsBody");
    const rowId = "li-" + (lineCounter++);
    const tr = document.createElement("tr");
    tr.id = rowId;
    tr.className = "line-item";
    tr.innerHTML = `
      <td class="border border-gray-200 p-2">
        <input type="text" class="w-full border border-gray-200 rounded-md px-2 py-1 item-desc" placeholder="Task or part description" value="${escapeHtml(prefill.desc || '')}">
      </td>
      <td class="border border-gray-200 p-2">
        <input type="number" min="0" step="0.01" class="w-full border border-gray-200 rounded-md px-2 py-1 text-center item-hours" value="${escapeHtml(prefill.hours ?? 1)}">
      </td>
      <td class="border border-gray-200 p-2">
        <input type="number" min="0" step="0.01" class="w-full border border-gray-200 rounded-md px-2 py-1 text-center item-rate" value="${escapeHtml(prefill.rate ?? '0.00')}">
      </td>
      <td class="border border-gray-200 p-2">
        <input type="number" min="0" step="0.01" class="w-full border border-gray-200 rounded-md px-2 py-1 text-center item-parts" value="${escapeHtml(prefill.parts ?? '0.00')}">
      </td>
      <td class="border border-gray-200 p-2 text-right mono item-total">${fmt(0)}</td>
      <td class="border border-gray-200 p-2 text-center no-print">
        <button class="text-red-600 hover:text-red-800" title="Delete line">
          <i class="fa-solid fa-trash-can"></i>
        </button>
      </td>
    `;
    tbody.appendChild(tr);

    tr.querySelector("button").addEventListener("click", () => {
      tr.remove();
      calculateTotals();
      autosave();
    });
    tr.querySelectorAll("input").forEach(inp=>{
      inp.addEventListener("input", () => { calculateTotals(); autosave(); });
    });
    calculateTotals();
  }

  function readLineItems(){
    const items = [];
    document.querySelectorAll(".line-item").forEach(tr=>{
      items.push({
        desc: tr.querySelector(".item-desc").value || "",
        hours: Number(tr.querySelector(".item-hours").value || 0),
        rate: Number(tr.querySelector(".item-rate").value || 0),
        parts: Number(tr.querySelector(".item-parts").value || 0)
      });
    });
    return items;
  }

  // ===========================
  // Totals
  // ===========================
  function calculateTotals(){
    setStatusBadge();
    const deposit = Number($("jobDeposit").value || 0);
    const paid = Number($("amountPaid").value || 0);
    let subtotal = 0;
    document.querySelectorAll(".line-item").forEach(tr=>{
      const hours = Number(tr.querySelector(".item-hours").value || 0);
      const rate = Number(tr.querySelector(".item-rate").value || 0);
      const parts = Number(tr.querySelector(".item-parts").value || 0);
      const total = (hours * rate) + parts;
      subtotal += total;
      tr.querySelector(".item-total").textContent = fmt(total);
    });
    const grand = subtotal;
    const balance = Math.max(0, grand - deposit - paid);
    $("tSubtotal").textContent = fmt(subtotal);
    $("tDeposit").textContent = fmt(deposit);
    $("tPaid").textContent = fmt(paid);
    $("tGrand").textContent = fmt(grand);
    $("tBalance").textContent = fmt(balance);
    return { subtotal, deposit, paid, grand, balance };
  }

  // ===========================
  // Logo handling
  // ===========================
  let companyLogoDataUrl = null;
  function handleLogoUpload(file){
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      companyLogoDataUrl = e.target.result;
      const preview = $("companyLogoPreview");
      preview.innerHTML = "";
      const img = document.createElement("img");
      img.src = companyLogoDataUrl;
      img.className = "h-14 object-contain";
      preview.appendChild(img);
      autosave();
    };
    reader.readAsDataURL(file);
  }

  // ===========================
  // Preview / Template fill
  // ===========================
  function buildTemplateDom(){
    const tpl = $("jobTemplate").firstElementChild.cloneNode(true);
    // logo
    const logoWrap = tpl.querySelector("#tplLogo");
    logoWrap.innerHTML = "";
    if(companyLogoDataUrl){
      const img = document.createElement("img");
      img.src = companyLogoDataUrl;
      img.style.height = "60px";
      img.style.objectFit = "contain";
      logoWrap.appendChild(img);
    }
    // company
    tpl.querySelector("#tplCompanyName").textContent = $("companyName").value || "Company";
    tpl.querySelector("#tplCompanyAddress").textContent = $("companyAddress").value || "";
    tpl.querySelector("#tplCompanyVat").textContent = $("companyVat").value || "";
    tpl.querySelector("#tplCompanyReg").textContent = $("companyReg").value || "";
    tpl.querySelector("#tplCompanyEmail").textContent = $("companyEmail").value || "";
    tpl.querySelector("#tplCompanyPhone").textContent = $("companyPhone").value || "";
    tpl.querySelector("#tplCompanyWebsite").textContent = $("companyWebsite").value || "";
    // job meta
    tpl.querySelector("#tplCardNumber").textContent = $("jobNumber").value || "";
    tpl.querySelector("#tplCardRef").textContent = $("jobReference").value || "";
    tpl.querySelector("#tplCardDate").textContent = formatDateISO($("jobDate").value) || "";
    tpl.querySelector("#tplCardDue").textContent = formatDateISO($("dueDate").value) || "";
    tpl.querySelector("#tplCardStatus").textContent = ($("jobStatus").value || "draft").toUpperCase();
    tpl.querySelector("#tplCardCurrency").textContent = $("currency").value || "ZAR";
    tpl.querySelector("#tplAssigned").textContent = $("jobAssigned").value || "";
    // customer
    tpl.querySelector("#tplClientName").textContent = $("clientName").value || "Customer";
    tpl.querySelector("#tplClientAddress").textContent = $("clientAddress").value || "";
    tpl.querySelector("#tplClientVat").textContent = $("clientVat").value || "";
    tpl.querySelector("#tplClientReg").textContent = $("clientReg").value || "";
    tpl.querySelector("#tplClientEmail").textContent = $("clientEmail").value || "";
    tpl.querySelector("#tplClientPhone").textContent = $("clientPhone").value || "";
    // bank
    tpl.querySelector("#tplBank").textContent = $("companyBank").value || "";
    // job desc
    tpl.querySelector("#tplJobDesc").textContent = $("jobDescription").value || "";
    // items
    const items = readLineItems();
    const tbody = tpl.querySelector("#tplItems");
    tbody.innerHTML = "";
    items.forEach(i => {
      const total = (i.hours * i.rate) + i.parts;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="border border-gray-200 p-2">${escapeHtml(i.desc || "")}</td>
        <td class="border border-gray-200 p-2 text-center">${i.hours}</td>
        <td class="border border-gray-200 p-2 text-center">${fmt(i.rate)}</td>
        <td class="border border-gray-200 p-2 text-center">${fmt(i.parts)}</td>
        <td class="border border-gray-200 p-2 text-right mono">${fmt(total)}</td>
      `;
      tbody.appendChild(tr);
    });
    // totals
    const t = calculateTotals();
    tpl.querySelector("#tplSubtotal").textContent = fmt(t.subtotal);
    tpl.querySelector("#tplDeposit").textContent = fmt(t.deposit);
    tpl.querySelector("#tplPaid").textContent = fmt(t.paid);
    tpl.querySelector("#tplGrand").textContent = fmt(t.grand);
    tpl.querySelector("#tplBalance").textContent = fmt(t.balance);
    // notes/terms
    tpl.querySelector("#tplNotes").textContent = $("notes").value || "";
    tpl.querySelector("#tplTerms").textContent = $("terms").value || "";
    return tpl;
  }

  function openPreview(){
    const modal = $("previewModal");
    const content = $("previewContent");
    content.innerHTML = "";
    content.appendChild(buildTemplateDom());
    modal.classList.remove("hidden");
    modal.classList.add("flex");
  }

  function closePreview(){
    const modal = $("previewModal");
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  }

  // ===========================
  // Export functions
  // ===========================
  function exportPDF(){
    // ensure preview is built
    const dom = buildTemplateDom();
    const wrapper = document.createElement("div");
    wrapper.style.position = "absolute";
    wrapper.style.left = "-9999px";
    wrapper.style.top = "0";
    wrapper.style.width = "210mm";
    wrapper.appendChild(dom);
    document.body.appendChild(wrapper);
    const filename = ($("jobNumber").value || "jobcard") + ".pdf";
    const opt = {
      margin: [10,10,10,10],
      filename,
      image: { type: "jpeg", quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true, letterRendering: true, allowTaint: true, foreignObjectRendering: true },
      jsPDF: { unit: "mm", format: "a4", orientation: "portrait", compress: true }
    };
    const loading = document.createElement("div");
    loading.textContent = "Generating PDF...";
    loading.style.position = "fixed";
    loading.style.left = "50%";
    loading.style.top = "50%";
    loading.style.transform = "translate(-50%, -50%)";
    loading.style.background = "rgba(0,0,0,.75)";
    loading.style.color = "white";
    loading.style.padding = "14px 18px";
    loading.style.borderRadius = "10px";
    loading.style.zIndex = "9999";
    document.body.appendChild(loading);
    html2pdf().set(opt).from(wrapper).save()
      .then(()=>{ document.body.removeChild(wrapper); document.body.removeChild(loading); })
      .catch(err=>{ console.error(err); alert("PDF export failed. Check console for details."); document.body.removeChild(wrapper); document.body.removeChild(loading); });
  }

  function exportCSV(){
    const items = readLineItems();
    const headers = ["Description","Hours","Rate","Parts"];
    const rows = items.map(i => [
      (i.desc || "").replaceAll('"','""'),
      i.hours,
      i.rate,
      i.parts
    ]);
    const csv = [headers, ...rows].map(r => r.map(v => `"${String(v ?? "")}"`).join(",")).join("\n");
    const filename = ($("jobNumber").value || "jobcard") + ".csv";
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
    saveAs(blob, filename);
  }

  function exportExcel(){
    const wb = XLSX.utils.book_new();
    const meta = [
      ["JOB CARD"],
      [""],
      ["Job #", $("jobNumber").value || ""],
      ["Reference", $("jobReference").value || ""],
      ["Start Date", formatDateISO($("jobDate").value)],
      ["Due Date", formatDateISO($("dueDate").value)],
      ["Status", ($("jobStatus").value || "").toUpperCase()],
      ["Currency", $("currency").value || "ZAR"],
      ["Assigned", $("jobAssigned").value || ""],
      [""],
      ["Company", $("companyName").value || ""],
      ["Company VAT", $("companyVat").value || ""],
      ["Company Address", $("companyAddress").value || ""],
      ["Company Email", $("companyEmail").value || ""],
      ["Company Phone", $("companyPhone").value || ""],
      [""],
      ["Customer", $("clientName").value || ""],
      ["Customer VAT", $("clientVat").value || ""],
      ["Customer Address", $("clientAddress").value || ""],
      ["Customer Email", $("clientEmail").value || ""],
      ["Customer Phone", $("clientPhone").value || ""],
      [""],
      ["Job Description", $("jobDescription").value || ""]
    ];
    const items = readLineItems();
    const itemsHeader = [["Description","Hours","Rate","Parts","Total"]];
    const itemsRows = items.map(i => {
      const total = (i.hours * i.rate) + i.parts;
      return [i.desc || "", i.hours, i.rate, i.parts, total];
    });
    const t = calculateTotals();
    const totals = [
      [""],
      ["Subtotal", t.subtotal],
      ["Deposit", t.deposit],
      ["Paid", t.paid],
      ["Grand Total", t.grand],
      ["Balance Due", t.balance]
    ];
    const ws = XLSX.utils.aoa_to_sheet([...meta, ...itemsHeader, ...itemsRows, ...totals]);
    XLSX.utils.book_append_sheet(wb, ws, "Job Card");
    XLSX.writeFile(wb, ($("jobNumber").value || "jobcard") + ".xlsx");
  }

  function exportWord(){
    // Use docx library if available, fallback to simple HTML doc otherwise
    if (typeof docx === "undefined") {
      // fallback: create simple HTML document and save as .doc
      const dom = buildTemplateDom();
      const htmlString = `<!DOCTYPE html><html><head><meta charset="utf-8"></head><body>${dom.outerHTML}</body></html>`;
      const blob = new Blob([htmlString], { type: "application/msword" });
      saveAs(blob, ($("jobNumber").value || "jobcard") + ".doc");
      return;
    }
    const { Document, Paragraph, HeadingLevel, Table, TableRow, TableCell, WidthType, AlignmentType, BorderStyle } = docx;
    const t = calculateTotals();
    const items = readLineItems();
    const doc = new Document({
      sections: [{
        properties: {},
        children: [
          new Paragraph({ text: "JOB CARD", heading: HeadingLevel.HEADING_1, alignment: AlignmentType.CENTER }),
          new Paragraph({ text: " " }),
          new Table({
            width: { size: 100, type: WidthType.PERCENTAGE },
            rows: [
              new TableRow({
                children: [
                  new TableCell({ children: [new Paragraph("Job #")] }),
                  new TableCell({ children: [new Paragraph($("jobNumber").value || "")] }),
                  new TableCell({ children: [new Paragraph("Start Date")] }),
                  new TableCell({ children: [new Paragraph(formatDateISO($("jobDate").value))] }),
                ]
              }),
              new TableRow({
                children: [
                  new TableCell({ children: [new Paragraph("Reference")] }),
                  new TableCell({ children: [new Paragraph($("jobReference").value || "")] }),
                  new TableCell({ children: [new Paragraph("Due Date")] }),
                  new TableCell({ children: [new Paragraph(formatDateISO($("dueDate").value))] }),
                ]
              }),
              new TableRow({
                children: [
                  new TableCell({ children: [new Paragraph("Status")] }),
                  new TableCell({ children: [new Paragraph(($("jobStatus").value || "").toUpperCase())] }),
                  new TableCell({ children: [new Paragraph("Currency")] }),
                  new TableCell({ children: [new Paragraph($("currency").value || "ZAR")] }),
                ]
              }),
              new TableRow({
                children: [
                  new TableCell({ children: [new Paragraph("Assigned")] }),
                  new TableCell({ children: [new Paragraph($("jobAssigned").value || "")] }),
                  new TableCell({ children: [new Paragraph("Deposit")] }),
                  new TableCell({ children: [new Paragraph(fmt($("jobDeposit").value))] }),
                ]
              }),
            ]
          }),
          new Paragraph({ text: " " }),
          new Paragraph({ text: "FROM:", heading: HeadingLevel.HEADING_3 }),
          new Paragraph($("companyName").value || ""),
          new Paragraph(`VAT: ${$("companyVat").value || ""}`),
          new Paragraph($("companyAddress").value || ""),
          new Paragraph(`Email: ${$("companyEmail").value || ""}`),
          new Paragraph(`Phone: ${$("companyPhone").value || ""}`),
          new Paragraph({ text: " " }),
          new Paragraph({ text: "TO:", heading: HeadingLevel.HEADING_3 }),
          new Paragraph($("clientName").value || ""),
          new Paragraph(`VAT: ${$("clientVat").value || ""}`),
          new Paragraph($("clientAddress").value || ""),
          new Paragraph(`Email: ${$("clientEmail").value || ""}`),
          new Paragraph(`Phone: ${$("clientPhone").value || ""}`),
          new Paragraph({ text: " " }),
          new Paragraph({ text: "Job Description:", heading: HeadingLevel.HEADING_3 }),
          new Paragraph($("jobDescription").value || ""),
          new Paragraph({ text: " " }),
          new Table({
            width: { size: 100, type: WidthType.PERCENTAGE },
            rows: [
              new TableRow({ tableHeader: true, children: ["Description","Hours","Rate","Parts","Total"].map(h => new TableCell({
                children:[new Paragraph({text:h, bold:true})],
                borders:{ top:{style: BorderStyle.SINGLE, size: 1}, bottom:{style: BorderStyle.SINGLE, size: 1}, left:{style: BorderStyle.SINGLE, size: 1}, right:{style: BorderStyle.SINGLE, size: 1} }
              })) }),
              ...items.map(i => {
                const total = (i.hours * i.rate) + i.parts;
                const cells = [i.desc || "", String(i.hours), fmt(i.rate), fmt(i.parts), fmt(total)];
                return new TableRow({
                  children: cells.map(v => new TableCell({
                    children:[new Paragraph(String(v))],
                    borders:{ top:{style: BorderStyle.SINGLE, size: 1}, bottom:{style: BorderStyle.SINGLE, size: 1}, left:{style: BorderStyle.SINGLE, size: 1}, right:{style: BorderStyle.SINGLE, size: 1} }
                  }))
                });
              })
            ]
          }),
          new Paragraph({ text: " " }),
          new Paragraph({ text: `Subtotal: ${fmt(t.subtotal)}` }),
          new Paragraph({ text: `Deposit: ${fmt(t.deposit)}` }),
          new Paragraph({ text: `Paid: ${fmt(t.paid)}` }),
          new Paragraph({ text: `Grand Total: ${fmt(t.grand)}`, bold: true }),
          new Paragraph({ text: `Balance Due: ${fmt(t.balance)}`, bold: true }),
          new Paragraph({ text: " " }),
          new Paragraph({ text: "NOTES:", heading: HeadingLevel.HEADING_3 }),
          new Paragraph($("notes").value || ""),
          new Paragraph({ text: " " }),
          new Paragraph({ text: "TERMS:", heading: HeadingLevel.HEADING_3 }),
          new Paragraph($("terms").value || ""),
          new Paragraph({ text: " " }),
          new Paragraph({ text: "BANK DETAILS:", heading: HeadingLevel.HEADING_3 }),
          new Paragraph($("companyBank").value || ""),
        ]
      }]
    });
    docx.Packer.toBlob(doc)
      .then(blob => saveAs(blob, ($("jobNumber").value || "jobcard") + ".docx"))
      .catch(err=>{ console.error(err); alert("Word export failed. Check console for details."); });
  }

  // ===========================
  // CSV Import
  // ===========================
  function parseCSV(text){
    const rows = [];
    let i=0, field="", row=[], inQuotes=false;
    const pushField = () => { row.push(field); field=""; };
    const pushRow = () => { if(row.length) rows.push(row); row=[]; };
    while(i<text.length){
      const c = text[i];
      if(inQuotes){
        if(c === '"'){
          if(text[i+1] === '"'){ field += '"'; i++; }
          else inQuotes = false;
        } else field += c;
      } else {
        if(c === '"') inQuotes = true;
        else if(c === ','){ pushField(); }
        else if(c === '\n'){ pushField(); pushRow(); }
        else if(c !== '\r'){ field += c; }
      }
      i++;
    }
    pushField(); pushRow();
    return rows;
  }
  function importCSV(file){
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      const text = e.target.result || "";
      const rows = parseCSV(text).filter(r => r.join(" ").trim().length);
      let startIdx = 0;
      if(rows[0] && rows[0][0] && rows[0][0].toLowerCase().includes("description")) startIdx = 1;
      for(let r=startIdx; r<rows.length; r++){
        const [desc, hours, rate, parts] = rows[r];
        addLineItem({
          desc: (desc||"").trim(),
          hours: Number((hours||"1").trim()),
          rate: Number((rate||"0").trim()),
          parts: Number((parts||"0").trim()),
        });
      }
      calculateTotals();
      autosave();
    };
    reader.readAsText(file);
  }

  // ===========================
  // Save/Load templates (localStorage)
  // ===========================
  const AUTOSAVE_KEY = "easyjc.autosave.v1";
  const TEMPLATES_KEY = "easyjc.templates.v1";
  function serializeState(){
    return {
      version: 1,
      savedAt: new Date().toISOString(),
      companyLogoDataUrl,
      fields: {
        companyName: $("companyName").value,
        companyVat: $("companyVat").value,
        companyReg: $("companyReg").value,
        companyEmail: $("companyEmail").value,
        companyPhone: $("companyPhone").value,
        companyWebsite: $("companyWebsite").value,
        companyAddress: $("companyAddress").value,
        companyBank: $("companyBank").value,
        clientName: $("clientName").value,
        clientVat: $("clientVat").value,
        clientReg: $("clientReg").value,
        clientEmail: $("clientEmail").value,
        clientPhone: $("clientPhone").value,
        clientAddress: $("clientAddress").value,
        jobNumber: $("jobNumber").value,
        jobReference: $("jobReference").value,
        jobDate: $("jobDate").value,
        dueDate: $("dueDate").value,
        currency: $("currency").value,
        jobStatus: $("jobStatus").value,
        jobDescription: $("jobDescription").value,
        jobAssigned: $("jobAssigned").value,
        amountPaid: $("amountPaid").value,
        jobDeposit: $("jobDeposit").value,
        notes: $("notes").value,
        terms: $("terms").value,
      },
      items: readLineItems()
    };
  }
  function applyState(state){
    if(!state) return;
    companyLogoDataUrl = state.companyLogoDataUrl || null;
    // logo preview
    const preview = $("companyLogoPreview");
    preview.innerHTML = "";
    if(companyLogoDataUrl){
      const img = document.createElement("img");
      img.src = companyLogoDataUrl;
      img.className = "h-14 object-contain";
      preview.appendChild(img);
    } else {
      preview.innerHTML = `<p class="text-sm text-slate-400">No logo uploaded</p>`;
    }
    const f = state.fields || {};
    Object.keys(f).forEach(k=>{ if($(k)) $(k).value = f[k] ?? ""; });
    // items
    $("itemsBody").innerHTML = "";
    (state.items || []).forEach(it => addLineItem(it));
    if(!(state.items || []).length) addLineItem();
    calculateTotals();
    setStatusBadge();
  }
  function autosave(){
    try{ localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(serializeState())); } catch(e){ console.warn("Autosave failed:", e); }
  }
  function loadAutosave(){
    try{ const raw = localStorage.getItem(AUTOSAVE_KEY); if(!raw) return false; applyState(JSON.parse(raw)); return true; } catch(e){ console.warn("Autosave load failed:", e); return false; }
  }
  function saveTemplate(){
    const name = prompt("Template name (e.g., 'Standard Job'):"); if(!name) return; const state = serializeState(); state.templateName = name;
    const templates = loadTemplates(); templates.push(state);
    localStorage.setItem(TEMPLATES_KEY, JSON.stringify(templates)); alert("Template saved: " + name);
  }
  function loadTemplates(){
    try{ return JSON.parse(localStorage.getItem(TEMPLATES_KEY) || "[]"); } catch { return []; }
  }
  function pickAndLoadTemplate(){
    const templates = loadTemplates(); if(!templates.length){ alert("No templates saved yet."); return; }
    const names = templates.map((t,i)=> `${i+1}) ${t.templateName || ("Template " + (i+1))}`).join("\n");
    const choice = prompt("Choose a template number:\n\n" + names); if(!choice) return; const idx = Number(choice) - 1; if(idx < 0 || idx >= templates.length){ alert("Invalid choice."); return; }
    applyState(templates[idx]); autosave();
  }
  function resetForm(){
    if(!confirm("Reset the job card form? (Templates remain saved)")) return;
    companyLogoDataUrl = null;
    $("companyLogo").value = "";
    $("companyLogoPreview").innerHTML = `<p class="text-sm text-slate-400">No logo uploaded</p>`;
    [
      "companyName","companyVat","companyReg","companyEmail","companyPhone","companyWebsite","companyAddress","companyBank",
      "clientName","clientVat","clientReg","clientEmail","clientPhone","clientAddress",
      "jobReference","jobDescription","jobAssigned","notes","terms"
    ].forEach(id => { if($(id)) $(id).value = ""; });
    $("currency").value = "ZAR";
    $("jobStatus").value = "draft";
    $("amountPaid").value = "0.00";
    $("jobDeposit").value = "0.00";
    // Dates default
    const today = new Date();
    $("jobDate").value = today.toISOString().split("T")[0];
    const due = new Date(); due.setDate(due.getDate()+7);
    $("dueDate").value = due.toISOString().split("T")[0];
    generateJobNumber();
    $("itemsBody").innerHTML = "";
    addLineItem();
    calculateTotals();
    autosave();
  }

  // ===========================
  // Print (manual)
  // ===========================
  function printManual(){
    const dom = buildTemplateDom();
    const w = window.open("", "_blank"); if(!w){ alert("Pop-up blocked. Allow popups to print."); return; }
    const style = `
      <style>
        body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; margin:0; padding:20px; background:#fff;}
        .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
        table{width:100%; border-collapse:collapse;}
        th,td{border:1px solid #e5e7eb; padding:8px;}
        th{background:#f9fafb;}
      </style>
    `;
    w.document.write(`<html><head><title>Print Job Card</title>${style}</head><body></body></html>`);
    w.document.body.appendChild(dom);
    w.document.close();
    w.focus(); w.print();
  }

  // ===========================
  // Init + Events
  // ===========================
  function bind(){
    // meta changes recalc
    ["jobDeposit","amountPaid","currency","jobStatus"].forEach(id=>{
      $(id).addEventListener("input", () => { calculateTotals(); autosave(); });
      $(id).addEventListener("change", () => { calculateTotals(); autosave(); });
    });
    // general fields autosave
    [
      "companyName","companyVat","companyReg","companyEmail","companyPhone","companyWebsite","companyAddress","companyBank",
      "clientName","clientVat","clientReg","clientEmail","clientPhone","clientAddress",
      "jobNumber","jobReference","jobDate","dueDate","jobDescription","jobAssigned","notes","terms"
    ].forEach(id=>{
      $(id).addEventListener("input", autosave);
      $(id).addEventListener("change", autosave);
    });
    // logo
    $("companyLogo").addEventListener("change", (e)=> handleLogoUpload(e.target.files[0]));
    // buttons
    $("btnAddLine").addEventListener("click", ()=> { addLineItem(); autosave(); });
    $("btnPreview").addEventListener("click", openPreview);
    $("btnClosePreview").addEventListener("click", closePreview);
    $("btnClosePreviewBottom").addEventListener("click", closePreview);
    $("previewModal").addEventListener("click", (e)=>{ if(e.target === $("previewModal")) closePreview(); });
    $("btnPDF").addEventListener("click", exportPDF);
    $("btnPDF2").addEventListener("click", exportPDF);
    $("btnWord").addEventListener("click", exportWord);
    $("btnExcel").addEventListener("click", exportExcel);
    $("btnCSV").addEventListener("click", exportCSV);
    $("btnPrint").addEventListener("click", printManual);
    $("btnSaveTemplate").addEventListener("click", saveTemplate);
    $("btnLoadTemplate").addEventListener("click", pickAndLoadTemplate);
    $("btnReset").addEventListener("click", resetForm);
    $("btnNewNumber").addEventListener("click", ()=> { generateJobNumber(); autosave(); });
    $("btnMarkCompleted").addEventListener("click", ()=> {
      $("jobStatus").value = "completed";
      // When marking completed, set paid equal to grand total for clarity
      const t = calculateTotals();
      $("amountPaid").value = t.grand.toFixed(2);
      calculateTotals(); autosave();
    });
    // CSV import
    $("btnImportCSV").addEventListener("click", ()=> $("csvFile").click());
    $("csvFile").addEventListener("change", (e)=>{
      importCSV(e.target.files[0]);
      e.target.value = "";
    });
    // initial line
    if(document.querySelectorAll(".line-item").length === 0){ addLineItem(); }
  }
  function init(){
    // Dates default
    const today = new Date();
    $("jobDate").value = today.toISOString().split("T")[0];
    const due = new Date(); due.setDate(due.getDate()+7);
    $("dueDate").value = due.toISOString().split("T")[0];
    generateJobNumber();
    const loaded = loadAutosave();
    if(!loaded){
      addLineItem();
      calculateTotals();
      autosave();
    } else {
      calculateTotals();
    }
    setStatusBadge();
  }
  document.addEventListener("DOMContentLoaded", ()=>{ bind(); init(); });
</script>

</body>
</html>
