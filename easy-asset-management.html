<!DOCTYPE html>
<html lang="en-ZA" class="">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EasyASM – Asset Management | Easy Suite</title>
  <meta name="description" content="Asset register with assignments, service history, warranty tracking, depreciation, audit-ready exports, and offline-friendly templates." />

  <!-- Favicon -->
  <link rel="icon" href="icon.png" type="image/png">
  <link rel="apple-touch-icon" href="icon.png">

  <!-- Tailwind CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* ===== Easy Suite base tokens ===== */
    :root{
      --blue:#2563eb;
      --blue2:#1d4ed8;
      --ink:#0f172a;
      --muted:#64748b;
      --card:#ffffff;
      --line:#e5e7eb;
      --bg:#f8fafc;
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    html,body{font-family:var(--sans); background:var(--bg); color:var(--ink);}
    .container{max-width:1200px;}
    .mono{font-family:var(--mono);}
    .card{background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow:0 1px 2px rgba(15,23,42,.06);}
    .card-h{padding:14px 16px; border-bottom:1px solid var(--line);}
    .card-b{padding:16px;}
    .badge{display:inline-flex; align-items:center; gap:.4rem; padding:.2rem .55rem; border-radius:999px; font-size:.75rem; font-weight:700; border:1px solid var(--line); background:#fff;}
    .badge.ok{border-color:rgba(22,163,74,.25); background:rgba(22,163,74,.08); color:#166534;}
    .badge.warn{border-color:rgba(245,158,11,.25); background:rgba(245,158,11,.10); color:#92400e;}
    .badge.bad{border-color:rgba(239,68,68,.25); background:rgba(239,68,68,.10); color:#991b1b;}
    .pill{display:inline-flex; align-items:center; gap:.5rem; padding:.35rem .7rem; border-radius:999px; font-weight:700; font-size:.8rem; border:1px solid var(--line); background:#fff;}
    .kbd{font-family:var(--mono); font-size:.75rem; border:1px solid var(--line); border-bottom-width:2px; padding:.1rem .35rem; border-radius:6px; background:#fff;}
    .btn{display:inline-flex; align-items:center; gap:.55rem; padding:.55rem .85rem; border-radius:12px; font-weight:800; border:1px solid transparent; cursor:pointer; user-select:none; transition:all .15s ease;}
    .btn:disabled{opacity:.5; cursor:not-allowed;}
    .btn-primary{background:var(--blue); color:#fff;}
    .btn-primary:hover{background:var(--blue2);}
    .btn-outline{background:#fff; border-color:var(--line); color:var(--ink);}
    .btn-outline:hover{border-color:#cbd5e1; background:#f8fafc;}
    .btn-danger{background:#fee2e2; border-color:#fecaca; color:#991b1b;}
    .btn-danger:hover{background:#fecaca;}
    .input, .select, .textarea{
      width:100%;
      border:1px solid var(--line);
      border-radius:12px;
      padding:.6rem .75rem;
      background:#fff;
      outline:none;
    }
    .input:focus, .select:focus, .textarea:focus{border-color:#93c5fd; box-shadow:0 0 0 3px rgba(59,130,246,.15);}
    .textarea{min-height:100px;}
    .help{color:var(--muted); font-size:.85rem;}
    .table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border:1px solid var(--line); border-radius:14px; background:#fff;}
    .table th{font-size:.75rem; text-transform:uppercase; letter-spacing:.04em; color:#475569; background:#f8fafc; border-bottom:1px solid var(--line); padding:.6rem .6rem; text-align:left; position:sticky; top:0; z-index:1;}
    .table td{border-bottom:1px solid var(--line); padding:.6rem .6rem; vertical-align:top;}
    .table tr:last-child td{border-bottom:none;}
    .table .actions{white-space:nowrap;}
    .hr{height:1px; background:var(--line); margin:14px 0;}
    .toast{
      position:fixed; right:16px; bottom:16px; z-index:9999;
      width:min(420px, calc(100vw - 32px));
    }
    .toast-item{
      background:#0b1220; color:#e2e8f0; border:1px solid rgba(148,163,184,.2);
      border-radius:14px; padding:12px 14px; box-shadow:0 12px 30px rgba(0,0,0,.25);
      display:flex; gap:10px; align-items:flex-start;
    }
    .toast-item .ticon{margin-top:2px;}
    .toast-item .tmain{flex:1;}
    .toast-item .tmain .tt{font-weight:900;}
    .toast-item .tmain .tb{color:#cbd5e1; font-size:.9rem; margin-top:2px;}
    .toast-item .tclose{background:transparent; border:none; color:#94a3b8; cursor:pointer;}
    .hidden{display:none !important;}

    /* ===== Dark mode ===== */
    html.dark, body.dark { background:#0b1220; color:#e5e7eb; }
    html.dark .card, body.dark .card{background:#0f172a; border-color:rgba(148,163,184,.18);}
    html.dark .card-h{border-bottom-color:rgba(148,163,184,.18);}
    html.dark .btn-outline{background:#0f172a; color:#e5e7eb; border-color:rgba(148,163,184,.22);}
    html.dark .btn-outline:hover{background:#111c33;}
    html.dark .input, html.dark .select, html.dark .textarea{background:#0b1220; color:#e5e7eb; border-color:rgba(148,163,184,.22);}
    html.dark .table{background:#0f172a; border-color:rgba(148,163,184,.18);}
    html.dark .table th{background:#0b1220; border-bottom-color:rgba(148,163,184,.18); color:#cbd5e1;}
    html.dark .table td{border-bottom-color:rgba(148,163,184,.12);}
    html.dark .badge{background:#0b1220; border-color:rgba(148,163,184,.22);}
    html.dark .help{color:#94a3b8;}
    html.dark .hr{background:rgba(148,163,184,.18);}

    /* ===== Print (manual style) ===== */
    @media print{
      .no-print{display:none !important;}
      body{background:#fff !important; color:#000 !important;}
      .card{box-shadow:none !important; border-color:#ddd !important;}
      .table th{position:static !important;}
      a[href]:after{content:"";} /* no url tails */
      .print-wrap{padding:0 !important;}
      .print-title{display:block !important;}
    }
  </style>
</head>

<body class="min-h-screen">
  <!-- Top Nav -->
  <nav class="bg-blue-600 text-white py-4 no-print">
    <div class="container mx-auto px-4 flex flex-wrap items-center gap-4">
      <a data-safe-link="" href="index.html" class="font-black text-xl mr-4">Easy&nbsp;Suite</a>
      <a data-safe-link="" href="easy-quote.html" class="hover:underline">Quote</a>
      <a data-safe-link="" href="easy-invoice.html" class="hover:underline">Invoice</a>
      <a data-safe-link="" href="easy-purchase-order.html" class="hover:underline">Purchase&nbsp;Order</a>
      <a data-safe-link="" href="easy-sales-order.html" class="hover:underline">Sales&nbsp;Order</a>
      <a data-safe-link="" href="easy-receipt.html" class="hover:underline">Receipt</a>
      <a data-safe-link="" href="easy-statement.html" class="hover:underline">Statement</a>
      <a data-safe-link="" href="easy-job-card.html" class="hover:underline">Job&nbsp;Card</a>
      <a data-safe-link="" href="easy-payroll.html" class="hover:underline">Payroll</a>
      <a data-safe-link="" href="easy-inventory.html" class="hover:underline">Inventory</a>
      <a data-safe-link="" href="easy-crm.html" class="hover:underline">CRM</a>
      <a data-safe-link="" href="easy-asset-management.html" class="underline font-extrabold">Assets</a>

      <div class="ml-auto flex items-center gap-2">
        <button id="btnDark" class="btn btn-outline" title="Toggle dark mode (D)">
          <span class="mono">D</span> Dark
        </button>
        <button id="btnPrint" class="btn btn-outline" title="Print (manual style)">
          Print
        </button>
      </div>
    </div>
  </nav>

  <!-- Header -->
  <header class="bg-white border-b border-gray-200 no-print">
    <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row gap-4 sm:gap-0 items-start sm:items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-xl bg-blue-600 text-white flex items-center justify-center font-black">AM</div>
        <div>
          <h1 class="text-2xl font-extrabold text-blue-700">EasyASM</h1>
          <p class="text-sm text-gray-500">Asset Management (Register / Lifecycle / Assignments)</p>
        </div>
      </div>

      <div class="flex flex-wrap items-center gap-2">
        <a class="btn btn-outline" href="index.html" title="Back to dashboard">
          <i class="fa-solid fa-grid-2"></i> Dashboard
        </a>

        <button class="btn btn-outline" id="btnSaveTemplate" title="Save current asset register as a template">
          <i class="fa-solid fa-floppy-disk"></i> Save
        </button>
        <button class="btn btn-outline" id="btnLoadTemplate" title="Load a saved template">
          <i class="fa-solid fa-folder-open"></i> Load
        </button>
        <button class="btn btn-outline" id="btnReset" title="Reset form (keeps templates)">
          <i class="fa-solid fa-rotate-left"></i> Reset
        </button>

        <span class="ml-0 sm:ml-4 text-xs text-gray-500">
          Autosave: <span class="font-bold" id="autosaveStatus">On</span>
        </span>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-6 print-wrap">
    <!-- Print title (only visible in print) -->
    <div class="print-title hidden">
      <h1 class="text-2xl font-black">EasyASM — Asset Register</h1>
      <p class="text-sm">Audit-ready register export (manual style).</p>
      <div class="hr"></div>
    </div>

    <!-- Quick flow -->
    <div class="card p-4 mb-6 no-print">
      <div class="flex gap-3">
        <div class="text-blue-600 pt-0.5"><i class="fa-solid fa-circle-info"></i></div>
        <div class="flex-1">
          <h3 class="text-sm font-extrabold text-slate-900">Quick flow</h3>
          <div class="text-sm text-slate-600 mt-1">
            1) Company + asset owner → 2) Add assets (category, serial, value, location) → 3) Assign to users/branches →
            4) Track warranty/service + status → 5) Export/print asset register & audit list.
          </div>
        </div>
      </div>
    </div>

    <!-- Top stats + controls -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
      <div class="card lg:col-span-2">
        <div class="card-h flex items-center justify-between">
          <div class="flex items-center gap-2">
            <i class="fa-solid fa-building text-blue-600"></i>
            <div>
              <div class="font-black">Company & Register Settings</div>
              <div class="help">These details print on your register exports.</div>
            </div>
          </div>
          <span class="pill no-print" title="Keyboard shortcuts">
            <i class="fa-solid fa-keyboard"></i>
            <span><span class="kbd">Ctrl</span>+<span class="kbd">S</span> save, <span class="kbd">/</span> search</span>
          </span>
        </div>
        <div class="card-b grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="text-sm font-extrabold">Company Name</label>
            <input id="companyName" class="input mt-1" placeholder="e.g., Skunkworks (Pty) Ltd" />
            <div class="help mt-1">Shown on print exports and CSV header.</div>
          </div>
          <div>
            <label class="text-sm font-extrabold">Register Owner / Custodian</label>
            <input id="registerOwner" class="input mt-1" placeholder="e.g., IT Department / Finance" />
            <div class="help mt-1">Who maintains this register (audit trail).</div>
          </div>

          <div>
            <label class="text-sm font-extrabold">Default Currency</label>
            <select id="currency" class="select mt-1">
              <option value="ZAR">ZAR</option>
              <option value="USD">USD</option>
              <option value="EUR">EUR</option>
              <option value="GBP">GBP</option>
              <option value="BWP">BWP</option>
              <option value="RWF">RWF</option>
              <option value="XAF">XAF</option>
              <option value="MXN">MXN</option>
            </select>
            <div class="help mt-1">Used for totals and export formatting.</div>
          </div>

          <div>
            <label class="text-sm font-extrabold">Depreciation Method (simple)</label>
            <select id="depMethod" class="select mt-1">
              <option value="none">None</option>
              <option value="straight_line">Straight-line</option>
            </select>
            <div class="help mt-1">For quick book-value estimates (non-binding).</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-h">
          <div class="flex items-center gap-2">
            <i class="fa-solid fa-chart-simple text-blue-600"></i>
            <div>
              <div class="font-black">Register Snapshot</div>
              <div class="help">Calculated from current assets.</div>
            </div>
          </div>
        </div>
        <div class="card-b space-y-3">
          <div class="flex items-center justify-between">
            <div class="help">Assets</div>
            <div class="font-black text-xl" id="statAssets">0</div>
          </div>
          <div class="flex items-center justify-between">
            <div class="help">Assigned</div>
            <div class="font-black text-xl" id="statAssigned">0</div>
          </div>
          <div class="flex items-center justify-between">
            <div class="help">Total Cost</div>
            <div class="font-black text-xl" id="statTotalCost">—</div>
          </div>
          <div class="flex items-center justify-between">
            <div class="help">Book Value (est.)</div>
            <div class="font-black text-xl" id="statBookValue">—</div>
          </div>
          <div class="hr"></div>
          <div class="flex flex-wrap gap-2 no-print">
            <button class="btn btn-primary" id="btnAddAsset"><i class="fa-solid fa-plus"></i> Add Asset</button>
            <button class="btn btn-outline" id="btnExportCSV"><i class="fa-solid fa-file-csv"></i> Export CSV</button>
            <button class="btn btn-outline" id="btnExportJSON"><i class="fa-solid fa-file-code"></i> Export JSON</button>
            <button class="btn btn-outline" id="btnImport"><i class="fa-solid fa-file-import"></i> Import</button>
          </div>
          <input id="fileImport" type="file" accept=".json,.csv" class="hidden" />
        </div>
      </div>
    </section>

    <!-- Asset entry + filters -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
      <div class="card lg:col-span-2">
        <div class="card-h flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div class="flex items-center gap-2">
            <i class="fa-solid fa-warehouse text-blue-600"></i>
            <div>
              <div class="font-black">Asset Register</div>
              <div class="help">Add assets, assign them, track lifecycle, and export audit-ready lists.</div>
            </div>
          </div>

          <div class="flex flex-wrap items-center gap-2 no-print">
            <div class="relative w-full md:w-80">
              <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-gray-400"></i>
              <input id="search" class="input pl-9" placeholder="Search (name, tag, serial, user, location)  /" />
            </div>
            <select id="filterStatus" class="select w-full md:w-44" title="Filter by status">
              <option value="">All status</option>
              <option value="In Service">In Service</option>
              <option value="In Repair">In Repair</option>
              <option value="Retired">Retired</option>
              <option value="Lost/Stolen">Lost/Stolen</option>
              <option value="Disposed">Disposed</option>
            </select>
            <select id="filterCategory" class="select w-full md:w-44" title="Filter by category">
              <option value="">All categories</option>
              <option>Laptop</option>
              <option>Desktop</option>
              <option>Server</option>
              <option>Network</option>
              <option>Mobile</option>
              <option>Printer</option>
              <option>Furniture</option>
              <option>Other</option>
            </select>
          </div>
        </div>

        <div class="card-b">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 no-print">
            <div>
              <label class="text-sm font-extrabold">Asset Name</label>
              <input id="aName" class="input mt-1" placeholder="e.g., Dell Latitude 7420" />
            </div>
            <div>
              <label class="text-sm font-extrabold">Category</label>
              <select id="aCategory" class="select mt-1">
                <option>Laptop</option>
                <option>Desktop</option>
                <option>Server</option>
                <option>Network</option>
                <option>Mobile</option>
                <option>Printer</option>
                <option>Furniture</option>
                <option>Other</option>
              </select>
            </div>

            <div>
              <label class="text-sm font-extrabold">Asset Tag / ID</label>
              <input id="aTag" class="input mt-1" placeholder="e.g., IT-000123" />
              <div class="help mt-1">Must be unique (recommended).</div>
            </div>
            <div>
              <label class="text-sm font-extrabold">Serial Number</label>
              <input id="aSerial" class="input mt-1" placeholder="e.g., ABCD1234XYZ" />
            </div>

            <div>
              <label class="text-sm font-extrabold">Location</label>
              <input id="aLocation" class="input mt-1" placeholder="e.g., Johannesburg HQ / Floor 2" />
            </div>
            <div>
              <label class="text-sm font-extrabold">Department / Cost Centre</label>
              <input id="aDept" class="input mt-1" placeholder="e.g., IT / FIN / OPS" />
            </div>

            <div>
              <label class="text-sm font-extrabold">Purchase Date</label>
              <input id="aPurchaseDate" type="date" class="input mt-1" />
            </div>
            <div>
              <label class="text-sm font-extrabold">Purchase Cost</label>
              <input id="aCost" type="number" step="0.01" class="input mt-1" placeholder="0.00" />
            </div>

            <div>
              <label class="text-sm font-extrabold">Warranty Expiry</label>
              <input id="aWarranty" type="date" class="input mt-1" />
            </div>
            <div>
              <label class="text-sm font-extrabold">Status</label>
              <select id="aStatus" class="select mt-1">
                <option>In Service</option>
                <option>In Repair</option>
                <option>Retired</option>
                <option>Lost/Stolen</option>
                <option>Disposed</option>
              </select>
            </div>

            <div class="md:col-span-2">
              <label class="text-sm font-extrabold">Notes</label>
              <textarea id="aNotes" class="textarea mt-1" placeholder="Condition, specs, accessories, etc."></textarea>
            </div>

            <div class="md:col-span-2 flex flex-wrap gap-2">
              <button class="btn btn-primary" id="btnSaveAsset"><i class="fa-solid fa-check"></i> Save Asset</button>
              <button class="btn btn-outline" id="btnClearAsset"><i class="fa-solid fa-eraser"></i> Clear</button>
              <button class="btn btn-outline" id="btnGenerateTag" title="Auto-generate an asset tag"><i class="fa-solid fa-wand-magic-sparkles"></i> Generate Tag</button>
              <span class="help ml-auto flex items-center gap-2">
                Editing: <span id="editMode" class="badge">Off</span>
              </span>
            </div>
          </div>

          <div class="hr no-print"></div>

          <!-- Table -->
          <div class="overflow-auto">
            <table class="table">
              <thead>
                <tr>
                  <th style="min-width:220px">Asset</th>
                  <th style="min-width:120px">Tag</th>
                  <th style="min-width:160px">Serial</th>
                  <th style="min-width:140px">Category</th>
                  <th style="min-width:180px">Location</th>
                  <th style="min-width:180px">Assigned To</th>
                  <th style="min-width:150px">Status</th>
                  <th style="min-width:150px">Warranty</th>
                  <th style="min-width:140px">Cost</th>
                  <th style="min-width:160px">Book Value</th>
                  <th class="no-print actions" style="min-width:210px">Actions</th>
                </tr>
              </thead>
              <tbody id="assetTbody">
                <!-- rows -->
              </tbody>
            </table>
          </div>

          <div class="mt-3 flex flex-col sm:flex-row sm:items-center justify-between gap-3">
            <div class="help">
              Tip: click an asset’s <b>Tag</b> to copy it. Use <span class="kbd">/</span> to jump to search.
            </div>
            <div class="flex flex-wrap gap-2 no-print">
              <button class="btn btn-outline" id="btnAuditList"><i class="fa-solid fa-clipboard-check"></i> Audit List</button>
              <button class="btn btn-danger" id="btnClearAll"><i class="fa-solid fa-trash"></i> Clear All</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Assignment + Service panel -->
      <div class="space-y-6">
        <div class="card">
          <div class="card-h flex items-center justify-between">
            <div class="flex items-center gap-2">
              <i class="fa-solid fa-user-tag text-blue-600"></i>
              <div>
                <div class="font-black">Assignment</div>
                <div class="help">Assign the selected asset to a person or branch.</div>
              </div>
            </div>
            <span class="badge" id="selectedBadge">No asset selected</span>
          </div>

          <div class="card-b space-y-3">
            <div>
              <label class="text-sm font-extrabold">Assigned To (Name)</label>
              <input id="asUser" class="input mt-1" placeholder="e.g., Raydo Matthee" />
            </div>
            <div>
              <label class="text-sm font-extrabold">Assigned To (Email/ID)</label>
              <input id="asUserId" class="input mt-1" placeholder="e.g., raydo@company.com / staff-id" />
            </div>
            <div>
              <label class="text-sm font-extrabold">Assigned Date</label>
              <input id="asDate" type="date" class="input mt-1" />
            </div>
            <div class="flex flex-wrap gap-2 no-print">
              <button class="btn btn-primary" id="btnApplyAssignment"><i class="fa-solid fa-link"></i> Apply</button>
              <button class="btn btn-outline" id="btnClearAssignment"><i class="fa-solid fa-link-slash"></i> Unassign</button>
            </div>
            <div class="help">
              Assignments are stored per asset (audit-friendly). Changing assignment logs an entry automatically.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-h flex items-center justify-between">
            <div class="flex items-center gap-2">
              <i class="fa-solid fa-screwdriver-wrench text-blue-600"></i>
              <div>
                <div class="font-black">Service & Incident Log</div>
                <div class="help">Warranty claims, repairs, inspections.</div>
              </div>
            </div>
            <button class="btn btn-outline no-print" id="btnAddService"><i class="fa-solid fa-plus"></i> Add</button>
          </div>

          <div class="card-b">
            <div class="no-print grid grid-cols-1 gap-3 mb-3">
              <div>
                <label class="text-sm font-extrabold">Type</label>
                <select id="svType" class="select mt-1">
                  <option>Service</option>
                  <option>Repair</option>
                  <option>Warranty Claim</option>
                  <option>Inspection</option>
                  <option>Incident</option>
                </select>
              </div>
              <div>
                <label class="text-sm font-extrabold">Date</label>
                <input id="svDate" type="date" class="input mt-1" />
              </div>
              <div>
                <label class="text-sm font-extrabold">Vendor / Tech</label>
                <input id="svVendor" class="input mt-1" placeholder="e.g., Dell / Internal IT" />
              </div>
              <div>
                <label class="text-sm font-extrabold">Cost</label>
                <input id="svCost" type="number" step="0.01" class="input mt-1" placeholder="0.00" />
              </div>
              <div>
                <label class="text-sm font-extrabold">Details</label>
                <textarea id="svNotes" class="textarea mt-1" placeholder="Work performed, findings, reference numbers, etc."></textarea>
              </div>
              <button class="btn btn-primary" id="btnSaveService"><i class="fa-solid fa-check"></i> Save Log Entry</button>
            </div>

            <div class="overflow-auto">
              <table class="table">
                <thead>
                  <tr>
                    <th style="min-width:120px">Date</th>
                    <th style="min-width:160px">Type</th>
                    <th style="min-width:200px">Vendor</th>
                    <th style="min-width:140px">Cost</th>
                    <th style="min-width:360px">Details</th>
                    <th class="no-print" style="min-width:120px">Action</th>
                  </tr>
                </thead>
                <tbody id="serviceTbody">
                  <tr>
                    <td colspan="6" class="help">Select an asset to view its service log.</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="mt-3 help">
              Service history prints with the register (manual style) for the selected asset.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-h flex items-center gap-2">
            <i class="fa-solid fa-shield-halved text-blue-600"></i>
            <div>
              <div class="font-black">Compliance Notes</div>
              <div class="help">Operational best practices.</div>
            </div>
          </div>
          <div class="card-b text-sm space-y-2">
            <div class="flex gap-2">
              <i class="fa-solid fa-check text-green-600 mt-0.5"></i>
              <div><b>Unique asset tags</b> reduce audit ambiguity and speed up incident response.</div>
            </div>
            <div class="flex gap-2">
              <i class="fa-solid fa-check text-green-600 mt-0.5"></i>
              <div><b>Assignment history</b> supports chain-of-custody and reduces disputes.</div>
            </div>
            <div class="flex gap-2">
              <i class="fa-solid fa-check text-green-600 mt-0.5"></i>
              <div><b>Service logs</b> support warranty claims and preventative maintenance planning.</div>
            </div>
            <div class="flex gap-2">
              <i class="fa-solid fa-triangle-exclamation text-amber-600 mt-0.5"></i>
              <div>Book value is an estimate; align with your accounting policy for statutory reporting.</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Modal: Templates -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center p-4 no-print" aria-hidden="true">
      <div class="card w-full max-w-2xl">
        <div class="card-h flex items-center justify-between">
          <div class="font-black"><i class="fa-solid fa-folder-open text-blue-600"></i> Templates</div>
          <button class="btn btn-outline" id="btnCloseModal"><i class="fa-solid fa-xmark"></i> Close</button>
        </div>
        <div class="card-b">
          <div class="help mb-3">Templates store your company settings + full register snapshot.</div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
            <div class="md:col-span-2">
              <label class="text-sm font-extrabold">Template Name</label>
              <input id="tplName" class="input mt-1" placeholder="e.g., 2026 IT Asset Register" />
            </div>
            <div class="flex items-end">
              <button class="btn btn-primary w-full" id="btnTplSave"><i class="fa-solid fa-floppy-disk"></i> Save Template</button>
            </div>
          </div>

          <div class="overflow-auto">
            <table class="table">
              <thead>
                <tr>
                  <th>Template</th>
                  <th style="min-width:180px">Updated</th>
                  <th class="no-print" style="min-width:220px">Actions</th>
                </tr>
              </thead>
              <tbody id="tplTbody"></tbody>
            </table>
          </div>

          <div class="mt-3 flex flex-wrap gap-2 no-print">
            <button class="btn btn-outline" id="btnTplExportAll"><i class="fa-solid fa-file-arrow-down"></i> Export All Templates</button>
            <button class="btn btn-danger" id="btnTplClearAll"><i class="fa-solid fa-trash"></i> Delete All Templates</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: Audit List -->
    <div id="auditModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center p-4 no-print" aria-hidden="true">
      <div class="card w-full max-w-3xl">
        <div class="card-h flex items-center justify-between">
          <div class="font-black"><i class="fa-solid fa-clipboard-check text-blue-600"></i> Audit List</div>
          <button class="btn btn-outline" id="btnCloseAudit"><i class="fa-solid fa-xmark"></i> Close</button>
        </div>
        <div class="card-b">
          <div class="help mb-3">
            This is a quick field checklist export view (serial, tag, location, assignment, status).
            Use <b>Print</b> for an audit handout.
          </div>

          <div class="overflow-auto">
            <table class="table">
              <thead>
                <tr>
                  <th style="min-width:220px">Asset</th>
                  <th style="min-width:120px">Tag</th>
                  <th style="min-width:160px">Serial</th>
                  <th style="min-width:180px">Location</th>
                  <th style="min-width:180px">Assigned</th>
                  <th style="min-width:150px">Status</th>
                </tr>
              </thead>
              <tbody id="auditTbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <footer class="mt-10 mb-6 text-center text-xs text-gray-500 no-print">
      <div class="font-bold">EasyASM</div>
      <div>Offline-first asset register • Templates • CSV/JSON import/export • Print-friendly manual mode</div>
    </footer>
  </main>

  <!-- Toast stack -->
  <div class="toast no-print" id="toast"></div>

  <script>
    /********************
     * EasyASM v1 (offline-first)
     ********************/
    (function(){
      const KEY_STATE = "easy.asm.state.v1";
      const KEY_TPL   = "easy.asm.templates.v1";
      const KEY_DARK  = "easy.darkmode.v1";

      /** DOM */
      const $ = (id)=>document.getElementById(id);

      const els = {
        companyName: $("companyName"),
        registerOwner: $("registerOwner"),
        currency: $("currency"),
        depMethod: $("depMethod"),

        // Stats
        statAssets: $("statAssets"),
        statAssigned: $("statAssigned"),
        statTotalCost: $("statTotalCost"),
        statBookValue: $("statBookValue"),

        // Filters
        search: $("search"),
        filterStatus: $("filterStatus"),
        filterCategory: $("filterCategory"),

        // Asset form
        aName: $("aName"),
        aCategory: $("aCategory"),
        aTag: $("aTag"),
        aSerial: $("aSerial"),
        aLocation: $("aLocation"),
        aDept: $("aDept"),
        aPurchaseDate: $("aPurchaseDate"),
        aCost: $("aCost"),
        aWarranty: $("aWarranty"),
        aStatus: $("aStatus"),
        aNotes: $("aNotes"),

        editMode: $("editMode"),
        assetTbody: $("assetTbody"),

        // Selected
        selectedBadge: $("selectedBadge"),

        // Assignment
        asUser: $("asUser"),
        asUserId: $("asUserId"),
        asDate: $("asDate"),

        // Service
        svType: $("svType"),
        svDate: $("svDate"),
        svVendor: $("svVendor"),
        svCost: $("svCost"),
        svNotes: $("svNotes"),
        serviceTbody: $("serviceTbody"),

        // Buttons
        btnDark: $("btnDark"),
        btnPrint: $("btnPrint"),
        btnSaveTemplate: $("btnSaveTemplate"),
        btnLoadTemplate: $("btnLoadTemplate"),
        btnReset: $("btnReset"),

        btnAddAsset: $("btnAddAsset"),
        btnSaveAsset: $("btnSaveAsset"),
        btnClearAsset: $("btnClearAsset"),
        btnGenerateTag: $("btnGenerateTag"),

        btnApplyAssignment: $("btnApplyAssignment"),
        btnClearAssignment: $("btnClearAssignment"),

        btnAddService: $("btnAddService"),
        btnSaveService: $("btnSaveService"),

        btnExportCSV: $("btnExportCSV"),
        btnExportJSON: $("btnExportJSON"),
        btnImport: $("btnImport"),
        fileImport: $("fileImport"),

        btnAuditList: $("btnAuditList"),
        btnClearAll: $("btnClearAll"),

        autosaveStatus: $("autosaveStatus"),

        // Modal templates
        modal: $("modal"),
        btnCloseModal: $("btnCloseModal"),
        tplName: $("tplName"),
        btnTplSave: $("btnTplSave"),
        tplTbody: $("tplTbody"),
        btnTplExportAll: $("btnTplExportAll"),
        btnTplClearAll: $("btnTplClearAll"),

        // Audit modal
        auditModal: $("auditModal"),
        btnCloseAudit: $("btnCloseAudit"),
        auditTbody: $("auditTbody"),

        toast: $("toast"),
      };

      /** State */
      const state = {
        meta: {
          companyName: "",
          registerOwner: "",
          currency: "ZAR",
          depMethod: "none"
        },
        assets: [],
        selectedAssetId: null,
        editingAssetId: null,
        autosave: true,
        lastSavedAt: null
      };

      /** Util */
      const uid = ()=> "a_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
      const nowISO = ()=> new Date().toISOString();
      const toDate = (v)=> (v ? new Date(v) : null);
      const fmtMoney = (num, ccy)=>{
        const n = Number(num || 0);
        try{
          return new Intl.NumberFormat("en-ZA", { style:"currency", currency: ccy || "ZAR", maximumFractionDigits: 2 }).format(n);
        }catch(_){
          return (ccy||"") + " " + n.toFixed(2);
        }
      };
      const fmtShort = (iso)=>{
        if(!iso) return "—";
        const d = new Date(iso);
        if(Number.isNaN(d.getTime())) return "—";
        return d.toLocaleDateString("en-ZA", { year:"numeric", month:"short", day:"2-digit" });
      };
      const daysUntil = (iso)=>{
        if(!iso) return null;
        const d = new Date(iso);
        if(Number.isNaN(d.getTime())) return null;
        const ms = d.getTime() - Date.now();
        return Math.ceil(ms / (1000*60*60*24));
      };
      const safeText = (s)=> (s ?? "").toString();
      const clamp = (n, a, b)=> Math.max(a, Math.min(b, n));

      function toast(type, title, body){
        const icon = type==="ok" ? "fa-circle-check" : type==="warn" ? "fa-triangle-exclamation" : "fa-circle-xmark";
        const item = document.createElement("div");
        item.className = "toast-item";
        item.innerHTML = `
          <div class="ticon"><i class="fa-solid ${icon}"></i></div>
          <div class="tmain">
            <div class="tt">${escapeHtml(title)}</div>
            <div class="tb">${escapeHtml(body||"")}</div>
          </div>
          <button class="tclose" title="Dismiss"><i class="fa-solid fa-xmark"></i></button>
        `;
        item.querySelector(".tclose").addEventListener("click", ()=> item.remove());
        els.toast.appendChild(item);
        setTimeout(()=>{ try{ item.remove(); }catch(_){} }, 6000);
      }

      function escapeHtml(str){
        return safeText(str)
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }

      function setAutosave(on){
        state.autosave = !!on;
        els.autosaveStatus.textContent = on ? "On" : "Off";
      }

      function persist(){
        if(!state.autosave) return;
        try{
          state.lastSavedAt = nowISO();
          localStorage.setItem(KEY_STATE, JSON.stringify(state));
          els.autosaveStatus.textContent = "On";
        }catch(e){
          els.autosaveStatus.textContent = "Off";
          toast("bad","Autosave failed","Your browser storage may be full or blocked.");
        }
      }

      function loadState(){
        const raw = localStorage.getItem(KEY_STATE);
        if(!raw) return false;
        try{
          const parsed = JSON.parse(raw);
          if(parsed && typeof parsed === "object"){
            // merge safely
            if(parsed.meta) state.meta = Object.assign(state.meta, parsed.meta);
            if(Array.isArray(parsed.assets)) state.assets = parsed.assets;
            state.selectedAssetId = parsed.selectedAssetId || null;
            state.editingAssetId = parsed.editingAssetId || null;
            state.autosave = parsed.autosave !== false;
            state.lastSavedAt = parsed.lastSavedAt || null;
            return true;
          }
        }catch(_){}
        return false;
      }

      function setDark(on){
        const html = document.documentElement;
        const body = document.body;
        if(on){ html.classList.add("dark"); body.classList.add("dark"); }
        else { html.classList.remove("dark"); body.classList.remove("dark"); }
        localStorage.setItem(KEY_DARK, on ? "1" : "0");
      }

      function applyMetaToUI(){
        els.companyName.value = state.meta.companyName || "";
        els.registerOwner.value = state.meta.registerOwner || "";
        els.currency.value = state.meta.currency || "ZAR";
        els.depMethod.value = state.meta.depMethod || "none";
        setAutosave(state.autosave !== false);
      }

      function readMetaFromUI(){
        state.meta.companyName = els.companyName.value.trim();
        state.meta.registerOwner = els.registerOwner.value.trim();
        state.meta.currency = els.currency.value;
        state.meta.depMethod = els.depMethod.value;
      }

      function computeBookValue(asset){
        // Simple estimate: Straight-line over 36 months unless user chooses none.
        const method = state.meta.depMethod || "none";
        const cost = Number(asset.cost || 0);
        if(method === "none") return cost;

        // If no purchase date, return cost
        if(!asset.purchaseDate) return cost;

        const purchase = new Date(asset.purchaseDate);
        if(Number.isNaN(purchase.getTime())) return cost;

        const months = Math.max(0, (Date.now() - purchase.getTime()) / (1000*60*60*24*30.4375));
        const life = 36; // default 3 years
        const dep = clamp(months / life, 0, 1);
        const book = cost * (1 - dep);
        return Math.max(0, book);
      }

      function snapshotStats(){
        const ccy = state.meta.currency || "ZAR";
        const count = state.assets.length;
        const assigned = state.assets.filter(a=> a.assignment && (a.assignment.user || a.assignment.userId)).length;
        const totalCost = state.assets.reduce((s,a)=> s + Number(a.cost||0), 0);
        const book = state.assets.reduce((s,a)=> s + computeBookValue(a), 0);

        els.statAssets.textContent = String(count);
        els.statAssigned.textContent = String(assigned);
        els.statTotalCost.textContent = fmtMoney(totalCost, ccy);
        els.statBookValue.textContent = fmtMoney(book, ccy);
      }

      function statusBadge(status){
        if(status === "In Service") return `<span class="badge ok"><i class="fa-solid fa-circle-check"></i> ${escapeHtml(status)}</span>`;
        if(status === "In Repair") return `<span class="badge warn"><i class="fa-solid fa-screwdriver-wrench"></i> ${escapeHtml(status)}</span>`;
        if(status === "Retired" || status === "Disposed") return `<span class="badge"><i class="fa-solid fa-box-archive"></i> ${escapeHtml(status)}</span>`;
        if(status === "Lost/Stolen") return `<span class="badge bad"><i class="fa-solid fa-triangle-exclamation"></i> ${escapeHtml(status)}</span>`;
        return `<span class="badge">${escapeHtml(status||"—")}</span>`;
      }

      function warrantyBadge(warrantyIso){
        if(!warrantyIso) return `<span class="badge">—</span>`;
        const d = daysUntil(warrantyIso);
        if(d === null) return `<span class="badge">—</span>`;
        if(d < 0) return `<span class="badge bad"><i class="fa-solid fa-xmark"></i> Expired</span>`;
        if(d <= 30) return `<span class="badge warn"><i class="fa-solid fa-clock"></i> ${d}d</span>`;
        return `<span class="badge ok"><i class="fa-solid fa-shield"></i> ${d}d</span>`;
      }

      function getFilteredAssets(){
        const q = (els.search.value || "").trim().toLowerCase();
        const fs = els.filterStatus.value;
        const fc = els.filterCategory.value;

        return state.assets.filter(a=>{
          if(fs && (a.status !== fs)) return false;
          if(fc && (a.category !== fc)) return false;

          if(!q) return true;
          const hay = [
            a.name, a.tag, a.serial, a.category, a.location, a.dept,
            a.assignment?.user, a.assignment?.userId,
            a.notes
          ].filter(Boolean).join(" ").toLowerCase();
          return hay.includes(q);
        });
      }

      function renderAssets(){
        const ccy = state.meta.currency || "ZAR";
        const rows = getFilteredAssets().map(a=>{
          const assignedTo = (a.assignment && (a.assignment.user || a.assignment.userId))
            ? `${escapeHtml(a.assignment.user || "—")}<div class="help">${escapeHtml(a.assignment.userId || "")}</div>`
            : `<span class="help">Unassigned</span>`;

          const book = computeBookValue(a);
          const tagCell = `<button class="btn btn-outline" data-act="copyTag" data-id="${a.id}" title="Copy tag">${escapeHtml(a.tag||"—")}</button>`;

          return `
            <tr>
              <td>
                <div class="font-extrabold">${escapeHtml(a.name||"—")}</div>
                <div class="help">${escapeHtml(a.dept||"")}</div>
              </td>
              <td>${tagCell}</td>
              <td class="mono">${escapeHtml(a.serial||"—")}</td>
              <td>${escapeHtml(a.category||"—")}</td>
              <td>${escapeHtml(a.location||"—")}</td>
              <td>${assignedTo}</td>
              <td>${statusBadge(a.status)}</td>
              <td>${warrantyBadge(a.warranty)}</td>
              <td class="font-extrabold">${fmtMoney(a.cost||0, ccy)}</td>
              <td class="font-extrabold">${fmtMoney(book, ccy)}</td>
              <td class="no-print actions">
                <button class="btn btn-outline" data-act="select" data-id="${a.id}" title="Select / view service log">
                  <i class="fa-solid fa-crosshairs"></i> Select
                </button>
                <button class="btn btn-outline" data-act="edit" data-id="${a.id}" title="Edit asset">
                  <i class="fa-solid fa-pen-to-square"></i> Edit
                </button>
                <button class="btn btn-danger" data-act="del" data-id="${a.id}" title="Delete asset">
                  <i class="fa-solid fa-trash"></i> Delete
                </button>
              </td>
            </tr>
          `;
        }).join("");

        els.assetTbody.innerHTML = rows || `
          <tr>
            <td colspan="11" class="help">No assets yet. Click <b>Add Asset</b> to create your first entry.</td>
          </tr>
        `;
        snapshotStats();
        renderSelectedBadge();
      }

      function renderSelectedBadge(){
        const a = state.assets.find(x=> x.id === state.selectedAssetId);
        if(!a){
          els.selectedBadge.className = "badge";
          els.selectedBadge.innerHTML = `No asset selected`;
          els.serviceTbody.innerHTML = `
            <tr><td colspan="6" class="help">Select an asset to view its service log.</td></tr>
          `;
          return;
        }
        els.selectedBadge.className = "badge ok";
        els.selectedBadge.innerHTML = `<i class="fa-solid fa-crosshairs"></i> ${escapeHtml(a.tag || a.name || "Selected")}`;
        renderServiceLog(a);
        applySelectedToAssignmentUI(a);
      }

      function clearAssetForm(){
        els.aName.value = "";
        els.aCategory.value = "Laptop";
        els.aTag.value = "";
        els.aSerial.value = "";
        els.aLocation.value = "";
        els.aDept.value = "";
        els.aPurchaseDate.value = "";
        els.aCost.value = "";
        els.aWarranty.value = "";
        els.aStatus.value = "In Service";
        els.aNotes.value = "";
        state.editingAssetId = null;
        els.editMode.className = "badge";
        els.editMode.textContent = "Off";
      }

      function setEditMode(on){
        els.editMode.className = on ? "badge warn" : "badge";
        els.editMode.textContent = on ? "On" : "Off";
      }

      function generateTag(){
        // Format: AM-YYYY-000123
        const year = new Date().getFullYear();
        const seq = String(state.assets.length + 1).padStart(6, "0");
        return `AM-${year}-${seq}`;
      }

      function validateAssetInput(asset){
        if(!asset.name) return "Asset name is required.";
        if(asset.tag){
          const dup = state.assets.find(a=> a.tag && a.tag.toLowerCase() === asset.tag.toLowerCase() && a.id !== asset.id);
          if(dup) return "Asset tag must be unique (duplicate found).";
        }
        return null;
      }

      function saveAssetFromForm(){
        readMetaFromUI();

        const editingId = state.editingAssetId;
        const existing = editingId ? state.assets.find(a=> a.id === editingId) : null;

        const asset = existing ? existing : {
          id: uid(),
          createdAt: nowISO(),
          assignment: null,
          history: [],
          serviceLog: []
        };

        asset.updatedAt = nowISO();
        asset.name = els.aName.value.trim();
        asset.category = els.aCategory.value;
        asset.tag = els.aTag.value.trim();
        asset.serial = els.aSerial.value.trim();
        asset.location = els.aLocation.value.trim();
        asset.dept = els.aDept.value.trim();
        asset.purchaseDate = els.aPurchaseDate.value || "";
        asset.cost = Number(els.aCost.value || 0);
        asset.warranty = els.aWarranty.value || "";
        asset.status = els.aStatus.value;
        asset.notes = els.aNotes.value.trim();

        const err = validateAssetInput(asset);
        if(err){ toast("warn","Cannot save asset", err); return; }

        if(!existing){
          state.assets.unshift(asset);
          toast("ok","Asset added", `${asset.tag || asset.name} created.`);
        }else{
          toast("ok","Asset updated", `${asset.tag || asset.name} saved.`);
        }

        state.selectedAssetId = asset.id;
        state.editingAssetId = null;
        setEditMode(false);
        persist();
        clearAssetForm();
        renderAssets();
      }

      function editAsset(id){
        const a = state.assets.find(x=> x.id === id);
        if(!a) return;

        state.editingAssetId = a.id;
        setEditMode(true);

        els.aName.value = a.name || "";
        els.aCategory.value = a.category || "Laptop";
        els.aTag.value = a.tag || "";
        els.aSerial.value = a.serial || "";
        els.aLocation.value = a.location || "";
        els.aDept.value = a.dept || "";
        els.aPurchaseDate.value = a.purchaseDate || "";
        els.aCost.value = Number(a.cost || 0);
        els.aWarranty.value = a.warranty || "";
        els.aStatus.value = a.status || "In Service";
        els.aNotes.value = a.notes || "";

        toast("ok","Edit mode","Update fields and click Save Asset.");
      }

      function deleteAsset(id){
        const a = state.assets.find(x=> x.id === id);
        if(!a) return;

        const ok = confirm(`Delete asset "${a.tag || a.name}"? This cannot be undone.`);
        if(!ok) return;

        state.assets = state.assets.filter(x=> x.id !== id);
        if(state.selectedAssetId === id) state.selectedAssetId = null;
        if(state.editingAssetId === id) state.editingAssetId = null;

        persist();
        renderAssets();
        toast("ok","Deleted", "Asset removed from register.");
      }

      async function copyTag(id){
        const a = state.assets.find(x=> x.id === id);
        if(!a || !a.tag) return toast("warn","No tag","This asset has no tag to copy.");
        try{
          await navigator.clipboard.writeText(a.tag);
          toast("ok","Copied", `Tag copied: ${a.tag}`);
        }catch(_){
          // fallback
          const ta = document.createElement("textarea");
          ta.value = a.tag;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          ta.remove();
          toast("ok","Copied", `Tag copied: ${a.tag}`);
        }
      }

      function selectAsset(id){
        const a = state.assets.find(x=> x.id === id);
        if(!a) return;
        state.selectedAssetId = id;
        persist();
        renderSelectedBadge();
        toast("ok","Selected", `${a.tag || a.name} is selected.`);
      }

      function applySelectedToAssignmentUI(asset){
        const asn = asset.assignment || {};
        els.asUser.value = asn.user || "";
        els.asUserId.value = asn.userId || "";
        els.asDate.value = asn.date || "";
      }

      function applyAssignment(){
        const a = state.assets.find(x=> x.id === state.selectedAssetId);
        if(!a) return toast("warn","No selection","Select an asset first.");

        const newAsn = {
          user: els.asUser.value.trim(),
          userId: els.asUserId.value.trim(),
          date: els.asDate.value || ""
        };

        if(!newAsn.user && !newAsn.userId){
          return toast("warn","Missing assignee","Provide at least a name or an email/ID.");
        }

        const prev = a.assignment || null;
        a.assignment = newAsn;

        // history log
        a.history = Array.isArray(a.history) ? a.history : [];
        a.history.unshift({
          at: nowISO(),
          action: "ASSIGN",
          from: prev ? (prev.user || prev.userId || "—") : "Unassigned",
          to: newAsn.user || newAsn.userId || "—"
        });

        a.updatedAt = nowISO();
        persist();
        renderAssets();
        toast("ok","Assigned","Assignment applied and logged.");
      }

      function unassign(){
        const a = state.assets.find(x=> x.id === state.selectedAssetId);
        if(!a) return toast("warn","No selection","Select an asset first.");
        const prev = a.assignment || null;
        if(!prev) return toast("warn","Already unassigned","No assignment to clear.");

        a.assignment = null;
        a.history = Array.isArray(a.history) ? a.history : [];
        a.history.unshift({
          at: nowISO(),
          action: "UNASSIGN",
          from: prev.user || prev.userId || "—",
          to: "Unassigned"
        });
        a.updatedAt = nowISO();

        els.asUser.value = "";
        els.asUserId.value = "";
        els.asDate.value = "";

        persist();
        renderAssets();
        toast("ok","Unassigned","Assignment cleared and logged.");
      }

      function renderServiceLog(asset){
        const ccy = state.meta.currency || "ZAR";
        const list = Array.isArray(asset.serviceLog) ? asset.serviceLog : [];
        if(!list.length){
          els.serviceTbody.innerHTML = `<tr><td colspan="6" class="help">No service entries yet for this asset.</td></tr>`;
          return;
        }
        els.serviceTbody.innerHTML = list.map((e, idx)=>{
          return `
            <tr>
              <td>${fmtShort(e.date)}</td>
              <td>${escapeHtml(e.type||"—")}</td>
              <td>${escapeHtml(e.vendor||"—")}</td>
              <td class="font-extrabold">${fmtMoney(e.cost||0, ccy)}</td>
              <td>${escapeHtml(e.notes||"")}</td>
              <td class="no-print">
                <button class="btn btn-danger" data-act="delService" data-idx="${idx}">
                  <i class="fa-solid fa-trash"></i> Delete
                </button>
              </td>
            </tr>
          `;
        }).join("");
      }

      function saveServiceEntry(){
        const a = state.assets.find(x=> x.id === state.selectedAssetId);
        if(!a) return toast("warn","No selection","Select an asset first.");

        const entry = {
          type: els.svType.value,
          date: els.svDate.value || "",
          vendor: els.svVendor.value.trim(),
          cost: Number(els.svCost.value || 0),
          notes: els.svNotes.value.trim(),
          at: nowISO()
        };

        if(!entry.date) return toast("warn","Missing date","Select a date for the service entry.");

        a.serviceLog = Array.isArray(a.serviceLog) ? a.serviceLog : [];
        a.serviceLog.unshift(entry);

        // history
        a.history = Array.isArray(a.history) ? a.history : [];
        a.history.unshift({
          at: nowISO(),
          action: "SERVICE",
          from: "",
          to: `${entry.type} (${fmtShort(entry.date)})`
        });

        a.updatedAt = nowISO();
        persist();
        renderSelectedBadge();
        toast("ok","Service entry saved","Logged against selected asset.");

        // Clear service inputs
        els.svVendor.value = "";
        els.svCost.value = "";
        els.svNotes.value = "";
      }

      function deleteService(idx){
        const a = state.assets.find(x=> x.id === state.selectedAssetId);
        if(!a) return;
        a.serviceLog = Array.isArray(a.serviceLog) ? a.serviceLog : [];
        const e = a.serviceLog[idx];
        const ok = confirm("Delete this service entry?");
        if(!ok) return;
        a.serviceLog.splice(idx, 1);
        a.updatedAt = nowISO();
        persist();
        renderSelectedBadge();
        toast("ok","Deleted","Service entry removed.");
      }

      /** Export / Import */
      function exportJSON(filename = "easy-asset-register.json", dataObj = null){
        readMetaFromUI();
        const payload = dataObj || {
          exportedAt: nowISO(),
          app: "EasyASM",
          version: "1.0",
          state: state
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
        downloadBlob(blob, filename);
      }

      function exportCSV(){
        readMetaFromUI();
        const ccy = state.meta.currency || "ZAR";
        const cols = [
          "Company","RegisterOwner","Currency",
          "AssetName","Category","Tag","Serial","Location","Department","PurchaseDate","Cost","WarrantyExpiry","Status",
          "AssignedTo","AssignedId","AssignedDate","Notes"
        ];
        const lines = [];
        lines.push(cols.join(","));
        state.assets.forEach(a=>{
          const row = [
            state.meta.companyName,
            state.meta.registerOwner,
            ccy,
            a.name, a.category, a.tag, a.serial, a.location, a.dept, a.purchaseDate, Number(a.cost||0), a.warranty, a.status,
            a.assignment?.user || "",
            a.assignment?.userId || "",
            a.assignment?.date || "",
            (a.notes||"").replaceAll("\n"," ")
          ].map(csvEscape);
          lines.push(row.join(","));
        });
        const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
        downloadBlob(blob, "easy-asset-register.csv");
      }

      function csvEscape(v){
        const s = safeText(v);
        if(s.includes(",") || s.includes('"') || s.includes("\n")){
          return '"' + s.replaceAll('"','""') + '"';
        }
        return s;
      }

      function downloadBlob(blob, filename){
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(()=>URL.revokeObjectURL(url), 1000);
      }

      async function importFile(file){
        const ext = (file.name.split(".").pop() || "").toLowerCase();
        const text = await file.text();

        if(ext === "json"){
          try{
            const obj = JSON.parse(text);
            const importedState = obj.state ? obj.state : obj;
            if(importedState && importedState.assets){
              // Replace state (safe merge)
              state.meta = Object.assign(state.meta, importedState.meta || {});
              state.assets = Array.isArray(importedState.assets) ? importedState.assets : [];
              state.selectedAssetId = null;
              state.editingAssetId = null;
              toast("ok","Imported JSON","Register updated from JSON import.");
              persist();
              applyMetaToUI();
              clearAssetForm();
              renderAssets();
              return;
            }
          }catch(e){
            return toast("bad","Import failed","Invalid JSON file.");
          }
          return toast("bad","Import failed","JSON format not recognized.");
        }

        if(ext === "csv"){
          // Minimal CSV parser (expects headers like exportCSV)
          const rows = parseCSV(text);
          if(!rows.length) return toast("bad","Import failed","CSV appears empty.");
          const header = rows[0].map(h=>h.trim());
          const idx = (name)=> header.indexOf(name);

          const required = ["AssetName","Category","Tag","Serial","Location","Department","PurchaseDate","Cost","WarrantyExpiry","Status"];
          const missing = required.filter(r=> idx(r) === -1);
          if(missing.length){
            return toast("bad","Import failed","CSV missing required columns: " + missing.join(", "));
          }

          const newAssets = [];
          for(let i=1;i<rows.length;i++){
            const r = rows[i];
            if(!r || !r.length) continue;
            const name = r[idx("AssetName")] || "";
            if(!name.trim()) continue;

            const asset = {
              id: uid(),
              createdAt: nowISO(),
              updatedAt: nowISO(),
              name: name.trim(),
              category: (r[idx("Category")] || "Other").trim(),
              tag: (r[idx("Tag")] || "").trim(),
              serial: (r[idx("Serial")] || "").trim(),
              location: (r[idx("Location")] || "").trim(),
              dept: (r[idx("Department")] || "").trim(),
              purchaseDate: (r[idx("PurchaseDate")] || "").trim(),
              cost: Number((r[idx("Cost")] || "0").toString().replaceAll(" ","")) || 0,
              warranty: (r[idx("WarrantyExpiry")] || "").trim(),
              status: (r[idx("Status")] || "In Service").trim(),
              notes: (r[idx("Notes")] || "").trim(),
              assignment: {
                user: (r[idx("AssignedTo")] || "").trim(),
                userId: (r[idx("AssignedId")] || "").trim(),
                date: (r[idx("AssignedDate")] || "").trim()
              },
              history: [],
              serviceLog: []
            };
            // Normalize empty assignment
            if(!asset.assignment.user && !asset.assignment.userId) asset.assignment = null;

            const err = validateAssetInput(asset);
            if(err){
              // If duplicate tag exists inside the imported set, auto-clear it (prefer import success)
              if(err.toLowerCase().includes("unique")){
                asset.tag = "";
              }
            }
            newAssets.push(asset);
          }

          // Try to read meta columns if present
          const compI = idx("Company");
          const ownI = idx("RegisterOwner");
          const curI = idx("Currency");
          if(compI !== -1 && rows[1] && rows[1][compI]) state.meta.companyName = rows[1][compI] || state.meta.companyName;
          if(ownI !== -1 && rows[1] && rows[1][ownI]) state.meta.registerOwner = rows[1][ownI] || state.meta.registerOwner;
          if(curI !== -1 && rows[1] && rows[1][curI]) state.meta.currency = rows[1][curI] || state.meta.currency;

          state.assets = newAssets.concat(state.assets); // prepend imported
          state.selectedAssetId = null;
          state.editingAssetId = null;

          toast("ok","Imported CSV", `${newAssets.length} assets imported.`);
          persist();
          applyMetaToUI();
          renderAssets();
          return;
        }

        toast("warn","Unsupported file","Please import a .json or .csv file.");
      }

      function parseCSV(text){
        const rows = [];
        let row = [];
        let cur = "";
        let inQuotes = false;

        for(let i=0;i<text.length;i++){
          const ch = text[i];
          const next = text[i+1];

          if(ch === '"' && inQuotes && next === '"'){ cur += '"'; i++; continue; }
          if(ch === '"'){ inQuotes = !inQuotes; continue; }

          if(ch === "," && !inQuotes){ row.push(cur); cur=""; continue; }
          if((ch === "\n" || ch === "\r") && !inQuotes){
            if(ch === "\r" && next === "\n") i++;
            row.push(cur);
            rows.push(row);
            row = [];
            cur = "";
            continue;
          }
          cur += ch;
        }
        if(cur.length || row.length){ row.push(cur); rows.push(row); }
        // remove empty trailing rows
        return rows.filter(r=> r.some(c=> (c||"").trim() !== ""));
      }

      /** Templates */
      function loadTemplates(){
        const raw = localStorage.getItem(KEY_TPL);
        if(!raw) return [];
        try{
          const arr = JSON.parse(raw);
          return Array.isArray(arr) ? arr : [];
        }catch(_){
          return [];
        }
      }

      function saveTemplates(arr){
        localStorage.setItem(KEY_TPL, JSON.stringify(arr));
      }

      function openModal(){
        renderTemplates();
        els.modal.classList.remove("hidden");
        els.modal.classList.add("flex");
        els.modal.setAttribute("aria-hidden","false");
      }

      function closeModal(){
        els.modal.classList.add("hidden");
        els.modal.classList.remove("flex");
        els.modal.setAttribute("aria-hidden","true");
      }

      function renderTemplates(){
        const tpls = loadTemplates();
        els.tplTbody.innerHTML = tpls.map(t=>{
          return `
            <tr>
              <td>
                <div class="font-extrabold">${escapeHtml(t.name)}</div>
                <div class="help">${escapeHtml(t.app||"EasyASM")} • ${escapeHtml(t.version||"")}</div>
              </td>
              <td>${fmtShort(t.updatedAt)}</td>
              <td class="no-print">
                <div class="flex flex-wrap gap-2">
                  <button class="btn btn-primary" data-act="tplLoad" data-id="${t.id}">
                    <i class="fa-solid fa-arrow-rotate-right"></i> Load
                  </button>
                  <button class="btn btn-outline" data-act="tplExport" data-id="${t.id}">
                    <i class="fa-solid fa-file-arrow-down"></i> Export
                  </button>
                  <button class="btn btn-danger" data-act="tplDel" data-id="${t.id}">
                    <i class="fa-solid fa-trash"></i> Delete
                  </button>
                </div>
              </td>
            </tr>
          `;
        }).join("") || `<tr><td colspan="3" class="help">No templates saved yet.</td></tr>`;
      }

      function saveTemplate(name){
        readMetaFromUI();
        const tpls = loadTemplates();
        const tpl = {
          id: "t_" + Math.random().toString(16).slice(2),
          name: name || ("Template " + new Date().toLocaleString("en-ZA")),
          app: "EasyASM",
          version: "1.0",
          updatedAt: nowISO(),
          payload: {
            meta: state.meta,
            assets: state.assets
          }
        };
        tpls.unshift(tpl);
        saveTemplates(tpls);
        toast("ok","Template saved", tpl.name);
        renderTemplates();
      }

      function loadTemplate(id){
        const tpls = loadTemplates();
        const tpl = tpls.find(t=> t.id === id);
        if(!tpl) return;

        const ok = confirm(`Load template "${tpl.name}"?\nThis will replace your current register in the page (your current state is still in autosave unless you reset).`);
        if(!ok) return;

        state.meta = Object.assign(state.meta, tpl.payload?.meta || {});
        state.assets = Array.isArray(tpl.payload?.assets) ? tpl.payload.assets : [];
        state.selectedAssetId = null;
        state.editingAssetId = null;

        persist();
        applyMetaToUI();
        clearAssetForm();
        renderAssets();
        closeModal();
        toast("ok","Template loaded", tpl.name);
      }

      function deleteTemplate(id){
        const tpls = loadTemplates();
        const t = tpls.find(x=> x.id === id);
        const ok = confirm(`Delete template "${t?.name || id}"?`);
        if(!ok) return;

        saveTemplates(tpls.filter(x=> x.id !== id));
        toast("ok","Deleted","Template removed.");
        renderTemplates();
      }

      function exportTemplate(id){
        const tpls = loadTemplates();
        const tpl = tpls.find(t=> t.id === id);
        if(!tpl) return;
        exportJSON(`easy-asm-template-${(tpl.name||"template").replaceAll(" ","_")}.json`, tpl);
        toast("ok","Exported","Template downloaded as JSON.");
      }

      function exportAllTemplates(){
        const tpls = loadTemplates();
        exportJSON("easy-asm-templates.json", { exportedAt: nowISO(), app:"EasyASM", version:"1.0", templates: tpls });
        toast("ok","Exported","All templates downloaded.");
      }

      function clearAllTemplates(){
        const ok = confirm("Delete ALL templates? This cannot be undone.");
        if(!ok) return;
        saveTemplates([]);
        renderTemplates();
        toast("ok","Cleared","All templates removed.");
      }

      /** Audit list modal */
      function openAudit(){
        renderAuditTable();
        els.auditModal.classList.remove("hidden");
        els.auditModal.classList.add("flex");
        els.auditModal.setAttribute("aria-hidden","false");
      }
      function closeAudit(){
        els.auditModal.classList.add("hidden");
        els.auditModal.classList.remove("flex");
        els.auditModal.setAttribute("aria-hidden","true");
      }
      function renderAuditTable(){
        const rows = getFilteredAssets().map(a=>{
          const assigned = a.assignment ? (a.assignment.user || a.assignment.userId || "—") : "Unassigned";
          return `
            <tr>
              <td><div class="font-extrabold">${escapeHtml(a.name||"—")}</div><div class="help">${escapeHtml(a.category||"")}</div></td>
              <td class="mono">${escapeHtml(a.tag||"—")}</td>
              <td class="mono">${escapeHtml(a.serial||"—")}</td>
              <td>${escapeHtml(a.location||"—")}</td>
              <td>${escapeHtml(assigned)}</td>
              <td>${escapeHtml(a.status||"—")}</td>
            </tr>
          `;
        }).join("");
        els.auditTbody.innerHTML = rows || `<tr><td colspan="6" class="help">No assets in current filter.</td></tr>`;
      }

      /** Reset / Clear */
      function resetAll(){
        const ok = confirm("Reset this page to defaults?\nThis clears the current register state (templates remain).");
        if(!ok) return;
        localStorage.removeItem(KEY_STATE);

        // reset state object
        state.meta = { companyName:"", registerOwner:"", currency:"ZAR", depMethod:"none" };
        state.assets = [];
        state.selectedAssetId = null;
        state.editingAssetId = null;
        state.autosave = true;
        state.lastSavedAt = null;

        applyMetaToUI();
        clearAssetForm();
        renderAssets();
        toast("ok","Reset complete","Register cleared (templates kept).");
      }

      function clearAllAssets(){
        const ok = confirm("Clear ALL assets in the register? This cannot be undone (unless you have a template/export).");
        if(!ok) return;
        state.assets = [];
        state.selectedAssetId = null;
        state.editingAssetId = null;
        persist();
        renderAssets();
        toast("ok","Cleared","All assets removed.");
      }

      /** Events */
      function wireEvents(){
        // Dark
        const savedDark = localStorage.getItem(KEY_DARK);
        if(savedDark === "1") setDark(true);

        els.btnDark.addEventListener("click", ()=> {
          const on = !document.documentElement.classList.contains("dark");
          setDark(on);
        });

        document.addEventListener("keydown", (e)=>{
          // D toggle
          if(e.key && e.key.toLowerCase() === "d" && !e.ctrlKey && !e.metaKey && !e.altKey){
            setDark(!document.documentElement.classList.contains("dark"));
          }
          // / search focus
          if(e.key === "/" && !e.ctrlKey && !e.metaKey && !e.altKey){
            e.preventDefault();
            els.search.focus();
          }
          // Ctrl+S to open templates save modal
          if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "s"){
            e.preventDefault();
            openModal();
            els.tplName.focus();
          }
        });

        // Print
        els.btnPrint.addEventListener("click", ()=> window.print());

        // Meta autosave
        [els.companyName, els.registerOwner, els.currency, els.depMethod].forEach(el=>{
          el.addEventListener("input", ()=> { readMetaFromUI(); persist(); snapshotStats(); });
          el.addEventListener("change", ()=> { readMetaFromUI(); persist(); snapshotStats(); renderAssets(); });
        });

        // Filters
        [els.search, els.filterStatus, els.filterCategory].forEach(el=>{
          el.addEventListener("input", renderAssets);
          el.addEventListener("change", renderAssets);
        });

        // Form buttons
        els.btnAddAsset.addEventListener("click", ()=>{
          clearAssetForm();
          toast("ok","Add asset","Fill in details and click Save Asset.");
          window.scrollTo({top: 0, behavior:"smooth"});
        });

        els.btnGenerateTag.addEventListener("click", ()=>{
          els.aTag.value = generateTag();
        });

        els.btnSaveAsset.addEventListener("click", saveAssetFromForm);
        els.btnClearAsset.addEventListener("click", ()=> { clearAssetForm(); setEditMode(false); });

        // Assignment
        els.btnApplyAssignment.addEventListener("click", applyAssignment);
        els.btnClearAssignment.addEventListener("click", unassign);

        // Service
        els.btnAddService.addEventListener("click", ()=>{
          if(!state.selectedAssetId) return toast("warn","No selection","Select an asset first.");
          els.svDate.value = new Date().toISOString().slice(0,10);
          els.svNotes.focus();
        });
        els.btnSaveService.addEventListener("click", saveServiceEntry);

        // Export/Import
        els.btnExportCSV.addEventListener("click", exportCSV);
        els.btnExportJSON.addEventListener("click", ()=> exportJSON());
        els.btnImport.addEventListener("click", ()=> els.fileImport.click());
        els.fileImport.addEventListener("change", async (e)=>{
          const f = e.target.files && e.target.files[0];
          if(!f) return;
          await importFile(f);
          els.fileImport.value = "";
        });

        // Templates
        els.btnSaveTemplate.addEventListener("click", ()=> { openModal(); });
        els.btnLoadTemplate.addEventListener("click", ()=> { openModal(); });
        els.btnCloseModal.addEventListener("click", closeModal);
        els.btnTplSave.addEventListener("click", ()=>{
          const name = els.tplName.value.trim();
          if(!name) return toast("warn","Template name required","Enter a name then save.");
          saveTemplate(name);
          els.tplName.value = "";
        });
        els.btnTplExportAll.addEventListener("click", exportAllTemplates);
        els.btnTplClearAll.addEventListener("click", clearAllTemplates);

        els.modal.addEventListener("click", (e)=>{
          if(e.target === els.modal) closeModal();
        });

        els.tplTbody.addEventListener("click", (e)=>{
          const btn = e.target.closest("button");
          if(!btn) return;
          const act = btn.getAttribute("data-act");
          const id = btn.getAttribute("data-id");
          if(act === "tplLoad") return loadTemplate(id);
          if(act === "tplDel") return deleteTemplate(id);
          if(act === "tplExport") return exportTemplate(id);
        });

        // Audit list
        els.btnAuditList.addEventListener("click", openAudit);
        els.btnCloseAudit.addEventListener("click", closeAudit);
        els.auditModal.addEventListener("click", (e)=>{
          if(e.target === els.auditModal) closeAudit();
        });

        // Reset/Clear
        els.btnReset.addEventListener("click", resetAll);
        els.btnClearAll.addEventListener("click", clearAllAssets);

        // Table actions
        els.assetTbody.addEventListener("click", (e)=>{
          const btn = e.target.closest("button");
          if(!btn) return;
          const act = btn.getAttribute("data-act");
          const id = btn.getAttribute("data-id");
          if(act === "edit") return editAsset(id);
          if(act === "del") return deleteAsset(id);
          if(act === "select") return selectAsset(id);
          if(act === "copyTag") return copyTag(id);
        });

        // Service delete actions
        els.serviceTbody.addEventListener("click", (e)=>{
          const btn = e.target.closest("button");
          if(!btn) return;
          const act = btn.getAttribute("data-act");
          if(act !== "delService") return;
          const idx = Number(btn.getAttribute("data-idx"));
          if(Number.isNaN(idx)) return;
          deleteService(idx);
        });
      }

      /** Init */
      function init(){
        const loaded = loadState();
        applyMetaToUI();
        renderAssets();

        // Choose a sensible default dates (no selection needed)
        els.aPurchaseDate.value = "";
        els.asDate.value = "";
        els.svDate.value = new Date().toISOString().slice(0,10);

        wireEvents();

        // First run toast
        if(!loaded){
          toast("ok","EasyASM ready","Offline-first asset register initialized.");
        }
      }

      init();
    })();
  </script>
</body>
</html>
