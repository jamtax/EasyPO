<!DOCTYPE html>
<html lang="en-ZA">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Easy CRM | Easy Suite</title>
  <meta name="description" content="Easy CRM – manage contacts, pipeline, follow-ups, and activity. Offline-first with CSV/JSON import/export." />

  <!-- Favicons (remote + optional local fallback) -->
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/jamtax/EasyPO/refs/heads/main/logo.png">
  <link rel="shortcut icon" href="https://raw.githubusercontent.com/jamtax/EasyPO/refs/heads/main/logo.png">
  <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/jamtax/EasyPO/refs/heads/main/logo.png">
  <!-- Optional local icons if you have them in the same folder -->
  <link rel="icon" href="icon.png" type="image/png">
  <link rel="icon" href="favicon.ico" type="image/x-icon">

  <!-- Tailwind (CDN) -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">

  <style>
    :root{
      --primary:#2563eb;
      --primary2:#1d4ed8;
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --danger:#dc2626;
      --success:#16a34a;
      --warning:#f59e0b;
      --shadow: 0 10px 25px rgba(2,6,23,.06);
    }
    body{background:var(--bg); color:var(--text);}
    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow);}
    .btn{display:inline-flex; align-items:center; justify-content:center; gap:.5rem; padding:.6rem 1rem; border-radius:10px; font-weight:800; border:1px solid transparent; transition:.15s; user-select:none;}
    .btn:hover{transform:translateY(-1px);}
    .btn-primary{background:var(--primary); color:#fff;}
    .btn-primary:hover{background:var(--primary2);}
    .btn-outline{background:#fff; border-color:var(--border); color:var(--text);}
    .btn-outline:hover{background:#f8fafc; border-color:#cbd5e1;}
    .btn-danger{background:var(--danger); color:#fff;}
    .btn-success{background:var(--success); color:#fff;}
    .btn-warning{background:var(--warning); color:#111827;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,"Liberation Mono","Courier New", monospace;}
    .responsive-table{overflow-x:auto; -webkit-overflow-scrolling:touch;}
    .pill{display:inline-flex; align-items:center; padding:.2rem .6rem; border-radius:999px; font-weight:900; font-size:.75rem;}
    .pill-lead{background:#eef2ff; color:#3730a3;}
    .pill-prospect{background:#ecfeff; color:#155e75;}
    .pill-client{background:#dcfce7; color:#166534;}
    .pill-inactive{background:#f1f5f9; color:#334155;}
    .pill-overdue{background:#fee2e2; color:#991b1b;}
    .modal-backdrop{background: rgba(2,6,23,.65);}
    .toast{position:fixed; right:16px; bottom:16px; z-index:9999;}
    .toast > div{background:rgba(2,6,23,.92); color:#fff; border-radius:12px; padding:12px 14px; max-width:380px; box-shadow:0 14px 35px rgba(2,6,23,.25);}
    .kbd{border:1px solid var(--border); border-bottom-width:2px; border-radius:8px; padding:1px 6px; font-weight:900; font-size:12px; background:#fff;}
    .dark body, body.dark{background:#0b1220; color:#e5e7eb;}
    body.dark .card{background:#0f172a; border-color:#1f2937; box-shadow:none;}
    body.dark .btn-outline{background:#0b1220; border-color:#1f2937; color:#e5e7eb;}
    body.dark input, body.dark select, body.dark textarea{background:#0b1220 !important; color:#e5e7eb !important; border-color:#1f2937 !important;}
    body.dark thead{background:#0b1220 !important;}
    body.dark .text-slate-600, body.dark .text-gray-600, body.dark .text-gray-500{color:#9ca3af !important;}

    input:focus, textarea:focus, select:focus{
      outline:none!important;
      border-color: rgba(37, 99, 235, .85)!important;
      box-shadow:0 0 0 3px rgba(37,99,235,.15)!important;
    }

    /* Print */
    @media print{
      .no-print{display:none !important;}
      body{background:#fff !important;}
      .card{box-shadow:none !important; border:none !important;}
      thead{display:table-header-group;}
      tfoot{display:table-footer-group;}
      tr{page-break-inside:avoid;}
    }
  </style>
</head>

<body class="min-h-screen">

  <!-- NAV -->
  <nav class="bg-blue-600 text-white py-4 no-print">
    <div class="container mx-auto px-4 flex flex-wrap items-center gap-4">
      <a data-safe-link href="index.html" class="font-black text-xl mr-4">Easy&nbsp;Suite</a>
      <a data-safe-link href="easy-quote.html" class="hover:underline">Quote</a>
      <a data-safe-link href="easy-invoice.html" class="hover:underline">Invoice</a>
      <a data-safe-link href="easy-purchase-order.html" class="hover:underline">Purchase&nbsp;Order</a>
      <a data-safe-link href="easy-sales-order.html" class="hover:underline">Sales&nbsp;Order</a>
      <a data-safe-link href="easy-receipt.html" class="hover:underline">Receipt</a>
      <a data-safe-link href="easy-statement.html" class="hover:underline">Statement</a>
      <a data-safe-link href="easy-job-card.html" class="hover:underline">Job&nbsp;Card</a>
      <a data-safe-link href="easy-payroll.html" class="hover:underline">Payroll</a>
      <a data-safe-link href="easy-inventory.html" class="hover:underline">Inventory</a>
      <a data-safe-link href="easy-crm.html" class="underline font-extrabold">CRM</a>

      <div class="ml-auto flex items-center gap-2">
        <button id="btnDark" class="btn btn-outline" title="Toggle dark mode (D)">
          <span class="mono">D</span> Dark
        </button>
        <button id="btnPrint" class="btn btn-outline" title="Print (manual style)">
          Print
        </button>
      </div>
    </div>
  </nav>

  <main class="container mx-auto px-4 py-8">

    <!-- HEADER -->
    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-6">
      <div>
        <h1 class="text-3xl font-extrabold text-slate-900">Easy CRM</h1>
        <p class="text-sm text-slate-600 mt-1">
          Contacts + pipeline + follow-ups + activity log. Works offline (LocalStorage).
          <span class="hidden md:inline">Tips: <span class="kbd">Ctrl</span>+<span class="kbd">K</span> focuses search.</span>
        </p>
      </div>

      <div class="flex flex-wrap gap-2 no-print">
        <button class="btn btn-outline" id="btnSeed">Seed Demo Data</button>
        <button class="btn btn-outline" id="btnExportCSV">Export CSV</button>
        <button class="btn btn-outline" id="btnImportCSV">Import CSV</button>
        <input class="hidden" type="file" id="csvFile" accept=".csv" />
        <button class="btn btn-outline" id="btnBackup">Backup JSON</button>
        <button class="btn btn-outline" id="btnRestore">Restore JSON</button>
        <input class="hidden" type="file" id="jsonFile" accept=".json,application/json" />
        <button class="btn btn-danger" id="btnClearAll">Clear All</button>
        <button class="btn btn-primary" id="btnAdd">Add Contact</button>
      </div>
    </div>

    <!-- KPIs -->
    <section class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
      <div class="card p-5">
        <div class="text-xs text-slate-500 font-black">CONTACTS</div>
        <div id="kpiContacts" class="text-2xl font-black text-blue-700 mt-1">0</div>
      </div>
      <div class="card p-5">
        <div class="text-xs text-slate-500 font-black">ACTIVE CLIENTS</div>
        <div id="kpiClients" class="text-2xl font-black text-emerald-700 mt-1">0</div>
      </div>
      <div class="card p-5">
        <div class="text-xs text-slate-500 font-black">PIPELINE VALUE</div>
        <div id="kpiPipeline" class="text-2xl font-black text-indigo-700 mt-1">R0.00</div>
      </div>
      <div class="card p-5">
        <div class="text-xs text-slate-500 font-black">OVERDUE FOLLOW-UPS</div>
        <div id="kpiOverdue" class="text-2xl font-black text-rose-700 mt-1">0</div>
      </div>
      <div class="card p-5">
        <div class="text-xs text-slate-500 font-black">NEXT 7 DAYS</div>
        <div id="kpiUpcoming" class="text-2xl font-black text-amber-700 mt-1">0</div>
      </div>
    </section>

    <!-- FILTERS -->
    <section class="card p-4 mb-6 no-print">
      <div class="grid grid-cols-1 md:grid-cols-6 gap-3">
        <div class="md:col-span-2">
          <label class="text-xs font-black text-slate-600">Search</label>
          <input id="q" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Name, company, email, phone, tag..." />
        </div>

        <div>
          <label class="text-xs font-black text-slate-600">Status</label>
          <select id="statusFilter" class="w-full border border-gray-200 rounded-lg px-3 py-2">
            <option value="">All</option>
            <option value="Lead">Lead</option>
            <option value="Prospect">Prospect</option>
            <option value="Client">Client</option>
            <option value="Inactive">Inactive</option>
          </select>
        </div>

        <div>
          <label class="text-xs font-black text-slate-600">Sort</label>
          <select id="sort" class="w-full border border-gray-200 rounded-lg px-3 py-2">
            <option value="name">Name</option>
            <option value="company">Company</option>
            <option value="status">Status</option>
            <option value="revenueDesc">Revenue (High → Low)</option>
            <option value="followupAsc">Follow-up (Soonest)</option>
            <option value="updatedDesc">Recently Updated</option>
          </select>
        </div>

        <div>
          <label class="text-xs font-black text-slate-600">Show</label>
          <select id="pageSize" class="w-full border border-gray-200 rounded-lg px-3 py-2">
            <option value="25">25</option>
            <option value="50" selected>50</option>
            <option value="100">100</option>
          </select>
        </div>

        <div class="flex items-end gap-2">
          <button class="btn btn-outline w-full" id="btnClearFilters">Clear</button>
        </div>
      </div>
    </section>

    <!-- TABLE -->
    <section class="card p-0 overflow-hidden">
      <div class="responsive-table">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-50 text-slate-600">
            <tr>
              <th class="p-3 text-left">Name</th>
              <th class="p-3 text-left">Company</th>
              <th class="p-3 text-left">Status</th>
              <th class="p-3 text-right">Pipeline (R)</th>
              <th class="p-3 text-left">Follow-up</th>
              <th class="p-3 text-left">Tags</th>
              <th class="p-3 text-left">Updated</th>
              <th class="p-3 text-center no-print">Actions</th>
            </tr>
          </thead>
          <tbody id="rows" class="divide-y divide-gray-100"></tbody>
        </table>
      </div>

      <div class="p-4 flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between text-xs text-slate-500">
        <div id="tableMeta">0 records</div>
        <div class="flex items-center gap-2 no-print">
          <button class="btn btn-outline" id="btnPrev">Prev</button>
          <span class="mono" id="pageMeta">1 / 1</span>
          <button class="btn btn-outline" id="btnNext">Next</button>
        </div>
      </div>
    </section>

    <!-- ACTIVITY -->
    <section class="card p-5 mt-6">
      <div class="flex items-start justify-between gap-3 mb-3">
        <div>
          <h2 class="text-lg font-black text-slate-900">Recent Activity</h2>
          <p class="text-xs text-slate-500">Last 30 activity items (local)</p>
        </div>
        <button class="btn btn-outline no-print" id="btnClearActivity">Clear Activity</button>
      </div>

      <div class="responsive-table">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-50 text-slate-600">
            <tr>
              <th class="p-3 text-left">Time</th>
              <th class="p-3 text-left">Contact</th>
              <th class="p-3 text-left">Event</th>
              <th class="p-3 text-left">Note</th>
            </tr>
          </thead>
          <tbody id="activityRows" class="divide-y divide-gray-100"></tbody>
        </table>
      </div>
    </section>

  </main>

  <!-- ADD/EDIT MODAL -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center p-4 z-50 no-print">
    <div class="modal-backdrop absolute inset-0"></div>
    <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-3xl p-5">
      <div class="flex items-start justify-between gap-3">
        <div>
          <h3 id="modalTitle" class="text-xl font-black text-slate-900">Add Contact</h3>
          <p class="text-xs text-slate-500">Required: name. Pipeline is your expected value (ZAR).</p>
        </div>
        <button id="btnClose" class="text-slate-500 hover:text-slate-900 text-xl font-black">×</button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">
        <div class="md:col-span-1">
          <label class="text-xs font-black text-slate-600">Full Name *</label>
          <input id="fName" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Full Name" />
        </div>
        <div>
          <label class="text-xs font-black text-slate-600">Company</label>
          <input id="fCompany" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Company" />
        </div>

        <div>
          <label class="text-xs font-black text-slate-600">Email</label>
          <input id="fEmail" type="email" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="email@domain.com" />
        </div>
        <div>
          <label class="text-xs font-black text-slate-600">Phone</label>
          <input id="fPhone" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="+27 ..." />
        </div>

        <div>
          <label class="text-xs font-black text-slate-600">Status</label>
          <select id="fStatus" class="w-full border border-gray-200 rounded-lg px-3 py-2">
            <option>Lead</option>
            <option>Prospect</option>
            <option>Client</option>
            <option>Inactive</option>
          </select>
        </div>
        <div>
          <label class="text-xs font-black text-slate-600">Follow-up Date</label>
          <input id="fFollowup" type="date" class="w-full border border-gray-200 rounded-lg px-3 py-2" />
        </div>

        <div>
          <label class="text-xs font-black text-slate-600">Pipeline Value (ZAR)</label>
          <input id="fRevenue" type="number" min="0" step="0.01" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="0.00" />
        </div>
        <div>
          <label class="text-xs font-black text-slate-600">Tags (comma separated)</label>
          <input id="fTags" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="e.g., Microsoft, IBM, Renewal, Hot" />
        </div>

        <div class="md:col-span-2">
          <label class="text-xs font-black text-slate-600">Notes</label>
          <textarea id="fNotes" rows="4" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Key context, last call notes, next steps..."></textarea>
        </div>
      </div>

      <div class="flex flex-wrap justify-between gap-2 mt-5">
        <button class="btn btn-outline" id="btnAddActivity">Add Activity Note</button>
        <div class="flex gap-2">
          <button class="btn btn-outline" id="btnCancel">Cancel</button>
          <button class="btn btn-primary" id="btnSave">Save</button>
        </div>
      </div>

      <input type="hidden" id="fId" />
    </div>
  </div>

  <!-- VIEW MODAL -->
  <div id="viewModal" class="fixed inset-0 hidden items-center justify-center p-4 z-50 no-print">
    <div class="modal-backdrop absolute inset-0"></div>
    <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-3xl p-5">
      <div class="flex items-start justify-between gap-3">
        <div>
          <h3 class="text-xl font-black text-slate-900">Contact Profile</h3>
          <p class="text-xs text-slate-500" id="viewSub">—</p>
        </div>
        <button id="btnViewClose" class="text-slate-500 hover:text-slate-900 text-xl font-black">×</button>
      </div>

      <div id="viewBody" class="mt-4"></div>

      <div class="mt-5 flex flex-wrap justify-end gap-2">
        <button class="btn btn-outline" id="btnViewEdit">Edit</button>
        <button class="btn btn-danger" id="btnViewDelete">Delete</button>
        <button class="btn btn-primary" id="btnViewCloseBottom">Close</button>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div class="toast hidden" id="toast"><div id="toastMsg"></div></div>

<script>
/* ============================
   Easy CRM – Offline First
   ============================ */

const STORE_KEY = "easy.crm.v2";
const ACT_KEY   = "easy.crm.activity.v1";
const PREF_KEY  = "easy.crm.prefs.v1";

const $ = (id) => document.getElementById(id);

let state = {
  contacts: [],
  activity: [],
  prefs: { dark:false },
  page: 1
};

function nowISO(){ return new Date().toISOString(); }

function escapeHtml(str){
  return String(str || "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
  }[m]));
}

function money(n){
  const x = Number(n || 0);
  return "R" + x.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

function toast(msg){
  $("toastMsg").textContent = msg;
  $("toast").classList.remove("hidden");
  clearTimeout(toast._t);
  toast._t = setTimeout(()=> $("toast").classList.add("hidden"), 2600);
}

function loadJson(key, fallback){
  try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
  catch { return fallback; }
}

function saveJson(key, val){
  localStorage.setItem(key, JSON.stringify(val));
}

function persist(){
  saveJson(STORE_KEY, state.contacts);
  saveJson(ACT_KEY, state.activity.slice(0,30));
  saveJson(PREF_KEY, state.prefs);
}

function logActivity(contactId, contactName, event, note){
  const entry = {
    ts: nowISO(),
    contactId: contactId || null,
    contactName: contactName || "",
    event: event || "Update",
    note: note || ""
  };
  state.activity.unshift(entry);
  state.activity = state.activity.slice(0,30);
  persist();
  renderActivity();
}

function statusPill(status){
  const s = String(status || "").toLowerCase();
  if(s === "lead") return `<span class="pill pill-lead">LEAD</span>`;
  if(s === "prospect") return `<span class="pill pill-prospect">PROSPECT</span>`;
  if(s === "client") return `<span class="pill pill-client">CLIENT</span>`;
  return `<span class="pill pill-inactive">INACTIVE</span>`;
}

function isOverdueDate(iso){
  if(!iso) return false;
  const d = new Date(iso + "T00:00:00");
  const today = new Date();
  today.setHours(0,0,0,0);
  return d < today;
}

function isWithinNextDays(iso, days){
  if(!iso) return false;
  const d = new Date(iso + "T00:00:00");
  const today = new Date();
  today.setHours(0,0,0,0);
  const end = new Date(today);
  end.setDate(end.getDate() + Number(days||7));
  return d >= today && d <= end;
}

/* ============================
   CRUD
   ============================ */
function normalizeTags(str){
  return String(str||"")
    .split(",")
    .map(t => t.trim())
    .filter(Boolean)
    .slice(0,20);
}

function openModal(mode, id){
  const isEdit = mode === "edit";
  const contact = isEdit ? state.contacts.find(c => c.id === id) : null;

  $("modalTitle").textContent = isEdit ? "Edit Contact" : "Add Contact";
  $("fId").value = contact ? String(contact.id) : "";
  $("fName").value = contact ? contact.name : "";
  $("fCompany").value = contact ? contact.company : "";
  $("fEmail").value = contact ? contact.email : "";
  $("fPhone").value = contact ? contact.phone : "";
  $("fStatus").value = contact ? contact.status : "Lead";
  $("fFollowup").value = contact ? (contact.followup || "") : "";
  $("fRevenue").value = contact ? String(Number(contact.revenue||0)) : "0";
  $("fTags").value = contact ? (contact.tags || []).join(", ") : "";
  $("fNotes").value = contact ? (contact.notes || "") : "";

  $("modal").classList.remove("hidden");
  $("modal").classList.add("flex");
}

function closeModal(){
  $("modal").classList.add("hidden");
  $("modal").classList.remove("flex");
}

function saveContact(){
  const name = $("fName").value.trim();
  if(!name) { alert("Name is required."); return; }

  const idRaw = $("fId").value.trim();
  const isEdit = Boolean(idRaw);
  const id = isEdit ? Number(idRaw) : Date.now();

  const contact = {
    id,
    name,
    company: $("fCompany").value.trim(),
    email: $("fEmail").value.trim(),
    phone: $("fPhone").value.trim(),
    status: $("fStatus").value,
    followup: $("fFollowup").value,
    revenue: Number($("fRevenue").value || 0),
    tags: normalizeTags($("fTags").value),
    notes: $("fNotes").value.trim(),
    updatedAt: nowISO(),
    createdAt: isEdit ? (state.contacts.find(c=>c.id===id)?.createdAt || nowISO()) : nowISO()
  };

  if(isEdit){
    state.contacts = state.contacts.map(c => c.id === id ? contact : c);
    toast("Contact updated.");
    logActivity(id, contact.name, "Updated", "Contact updated");
  }else{
    state.contacts.unshift(contact);
    toast("Contact added.");
    logActivity(id, contact.name, "Created", "New contact added");
  }

  persist();
  closeModal();
  render();
}

function deleteContact(id){
  const c = state.contacts.find(x => x.id === id);
  if(!c) return;
  if(!confirm(`Delete contact: ${c.name}?`)) return;

  state.contacts = state.contacts.filter(x => x.id !== id);
  toast("Contact deleted.");
  logActivity(id, c.name, "Deleted", "Contact removed");
  persist();
  render();
}

function openView(id){
  const c = state.contacts.find(x => x.id === id);
  if(!c) { toast("Contact not found."); return; }

  $("viewSub").textContent = c.company ? c.company : "—";

  const overdue = isOverdueDate(c.followup);
  const follow = c.followup ? escapeHtml(c.followup) : "-";
  const tags = (c.tags||[]).map(t => `<span class="pill pill-inactive mr-1 mb-1">${escapeHtml(t)}</span>`).join(" ") || `<span class="text-slate-500">—</span>`;

  $("viewBody").innerHTML = `
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="card p-4">
        <div class="text-xs text-slate-500 font-black mb-2">BASIC</div>
        <div class="text-lg font-black">${escapeHtml(c.name)}</div>
        <div class="text-sm text-slate-600 mt-1">${escapeHtml(c.company || "")}</div>
        <div class="mt-3 text-sm">
          <div><span class="font-black">Email:</span> ${c.email ? `<a class="text-blue-600 hover:underline" href="mailto:${escapeHtml(c.email)}">${escapeHtml(c.email)}</a>` : "—"}</div>
          <div><span class="font-black">Phone:</span> ${c.phone ? `<a class="text-blue-600 hover:underline" href="tel:${escapeHtml(c.phone)}">${escapeHtml(c.phone)}</a>` : "—"}</div>
        </div>
      </div>

      <div class="card p-4">
        <div class="text-xs text-slate-500 font-black mb-2">PIPELINE</div>
        <div class="text-sm flex items-center justify-between">
          <span class="font-black">Status</span>
          <span>${statusPill(c.status)}</span>
        </div>
        <div class="text-sm flex items-center justify-between mt-2">
          <span class="font-black">Value</span>
          <span class="mono font-black">${money(c.revenue||0)}</span>
        </div>
        <div class="text-sm flex items-center justify-between mt-2">
          <span class="font-black">Follow-up</span>
          <span class="${overdue ? "text-rose-700 font-black" : ""}">${follow} ${overdue ? `<span class="pill pill-overdue ml-2">OVERDUE</span>` : ""}</span>
        </div>
      </div>

      <div class="card p-4 md:col-span-2">
        <div class="text-xs text-slate-500 font-black mb-2">TAGS</div>
        <div class="flex flex-wrap">${tags}</div>
      </div>

      <div class="card p-4 md:col-span-2">
        <div class="text-xs text-slate-500 font-black mb-2">NOTES</div>
        <div class="text-sm whitespace-pre-line">${escapeHtml(c.notes || "—")}</div>
      </div>

      <div class="card p-4 md:col-span-2">
        <div class="text-xs text-slate-500 font-black mb-2">METADATA</div>
        <div class="text-xs text-slate-500">
          Created: <span class="mono">${escapeHtml(new Date(c.createdAt).toLocaleString())}</span>
          • Updated: <span class="mono">${escapeHtml(new Date(c.updatedAt).toLocaleString())}</span>
        </div>
      </div>
    </div>
  `;

  $("btnViewEdit").onclick = () => { closeView(); openModal("edit", id); };
  $("btnViewDelete").onclick = () => { closeView(); deleteContact(id); };

  $("viewModal").classList.remove("hidden");
  $("viewModal").classList.add("flex");
}

function closeView(){
  $("viewModal").classList.add("hidden");
  $("viewModal").classList.remove("flex");
}

/* ============================
   Render
   ============================ */
function computeKPIs(list){
  const contacts = state.contacts.length;
  const clients = state.contacts.filter(c => c.status === "Client").length;
  const pipeline = state.contacts
    .filter(c => c.status !== "Inactive")
    .reduce((a,c)=> a + Number(c.revenue||0), 0);

  const overdue = state.contacts.filter(c => isOverdueDate(c.followup)).length;
  const upcoming = state.contacts.filter(c => isWithinNextDays(c.followup, 7)).length;

  $("kpiContacts").textContent = String(contacts);
  $("kpiClients").textContent = String(clients);
  $("kpiPipeline").textContent = money(pipeline);
  $("kpiOverdue").textContent = String(overdue);
  $("kpiUpcoming").textContent = String(upcoming);
}

function applyFilters(){
  const q = ($("q").value || "").trim().toLowerCase();
  const sf = ($("statusFilter").value || "").trim();
  let list = [...state.contacts];

  if(sf){
    list = list.filter(c => c.status === sf);
  }

  if(q){
    list = list.filter(c => {
      const tags = (c.tags||[]).join(" ");
      const hay = `${c.name} ${c.company} ${c.email} ${c.phone} ${tags}`.toLowerCase();
      return hay.includes(q);
    });
  }

  // sort
  const sort = $("sort").value;
  list.sort((a,b)=>{
    if(sort === "name") return String(a.name||"").localeCompare(String(b.name||""));
    if(sort === "company") return String(a.company||"").localeCompare(String(b.company||""));
    if(sort === "status") return String(a.status||"").localeCompare(String(b.status||""));
    if(sort === "revenueDesc") return Number(b.revenue||0) - Number(a.revenue||0);
    if(sort === "followupAsc") return new Date(a.followup || "2999-12-31") - new Date(b.followup || "2999-12-31");
    if(sort === "updatedDesc") return new Date(b.updatedAt||0) - new Date(a.updatedAt||0);
    return 0;
  });

  return list;
}

function render(){
  const list = applyFilters();
  computeKPIs(list);

  const pageSize = Number($("pageSize").value || 50);
  const totalPages = Math.max(1, Math.ceil(list.length / pageSize));
  state.page = Math.min(state.page, totalPages);

  const start = (state.page - 1) * pageSize;
  const slice = list.slice(start, start + pageSize);

  $("pageMeta").textContent = `${state.page} / ${totalPages}`;
  $("tableMeta").textContent = `${list.length} records • showing ${slice.length} • page size ${pageSize}`;

  const rows = $("rows");
  rows.innerHTML = "";

  if(!slice.length){
    rows.innerHTML = `<tr><td colspan="8" class="p-6 text-center text-slate-500">No contacts found.</td></tr>`;
    return;
  }

  slice.forEach(c => {
    const overdue = isOverdueDate(c.followup);
    const follow = c.followup ? escapeHtml(c.followup) : "-";
    const tags = (c.tags||[]).slice(0,4).map(t => `<span class="pill pill-inactive mr-1 mb-1">${escapeHtml(t)}</span>`).join("");
    const tagMore = (c.tags||[]).length > 4 ? `<span class="text-xs text-slate-500 ml-1">+${(c.tags||[]).length-4}</span>` : "";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="p-3 font-black">${escapeHtml(c.name)}</td>
      <td class="p-3">${escapeHtml(c.company || "")}</td>
      <td class="p-3">${statusPill(c.status)}</td>
      <td class="p-3 text-right mono font-black">${money(c.revenue||0)}</td>
      <td class="p-3 ${overdue ? "text-rose-700 font-black" : ""}">
        ${follow} ${overdue ? `<span class="pill pill-overdue ml-2">OVERDUE</span>` : ""}
      </td>
      <td class="p-3">
        <div class="flex flex-wrap items-center">${tags}${tagMore || ""}</div>
      </td>
      <td class="p-3 text-xs text-slate-500 mono">${escapeHtml(new Date(c.updatedAt||c.createdAt||0).toLocaleString())}</td>
      <td class="p-3 text-center no-print">
        <div class="flex justify-center gap-2 flex-wrap">
          <button class="btn btn-outline" data-view="${c.id}">View</button>
          <button class="btn btn-outline" data-edit="${c.id}">Edit</button>
          <button class="btn btn-danger" data-del="${c.id}">Delete</button>
        </div>
      </td>
    `;
    rows.appendChild(tr);
  });

  // wire row actions
  rows.querySelectorAll("[data-view]").forEach(b => b.addEventListener("click", () => openView(Number(b.getAttribute("data-view")))));
  rows.querySelectorAll("[data-edit]").forEach(b => b.addEventListener("click", () => openModal("edit", Number(b.getAttribute("data-edit")))));
  rows.querySelectorAll("[data-del]").forEach(b => b.addEventListener("click", () => deleteContact(Number(b.getAttribute("data-del")))));
}

function renderActivity(){
  const tb = $("activityRows");
  tb.innerHTML = "";
  const list = state.activity.slice(0,30);
  if(!list.length){
    tb.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-slate-500">No activity yet.</td></tr>`;
    return;
  }
  list.forEach(a => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="p-3 mono">${escapeHtml(new Date(a.ts).toLocaleString())}</td>
      <td class="p-3 font-black">${escapeHtml(a.contactName || "—")}</td>
      <td class="p-3">${escapeHtml(a.event || "—")}</td>
      <td class="p-3">${escapeHtml(a.note || "")}</td>
    `;
    tb.appendChild(tr);
  });
}

/* ============================
   Import / Export
   ============================ */

function exportCSV(){
  const header = ["Name","Company","Email","Phone","Status","PipelineValue","Followup","Tags","Notes","CreatedAt","UpdatedAt"];
  const lines = [header.join(",")];

  state.contacts.forEach(c => {
    const row = [
      c.name, c.company, c.email, c.phone, c.status,
      String(Number(c.revenue||0)),
      c.followup || "",
      (c.tags||[]).join("|"),
      (c.notes||"").replace(/\r?\n/g, "\\n"),
      c.createdAt || "",
      c.updatedAt || ""
    ].map(v => `"${String(v||"").replace(/"/g,'""')}"`);
    lines.push(row.join(","));
  });

  const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "easy-crm-export.csv";
  a.click();
  setTimeout(()=> URL.revokeObjectURL(a.href), 0);
  toast("CSV exported.");
}

function parseCSV(text){
  // Minimal CSV parser (handles quotes). Returns array of rows (array of fields).
  const rows = [];
  let i=0, field="", row=[], inQuotes=false;

  while(i < text.length){
    const ch = text[i];

    if(inQuotes){
      if(ch === '"'){
        if(text[i+1] === '"'){ field += '"'; i += 2; continue; }
        inQuotes = false; i++; continue;
      }
      field += ch; i++; continue;
    }else{
      if(ch === '"'){ inQuotes = true; i++; continue; }
      if(ch === ","){ row.push(field); field=""; i++; continue; }
      if(ch === "\n"){
        row.push(field); field="";
        if(row.some(x => String(x).trim().length)) rows.push(row);
        row=[]; i++; continue;
      }
      if(ch === "\r"){ i++; continue; }
      field += ch; i++; continue;
    }
  }
  row.push(field);
  if(row.some(x => String(x).trim().length)) rows.push(row);
  return rows;
}

function importCSVFile(file){
  if(!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const rows = parseCSV(String(reader.result || ""));
      if(rows.length < 2){ alert("CSV looks empty."); return; }

      const header = rows[0].map(h => String(h||"").trim().toLowerCase());
      const idx = (name) => header.indexOf(name.toLowerCase());

      // Expected columns (flexible): name, company, email, phone, status, pipelinevalue/revenue, followup, tags, notes
      const iName = idx("name");
      if(iName < 0){ alert("CSV must include a 'Name' column."); return; }

      const imported = [];
      for(let r=1; r<rows.length; r++){
        const cols = rows[r];
        const name = String(cols[iName]||"").trim();
        if(!name) continue;

        const company = idx("company") >= 0 ? String(cols[idx("company")]||"").trim() : "";
        const email   = idx("email") >= 0 ? String(cols[idx("email")]||"").trim() : "";
        const phone   = idx("phone") >= 0 ? String(cols[idx("phone")]||"").trim() : "";
        const status  = idx("status")>= 0 ? String(cols[idx("status")]||"Lead").trim() : "Lead";
        const revCol  = idx("pipelinevalue") >= 0 ? idx("pipelinevalue") : (idx("revenue") >= 0 ? idx("revenue") : -1);
        const revenue = revCol >= 0 ? Number(cols[revCol]||0) : 0;
        const follow  = idx("followup")>=0 ? String(cols[idx("followup")]||"").trim() : "";
        const tagsRaw = idx("tags")>=0 ? String(cols[idx("tags")]||"").trim() : "";
        const notes   = idx("notes")>=0 ? String(cols[idx("notes")]||"").replace(/\\n/g,"\n").trim() : "";

        imported.push({
          id: Date.now() + r,
          name, company, email, phone,
          status: ["Lead","Prospect","Client","Inactive"].includes(status) ? status : "Lead",
          followup: follow,
          revenue: Number.isFinite(revenue) ? revenue : 0,
          tags: tagsRaw ? tagsRaw.split(/[|,]/).map(x=>x.trim()).filter(Boolean) : [],
          notes,
          createdAt: nowISO(),
          updatedAt: nowISO()
        });
      }

      if(!imported.length){ alert("No valid rows found."); return; }

      // Merge: if same email or same (name+company), update existing; else add.
      let added=0, updated=0;
      imported.forEach(nc => {
        const keyEmail = (nc.email||"").toLowerCase();
        const match = state.contacts.find(c =>
          (keyEmail && (c.email||"").toLowerCase() === keyEmail) ||
          ((c.name||"").toLowerCase() === (nc.name||"").toLowerCase() && (c.company||"").toLowerCase() === (nc.company||"").toLowerCase())
        );
        if(match){
          nc.id = match.id;
          nc.createdAt = match.createdAt || nc.createdAt;
          state.contacts = state.contacts.map(c => c.id === match.id ? nc : c);
          updated++;
          logActivity(nc.id, nc.name, "Imported Update", "Updated from CSV import");
        }else{
          state.contacts.unshift(nc);
          added++;
          logActivity(nc.id, nc.name, "Imported", "Added from CSV import");
        }
      });

      persist();
      toast(`CSV imported. Added ${added}, updated ${updated}.`);
      render();
    }catch(e){
      console.error(e);
      alert("Import failed. Please verify CSV format.");
    }
  };
  reader.readAsText(file);
}

function backupJSON(){
  const payload = {
    exportedAt: nowISO(),
    version: 2,
    contacts: state.contacts,
    activity: state.activity
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "easy-crm-backup.json";
  a.click();
  setTimeout(()=> URL.revokeObjectURL(a.href), 0);
  toast("JSON backup downloaded.");
}

function restoreJSONFile(file){
  if(!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const obj = JSON.parse(String(reader.result||"{}"));
      const contacts = Array.isArray(obj.contacts) ? obj.contacts : (Array.isArray(obj) ? obj : []);
      const activity = Array.isArray(obj.activity) ? obj.activity : [];
      if(!Array.isArray(contacts) || !contacts.length){
        if(!confirm("Backup has no contacts (or not recognized). Clear current CRM anyway?")) return;
      }

      // normalize
      state.contacts = (contacts || []).map(c => ({
        id: Number(c.id || Date.now()),
        name: String(c.name||"").trim() || "Unnamed",
        company: String(c.company||"").trim(),
        email: String(c.email||"").trim(),
        phone: String(c.phone||"").trim(),
        status: ["Lead","Prospect","Client","Inactive"].includes(c.status) ? c.status : "Lead",
        followup: String(c.followup||"").trim(),
        revenue: Number(c.revenue||0),
        tags: Array.isArray(c.tags) ? c.tags.map(x=>String(x).trim()).filter(Boolean) : normalizeTags(c.tags),
        notes: String(c.notes||""),
        createdAt: c.createdAt || nowISO(),
        updatedAt: c.updatedAt || nowISO()
      }));

      state.activity = (activity || []).slice(0,30).map(a => ({
        ts: a.ts || nowISO(),
        contactId: a.contactId ?? null,
        contactName: String(a.contactName||""),
        event: String(a.event||""),
        note: String(a.note||"")
      }));

      persist();
      toast("Backup restored.");
      render();
      renderActivity();
    }catch(e){
      console.error(e);
      alert("Restore failed. Invalid JSON backup file.");
    }
  };
  reader.readAsText(file);
}

/* ============================
   Demo Data
   ============================ */
function seedDemo(){
  if(state.contacts.length && !confirm("Seed demo data will ADD into your existing contacts. Continue?")) return;

  const demo = [
    {name:"A. Ndlovu", company:"Ndlovu Engineering", email:"andile@ndlovu.co.za", phone:"+27 11 000 0001", status:"Prospect", followup: daysFromNow(2), revenue: 85000, tags:["Renewal","Quote"], notes:"Requested proposal for annual support."},
    {name:"L. Mokoena", company:"Mokoena Holdings", email:"lindi@mokoena.africa", phone:"+27 11 000 0002", status:"Lead", followup: daysFromNow(-3), revenue: 120000, tags:["Hot","Onsite"], notes:"Overdue follow-up. Needs call-back."},
    {name:"R. Naidoo", company:"Naidoo Logistics", email:"raj@naidoo.co.za", phone:"+27 11 000 0003", status:"Client", followup: daysFromNow(10), revenue: 45000, tags:["Client","Invoice"], notes:"Client: monthly billing cycle."},
    {name:"S. Dlamini", company:"Dlamini Retail", email:"sindi@dlamini.co.za", phone:"+27 11 000 0004", status:"Inactive", followup:"", revenue: 0, tags:["Dormant"], notes:"No response after 6 attempts."}
  ].map((c,i)=>({
    id: Date.now() + i,
    ...c,
    createdAt: nowISO(),
    updatedAt: nowISO()
  }));

  demo.forEach(c => { state.contacts.unshift(c); logActivity(c.id, c.name, "Seeded", "Demo contact created"); });
  persist();
  toast("Demo data added.");
  render();
}

function daysFromNow(n){
  const d = new Date();
  d.setDate(d.getDate() + Number(n||0));
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}

/* ============================
   Preferences
   ============================ */
function applyDarkMode(on){
  state.prefs.dark = Boolean(on);
  if(state.prefs.dark) document.body.classList.add("dark");
  else document.body.classList.remove("dark");
  $("btnDark").innerHTML = `<span class="mono">D</span> ${state.prefs.dark ? "Light" : "Dark"}`;
  persist();
}

function toggleDark(){
  applyDarkMode(!state.prefs.dark);
}

/* ============================
   Wiring
   ============================ */
function init(){
  state.contacts = loadJson(STORE_KEY, []);
  state.activity = loadJson(ACT_KEY, []);
  state.prefs = loadJson(PREF_KEY, {dark:false});

  applyDarkMode(state.prefs.dark);

  // base renders
  render();
  renderActivity();

  // events
  $("btnAdd").addEventListener("click", ()=> openModal("add"));
  $("btnClose").addEventListener("click", closeModal);
  $("btnCancel").addEventListener("click", closeModal);
  $("btnSave").addEventListener("click", saveContact);

  $("btnViewClose").addEventListener("click", closeView);
  $("btnViewCloseBottom").addEventListener("click", closeView);

  $("btnPrev").addEventListener("click", ()=>{
    state.page = Math.max(1, state.page - 1);
    render();
  });
  $("btnNext").addEventListener("click", ()=>{
    const list = applyFilters();
    const pageSize = Number($("pageSize").value || 50);
    const totalPages = Math.max(1, Math.ceil(list.length / pageSize));
    state.page = Math.min(totalPages, state.page + 1);
    render();
  });

  ["q","statusFilter","sort","pageSize"].forEach(id=>{
    $(id).addEventListener("input", ()=> { state.page = 1; render(); });
    $(id).addEventListener("change", ()=> { state.page = 1; render(); });
  });

  $("btnClearFilters").addEventListener("click", ()=>{
    $("q").value = "";
    $("statusFilter").value = "";
    $("sort").value = "name";
    $("pageSize").value = "50";
    state.page = 1;
    render();
    toast("Filters cleared.");
  });

  $("btnExportCSV").addEventListener("click", exportCSV);
  $("btnImportCSV").addEventListener("click", ()=> $("csvFile").click());
  $("csvFile").addEventListener("change", (e)=> importCSVFile(e.target.files[0]));

  $("btnBackup").addEventListener("click", backupJSON);
  $("btnRestore").addEventListener("click", ()=> $("jsonFile").click());
  $("jsonFile").addEventListener("change", (e)=> restoreJSONFile(e.target.files[0]));

  $("btnSeed").addEventListener("click", seedDemo);

  $("btnClearAll").addEventListener("click", ()=>{
    if(!confirm("This will permanently clear ALL CRM data stored in this browser. Continue?")) return;
    state.contacts = [];
    state.activity = [];
    persist();
    render();
    renderActivity();
    toast("All CRM data cleared.");
  });

  $("btnClearActivity").addEventListener("click", ()=>{
    if(!confirm("Clear activity log?")) return;
    state.activity = [];
    persist();
    renderActivity();
    toast("Activity cleared.");
  });

  $("btnAddActivity").addEventListener("click", ()=>{
    const name = $("fName").value.trim() || "Unnamed";
    const note = prompt("Activity note (e.g., called, emailed, meeting booked):");
    if(note === null) return;
    const idRaw = $("fId").value.trim();
    const id = idRaw ? Number(idRaw) : null;
    logActivity(id, name, "Note", String(note||"").trim());
    toast("Activity added.");
  });

  $("btnDark").addEventListener("click", toggleDark);
  $("btnPrint").addEventListener("click", ()=> window.print());

  // keyboard shortcuts
  document.addEventListener("keydown", (e)=>{
    if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "k"){
      e.preventDefault();
      $("q").focus();
    }
    if(!e.ctrlKey && !e.metaKey && e.key.toLowerCase() === "d"){
      // ignore typing in inputs
      const t = (document.activeElement && document.activeElement.tagName || "").toLowerCase();
      if(["input","textarea","select"].includes(t)) return;
      toggleDark();
    }
    if(!e.ctrlKey && !e.metaKey && e.key === "Escape"){
      closeModal();
      closeView();
    }
  });
}

init();
</script>
</body>
</html>
