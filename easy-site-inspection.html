<!DOCTYPE html>
<html lang="en-ZA">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EasyINSPECT – Site Inspection | Easy Suite</title>
  <meta name="description" content="Production-ready site inspection tool with checklists, findings, photos, signatures, corrective actions, offline templates, and audit-ready exports." />

  <!-- Favicon -->
  <link rel="icon" href="icon.png" type="image/png">
  <link rel="apple-touch-icon" href="icon.png">

  <!-- Tailwind CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root{
      --blue:#2563eb; --blue2:#1d4ed8;
      --ink:#0f172a; --muted:#64748b;
      --card:#ffffff; --line:#e5e7eb; --bg:#f8fafc;
      --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    html,body{font-family:var(--sans); background:var(--bg); color:var(--ink);}
    .container{max-width:1200px;}
    .mono{font-family:var(--mono);}
    .card{background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow:0 1px 2px rgba(15,23,42,.06);}
    .card-h{padding:14px 16px; border-bottom:1px solid var(--line);}
    .card-b{padding:16px;}
    .btn{display:inline-flex; align-items:center; gap:.55rem; padding:.55rem .85rem; border-radius:12px; font-weight:800; border:1px solid transparent; cursor:pointer; user-select:none; transition:all .15s ease;}
    .btn:disabled{opacity:.5; cursor:not-allowed;}
    .btn-primary{background:var(--blue); color:#fff;}
    .btn-primary:hover{background:var(--blue2);}
    .btn-outline{background:#fff; border-color:var(--line); color:var(--ink); border:1px solid var(--line);}
    .btn-outline:hover{border-color:#cbd5e1; background:#f8fafc;}
    .btn-danger{background:#fee2e2; border-color:#fecaca; color:#991b1b; border:1px solid #fecaca;}
    .btn-danger:hover{background:#fecaca;}
    .input,.select,.textarea{
      width:100%; border:1px solid var(--line); border-radius:12px; padding:.6rem .75rem; background:#fff; outline:none;
    }
    .input:focus,.select:focus,.textarea:focus{border-color:#93c5fd; box-shadow:0 0 0 3px rgba(59,130,246,.15);}
    .textarea{min-height:110px;}
    .help{color:var(--muted); font-size:.85rem;}
    .badge{display:inline-flex; align-items:center; gap:.4rem; padding:.2rem .55rem; border-radius:999px; font-size:.75rem; font-weight:800; border:1px solid var(--line); background:#fff;}
    .badge.ok{border-color:rgba(22,163,74,.25); background:rgba(22,163,74,.08); color:#166534;}
    .badge.warn{border-color:rgba(245,158,11,.25); background:rgba(245,158,11,.10); color:#92400e;}
    .badge.bad{border-color:rgba(239,68,68,.25); background:rgba(239,68,68,.10); color:#991b1b;}
    .hr{height:1px; background:var(--line); margin:14px 0;}
    .table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border:1px solid var(--line); border-radius:14px; background:#fff;}
    .table th{font-size:.75rem; text-transform:uppercase; letter-spacing:.04em; color:#475569; background:#f8fafc; border-bottom:1px solid var(--line); padding:.6rem .6rem; text-align:left; position:sticky; top:0; z-index:1;}
    .table td{border-bottom:1px solid var(--line); padding:.6rem .6rem; vertical-align:top;}
    .table tr:last-child td{border-bottom:none;}
    .hidden{display:none !important;}
    .no-print{}
    @media print{
      .no-print{display:none !important;}
      body{background:#fff !important; color:#000 !important;}
      .card{box-shadow:none !important; border-color:#ddd !important;}
      .table th{position:static !important;}
      a[href]:after{content:"";}
      .print-title{display:block !important;}
      .print-wrap{padding:0 !important;}
    }
    /* Dark mode */
    html.dark, body.dark { background:#0b1220; color:#e5e7eb; }
    html.dark .card, body.dark .card{background:#0f172a; border-color:rgba(148,163,184,.18);}
    html.dark .card-h{border-bottom-color:rgba(148,163,184,.18);}
    html.dark .btn-outline{background:#0f172a; color:#e5e7eb; border-color:rgba(148,163,184,.22);}
    html.dark .btn-outline:hover{background:#111c33;}
    html.dark .input, html.dark .select, html.dark .textarea{background:#0b1220; color:#e5e7eb; border-color:rgba(148,163,184,.22);}
    html.dark .table{background:#0f172a; border-color:rgba(148,163,184,.18);}
    html.dark .table th{background:#0b1220; border-bottom-color:rgba(148,163,184,.18); color:#cbd5e1;}
    html.dark .table td{border-bottom-color:rgba(148,163,184,.12);}
    html.dark .help{color:#94a3b8;}
    html.dark .hr{background:rgba(148,163,184,.18);}

    /* Signature pads */
    .sig-wrap{border:1px dashed var(--line); border-radius:14px; background:#fff; overflow:hidden;}
    .sig-canvas{width:100%; height:160px; display:block; touch-action:none; background:#fff;}
    html.dark .sig-wrap{background:#0b1220; border-color:rgba(148,163,184,.22);}
    html.dark .sig-canvas{background:#0b1220;}
    .photo-grid{display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:10px;}
    @media (min-width: 768px){ .photo-grid{grid-template-columns:repeat(4, minmax(0,1fr));} }
    .photo-item{border:1px solid var(--line); border-radius:14px; overflow:hidden; background:#fff;}
    html.dark .photo-item{background:#0b1220; border-color:rgba(148,163,184,.22);}
    .photo-item img{width:100%; height:110px; object-fit:cover; display:block;}
    .photo-item .meta{padding:8px 10px;}
    .toast{position:fixed; right:16px; bottom:16px; z-index:9999; width:min(420px, calc(100vw - 32px));}
    .toast-item{
      background:#0b1220; color:#e2e8f0; border:1px solid rgba(148,163,184,.2);
      border-radius:14px; padding:12px 14px; box-shadow:0 12px 30px rgba(0,0,0,.25);
      display:flex; gap:10px; align-items:flex-start;
    }
    .toast-item .tmain{flex:1;}
    .toast-item .tt{font-weight:900;}
    .toast-item .tb{color:#cbd5e1; font-size:.9rem; margin-top:2px;}
    .toast-item .tclose{background:transparent; border:none; color:#94a3b8; cursor:pointer;}
  </style>
</head>

<body class="min-h-screen">
  <!-- Top Nav -->
  <nav class="bg-blue-600 text-white py-4 no-print">
    <div class="container mx-auto px-4 flex flex-wrap items-center gap-4">
      <a data-safe-link="" href="index.html" class="font-black text-xl mr-4">Easy&nbsp;Suite</a>
      <a data-safe-link="" href="easy-quote.html" class="hover:underline">Quote</a>
      <a data-safe-link="" href="easy-invoice.html" class="hover:underline">Invoice</a>
      <a data-safe-link="" href="easy-purchase-order.html" class="hover:underline">Purchase&nbsp;Order</a>
      <a data-safe-link="" href="easy-sales-order.html" class="hover:underline">Sales&nbsp;Order</a>
      <a data-safe-link="" href="easy-receipt.html" class="hover:underline">Receipt</a>
      <a data-safe-link="" href="easy-statement.html" class="hover:underline">Statement</a>
      <a data-safe-link="" href="easy-job-card.html" class="hover:underline">Job&nbsp;Card</a>
      <a data-safe-link="" href="easy-payroll.html" class="hover:underline">Payroll</a>
      <a data-safe-link="" href="easy-inventory.html" class="hover:underline">Inventory</a>
      <a data-safe-link="" href="easy-crm.html" class="hover:underline">CRM</a>
      <a data-safe-link="" href="easy-asset-management.html" class="hover:underline">Assets</a>
      <a data-safe-link="" href="easy-site-inspection.html" class="underline font-extrabold">Inspection</a>

      <div class="ml-auto flex items-center gap-2">
        <button id="btnDark" class="btn btn-outline" title="Toggle dark mode (D)">
          <span class="mono">D</span> Dark
        </button>
        <button id="btnPrint" class="btn btn-outline" title="Print (manual style)">
          Print
        </button>
      </div>
    </div>
  </nav>

  <!-- Header -->
  <header class="bg-white border-b border-gray-200 no-print">
    <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row gap-4 sm:gap-0 items-start sm:items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-xl bg-blue-600 text-white flex items-center justify-center font-black">IN</div>
        <div>
          <h1 class="text-2xl font-extrabold text-blue-700">EasyINSPECT</h1>
          <p class="text-sm text-gray-500">Site Inspection (HSE / QA / Snag / Audit)</p>
        </div>
      </div>

      <div class="flex flex-wrap items-center gap-2">
        <a class="btn btn-outline" href="index.html" title="Back to dashboard">
          <i class="fa-solid fa-grid-2"></i> Dashboard
        </a>

        <button class="btn btn-outline" id="btnSaveTemplate" title="Save current inspection as a template">
          <i class="fa-solid fa-floppy-disk"></i> Save
        </button>
        <button class="btn btn-outline" id="btnLoadTemplate" title="Load a saved template">
          <i class="fa-solid fa-folder-open"></i> Load
        </button>
        <button class="btn btn-outline" id="btnReset" title="Reset form (keeps templates)">
          <i class="fa-solid fa-rotate-left"></i> Reset
        </button>

        <span class="ml-0 sm:ml-4 text-xs text-gray-500">
          Autosave: <span class="font-bold" id="autosaveStatus">On</span>
        </span>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-6 print-wrap">
    <!-- Print title (only visible in print) -->
    <div class="print-title hidden">
      <h1 class="text-2xl font-black">EasyINSPECT — Site Inspection Report</h1>
      <p class="text-sm">Print-ready inspection report (manual style).</p>
      <div class="hr"></div>
    </div>

    <!-- Quick flow -->
    <div class="card p-4 mb-6 no-print">
      <div class="flex gap-3">
        <div class="text-blue-600 pt-0.5"><i class="fa-solid fa-circle-info"></i></div>
        <div class="flex-1">
          <h3 class="text-sm font-extrabold text-slate-900">Quick flow</h3>
          <div class="text-sm text-slate-600 mt-1">
            1) Site + inspection details → 2) Choose checklist → 3) Add findings + photos → 4) Assign corrective actions →
            5) Capture signatures → 6) Print/export audit-ready report.
          </div>
        </div>
      </div>
    </div>

    <!-- Section: Inspection Meta -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
      <div class="card lg:col-span-2">
        <div class="card-h flex items-center justify-between">
          <div class="flex items-center gap-2">
            <i class="fa-solid fa-location-dot text-blue-600"></i>
            <div>
              <div class="font-black">Inspection Details</div>
              <div class="help">These appear on the report header and exports.</div>
            </div>
          </div>
          <span class="badge no-print" title="Keyboard shortcuts">
            <i class="fa-solid fa-keyboard"></i>
            <span class="mono">D</span> dark • <span class="mono">/</span> search • <span class="mono">Ctrl+S</span> templates
          </span>
        </div>
        <div class="card-b grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="text-sm font-extrabold">Company Name</label>
            <input id="companyName" class="input mt-1" placeholder="e.g., Skunkworks (Pty) Ltd" />
          </div>
          <div>
            <label class="text-sm font-extrabold">Site / Project</label>
            <input id="siteName" class="input mt-1" placeholder="e.g., Germiston Plant Upgrade" />
          </div>

          <div>
            <label class="text-sm font-extrabold">Site Address</label>
            <input id="siteAddress" class="input mt-1" placeholder="Street, suburb, city" />
          </div>
          <div>
            <label class="text-sm font-extrabold">Inspection Type</label>
            <select id="inspectionType" class="select mt-1">
              <option>HSE (Health & Safety)</option>
              <option>QA (Quality Assurance)</option>
              <option>Snag / Punch List</option>
              <option>Audit / Compliance</option>
              <option>Other</option>
            </select>
          </div>

          <div>
            <label class="text-sm font-extrabold">Inspection Date</label>
            <input id="inspectionDate" type="date" class="input mt-1" />
          </div>
          <div>
            <label class="text-sm font-extrabold">Weather / Conditions</label>
            <input id="conditions" class="input mt-1" placeholder="e.g., Clear, windy, wet surface areas" />
          </div>

          <div>
            <label class="text-sm font-extrabold">Inspector Name</label>
            <input id="inspectorName" class="input mt-1" placeholder="e.g., Lohan / Raydo" />
          </div>
          <div>
            <label class="text-sm font-extrabold">Inspector Contact</label>
            <input id="inspectorContact" class="input mt-1" placeholder="Phone / email" />
          </div>

          <div class="md:col-span-2">
            <label class="text-sm font-extrabold">Scope / Notes</label>
            <textarea id="scopeNotes" class="textarea mt-1" placeholder="Inspection scope, constraints, special access requirements, etc."></textarea>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-h">
          <div class="flex items-center gap-2">
            <i class="fa-solid fa-chart-pie text-blue-600"></i>
            <div>
              <div class="font-black">Inspection Snapshot</div>
              <div class="help">Auto-calculated as you work.</div>
            </div>
          </div>
        </div>
        <div class="card-b space-y-3">
          <div class="flex items-center justify-between">
            <div class="help">Checklist items</div>
            <div class="font-black text-xl" id="statChecklist">0</div>
          </div>
          <div class="flex items-center justify-between">
            <div class="help">Completed</div>
            <div class="font-black text-xl" id="statCompleted">0</div>
          </div>
          <div class="flex items-center justify-between">
            <div class="help">Findings</div>
            <div class="font-black text-xl" id="statFindings">0</div>
          </div>
          <div class="flex items-center justify-between">
            <div class="help">High risk</div>
            <div class="font-black text-xl" id="statHighRisk">0</div>
          </div>
          <div class="hr"></div>
          <div class="flex flex-wrap gap-2 no-print">
            <button class="btn btn-primary" id="btnAddFinding"><i class="fa-solid fa-plus"></i> Add Finding</button>
            <button class="btn btn-outline" id="btnExportJSON"><i class="fa-solid fa-file-code"></i> Export JSON</button>
            <button class="btn btn-outline" id="btnExportCSV"><i class="fa-solid fa-file-csv"></i> Export CSV</button>
            <button class="btn btn-outline" id="btnImport"><i class="fa-solid fa-file-import"></i> Import</button>
          </div>
          <input id="fileImport" type="file" accept=".json,.csv" class="hidden" />
        </div>
      </div>
    </section>

    <!-- Section: Checklist -->
    <section class="card mb-6">
      <div class="card-h flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div class="flex items-center gap-2">
          <i class="fa-solid fa-list-check text-blue-600"></i>
          <div>
            <div class="font-black">Checklist</div>
            <div class="help">Pick a baseline checklist and mark compliance per item.</div>
          </div>
        </div>

        <div class="flex flex-wrap items-center gap-2 no-print">
          <div class="relative w-full md:w-80">
            <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-gray-400"></i>
            <input id="search" class="input pl-9" placeholder="Search checklist + findings  /" />
          </div>
          <select id="checklistPreset" class="select w-full md:w-56" title="Checklist preset">
            <option value="hse">HSE – General</option>
            <option value="qa">QA – Workmanship</option>
            <option value="snag">Snag – Practical</option>
            <option value="electrical">Electrical – Basic</option>
            <option value="fire">Fire – Basic</option>
            <option value="custom">Custom</option>
          </select>
          <button class="btn btn-outline" id="btnLoadPreset"><i class="fa-solid fa-wand-magic-sparkles"></i> Load</button>
          <button class="btn btn-outline" id="btnAddChecklistItem"><i class="fa-solid fa-plus"></i> Add Item</button>
        </div>
      </div>

      <div class="card-b">
        <div class="overflow-auto">
          <table class="table">
            <thead>
              <tr>
                <th style="min-width:320px">Checklist Item</th>
                <th style="min-width:150px">Result</th>
                <th style="min-width:220px">Comments</th>
                <th style="min-width:160px">Evidence</th>
                <th class="no-print" style="min-width:220px">Actions</th>
              </tr>
            </thead>
            <tbody id="checklistTbody"></tbody>
          </table>
        </div>
        <div class="help mt-3">
          Results: <span class="badge ok"><i class="fa-solid fa-check"></i> Pass</span>
          <span class="badge warn"><i class="fa-solid fa-minus"></i> N/A</span>
          <span class="badge bad"><i class="fa-solid fa-xmark"></i> Fail</span>
          • Failing items can be linked to a finding for corrective action tracking.
        </div>
      </div>
    </section>

    <!-- Section: Findings + Actions -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
      <div class="card lg:col-span-2">
        <div class="card-h flex items-center justify-between">
          <div class="flex items-center gap-2">
            <i class="fa-solid fa-triangle-exclamation text-blue-600"></i>
            <div>
              <div class="font-black">Findings & Corrective Actions</div>
              <div class="help">Track risk, owner, due date, and closure evidence.</div>
            </div>
          </div>
          <span id="selectedFindingBadge" class="badge">No finding selected</span>
        </div>

        <div class="card-b">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 no-print">
            <div>
              <label class="text-sm font-extrabold">Title</label>
              <input id="fTitle" class="input mt-1" placeholder="e.g., Missing handrail at stairwell" />
            </div>
            <div>
              <label class="text-sm font-extrabold">Risk Level</label>
              <select id="fRisk" class="select mt-1">
                <option>Low</option>
                <option>Medium</option>
                <option>High</option>
                <option>Critical</option>
              </select>
            </div>

            <div>
              <label class="text-sm font-extrabold">Area / Location</label>
              <input id="fArea" class="input mt-1" placeholder="e.g., Block B, Level 2" />
            </div>
            <div>
              <label class="text-sm font-extrabold">Reference (optional)</label>
              <input id="fRef" class="input mt-1" placeholder="e.g., NCR-0004 / Photo-02" />
            </div>

            <div>
              <label class="text-sm font-extrabold">Owner (responsible)</label>
              <input id="fOwner" class="input mt-1" placeholder="Name / contractor / team" />
            </div>
            <div>
              <label class="text-sm font-extrabold">Due Date</label>
              <input id="fDue" type="date" class="input mt-1" />
            </div>

            <div>
              <label class="text-sm font-extrabold">Status</label>
              <select id="fStatus" class="select mt-1">
                <option>Open</option>
                <option>In Progress</option>
                <option>Closed</option>
              </select>
            </div>
            <div>
              <label class="text-sm font-extrabold">Linked Checklist Item (optional)</label>
              <select id="fLinkedChecklist" class="select mt-1"></select>
            </div>

            <div class="md:col-span-2">
              <label class="text-sm font-extrabold">Details</label>
              <textarea id="fDetails" class="textarea mt-1" placeholder="Describe the issue, immediate controls, and required corrective action."></textarea>
            </div>

            <div class="md:col-span-2 flex flex-wrap gap-2">
              <button class="btn btn-primary" id="btnSaveFinding"><i class="fa-solid fa-check"></i> Save Finding</button>
              <button class="btn btn-outline" id="btnClearFinding"><i class="fa-solid fa-eraser"></i> Clear</button>
              <span class="help ml-auto flex items-center gap-2">
                Editing: <span id="findingEditMode" class="badge">Off</span>
              </span>
            </div>
          </div>

          <div class="hr no-print"></div>

          <div class="overflow-auto">
            <table class="table">
              <thead>
                <tr>
                  <th style="min-width:280px">Finding</th>
                  <th style="min-width:140px">Risk</th>
                  <th style="min-width:180px">Owner</th>
                  <th style="min-width:150px">Due</th>
                  <th style="min-width:150px">Status</th>
                  <th style="min-width:220px">Linked Item</th>
                  <th class="no-print" style="min-width:240px">Actions</th>
                </tr>
              </thead>
              <tbody id="findingsTbody"></tbody>
            </table>
          </div>

          <div class="help mt-3">
            Tip: use findings for audit trails. “Closed” should include closure evidence in photos or notes.
          </div>
        </div>
      </div>

      <div class="space-y-6">
        <!-- Photos -->
        <div class="card">
          <div class="card-h flex items-center justify-between">
            <div class="flex items-center gap-2">
              <i class="fa-solid fa-camera text-blue-600"></i>
              <div>
                <div class="font-black">Photos / Evidence</div>
                <div class="help">Attach photos to the inspection (offline stored).</div>
              </div>
            </div>
            <div class="flex items-center gap-2 no-print">
              <button class="btn btn-outline" id="btnAddPhoto"><i class="fa-solid fa-plus"></i> Add</button>
              <button class="btn btn-danger" id="btnClearPhotos"><i class="fa-solid fa-trash"></i></button>
            </div>
          </div>
          <div class="card-b">
            <input id="photoInput" type="file" accept="image/*" multiple class="hidden" />
            <div class="photo-grid" id="photoGrid"></div>
            <div class="help mt-3">Photos are stored in your browser storage (base64). For large inspections, export JSON regularly.</div>
          </div>
        </div>

        <!-- Signatures -->
        <div class="card">
          <div class="card-h">
            <div class="flex items-center gap-2">
              <i class="fa-solid fa-pen-nib text-blue-600"></i>
              <div>
                <div class="font-black">Signatures</div>
                <div class="help">Capture inspector + site representative sign-off.</div>
              </div>
            </div>
          </div>
          <div class="card-b space-y-4">
            <div>
              <div class="flex items-center justify-between mb-2">
                <div class="font-extrabold">Inspector</div>
                <button class="btn btn-outline no-print" id="btnClearSig1"><i class="fa-solid fa-eraser"></i> Clear</button>
              </div>
              <div class="sig-wrap">
                <canvas id="sig1" class="sig-canvas"></canvas>
              </div>
              <div class="help mt-2">Sign with finger/mouse. Saved locally.</div>
            </div>

            <div>
              <div class="flex items-center justify-between mb-2">
                <div class="font-extrabold">Site Representative</div>
                <button class="btn btn-outline no-print" id="btnClearSig2"><i class="fa-solid fa-eraser"></i> Clear</button>
              </div>
              <div class="sig-wrap">
                <canvas id="sig2" class="sig-canvas"></canvas>
              </div>
              <div class="help mt-2">Sign-off indicates acknowledgement of findings and corrective actions.</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Templates modal -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center p-4 no-print" aria-hidden="true">
      <div class="card w-full max-w-2xl">
        <div class="card-h flex items-center justify-between">
          <div class="font-black"><i class="fa-solid fa-folder-open text-blue-600"></i> Templates</div>
          <button class="btn btn-outline" id="btnCloseModal"><i class="fa-solid fa-xmark"></i> Close</button>
        </div>
        <div class="card-b">
          <div class="help mb-3">Templates store your inspection meta + checklist + findings + photos + signatures.</div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
            <div class="md:col-span-2">
              <label class="text-sm font-extrabold">Template Name</label>
              <input id="tplName" class="input mt-1" placeholder="e.g., Weekly HSE Inspection" />
            </div>
            <div class="flex items-end">
              <button class="btn btn-primary w-full" id="btnTplSave"><i class="fa-solid fa-floppy-disk"></i> Save Template</button>
            </div>
          </div>

          <div class="overflow-auto">
            <table class="table">
              <thead>
                <tr>
                  <th>Template</th>
                  <th style="min-width:180px">Updated</th>
                  <th class="no-print" style="min-width:220px">Actions</th>
                </tr>
              </thead>
              <tbody id="tplTbody"></tbody>
            </table>
          </div>

          <div class="mt-3 flex flex-wrap gap-2 no-print">
            <button class="btn btn-outline" id="btnTplExportAll"><i class="fa-solid fa-file-arrow-down"></i> Export All Templates</button>
            <button class="btn btn-danger" id="btnTplClearAll"><i class="fa-solid fa-trash"></i> Delete All Templates</button>
          </div>
        </div>
      </div>
    </div>

    <footer class="mt-10 mb-6 text-center text-xs text-gray-500 no-print">
      <div class="font-bold">EasyINSPECT</div>
      <div>Offline-first inspections • Checklists • Findings • Photos • Signatures • Templates • Print-ready reports</div>
    </footer>
  </main>

  <div class="toast no-print" id="toast"></div>

  <script>
    /********************
     * EasyINSPECT v1 (offline-first)
     ********************/
    (function(){
      const KEY_STATE = "easy.inspect.state.v1";
      const KEY_TPL   = "easy.inspect.templates.v1";
      const KEY_DARK  = "easy.darkmode.v1";

      const $ = (id)=>document.getElementById(id);

      const els = {
        companyName: $("companyName"),
        siteName: $("siteName"),
        siteAddress: $("siteAddress"),
        inspectionType: $("inspectionType"),
        inspectionDate: $("inspectionDate"),
        conditions: $("conditions"),
        inspectorName: $("inspectorName"),
        inspectorContact: $("inspectorContact"),
        scopeNotes: $("scopeNotes"),

        statChecklist: $("statChecklist"),
        statCompleted: $("statCompleted"),
        statFindings: $("statFindings"),
        statHighRisk: $("statHighRisk"),

        search: $("search"),
        checklistPreset: $("checklistPreset"),
        btnLoadPreset: $("btnLoadPreset"),
        btnAddChecklistItem: $("btnAddChecklistItem"),

        checklistTbody: $("checklistTbody"),
        fLinkedChecklist: $("fLinkedChecklist"),

        btnAddFinding: $("btnAddFinding"),
        fTitle: $("fTitle"),
        fRisk: $("fRisk"),
        fArea: $("fArea"),
        fRef: $("fRef"),
        fOwner: $("fOwner"),
        fDue: $("fDue"),
        fStatus: $("fStatus"),
        fDetails: $("fDetails"),
        btnSaveFinding: $("btnSaveFinding"),
        btnClearFinding: $("btnClearFinding"),
        findingEditMode: $("findingEditMode"),
        selectedFindingBadge: $("selectedFindingBadge"),

        findingsTbody: $("findingsTbody"),

        btnAddPhoto: $("btnAddPhoto"),
        btnClearPhotos: $("btnClearPhotos"),
        photoInput: $("photoInput"),
        photoGrid: $("photoGrid"),

        sig1: $("sig1"),
        sig2: $("sig2"),
        btnClearSig1: $("btnClearSig1"),
        btnClearSig2: $("btnClearSig2"),

        btnDark: $("btnDark"),
        btnPrint: $("btnPrint"),

        btnExportJSON: $("btnExportJSON"),
        btnExportCSV: $("btnExportCSV"),
        btnImport: $("btnImport"),
        fileImport: $("fileImport"),

        btnSaveTemplate: $("btnSaveTemplate"),
        btnLoadTemplate: $("btnLoadTemplate"),
        btnReset: $("btnReset"),
        autosaveStatus: $("autosaveStatus"),

        modal: $("modal"),
        btnCloseModal: $("btnCloseModal"),
        tplName: $("tplName"),
        btnTplSave: $("btnTplSave"),
        tplTbody: $("tplTbody"),
        btnTplExportAll: $("btnTplExportAll"),
        btnTplClearAll: $("btnTplClearAll"),

        toast: $("toast"),
      };

      const state = {
        meta: {
          companyName:"",
          siteName:"",
          siteAddress:"",
          inspectionType:"HSE (Health & Safety)",
          inspectionDate:"",
          conditions:"",
          inspectorName:"",
          inspectorContact:"",
          scopeNotes:"",
        },
        checklist: [],
        findings: [],
        photos: [], // {id, name, dataUrl, note, at}
        signatures: { inspector:null, siteRep:null }, // dataUrl PNG
        selectedFindingId: null,
        editingFindingId: null,
        autosave: true,
        lastSavedAt: null
      };

      const uid = ()=> "i_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
      const nowISO = ()=> new Date().toISOString();
      const safeText = (s)=> (s ?? "").toString();
      const escapeHtml = (s)=> safeText(s)
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
      const fmtShort = (iso)=>{
        if(!iso) return "—";
        const d = new Date(iso);
        if(Number.isNaN(d.getTime())) return "—";
        return d.toLocaleDateString("en-ZA", { year:"numeric", month:"short", day:"2-digit" });
      };

      function toast(type, title, body){
        const icon = type==="ok" ? "fa-circle-check" : type==="warn" ? "fa-triangle-exclamation" : "fa-circle-xmark";
        const item = document.createElement("div");
        item.className = "toast-item";
        item.innerHTML = `
          <div class="ticon"><i class="fa-solid ${icon}"></i></div>
          <div class="tmain">
            <div class="tt">${escapeHtml(title)}</div>
            <div class="tb">${escapeHtml(body||"")}</div>
          </div>
          <button class="tclose" title="Dismiss"><i class="fa-solid fa-xmark"></i></button>
        `;
        item.querySelector(".tclose").addEventListener("click", ()=> item.remove());
        els.toast.appendChild(item);
        setTimeout(()=>{ try{ item.remove(); }catch(_){} }, 6000);
      }

      function setDark(on){
        const html = document.documentElement;
        const body = document.body;
        if(on){ html.classList.add("dark"); body.classList.add("dark"); }
        else { html.classList.remove("dark"); body.classList.remove("dark"); }
        localStorage.setItem(KEY_DARK, on ? "1" : "0");
      }

      function persist(){
        if(!state.autosave) return;
        try{
          state.lastSavedAt = nowISO();
          localStorage.setItem(KEY_STATE, JSON.stringify(state));
          els.autosaveStatus.textContent = "On";
        }catch(e){
          els.autosaveStatus.textContent = "Off";
          toast("bad","Autosave failed","Your browser storage may be full or blocked.");
        }
      }

      function loadState(){
        const raw = localStorage.getItem(KEY_STATE);
        if(!raw) return false;
        try{
          const parsed = JSON.parse(raw);
          if(parsed && typeof parsed === "object"){
            if(parsed.meta) state.meta = Object.assign(state.meta, parsed.meta);
            state.checklist = Array.isArray(parsed.checklist) ? parsed.checklist : [];
            state.findings = Array.isArray(parsed.findings) ? parsed.findings : [];
            state.photos = Array.isArray(parsed.photos) ? parsed.photos : [];
            state.signatures = Object.assign(state.signatures, parsed.signatures || {});
            state.selectedFindingId = parsed.selectedFindingId || null;
            state.editingFindingId = parsed.editingFindingId || null;
            state.autosave = parsed.autosave !== false;
            state.lastSavedAt = parsed.lastSavedAt || null;
            return true;
          }
        }catch(_){}
        return false;
      }

      function applyMetaToUI(){
        els.companyName.value = state.meta.companyName || "";
        els.siteName.value = state.meta.siteName || "";
        els.siteAddress.value = state.meta.siteAddress || "";
        els.inspectionType.value = state.meta.inspectionType || "HSE (Health & Safety)";
        els.inspectionDate.value = state.meta.inspectionDate || "";
        els.conditions.value = state.meta.conditions || "";
        els.inspectorName.value = state.meta.inspectorName || "";
        els.inspectorContact.value = state.meta.inspectorContact || "";
        els.scopeNotes.value = state.meta.scopeNotes || "";
        els.autosaveStatus.textContent = state.autosave ? "On" : "Off";
      }

      function readMetaFromUI(){
        state.meta.companyName = els.companyName.value.trim();
        state.meta.siteName = els.siteName.value.trim();
        state.meta.siteAddress = els.siteAddress.value.trim();
        state.meta.inspectionType = els.inspectionType.value;
        state.meta.inspectionDate = els.inspectionDate.value;
        state.meta.conditions = els.conditions.value.trim();
        state.meta.inspectorName = els.inspectorName.value.trim();
        state.meta.inspectorContact = els.inspectorContact.value.trim();
        state.meta.scopeNotes = els.scopeNotes.value.trim();
      }

      function presetItems(key){
        const HSE = [
          "PPE compliance (hard hat, vest, boots, eye protection)",
          "Housekeeping (trip hazards, waste management)",
          "Access control / site induction visible",
          "Work at height controls (ladders/scaffolding)",
          "Electrical safety (extensions, DB boards, lockout)",
          "Fire safety (extinguishers, access to exits)",
          "Tool safety (guards, inspections, correct use)",
          "Signage & demarcation (restricted areas)",
          "First aid availability and emergency numbers",
          "Hazard reporting and near-miss process"
        ];
        const QA = [
          "Materials match specification (type, grade, quantity)",
          "Workmanship (alignment, plumb, level, finish)",
          "Fasteners/anchors correct and torqued",
          "Cable routing neat, labeled, protected",
          "Conduit/trunking secure and sealed where required",
          "Test results recorded (continuity, insulation, etc.)",
          "As-built updates captured",
          "Snag items recorded and assigned",
          "Photos captured for key milestones",
          "Client requirements met for acceptance"
        ];
        const SNAG = [
          "Damage to surfaces (scratches, dents, paint)",
          "Missing covers/caps/plates/labels",
          "Uneven finishes or poor sealing",
          "Loose fixtures or fittings",
          "Incomplete cleanup / debris",
          "Non-compliant routing / exposed cabling",
          "Missing documentation / handover pack",
          "Access panels blocked or not labeled",
          "Equipment not commissioned/tested",
          "Outstanding punch list items from prior visit"
        ];
        const ELEC = [
          "DB board labeled and closed properly",
          "Cables protected from mechanical damage",
          "Earthing/bonding present and intact",
          "No exposed conductors or open joints",
          "Temporary power safe and managed",
          "Extension leads in good condition (no joins)",
          "RCD protection where required",
          "Isolation procedures followed (LOTO if applicable)"
        ];
        const FIRE = [
          "Extinguishers present, in date, accessible",
          "Escape routes clear and marked",
          "No blocked exits",
          "Hot work permits where applicable",
          "Flammables stored correctly",
          "Fire alarms/points accessible (if installed)"
        ];
        if(key==="qa") return QA;
        if(key==="snag") return SNAG;
        if(key==="electrical") return ELEC;
        if(key==="fire") return FIRE;
        return HSE;
      }

      function ensureChecklist(){
        if(state.checklist.length) return;
        // default
        const items = presetItems("hse");
        state.checklist = items.map((t)=>({
          id: uid(),
          text: t,
          result: "N/A", // Pass, Fail, N/A
          comment: "",
          evidence: ""
        }));
      }

      function badgeResult(r){
        if(r==="Pass") return `<span class="badge ok"><i class="fa-solid fa-check"></i> Pass</span>`;
        if(r==="Fail") return `<span class="badge bad"><i class="fa-solid fa-xmark"></i> Fail</span>`;
        return `<span class="badge warn"><i class="fa-solid fa-minus"></i> N/A</span>`;
      }

      function getSearchQ(){
        return (els.search.value || "").trim().toLowerCase();
      }

      function renderChecklist(){
        const q = getSearchQ();
        const filtered = state.checklist.filter(it=>{
          if(!q) return true;
          const hay = (it.text + " " + it.comment + " " + it.evidence).toLowerCase();
          return hay.includes(q);
        });

        els.checklistTbody.innerHTML = filtered.map(it=>{
          return `
            <tr>
              <td>
                <div class="font-extrabold">${escapeHtml(it.text)}</div>
                <div class="help">ID: <span class="mono">${escapeHtml(it.id)}</span></div>
              </td>
              <td>
                <select class="select" data-act="setResult" data-id="${it.id}">
                  <option ${it.result==="Pass"?"selected":""}>Pass</option>
                  <option ${it.result==="Fail"?"selected":""}>Fail</option>
                  <option ${it.result==="N/A"?"selected":""}>N/A</option>
                </select>
                <div class="mt-2">${badgeResult(it.result)}</div>
              </td>
              <td>
                <textarea class="textarea" style="min-height:90px" data-act="setComment" data-id="${it.id}" placeholder="Notes...">${escapeHtml(it.comment||"")}</textarea>
              </td>
              <td>
                <input class="input" data-act="setEvidence" data-id="${it.id}" placeholder="e.g., Photo-03 / Ref / Doc" value="${escapeHtml(it.evidence||"")}" />
              </td>
              <td class="no-print">
                <div class="flex flex-wrap gap-2">
                  <button class="btn btn-outline" data-act="makeFinding" data-id="${it.id}" title="Create finding from this item (recommended for Fail)">
                    <i class="fa-solid fa-bolt"></i> Finding
                  </button>
                  <button class="btn btn-danger" data-act="delItem" data-id="${it.id}">
                    <i class="fa-solid fa-trash"></i> Delete
                  </button>
                </div>
              </td>
            </tr>
          `;
        }).join("") || `<tr><td colspan="5" class="help">No checklist items match your search.</td></tr>`;

        // Linked checklist dropdown
        const opts = [`<option value="">— None —</option>`]
          .concat(state.checklist.map(it=> `<option value="${it.id}">${escapeHtml(it.text)}</option>`));
        els.fLinkedChecklist.innerHTML = opts.join("");

        snapshotStats();
      }

      function riskBadge(r){
        if(r==="Critical") return `<span class="badge bad"><i class="fa-solid fa-skull-crossbones"></i> Critical</span>`;
        if(r==="High") return `<span class="badge bad"><i class="fa-solid fa-triangle-exclamation"></i> High</span>`;
        if(r==="Medium") return `<span class="badge warn"><i class="fa-solid fa-circle-exclamation"></i> Medium</span>`;
        return `<span class="badge ok"><i class="fa-solid fa-circle-check"></i> Low</span>`;
      }

      function renderFindings(){
        const q = getSearchQ();
        const filtered = state.findings.filter(f=>{
          if(!q) return true;
          const hay = [
            f.title, f.risk, f.area, f.ref, f.owner, f.status, f.details,
            (f.linkedChecklistText||"")
          ].filter(Boolean).join(" ").toLowerCase();
          return hay.includes(q);
        });

        els.findingsTbody.innerHTML = filtered.map(f=>{
          const linked = f.linkedChecklistText ? f.linkedChecklistText : (f.linkedChecklistId ? "Linked item" : "—");
          return `
            <tr>
              <td>
                <div class="font-extrabold">${escapeHtml(f.title||"—")}</div>
                <div class="help">${escapeHtml(f.area||"")}</div>
              </td>
              <td>${riskBadge(f.risk)}</td>
              <td>${escapeHtml(f.owner||"—")}</td>
              <td>${fmtShort(f.dueDate)}</td>
              <td>${escapeHtml(f.status||"Open")}</td>
              <td>${escapeHtml(linked)}</td>
              <td class="no-print">
                <div class="flex flex-wrap gap-2">
                  <button class="btn btn-outline" data-act="selectFinding" data-id="${f.id}">
                    <i class="fa-solid fa-crosshairs"></i> Select
                  </button>
                  <button class="btn btn-outline" data-act="editFinding" data-id="${f.id}">
                    <i class="fa-solid fa-pen-to-square"></i> Edit
                  </button>
                  <button class="btn btn-danger" data-act="delFinding" data-id="${f.id}">
                    <i class="fa-solid fa-trash"></i> Delete
                  </button>
                </div>
              </td>
            </tr>
          `;
        }).join("") || `<tr><td colspan="7" class="help">No findings yet. Click <b>Add Finding</b> to create your first one.</td></tr>`;

        snapshotStats();
        renderSelectedFindingBadge();
      }

      function renderSelectedFindingBadge(){
        const f = state.findings.find(x=> x.id === state.selectedFindingId);
        if(!f){
          els.selectedFindingBadge.className = "badge";
          els.selectedFindingBadge.innerHTML = "No finding selected";
          return;
        }
        let cls = "badge ok";
        if(f.risk==="High" || f.risk==="Critical") cls = "badge bad";
        else if(f.risk==="Medium") cls = "badge warn";
        els.selectedFindingBadge.className = cls;
        els.selectedFindingBadge.innerHTML = `<i class="fa-solid fa-crosshairs"></i> ${escapeHtml(f.title || "Selected")}`;
      }

      function snapshotStats(){
        const total = state.checklist.length;
        const completed = state.checklist.filter(it=> it.result === "Pass" || it.result === "Fail").length;
        const findings = state.findings.length;
        const highRisk = state.findings.filter(f=> f.risk==="High" || f.risk==="Critical").length;

        els.statChecklist.textContent = String(total);
        els.statCompleted.textContent = String(completed);
        els.statFindings.textContent = String(findings);
        els.statHighRisk.textContent = String(highRisk);
      }

      function clearFindingForm(){
        els.fTitle.value = "";
        els.fRisk.value = "Low";
        els.fArea.value = "";
        els.fRef.value = "";
        els.fOwner.value = "";
        els.fDue.value = "";
        els.fStatus.value = "Open";
        els.fLinkedChecklist.value = "";
        els.fDetails.value = "";
        state.editingFindingId = null;
        els.findingEditMode.className = "badge";
        els.findingEditMode.textContent = "Off";
      }

      function setFindingEdit(on){
        els.findingEditMode.className = on ? "badge warn" : "badge";
        els.findingEditMode.textContent = on ? "On" : "Off";
      }

      function addFinding(){
        clearFindingForm();
        toast("ok","Add finding","Fill in details and click Save Finding.");
        window.scrollTo({top: document.body.scrollHeight * 0.25, behavior:"smooth"});
      }

      function saveFinding(){
        readMetaFromUI();

        const editingId = state.editingFindingId;
        const existing = editingId ? state.findings.find(f=> f.id === editingId) : null;

        const f = existing ? existing : { id: uid(), createdAt: nowISO() };
        f.updatedAt = nowISO();
        f.title = els.fTitle.value.trim();
        f.risk = els.fRisk.value;
        f.area = els.fArea.value.trim();
        f.ref = els.fRef.value.trim();
        f.owner = els.fOwner.value.trim();
        f.dueDate = els.fDue.value || "";
        f.status = els.fStatus.value;
        f.details = els.fDetails.value.trim();

        const lId = els.fLinkedChecklist.value || "";
        f.linkedChecklistId = lId;
        const item = state.checklist.find(it=> it.id === lId);
        f.linkedChecklistText = item ? item.text : "";

        if(!f.title) return toast("warn","Cannot save finding","Title is required.");

        if(!existing){
          state.findings.unshift(f);
          toast("ok","Finding added", f.title);
        }else{
          toast("ok","Finding updated", f.title);
        }

        state.selectedFindingId = f.id;
        state.editingFindingId = null;
        setFindingEdit(false);
        persist();
        clearFindingForm();
        renderFindings();
      }

      function editFinding(id){
        const f = state.findings.find(x=> x.id === id);
        if(!f) return;

        state.editingFindingId = id;
        setFindingEdit(true);

        els.fTitle.value = f.title || "";
        els.fRisk.value = f.risk || "Low";
        els.fArea.value = f.area || "";
        els.fRef.value = f.ref || "";
        els.fOwner.value = f.owner || "";
        els.fDue.value = f.dueDate || "";
        els.fStatus.value = f.status || "Open";
        els.fLinkedChecklist.value = f.linkedChecklistId || "";
        els.fDetails.value = f.details || "";

        toast("ok","Edit mode","Update fields then Save Finding.");
      }

      function deleteFinding(id){
        const f = state.findings.find(x=> x.id === id);
        const ok = confirm(`Delete finding "${f?.title || id}"?`);
        if(!ok) return;
        state.findings = state.findings.filter(x=> x.id !== id);
        if(state.selectedFindingId === id) state.selectedFindingId = null;
        if(state.editingFindingId === id) state.editingFindingId = null;
        persist();
        renderFindings();
        toast("ok","Deleted","Finding removed.");
      }

      function selectFinding(id){
        state.selectedFindingId = id;
        persist();
        renderSelectedFindingBadge();
        toast("ok","Selected","Finding selected.");
      }

      function makeFindingFromChecklist(itemId){
        const it = state.checklist.find(x=> x.id === itemId);
        if(!it) return;
        addFinding();
        els.fTitle.value = it.text;
        els.fRisk.value = (it.result === "Fail") ? "High" : "Medium";
        els.fLinkedChecklist.value = it.id;
        els.fDetails.value = it.comment || "";
        toast("ok","Prefilled finding","Linked to checklist item.");
      }

      function addChecklistItem(){
        const text = prompt("New checklist item:");
        if(!text || !text.trim()) return;
        state.checklist.unshift({ id: uid(), text: text.trim(), result:"N/A", comment:"", evidence:"" });
        persist();
        renderChecklist();
        toast("ok","Added","Checklist item created.");
      }

      function deleteChecklistItem(id){
        const it = state.checklist.find(x=> x.id === id);
        const ok = confirm(`Delete checklist item "${it?.text || id}"?`);
        if(!ok) return;
        state.checklist = state.checklist.filter(x=> x.id !== id);
        persist();
        renderChecklist();
        toast("ok","Deleted","Checklist item removed.");
      }

      function setChecklistResult(id, v){
        const it = state.checklist.find(x=> x.id === id);
        if(!it) return;
        it.result = v;
        persist();
        renderChecklist();
      }

      function setChecklistField(id, field, v){
        const it = state.checklist.find(x=> x.id === id);
        if(!it) return;
        it[field] = v;
        persist();
      }

      function renderPhotos(){
        els.photoGrid.innerHTML = state.photos.map(p=>{
          return `
            <div class="photo-item">
              <img src="${p.dataUrl}" alt="${escapeHtml(p.name||"photo")}" />
              <div class="meta">
                <div class="font-extrabold text-sm truncate">${escapeHtml(p.name||"Photo")}</div>
                <div class="help">${fmtShort(p.at)}</div>
                <input class="input mt-2" data-act="photoNote" data-id="${p.id}" placeholder="Caption / evidence note" value="${escapeHtml(p.note||"")}" />
                <button class="btn btn-danger mt-2 w-full" data-act="delPhoto" data-id="${p.id}">
                  <i class="fa-solid fa-trash"></i> Remove
                </button>
              </div>
            </div>
          `;
        }).join("") || `<div class="help">No photos yet. Click <b>Add</b> to attach evidence.</div>`;
      }

      async function addPhotos(files){
        const arr = Array.from(files || []);
        if(!arr.length) return;
        for(const f of arr){
          const dataUrl = await fileToDataUrl(f);
          state.photos.unshift({ id: uid(), name: f.name, dataUrl, note:"", at: nowISO() });
        }
        persist();
        renderPhotos();
        toast("ok","Photos added", `${arr.length} photo(s) attached.`);
      }

      function fileToDataUrl(file){
        return new Promise((resolve,reject)=>{
          const r = new FileReader();
          r.onload = ()=> resolve(r.result);
          r.onerror = reject;
          r.readAsDataURL(file);
        });
      }

      function deletePhoto(id){
        state.photos = state.photos.filter(p=> p.id !== id);
        persist();
        renderPhotos();
        toast("ok","Removed","Photo deleted.");
      }

      function clearPhotos(){
        const ok = confirm("Remove ALL photos from this inspection?");
        if(!ok) return;
        state.photos = [];
        persist();
        renderPhotos();
        toast("ok","Cleared","All photos removed.");
      }

      /** Signatures */
      function setupSignature(canvas, onSave){
        const ctx = canvas.getContext("2d");
        let drawing = false;
        let last = null;

        function resize(){
          const rect = canvas.getBoundingClientRect();
          const dpr = window.devicePixelRatio || 1;
          canvas.width = Math.floor(rect.width * dpr);
          canvas.height = Math.floor(rect.height * dpr);
          ctx.setTransform(dpr,0,0,dpr,0,0);
          ctx.lineWidth = 2.2;
          ctx.lineCap = "round";
          ctx.lineJoin = "round";
          ctx.strokeStyle = document.documentElement.classList.contains("dark") ? "#e5e7eb" : "#0f172a";
          // if we have a stored signature, redraw it after resize
          onSave("redraw");
        }

        function pos(e){
          const rect = canvas.getBoundingClientRect();
          const x = (e.clientX - rect.left);
          const y = (e.clientY - rect.top);
          return {x,y};
        }

        function start(e){
          drawing = true;
          last = pos(e);
        }
        function move(e){
          if(!drawing) return;
          const p = pos(e);
          ctx.beginPath();
          ctx.moveTo(last.x, last.y);
          ctx.lineTo(p.x, p.y);
          ctx.stroke();
          last = p;
        }
        function end(){
          if(!drawing) return;
          drawing = false;
          last = null;
          const dataUrl = canvas.toDataURL("image/png");
          onSave(dataUrl);
        }

        // Mouse
        canvas.addEventListener("mousedown", (e)=> start(e));
        window.addEventListener("mousemove", (e)=> move(e));
        window.addEventListener("mouseup", ()=> end());

        // Touch
        canvas.addEventListener("touchstart", (e)=>{
          e.preventDefault();
          const t = e.touches[0];
          start(t);
        }, {passive:false});
        canvas.addEventListener("touchmove", (e)=>{
          e.preventDefault();
          const t = e.touches[0];
          move(t);
        }, {passive:false});
        canvas.addEventListener("touchend", (e)=>{
          e.preventDefault();
          end();
        }, {passive:false});

        window.addEventListener("resize", resize);
        resize();

        return {
          clear(){
            ctx.clearRect(0,0,canvas.width, canvas.height);
            onSave(null);
          },
          drawFrom(dataUrl){
            if(!dataUrl) return;
            const img = new Image();
            img.onload = ()=>{
              // draw at CSS px scale (ctx already scaled)
              ctx.drawImage(img, 0, 0, canvas.getBoundingClientRect().width, canvas.getBoundingClientRect().height);
            };
            img.src = dataUrl;
          }
        };
      }

      /** Export */
      function downloadBlob(blob, filename){
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(()=>URL.revokeObjectURL(url), 1000);
      }

      function exportJSON(filename="easy-site-inspection.json", dataObj=null){
        readMetaFromUI();
        const payload = dataObj || { exportedAt: nowISO(), app:"EasyINSPECT", version:"1.0", state };
        const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
        downloadBlob(blob, filename);
      }

      function csvEscape(v){
        const s = safeText(v);
        if(s.includes(",") || s.includes('"') || s.includes("\n")){
          return '"' + s.replaceAll('"','""') + '"';
        }
        return s;
      }

      function exportCSV(){
        readMetaFromUI();
        // Export two CSV sections: checklist + findings (simple flat CSV with Type column)
        const cols = ["Type","InspectionDate","Site","Inspector","Item","Result","Risk","Owner","DueDate","Status","Comment","Evidence","Details"];
        const lines = [cols.join(",")];
        const meta = state.meta;

        state.checklist.forEach(it=>{
          lines.push([
            "CHECKLIST",
            meta.inspectionDate, meta.siteName, meta.inspectorName,
            it.text, it.result, "", "", "", "",
            it.comment, it.evidence, ""
          ].map(csvEscape).join(","));
        });

        state.findings.forEach(f=>{
          lines.push([
            "FINDING",
            meta.inspectionDate, meta.siteName, meta.inspectorName,
            f.title, "", f.risk, f.owner, f.dueDate, f.status,
            "", f.ref, f.details
          ].map(csvEscape).join(","));
        });

        const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
        downloadBlob(blob, "easy-site-inspection.csv");
      }

      async function importFile(file){
        const ext = (file.name.split(".").pop() || "").toLowerCase();
        const text = await file.text();

        if(ext === "json"){
          try{
            const obj = JSON.parse(text);
            const importedState = obj.state ? obj.state : obj;
            if(importedState && importedState.checklist){
              state.meta = Object.assign(state.meta, importedState.meta || {});
              state.checklist = Array.isArray(importedState.checklist) ? importedState.checklist : [];
              state.findings = Array.isArray(importedState.findings) ? importedState.findings : [];
              state.photos = Array.isArray(importedState.photos) ? importedState.photos : [];
              state.signatures = Object.assign(state.signatures, importedState.signatures || {});
              state.selectedFindingId = null;
              state.editingFindingId = null;

              persist();
              applyMetaToUI();
              renderChecklist();
              renderFindings();
              renderPhotos();
              sig1Pad.drawFrom(state.signatures.inspector);
              sig2Pad.drawFrom(state.signatures.siteRep);
              toast("ok","Imported JSON","Inspection updated from JSON import.");
              return;
            }
          }catch(e){
            return toast("bad","Import failed","Invalid JSON file.");
          }
          return toast("bad","Import failed","JSON format not recognized.");
        }

        if(ext === "csv"){
          // Minimal: accept our export CSV
          const rows = parseCSV(text);
          if(!rows.length) return toast("bad","Import failed","CSV appears empty.");
          const header = rows[0].map(h=>h.trim());
          const idx = (name)=> header.indexOf(name);
          if(idx("Type") === -1) return toast("bad","Import failed","CSV missing Type column.");

          const newChecklist = [];
          const newFindings = [];
          for(let i=1;i<rows.length;i++){
            const r = rows[i];
            if(!r || !r.length) continue;
            const type = (r[idx("Type")] || "").trim();
            if(type === "CHECKLIST"){
              const it = {
                id: uid(),
                text: (r[idx("Item")] || "").trim(),
                result: (r[idx("Result")] || "N/A").trim() || "N/A",
                comment: (r[idx("Comment")] || "").trim(),
                evidence: (r[idx("Evidence")] || "").trim()
              };
              if(it.text) newChecklist.push(it);
            }else if(type === "FINDING"){
              const f = {
                id: uid(),
                createdAt: nowISO(),
                updatedAt: nowISO(),
                title: (r[idx("Item")] || "").trim(),
                risk: (r[idx("Risk")] || "Low").trim() || "Low",
                owner: (r[idx("Owner")] || "").trim(),
                dueDate: (r[idx("DueDate")] || "").trim(),
                status: (r[idx("Status")] || "Open").trim() || "Open",
                ref: (r[idx("Evidence")] || "").trim(),
                details: (r[idx("Details")] || "").trim(),
                area: "",
                linkedChecklistId: "",
                linkedChecklistText: ""
              };
              if(f.title) newFindings.push(f);
            }
          }

          state.checklist = newChecklist.length ? newChecklist : state.checklist;
          state.findings = newFindings.concat(state.findings);

          persist();
          renderChecklist();
          renderFindings();
          toast("ok","Imported CSV","Checklist/findings imported.");
          return;
        }

        toast("warn","Unsupported file","Please import a .json or .csv file.");
      }

      function parseCSV(text){
        const rows = [];
        let row = [];
        let cur = "";
        let inQuotes = false;

        for(let i=0;i<text.length;i++){
          const ch = text[i];
          const next = text[i+1];

          if(ch === '"' && inQuotes && next === '"'){ cur += '"'; i++; continue; }
          if(ch === '"'){ inQuotes = !inQuotes; continue; }

          if(ch === "," && !inQuotes){ row.push(cur); cur=""; continue; }
          if((ch === "\n" || ch === "\r") && !inQuotes){
            if(ch === "\r" && next === "\n") i++;
            row.push(cur);
            rows.push(row);
            row = [];
            cur = "";
            continue;
          }
          cur += ch;
        }
        if(cur.length || row.length){ row.push(cur); rows.push(row); }
        return rows.filter(r=> r.some(c=> (c||"").trim() !== ""));
      }

      /** Templates */
      function loadTemplates(){
        const raw = localStorage.getItem(KEY_TPL);
        if(!raw) return [];
        try{ const arr = JSON.parse(raw); return Array.isArray(arr) ? arr : []; }catch(_){ return []; }
      }
      function saveTemplates(arr){ localStorage.setItem(KEY_TPL, JSON.stringify(arr)); }

      function openModal(){
        renderTemplates();
        els.modal.classList.remove("hidden");
        els.modal.classList.add("flex");
        els.modal.setAttribute("aria-hidden","false");
      }
      function closeModal(){
        els.modal.classList.add("hidden");
        els.modal.classList.remove("flex");
        els.modal.setAttribute("aria-hidden","true");
      }

      function renderTemplates(){
        const tpls = loadTemplates();
        els.tplTbody.innerHTML = tpls.map(t=>{
          return `
            <tr>
              <td>
                <div class="font-extrabold">${escapeHtml(t.name)}</div>
                <div class="help">${escapeHtml(t.app||"EasyINSPECT")} • ${escapeHtml(t.version||"")}</div>
              </td>
              <td>${fmtShort(t.updatedAt)}</td>
              <td class="no-print">
                <div class="flex flex-wrap gap-2">
                  <button class="btn btn-primary" data-act="tplLoad" data-id="${t.id}">
                    <i class="fa-solid fa-arrow-rotate-right"></i> Load
                  </button>
                  <button class="btn btn-outline" data-act="tplExport" data-id="${t.id}">
                    <i class="fa-solid fa-file-arrow-down"></i> Export
                  </button>
                  <button class="btn btn-danger" data-act="tplDel" data-id="${t.id}">
                    <i class="fa-solid fa-trash"></i> Delete
                  </button>
                </div>
              </td>
            </tr>
          `;
        }).join("") || `<tr><td colspan="3" class="help">No templates saved yet.</td></tr>`;
      }

      function saveTemplate(name){
        readMetaFromUI();
        const tpls = loadTemplates();
        const tpl = {
          id: "t_" + Math.random().toString(16).slice(2),
          name: name || ("Template " + new Date().toLocaleString("en-ZA")),
          app: "EasyINSPECT",
          version: "1.0",
          updatedAt: nowISO(),
          payload: JSON.parse(JSON.stringify(state))
        };
        tpls.unshift(tpl);
        saveTemplates(tpls);
        toast("ok","Template saved", tpl.name);
        renderTemplates();
      }

      function loadTemplate(id){
        const tpls = loadTemplates();
        const tpl = tpls.find(t=> t.id === id);
        if(!tpl) return;

        const ok = confirm(`Load template "${tpl.name}"?\nThis will replace your current inspection in the page.`);
        if(!ok) return;

        const p = tpl.payload || {};
        state.meta = Object.assign(state.meta, p.meta || {});
        state.checklist = Array.isArray(p.checklist) ? p.checklist : [];
        state.findings = Array.isArray(p.findings) ? p.findings : [];
        state.photos = Array.isArray(p.photos) ? p.photos : [];
        state.signatures = Object.assign(state.signatures, p.signatures || {});
        state.selectedFindingId = null;
        state.editingFindingId = null;

        persist();
        applyMetaToUI();
        renderChecklist();
        renderFindings();
        renderPhotos();
        sig1Pad.drawFrom(state.signatures.inspector);
        sig2Pad.drawFrom(state.signatures.siteRep);
        closeModal();
        toast("ok","Template loaded", tpl.name);
      }

      function deleteTemplate(id){
        const tpls = loadTemplates();
        const t = tpls.find(x=> x.id === id);
        const ok = confirm(`Delete template "${t?.name || id}"?`);
        if(!ok) return;
        saveTemplates(tpls.filter(x=> x.id !== id));
        toast("ok","Deleted","Template removed.");
        renderTemplates();
      }

      function exportTemplate(id){
        const tpls = loadTemplates();
        const tpl = tpls.find(t=> t.id === id);
        if(!tpl) return;
        exportJSON(`easy-inspect-template-${(tpl.name||"template").replaceAll(" ","_")}.json`, tpl);
        toast("ok","Exported","Template downloaded as JSON.");
      }

      function exportAllTemplates(){
        const tpls = loadTemplates();
        exportJSON("easy-inspect-templates.json", { exportedAt: nowISO(), app:"EasyINSPECT", version:"1.0", templates: tpls });
        toast("ok","Exported","All templates downloaded.");
      }

      function clearAllTemplates(){
        const ok = confirm("Delete ALL templates? This cannot be undone.");
        if(!ok) return;
        saveTemplates([]);
        renderTemplates();
        toast("ok","Cleared","All templates removed.");
      }

      /** Reset */
      function resetAll(){
        const ok = confirm("Reset this inspection page to defaults?\nThis clears the current inspection state (templates remain).");
        if(!ok) return;
        localStorage.removeItem(KEY_STATE);

        state.meta = {
          companyName:"",
          siteName:"",
          siteAddress:"",
          inspectionType:"HSE (Health & Safety)",
          inspectionDate:"",
          conditions:"",
          inspectorName:"",
          inspectorContact:"",
          scopeNotes:"",
        };
        state.checklist = [];
        state.findings = [];
        state.photos = [];
        state.signatures = { inspector:null, siteRep:null };
        state.selectedFindingId = null;
        state.editingFindingId = null;
        state.autosave = true;
        state.lastSavedAt = null;

        applyMetaToUI();
        ensureChecklist();
        renderChecklist();
        renderFindings();
        renderPhotos();
        sig1Pad.clear();
        sig2Pad.clear();
        toast("ok","Reset complete","Inspection cleared (templates kept).");
      }

      /** Wiring */
      function wire(){
        // Dark mode init
        if(localStorage.getItem(KEY_DARK) === "1") setDark(true);

        els.btnDark.addEventListener("click", ()=> setDark(!document.documentElement.classList.contains("dark")));
        document.addEventListener("keydown", (e)=>{
          if(e.key && e.key.toLowerCase() === "d" && !e.ctrlKey && !e.metaKey && !e.altKey){
            setDark(!document.documentElement.classList.contains("dark"));
          }
          if(e.key === "/" && !e.ctrlKey && !e.metaKey && !e.altKey){
            e.preventDefault();
            els.search.focus();
          }
          if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "s"){
            e.preventDefault();
            openModal();
            els.tplName.focus();
          }
        });

        els.btnPrint.addEventListener("click", ()=> window.print());

        // Meta autosave
        [
          els.companyName, els.siteName, els.siteAddress, els.inspectionType, els.inspectionDate,
          els.conditions, els.inspectorName, els.inspectorContact, els.scopeNotes
        ].forEach(el=>{
          el.addEventListener("input", ()=> { readMetaFromUI(); persist(); });
          el.addEventListener("change", ()=> { readMetaFromUI(); persist(); });
        });

        els.search.addEventListener("input", ()=> { renderChecklist(); renderFindings(); });
        els.search.addEventListener("change", ()=> { renderChecklist(); renderFindings(); });

        // Checklist preset load
        els.btnLoadPreset.addEventListener("click", ()=>{
          const key = els.checklistPreset.value;
          if(key === "custom"){
            toast("warn","Custom preset","Add items manually using Add Item.");
            return;
          }
          const ok = confirm("Replace current checklist with the selected preset?");
          if(!ok) return;
          const items = presetItems(key);
          state.checklist = items.map(t=>({ id: uid(), text:t, result:"N/A", comment:"", evidence:"" }));
          persist();
          renderChecklist();
          toast("ok","Checklist loaded","Preset applied.");
        });

        els.btnAddChecklistItem.addEventListener("click", addChecklistItem);

        // Checklist interactions (delegate)
        els.checklistTbody.addEventListener("change", (e)=>{
          const el = e.target;
          const id = el.getAttribute("data-id");
          const act = el.getAttribute("data-act");
          if(!id || !act) return;
          if(act === "setResult") return setChecklistResult(id, el.value);
        });
        els.checklistTbody.addEventListener("input", (e)=>{
          const el = e.target;
          const id = el.getAttribute("data-id");
          const act = el.getAttribute("data-act");
          if(!id || !act) return;
          if(act === "setComment") return setChecklistField(id, "comment", el.value);
          if(act === "setEvidence") return setChecklistField(id, "evidence", el.value);
        });
        els.checklistTbody.addEventListener("click", (e)=>{
          const btn = e.target.closest("button");
          if(!btn) return;
          const id = btn.getAttribute("data-id");
          const act = btn.getAttribute("data-act");
          if(act === "delItem") return deleteChecklistItem(id);
          if(act === "makeFinding") return makeFindingFromChecklist(id);
        });

        // Findings
        els.btnAddFinding.addEventListener("click", addFinding);
        els.btnSaveFinding.addEventListener("click", saveFinding);
        els.btnClearFinding.addEventListener("click", ()=> { clearFindingForm(); setFindingEdit(false); });

        els.findingsTbody.addEventListener("click", (e)=>{
          const btn = e.target.closest("button");
          if(!btn) return;
          const id = btn.getAttribute("data-id");
          const act = btn.getAttribute("data-act");
          if(act === "selectFinding") return selectFinding(id);
          if(act === "editFinding") return editFinding(id);
          if(act === "delFinding") return deleteFinding(id);
        });

        // Photos
        els.btnAddPhoto.addEventListener("click", ()=> els.photoInput.click());
        els.photoInput.addEventListener("change", async (e)=>{
          const files = e.target.files;
          await addPhotos(files);
          els.photoInput.value = "";
        });
        els.btnClearPhotos.addEventListener("click", clearPhotos);

        els.photoGrid.addEventListener("input", (e)=>{
          const el = e.target;
          const act = el.getAttribute("data-act");
          const id = el.getAttribute("data-id");
          if(act !== "photoNote" || !id) return;
          const p = state.photos.find(x=> x.id === id);
          if(!p) return;
          p.note = el.value;
          persist();
        });
        els.photoGrid.addEventListener("click", (e)=>{
          const btn = e.target.closest("button");
          if(!btn) return;
          const act = btn.getAttribute("data-act");
          const id = btn.getAttribute("data-id");
          if(act === "delPhoto") return deletePhoto(id);
        });

        // Export/Import
        els.btnExportJSON.addEventListener("click", ()=> exportJSON());
        els.btnExportCSV.addEventListener("click", exportCSV);
        els.btnImport.addEventListener("click", ()=> els.fileImport.click());
        els.fileImport.addEventListener("change", async (e)=>{
          const f = e.target.files && e.target.files[0];
          if(!f) return;
          await importFile(f);
          els.fileImport.value = "";
        });

        // Templates
        els.btnSaveTemplate.addEventListener("click", openModal);
        els.btnLoadTemplate.addEventListener("click", openModal);
        els.btnCloseModal.addEventListener("click", closeModal);
        els.modal.addEventListener("click", (e)=> { if(e.target === els.modal) closeModal(); });

        els.btnTplSave.addEventListener("click", ()=>{
          const name = els.tplName.value.trim();
          if(!name) return toast("warn","Template name required","Enter a name then save.");
          saveTemplate(name);
          els.tplName.value = "";
        });
        els.btnTplExportAll.addEventListener("click", exportAllTemplates);
        els.btnTplClearAll.addEventListener("click", clearAllTemplates);

        els.tplTbody.addEventListener("click", (e)=>{
          const btn = e.target.closest("button");
          if(!btn) return;
          const act = btn.getAttribute("data-act");
          const id = btn.getAttribute("data-id");
          if(act === "tplLoad") return loadTemplate(id);
          if(act === "tplDel") return deleteTemplate(id);
          if(act === "tplExport") return exportTemplate(id);
        });

        // Reset
        els.btnReset.addEventListener("click", resetAll);
      }

      // Signature pads need to exist before init
      let sig1Pad, sig2Pad;

      function init(){
        const loaded = loadState();
        if(!state.meta.inspectionDate){
          state.meta.inspectionDate = new Date().toISOString().slice(0,10);
        }

        applyMetaToUI();
        ensureChecklist();

        // Setup signature pads
        sig1Pad = setupSignature(els.sig1, (dataUrlOrCmd)=>{
          if(dataUrlOrCmd === "redraw"){
            // redraw current signature on resize
            const cur = state.signatures.inspector;
            if(cur) sig1Pad.drawFrom(cur);
            return;
          }
          state.signatures.inspector = dataUrlOrCmd;
          persist();
        });

        sig2Pad = setupSignature(els.sig2, (dataUrlOrCmd)=>{
          if(dataUrlOrCmd === "redraw"){
            const cur = state.signatures.siteRep;
            if(cur) sig2Pad.drawFrom(cur);
            return;
          }
          state.signatures.siteRep = dataUrlOrCmd;
          persist();
        });

        // Load saved signatures to canvas
        if(state.signatures.inspector) sig1Pad.drawFrom(state.signatures.inspector);
        if(state.signatures.siteRep) sig2Pad.drawFrom(state.signatures.siteRep);

        els.btnClearSig1.addEventListener("click", ()=> { sig1Pad.clear(); toast("ok","Cleared","Inspector signature cleared."); });
        els.btnClearSig2.addEventListener("click", ()=> { sig2Pad.clear(); toast("ok","Cleared","Site rep signature cleared."); });

        renderChecklist();
        renderFindings();
        renderPhotos();
        wire();

        if(!loaded){
          toast("ok","EasyINSPECT ready","Offline-first inspection initialized.");
        }
      }

      init();
    })();
  </script>
</body>
</html>
