<!DOCTYPE html>
<html lang="en-ZA">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EasyINV – Feature-Rich Invoice Generator</title>
  <meta name="description" content="Create professional invoices in seconds. Preview, print, export PDF/Word/Excel/CSV, and save templates locally." />
  
  <!-- Favicon -->
  <link rel="icon" href="icon.png" type="image/png">
  <link rel="shortcut icon" href="icon.png">
  <link rel="alternate icon" href="favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" href="icon.png">
  <!-- Tailwind CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">

  <!-- Libraries removed -->
  <!-- External PDF/Excel/Word libraries have been removed to ensure the page functions offline.  -->

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root{
      --primary:#2563eb;
      --primary2:#1d4ed8;
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --danger:#dc2626;
      --success:#16a34a;
      --warning:#f59e0b;
    }
    body{background:var(--bg); color:var(--text);}

    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:0 10px 25px rgba(2,6,23,.05);}
    .btn{display:inline-flex; align-items:center; justify-content:center; gap:.5rem; padding:.7rem 1rem; border-radius:10px; font-weight:700; transition: all .2s ease; border:1px solid transparent;}
    .btn:hover{transform:translateY(-1px);}
    .btn-primary{background:var(--primary); color:#fff;}
    .btn-primary:hover{background:var(--primary2);}
    .btn-outline{background:#fff; border-color:var(--border); color:var(--text);}
    .btn-outline:hover{border-color:#cbd5e1; background:#f8fafc;}
    .btn-danger{background:var(--danger); color:#fff;}
    .btn-danger:hover{filter:brightness(.95);}
    .btn-success{background:var(--success); color:#fff;}
    .btn-success:hover{filter:brightness(.95);}
    .badge{display:inline-flex; align-items:center; gap:.4rem; padding:.25rem .6rem; border-radius:999px; font-weight:800; font-size:.75rem;}
    .badge-draft{background:#eef2ff; color:#3730a3;}
    .badge-sent{background:#ecfeff; color:#155e75;}
    .badge-paid{background:#dcfce7; color:#166534;}
    .badge-overdue{background:#fee2e2; color:#991b1b;}
    .badge-partial{background:#ffedd5; color:#9a3412;}

    input:focus, textarea:focus, select:focus{
      outline:none!important;
      border-color: rgba(37, 99, 235, .8)!important;
      box-shadow:0 0 0 3px rgba(37,99,235,.15)!important;
    }

    .responsive-table {overflow-x:auto; -webkit-overflow-scrolling:touch;}
    .mono {font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    /* Print-friendly manual style */
    @media print {
      .no-print { display:none !important; }
      .print-only { display:block !important; }
      body { background:#fff !important; }
      .card { box-shadow:none !important; border:none !important; }
      .manual-print { max-width: 210mm; margin:0 auto; padding:0; }
      table { page-break-inside:auto; }
      tr { page-break-inside:avoid; page-break-after:auto; }
      thead { display:table-header-group; }
      tfoot { display:table-footer-group; }
    }
  </style>
</head>

<body class="min-h-screen flex flex-col">

  
  <!-- Navigation -->
  <nav class="bg-blue-600 text-white py-4 no-print">
    <div class="container mx-auto px-4 flex flex-wrap items-center gap-4">
      <a href="index.html" class="font-bold text-xl mr-4">Easy&nbsp;Suite</a>
      <a href="easy-quote.html" class="underline font-semibold">Quote</a>
      <a href="easy-invoice.html" class="hover:underline">Invoice</a>
      <a href="easy-purchase-order.html" class="hover:underline">Purchase&nbsp;Order</a>
      <a href="easy-sales-order.html" class="hover:underline">Sales&nbsp;Order</a>
      <a href="easy-receipt.html" class="hover:underline">Receipt</a>
      <a href="easy-statement.html" class="hover:underline">Statement</a>
      <a href="easy-job-card.html" class="hover:underline">Job&nbsp;Card</a>
      <a href="easy-payroll.html" class="hover:underline">Payroll</a>
      <a href="easy-inventory.html" class="hover:underline">Inventory</a>
      <a href="easy-crm.html" class="hover:underline">CRM</a>
    </div>
  </nav>

<!-- Header -->
  <header class="bg-white border-b border-gray-200 no-print">
    <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row gap-4 sm:gap-0 items-start sm:items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-xl bg-blue-600 text-white flex items-center justify-center font-black">EI</div>
        <div>
          <h1 class="text-2xl font-extrabold text-blue-700">EasyINV</h1>
          <p class="text-sm text-gray-500">Feature-Rich Invoice Generator</p>
        </div>
      </div>

      <div class="flex flex-wrap items-center gap-2">
        <button class="btn btn-outline" id="btnSaveTemplate" title="Save current invoice as a template">
          <i class="fa-solid fa-floppy-disk"></i> Save
        </button>
        <button class="btn btn-outline" id="btnLoadTemplate" title="Load a saved template">
          <i class="fa-solid fa-folder-open"></i> Load
        </button>
        <button class="btn btn-outline" id="btnReset" title="Reset form (keeps templates)">
          <i class="fa-solid fa-rotate-left"></i> Reset
        </button>

        <span class="ml-0 sm:ml-4 text-xs text-gray-500">
          Autosave: <span class="font-bold" id="autosaveStatus">On</span>
        </span>
      </div>
    </div>
  </header>

  <main class="flex-grow container mx-auto px-4 py-6 md:py-8">

    <!-- Tips -->
    <div class="card p-4 mb-6 no-print">
      <div class="flex gap-3">
        <div class="text-blue-600 pt-0.5"><i class="fa-solid fa-circle-info"></i></div>
        <div class="flex-1">
          <h3 class="text-sm font-extrabold text-slate-900">Quick flow</h3>
          <div class="text-sm text-slate-600 mt-1">
            1) Add your company + client details → 2) Add line items → 3) Preview → 4) Export PDF/Word/Excel/CSV → 5) Save as a template.
          </div>
        </div>
      </div>
    </div>

    <!-- Top Grid: Parties + Invoice Meta -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
      <!-- Company -->
      <section class="card p-5">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-extrabold"><i class="fa-solid fa-building text-blue-600 mr-2"></i>Company</h2>
          <span class="text-xs text-slate-500">Sender</span>
        </div>

        <div class="space-y-3">
          <div>
            <label class="block text-sm font-bold text-slate-700 mb-1">Company Logo</label>
            <input type="file" id="companyLogo" accept="image/*"
              class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-bold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
            />
            <div id="companyLogoPreview" class="mt-2 h-14 flex items-center">
              <p class="text-sm text-slate-400">No logo uploaded</p>
            </div>
          </div>

          <div>
            <label class="block text-sm font-bold text-slate-700 mb-1">Company Name</label>
            <input id="companyName" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Your Company (Pty) Ltd">
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">VAT Number</label>
              <input id="companyVat" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="e.g., 4080...">
            </div>
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Reg/CK</label>
              <input id="companyReg" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Optional">
            </div>
          </div>

          <div>
            <label class="block text-sm font-bold text-slate-700 mb-1">Email</label>
            <input id="companyEmail" type="email" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="accounts@yourcompany.co.za">
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Phone</label>
              <input id="companyPhone" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="+27 ...">
            </div>
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Website</label>
              <input id="companyWebsite" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="https://...">
            </div>
          </div>

          <div>
            <label class="block text-sm font-bold text-slate-700 mb-1">Address</label>
            <textarea id="companyAddress" rows="3" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Street, City, Province, Postal Code"></textarea>
          </div>

          <div class="border-t border-gray-100 pt-3">
            <label class="block text-sm font-bold text-slate-700 mb-1">Bank Details (optional)</label>
            <textarea id="companyBank" rows="3" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Bank: ...&#10;Account: ...&#10;Branch: ...&#10;Reference: Invoice #"></textarea>
          </div>
        </div>
      </section>

      <!-- Client -->
      <section class="card p-5">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-extrabold"><i class="fa-solid fa-user-tie text-blue-600 mr-2"></i>Client</h2>
          <span class="text-xs text-slate-500">Bill To</span>
        </div>

        <div class="space-y-3">
          <div>
            <label class="block text-sm font-bold text-slate-700 mb-1">Client Name</label>
            <input id="clientName" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Client Company / Person">
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Client VAT</label>
              <input id="clientVat" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Optional">
            </div>
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Client Reg/ID</label>
              <input id="clientReg" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Optional">
            </div>
          </div>

          <div>
            <label class="block text-sm font-bold text-slate-700 mb-1">Email</label>
            <input id="clientEmail" type="email" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="billing@client.co.za">
          </div>

          <div>
            <label class="block text-sm font-bold text-slate-700 mb-1">Phone</label>
            <input id="clientPhone" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="+27 ...">
          </div>

          <div>
            <label class="block text-sm font-bold text-slate-700 mb-1">Address</label>
            <textarea id="clientAddress" rows="4" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Street, City, Province, Postal Code"></textarea>
          </div>
        </div>
      </section>

      <!-- Invoice Meta -->
      <section class="card p-5">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-extrabold"><i class="fa-solid fa-file-invoice text-blue-600 mr-2"></i>Invoice</h2>
          <span id="statusBadge" class="badge badge-draft"><i class="fa-solid fa-pen"></i> DRAFT</span>
        </div>

        <div class="space-y-3">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Invoice #</label>
              <input id="invoiceNumber" class="w-full border border-gray-200 rounded-lg px-3 py-2 mono" placeholder="INV0000001">
            </div>
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Reference</label>
              <input id="invoiceReference" class="w-full border border-gray-200 rounded-lg px-3 py-2 mono" placeholder="PO / SO / Job ref">
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Issue Date</label>
              <input id="invoiceDate" type="date" class="w-full border border-gray-200 rounded-lg px-3 py-2">
            </div>
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Due Date</label>
              <input id="dueDate" type="date" class="w-full border border-gray-200 rounded-lg px-3 py-2">
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Currency</label>
              <select id="currency" class="w-full border border-gray-200 rounded-lg px-3 py-2">
                <option value="ZAR" selected>ZAR (R)</option>
                <option value="USD">USD ($)</option>
                <option value="EUR">EUR (€)</option>
                <option value="GBP">GBP (£)</option>
              </select>
              <p class="text-xs text-slate-500 mt-1">Formatting adapts; no FX conversion.</p>
            </div>
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Status</label>
              <select id="invoiceStatus" class="w-full border border-gray-200 rounded-lg px-3 py-2">
                <option value="draft" selected>Draft</option>
                <option value="sent">Sent</option>
                <option value="partial">Partially Paid</option>
                <option value="paid">Paid</option>
                <option value="overdue">Overdue</option>
              </select>
            </div>
          </div>

          <div class="border-t border-gray-100 pt-3 space-y-3">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-1">Overall Discount %</label>
                <input id="overallDiscount" type="number" min="0" max="100" step="0.01" value="0.00"
                  class="w-full border border-gray-200 rounded-lg px-3 py-2">
              </div>
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-1">Shipping / Delivery</label>
                <input id="shipping" type="number" min="0" step="0.01" value="0.00"
                  class="w-full border border-gray-200 rounded-lg px-3 py-2">
              </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-1">Amount Paid</label>
                <input id="amountPaid" type="number" min="0" step="0.01" value="0.00"
                  class="w-full border border-gray-200 rounded-lg px-3 py-2">
              </div>
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-1">Default VAT % (new lines)</label>
                <input id="defaultVat" type="number" min="0" max="100" step="0.01" value="15.00"
                  class="w-full border border-gray-200 rounded-lg px-3 py-2">
              </div>
            </div>

            <div class="flex items-center justify-between gap-3">
              <button class="btn btn-outline w-full" id="btnNewNumber">
                <i class="fa-solid fa-wand-magic-sparkles"></i> New Invoice #
              </button>
              <button class="btn btn-outline w-full" id="btnMarkPaid">
                <i class="fa-solid fa-check"></i> Mark Paid
              </button>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- Line Items -->
    <section class="card p-5 mb-6">
      <div class="flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between mb-4">
        <h2 class="text-lg font-extrabold"><i class="fa-solid fa-list-check text-blue-600 mr-2"></i>Line Items</h2>
        <div class="flex flex-wrap gap-2 no-print">
          <button class="btn btn-outline" id="btnImportCSV" title="Import line items from CSV (Description,Qty,Rate,Disc%,VAT%)">
            <i class="fa-solid fa-file-import"></i> Import CSV
          </button>
          <input type="file" id="csvFile" accept=".csv" class="hidden">
          <button class="btn btn-primary" id="btnAddLine">
            <i class="fa-solid fa-plus"></i> Add Line
          </button>
        </div>
      </div>

      <div class="responsive-table">
        <table class="w-full text-sm border-collapse" id="itemsTable">
          <thead>
            <tr class="bg-gray-50 text-gray-600">
              <th class="border border-gray-200 p-2 text-left">Description</th>
              <th class="border border-gray-200 p-2 text-center">Qty</th>
              <th class="border border-gray-200 p-2 text-center">Rate (Excl.)</th>
              <th class="border border-gray-200 p-2 text-center">Disc %</th>
              <th class="border border-gray-200 p-2 text-center">VAT %</th>
              <th class="border border-gray-200 p-2 text-right">Total Excl.</th>
              <th class="border border-gray-200 p-2 text-right">Total Incl.</th>
              <th class="border border-gray-200 p-2 text-center no-print">Action</th>
            </tr>
          </thead>
          <tbody id="itemsBody"></tbody>
        </table>
      </div>
    </section>

    <!-- Notes & Terms -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
      <section class="card p-5">
        <h2 class="text-lg font-extrabold mb-3"><i class="fa-solid fa-note-sticky text-blue-600 mr-2"></i>Notes</h2>
        <textarea id="notes" rows="6" class="w-full border border-gray-200 rounded-lg px-3 py-2"
          placeholder="Optional notes to client (delivery details, contact person, etc.)"></textarea>
      </section>

      <section class="card p-5">
        <h2 class="text-lg font-extrabold mb-3"><i class="fa-solid fa-file-contract text-blue-600 mr-2"></i>Terms</h2>
        <textarea id="terms" rows="6" class="w-full border border-gray-200 rounded-lg px-3 py-2"
          placeholder="Payment terms, late fees, warranty conditions, etc."></textarea>
      </section>
    </div>

    <!-- Totals + Actions -->
    <section class="card p-5 mb-6">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
        <div class="lg:col-span-2">
          <h2 class="text-lg font-extrabold mb-2"><i class="fa-solid fa-calculator text-blue-600 mr-2"></i>Totals</h2>
          <p class="text-sm text-slate-500">Totals update automatically. Discount logic: line discount first, then overall discount on subtotal.</p>
        </div>

        <div class="lg:col-span-1">
          <div class="space-y-2 text-sm">
            <div class="flex justify-between border-t border-gray-100 pt-2">
              <span class="font-bold text-slate-700">Subtotal (Excl.)</span>
              <span id="tSubtotal" class="font-extrabold mono">R0.00</span>
            </div>
            <div class="flex justify-between">
              <span class="font-bold text-slate-700">Line Discounts</span>
              <span id="tLineDiscount" class="font-extrabold mono">R0.00</span>
            </div>
            <div class="flex justify-between">
              <span class="font-bold text-slate-700">Overall Discount</span>
              <span id="tOverallDiscount" class="font-extrabold mono">R0.00</span>
            </div>
            <div class="flex justify-between">
              <span class="font-bold text-slate-700">VAT Total</span>
              <span id="tVat" class="font-extrabold mono">R0.00</span>
            </div>
            <div class="flex justify-between">
              <span class="font-bold text-slate-700">Shipping</span>
              <span id="tShipping" class="font-extrabold mono">R0.00</span>
            </div>

            <div class="flex justify-between border-t border-b border-gray-100 py-2 text-base">
              <span class="font-black text-slate-900">GRAND TOTAL</span>
              <span id="tGrand" class="font-black mono">R0.00</span>
            </div>

            <div class="flex justify-between mt-3 text-base">
              <span class="font-black text-slate-900">AMOUNT PAID</span>
              <span id="tPaid" class="font-black mono">R0.00</span>
            </div>

            <div class="flex justify-between border-t border-gray-200 pt-3 text-lg">
              <span class="font-black text-slate-900">BALANCE DUE</span>
              <span id="tBalance" class="font-black mono">R0.00</span>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-6 flex flex-wrap gap-3 justify-center no-print">
        <button class="btn btn-outline" id="btnPreview">
          <i class="fa-solid fa-eye"></i> Preview
        </button>
        <button class="btn btn-outline" id="btnPrint">
          <i class="fa-solid fa-print"></i> Print (Manual)
        </button>
        <button class="btn btn-danger" id="btnPDF">
          <i class="fa-solid fa-file-pdf"></i> Export PDF
        </button>
        <button class="btn btn-primary" id="btnWord">
          <i class="fa-solid fa-file-word"></i> Export Word
        </button>
        <button class="btn btn-success" id="btnExcel">
          <i class="fa-solid fa-file-excel"></i> Export Excel
        </button>
        <button class="btn btn-outline" id="btnCSV">
          <i class="fa-solid fa-file-csv"></i> Export CSV
        </button>
      </div>
    </section>

    <!-- Preview Modal -->
    <div id="previewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50 no-print">
      <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-screen overflow-y-auto">
        <div class="p-4 flex justify-between items-center border-b border-gray-200">
          <div>
            <h2 class="text-xl font-black text-slate-900">Invoice Preview</h2>
            <p class="text-xs text-slate-500">This is the export/print layout.</p>
          </div>
          <button id="btnClosePreview" class="text-slate-500 hover:text-slate-800">
            <i class="fa-solid fa-xmark text-xl"></i>
          </button>
        </div>

        <div id="previewContent" class="p-6"></div>

        <div class="p-4 border-t border-gray-200 flex justify-end gap-2">
          <button class="btn btn-outline" id="btnClosePreviewBottom">Close</button>
          <button class="btn btn-danger" id="btnPDF2">
            <i class="fa-solid fa-file-pdf"></i> Export PDF
          </button>
        </div>
      </div>
    </div>

    <!-- Hidden Export Template -->
    <div id="invoiceTemplate" class="hidden">
      <div class="manual-print max-w-4xl mx-auto bg-white p-6">
        <div class="flex items-start justify-between gap-6 mb-6">
          <div class="flex-1">
            <div id="tplLogo" class="mb-3"></div>
            <div class="text-xl font-black" id="tplCompanyName">Company</div>
            <div class="text-sm text-slate-600 mt-1 whitespace-pre-line" id="tplCompanyAddress"></div>
            <div class="text-sm text-slate-600 mt-2">
              <div><span class="font-bold">VAT:</span> <span id="tplCompanyVat"></span></div>
              <div><span class="font-bold">Reg:</span> <span id="tplCompanyReg"></span></div>
              <div><span class="font-bold">Email:</span> <span id="tplCompanyEmail"></span></div>
              <div><span class="font-bold">Phone:</span> <span id="tplCompanyPhone"></span></div>
              <div><span class="font-bold">Website:</span> <span id="tplCompanyWebsite"></span></div>
            </div>
          </div>

          <div class="w-72 text-right">
            <div class="text-3xl font-black tracking-tight">INVOICE</div>
            <div class="mt-2 grid grid-cols-2 gap-x-2 text-sm">
              <span class="text-right font-bold">NUMBER:</span><span class="text-left mono" id="tplInvNumber"></span>
              <span class="text-right font-bold">REF:</span><span class="text-left mono" id="tplInvRef"></span>
              <span class="text-right font-bold">DATE:</span><span class="text-left" id="tplInvDate"></span>
              <span class="text-right font-bold">DUE:</span><span class="text-left" id="tplInvDue"></span>
              <span class="text-right font-bold">STATUS:</span><span class="text-left" id="tplInvStatus"></span>
              <span class="text-right font-bold">CURRENCY:</span><span class="text-left mono" id="tplInvCurrency"></span>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-6">
          <div class="border border-gray-200 rounded-lg p-4">
            <div class="text-xs text-slate-500 font-black mb-2">BILL TO</div>
            <div class="text-base font-black" id="tplClientName"></div>
            <div class="text-sm text-slate-600 mt-1 whitespace-pre-line" id="tplClientAddress"></div>
            <div class="text-sm text-slate-600 mt-2">
              <div><span class="font-bold">VAT:</span> <span id="tplClientVat"></span></div>
              <div><span class="font-bold">Reg/ID:</span> <span id="tplClientReg"></span></div>
              <div><span class="font-bold">Email:</span> <span id="tplClientEmail"></span></div>
              <div><span class="font-bold">Phone:</span> <span id="tplClientPhone"></span></div>
            </div>
          </div>

          <div class="border border-gray-200 rounded-lg p-4">
            <div class="text-xs text-slate-500 font-black mb-2">PAYMENT / BANK</div>
            <div class="text-sm text-slate-700 whitespace-pre-line" id="tplBank"></div>
          </div>
        </div>

        <div class="responsive-table mb-5">
          <table class="w-full border-collapse text-sm">
            <thead>
              <tr class="bg-gray-50">
                <th class="border border-gray-200 p-2 text-left">Description</th>
                <th class="border border-gray-200 p-2 text-center">Qty</th>
                <th class="border border-gray-200 p-2 text-right">Rate</th>
                <th class="border border-gray-200 p-2 text-center">Disc</th>
                <th class="border border-gray-200 p-2 text-center">VAT</th>
                <th class="border border-gray-200 p-2 text-right">Excl</th>
                <th class="border border-gray-200 p-2 text-right">Incl</th>
              </tr>
            </thead>
            <tbody id="tplItems"></tbody>
          </table>
        </div>

        <div class="flex justify-end mb-6">
          <div class="w-full sm:w-1/2 md:w-1/3 text-sm">
            <div class="flex justify-between border-t border-gray-200 pt-2">
              <span class="font-bold text-slate-700">Subtotal</span>
              <span class="mono" id="tplSubtotal"></span>
            </div>
            <div class="flex justify-between">
              <span class="font-bold text-slate-700">Line Discounts</span>
              <span class="mono" id="tplLineDisc"></span>
            </div>
            <div class="flex justify-between">
              <span class="font-bold text-slate-700">Overall Discount</span>
              <span class="mono" id="tplOverallDisc"></span>
            </div>
            <div class="flex justify-between">
              <span class="font-bold text-slate-700">VAT</span>
              <span class="mono" id="tplVat"></span>
            </div>
            <div class="flex justify-between">
              <span class="font-bold text-slate-700">Shipping</span>
              <span class="mono" id="tplShipping"></span>
            </div>
            <div class="flex justify-between border-t border-b border-gray-200 py-2 font-black text-base">
              <span>GRAND TOTAL</span>
              <span class="mono" id="tplGrand"></span>
            </div>
            <div class="flex justify-between mt-2">
              <span class="font-black text-slate-900">PAID</span>
              <span class="mono font-black" id="tplPaid"></span>
            </div>
            <div class="flex justify-between mt-2 text-lg font-black">
              <span>BALANCE DUE</span>
              <span class="mono" id="tplBalance"></span>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
          <div class="border border-gray-200 rounded-lg p-4">
            <div class="text-xs text-slate-500 font-black mb-2">NOTES</div>
            <div class="text-sm text-slate-700 whitespace-pre-line" id="tplNotes"></div>
          </div>
          <div class="border border-gray-200 rounded-lg p-4">
            <div class="text-xs text-slate-500 font-black mb-2">TERMS</div>
            <div class="text-sm text-slate-700 whitespace-pre-line" id="tplTerms"></div>
          </div>
        </div>

        <div class="mt-6 text-xs text-slate-500 text-center">
          Generated with EasyINV • Print-friendly output
        </div>
      </div>
    </div>

  </main>

<script>
  // ===========================
  // Helpers
  // ===========================
  // In production, avoid global alert handlers. Errors will be logged via
  // console.error instead of interrupting the user with pop‑up messages.
  // window.onerror is intentionally left undefined here.
  const $ = (id) => document.getElementById(id);

  function escapeHtml(str){
    // Convert the input to a string before replacing to avoid errors when
    // non‑string values (e.g. numbers) are passed.  Using String() ensures
    // that truthy non‑string values like numbers or booleans are coerced to
    // strings, and that undefined/null becomes an empty string.  Without this
    // conversion, calling `.replace` on a number would throw an error.
    return String(str || "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
    }[m]));
  }

  function symbolForCurrency(cur){
    switch(cur){
      case "USD": return "$";
      case "EUR": return "€";
      case "GBP": return "£";
      case "ZAR":
      default: return "R";
    }
  }

  // Simple file saver helper.  Replaces the external FileSaver.js dependency.
  // Creates a download link for the provided blob and triggers a click so the
  // browser prompts the user to save the file.  Afterwards the link and
  // object URL are cleaned up.  This keeps downloads working offline.
  function saveAs(blob, filename){
    try {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.style.display = 'none';
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      // Give the browser a tick to register the click before cleanup
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 0);
    } catch (err) {
      console.error(err);
      alert('Download failed. Your browser may not support programmatic downloads.');
    }
  }

  function fmt(amount){
    const cur = $("currency").value || "ZAR";
    const sym = symbolForCurrency(cur);
    const n = Number(amount || 0);
    // Keep simple formatting consistent across browsers
    const fixed = n.toFixed(2);
    const withSep = fixed.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    return sym + withSep;
  }

  function formatDateISO(iso){
    if(!iso) return "";
    const [y,m,d] = iso.split("-");
    return `${d}/${m}/${y}`;
  }

  function setStatusBadge(){
    const s = $("invoiceStatus").value;
    const badge = $("statusBadge");

    const map = {
      draft: {cls:"badge badge-draft", icon:"fa-pen", text:"DRAFT"},
      sent: {cls:"badge badge-sent", icon:"fa-paper-plane", text:"SENT"},
      partial: {cls:"badge badge-partial", icon:"fa-circle-half-stroke", text:"PARTIAL"},
      paid: {cls:"badge badge-paid", icon:"fa-check", text:"PAID"},
      overdue: {cls:"badge badge-overdue", icon:"fa-triangle-exclamation", text:"OVERDUE"},
    };
    const v = map[s] || map.draft;
    badge.className = v.cls;
    badge.innerHTML = `<i class="fa-solid ${v.icon}"></i> ${v.text}`;
  }

  function generateInvoiceNumber(){
    const n = Math.floor(Math.random()*10000000).toString().padStart(7,"0");
    $("invoiceNumber").value = "INV" + n;
  }

  // ===========================
  // Line items
  // ===========================
  let lineCounter = 0;

  function addLineItem(prefill={}){
    const tbody = $("itemsBody");
    const rowId = "li-" + (lineCounter++);

    const defaultVat = Number($("defaultVat").value || 0).toFixed(2);

    const tr = document.createElement("tr");
    tr.id = rowId;
    tr.className = "line-item";

    tr.innerHTML = `
      <td class="border border-gray-200 p-2">
        <input type="text" class="w-full border border-gray-200 rounded-md px-2 py-1 item-desc"
          placeholder="Description" value="${escapeHtml(prefill.desc || "")}">
      </td>
      <td class="border border-gray-200 p-2">
        <input type="number" min="0" step="1" class="w-full border border-gray-200 rounded-md px-2 py-1 text-center item-qty"
          value="${escapeHtml(prefill.qty ?? 1)}">
      </td>
      <td class="border border-gray-200 p-2">
        <input type="number" min="0" step="0.01" class="w-full border border-gray-200 rounded-md px-2 py-1 text-center item-rate"
          value="${escapeHtml(prefill.rate ?? "0.00")}">
      </td>
      <td class="border border-gray-200 p-2">
        <input type="number" min="0" max="100" step="0.01" class="w-full border border-gray-200 rounded-md px-2 py-1 text-center item-disc"
          value="${escapeHtml(prefill.disc ?? "0.00")}">
      </td>
      <td class="border border-gray-200 p-2">
        <input type="number" min="0" max="100" step="0.01" class="w-full border border-gray-200 rounded-md px-2 py-1 text-center item-vat"
          value="${escapeHtml(prefill.vat ?? defaultVat)}">
      </td>
      <td class="border border-gray-200 p-2 text-right mono item-excl">${fmt(0)}</td>
      <td class="border border-gray-200 p-2 text-right mono item-incl">${fmt(0)}</td>
      <td class="border border-gray-200 p-2 text-center no-print">
        <button class="text-red-600 hover:text-red-800" title="Delete line">
          <i class="fa-solid fa-trash-can"></i>
        </button>
      </td>
    `;

    tbody.appendChild(tr);

    // delete
    tr.querySelector("button").addEventListener("click", () => {
      tr.remove();
      calculateTotals();
      autosave();
    });

    // recalc on changes
    tr.querySelectorAll("input").forEach(inp=>{
      inp.addEventListener("input", () => {
        calculateTotals();
        autosave();
      });
    });

    calculateTotals();
  }

  function readLineItems(){
    const items = [];
    document.querySelectorAll(".line-item").forEach(tr=>{
      items.push({
        desc: tr.querySelector(".item-desc").value || "",
        qty: Number(tr.querySelector(".item-qty").value || 0),
        rate: Number(tr.querySelector(".item-rate").value || 0),
        disc: Number(tr.querySelector(".item-disc").value || 0),
        vat: Number(tr.querySelector(".item-vat").value || 0),
      });
    });
    return items;
  }

  // ===========================
  // Totals
  // ===========================
  function calculateTotals(){
    setStatusBadge();

    const overallDiscPct = Number($("overallDiscount").value || 0) / 100;
    const shipping = Number($("shipping").value || 0);
    const paid = Number($("amountPaid").value || 0);

    let subtotalExcl = 0;
    let lineDiscountTotal = 0;
    let vatTotal = 0;

    document.querySelectorAll(".line-item").forEach(tr=>{
      const qty = Number(tr.querySelector(".item-qty").value || 0);
      const rate = Number(tr.querySelector(".item-rate").value || 0);
      const discPct = Number(tr.querySelector(".item-disc").value || 0) / 100;
      const vatPct = Number(tr.querySelector(".item-vat").value || 0) / 100;

      const base = qty * rate;
      const discAmt = base * discPct;
      const excl = Math.max(0, base - discAmt);
      const vatAmt = excl * vatPct;
      const incl = excl + vatAmt;

      subtotalExcl += excl;
      lineDiscountTotal += discAmt;
      vatTotal += vatAmt;

      tr.querySelector(".item-excl").textContent = fmt(excl);
      tr.querySelector(".item-incl").textContent = fmt(incl);
    });

    const overallDiscountAmt = subtotalExcl * overallDiscPct;
    const discountedSubtotal = Math.max(0, subtotalExcl - overallDiscountAmt);

    // VAT already computed per line based on line-excl after line discount.
    // Overall discount usually reduces taxable base; we apply proportional reduction to VAT:
    const vatAfterOverallDisc = Math.max(0, vatTotal - (vatTotal * overallDiscPct));

    const grand = discountedSubtotal + vatAfterOverallDisc + shipping;
    const balance = Math.max(0, grand - paid);

    $("tSubtotal").textContent = fmt(subtotalExcl);
    $("tLineDiscount").textContent = fmt(lineDiscountTotal);
    $("tOverallDiscount").textContent = fmt(overallDiscountAmt);
    $("tVat").textContent = fmt(vatAfterOverallDisc);
    $("tShipping").textContent = fmt(shipping);
    $("tGrand").textContent = fmt(grand);
    $("tPaid").textContent = fmt(paid);
    $("tBalance").textContent = fmt(balance);

    return {
      subtotalExcl,
      lineDiscountTotal,
      overallDiscountAmt,
      vat: vatAfterOverallDisc,
      shipping,
      grand,
      paid,
      balance
    };
  }

  // ===========================
  // Logo handling (embed as DataURL)
  // ===========================
  let companyLogoDataUrl = null;

  function handleLogoUpload(file){
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      companyLogoDataUrl = e.target.result;
      const preview = $("companyLogoPreview");
      preview.innerHTML = "";
      const img = document.createElement("img");
      img.src = companyLogoDataUrl;
      img.className = "h-14 object-contain";
      preview.appendChild(img);
      autosave();
    };
    reader.readAsDataURL(file);
  }

  // ===========================
  // Preview / Template fill
  // ===========================
  function buildTemplateDom(){
    const tpl = $("invoiceTemplate").firstElementChild.cloneNode(true);

    // logo
    const logoWrap = tpl.querySelector("#tplLogo");
    logoWrap.innerHTML = "";
    if(companyLogoDataUrl){
      const img = document.createElement("img");
      img.src = companyLogoDataUrl;
      img.style.height = "60px";
      img.style.objectFit = "contain";
      logoWrap.appendChild(img);
    }

    // company
    tpl.querySelector("#tplCompanyName").textContent = $("companyName").value || "Company";
    tpl.querySelector("#tplCompanyAddress").textContent = $("companyAddress").value || "";
    tpl.querySelector("#tplCompanyVat").textContent = $("companyVat").value || "";
    tpl.querySelector("#tplCompanyReg").textContent = $("companyReg").value || "";
    tpl.querySelector("#tplCompanyEmail").textContent = $("companyEmail").value || "";
    tpl.querySelector("#tplCompanyPhone").textContent = $("companyPhone").value || "";
    tpl.querySelector("#tplCompanyWebsite").textContent = $("companyWebsite").value || "";

    // invoice meta
    tpl.querySelector("#tplInvNumber").textContent = $("invoiceNumber").value || "";
    tpl.querySelector("#tplInvRef").textContent = $("invoiceReference").value || "";
    tpl.querySelector("#tplInvDate").textContent = formatDateISO($("invoiceDate").value) || "";
    tpl.querySelector("#tplInvDue").textContent = formatDateISO($("dueDate").value) || "";
    tpl.querySelector("#tplInvStatus").textContent = ($("invoiceStatus").value || "draft").toUpperCase();
    tpl.querySelector("#tplInvCurrency").textContent = $("currency").value || "ZAR";

    // client
    tpl.querySelector("#tplClientName").textContent = $("clientName").value || "Client";
    tpl.querySelector("#tplClientAddress").textContent = $("clientAddress").value || "";
    tpl.querySelector("#tplClientVat").textContent = $("clientVat").value || "";
    tpl.querySelector("#tplClientReg").textContent = $("clientReg").value || "";
    tpl.querySelector("#tplClientEmail").textContent = $("clientEmail").value || "";
    tpl.querySelector("#tplClientPhone").textContent = $("clientPhone").value || "";

    // bank / payment
    tpl.querySelector("#tplBank").textContent = $("companyBank").value || "";

    // items
    const items = readLineItems();
    const tbody = tpl.querySelector("#tplItems");
    tbody.innerHTML = "";

    items.forEach(i=>{
      const base = i.qty * i.rate;
      const discAmt = base * (i.disc/100);
      const excl = Math.max(0, base - discAmt);
      const vatAmt = excl * (i.vat/100);
      const incl = excl + vatAmt;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="border border-gray-200 p-2">${escapeHtml(i.desc || "Item")}</td>
        <td class="border border-gray-200 p-2 text-center">${i.qty}</td>
        <td class="border border-gray-200 p-2 text-right mono">${fmt(i.rate)}</td>
        <td class="border border-gray-200 p-2 text-center">${Number(i.disc||0).toFixed(2)}%</td>
        <td class="border border-gray-200 p-2 text-center">${Number(i.vat||0).toFixed(2)}%</td>
        <td class="border border-gray-200 p-2 text-right mono">${fmt(excl)}</td>
        <td class="border border-gray-200 p-2 text-right mono">${fmt(incl)}</td>
      `;
      tbody.appendChild(tr);
    });

    // totals
    const t = calculateTotals();
    tpl.querySelector("#tplSubtotal").textContent = fmt(t.subtotalExcl);
    tpl.querySelector("#tplLineDisc").textContent = fmt(t.lineDiscountTotal);
    tpl.querySelector("#tplOverallDisc").textContent = fmt(t.overallDiscountAmt);
    tpl.querySelector("#tplVat").textContent = fmt(t.vat);
    tpl.querySelector("#tplShipping").textContent = fmt(t.shipping);
    tpl.querySelector("#tplGrand").textContent = fmt(t.grand);
    tpl.querySelector("#tplPaid").textContent = fmt(t.paid);
    tpl.querySelector("#tplBalance").textContent = fmt(t.balance);

    // notes/terms
    tpl.querySelector("#tplNotes").textContent = $("notes").value || "";
    tpl.querySelector("#tplTerms").textContent = $("terms").value || "";

    return tpl;
  }

  function openPreview(){
    const modal = $("previewModal");
    const content = $("previewContent");
    content.innerHTML = "";
    content.appendChild(buildTemplateDom());
    modal.classList.remove("hidden");
    modal.classList.add("flex");
  }

  function closePreview(){
    const modal = $("previewModal");
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  }

  // ===========================
  // Exports
  // ===========================
  function exportPDF(){
    // PDF export fallback: open the print dialog on the preview.  We
    // generate the preview (which already lays out the invoice in a
    // print‑friendly format) and then invoke the browser's native print
    // function.  Users can select "Save as PDF" in the print dialog to
    // generate a PDF.  This approach avoids reliance on external
    // libraries and works offline across modern browsers.
    openPreview();
    // Give the modal a moment to render before printing
    setTimeout(() => {
      window.print();
    }, 100);
  }

  function exportCSV(){
    const items = readLineItems();
    const headers = ["Description","Qty","Rate","Disc%","VAT%"];
    const rows = items.map(i => [
      (i.desc || "").replaceAll('"','""'),
      i.qty,
      i.rate,
      i.disc,
      i.vat
    ]);

    const csv = [headers, ...rows]
      .map(r => r.map(v => `"${String(v ?? "")}"`).join(","))
      .join("\n");

    const filename = ($("invoiceNumber").value || "invoice") + ".csv";
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
    saveAs(blob, filename);
  }

  // Excel export rewritten to avoid external dependencies.  This version
  // generates a simple HTML table wrapped in an Excel-compatible file
  // structure and saves it with a .xls extension.  Modern versions of
  // Excel will open this file without issues.  Note: this is a basic
  // representation and may not support all Excel features.
  function exportExcel(){
    try {
      const templateDom = buildTemplateDom();
      // Clone the template DOM so we can tweak it without affecting the preview
      const clone = templateDom.cloneNode(true);
      // Build a wrapper table containing the invoice content.  We'll
      // surround the entire invoice in a single table cell to preserve
      // layout.  Excel interprets HTML tables directly.
      const wrapperTable = document.createElement('table');
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.appendChild(clone);
      tr.appendChild(td);
      wrapperTable.appendChild(tr);
      // Serialize to HTML
      const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"></head><body>${wrapperTable.outerHTML}</body></html>`;
      const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
      const filename = ($("invoiceNumber").value || 'invoice') + '.xls';
      saveAs(blob, filename);
    } catch (err) {
      console.error(err);
      alert('Excel export failed.');
    }
  }

  function _exportWordOld(){
    // This legacy Word export relied on the external `docx` library. It's deprecated to
    // ensure offline functionality. Return early and advise the user to use the new
    // `Export Word` button which uses the offline HTML-to-Doc fallback.
    alert("This legacy Word export is deprecated. Please use the Export Word button instead.");
    return;

    const { Document, Paragraph, HeadingLevel, Table, TableRow, TableCell, WidthType, AlignmentType, BorderStyle } = docx;

    const t = calculateTotals();
    const items = readLineItems();

    const doc = new Document({
      sections: [{
        properties: {},
        children: [
          new Paragraph({ text: "INVOICE", heading: HeadingLevel.HEADING_1, alignment: AlignmentType.CENTER }),
          new Paragraph({ text: " " }),

          new Table({
            width: { size: 100, type: WidthType.PERCENTAGE },
            rows: [
              new TableRow({
                children: [
                  new TableCell({ children: [new Paragraph("Invoice #")]}),
                  new TableCell({ children: [new Paragraph($("invoiceNumber").value || "")]}),
                  new TableCell({ children: [new Paragraph("Issue Date")]}),
                  new TableCell({ children: [new Paragraph(formatDateISO($("invoiceDate").value))]}),
                ]
              }),
              new TableRow({
                children: [
                  new TableCell({ children: [new Paragraph("Reference")]}),
                  new TableCell({ children: [new Paragraph($("invoiceReference").value || "")]}),
                  new TableCell({ children: [new Paragraph("Due Date")]}),
                  new TableCell({ children: [new Paragraph(formatDateISO($("dueDate").value))]}),
                ]
              }),
            ]
          }),

          new Paragraph({ text: " " }),
          new Paragraph({ text: "FROM:", heading: HeadingLevel.HEADING_3 }),
          new Paragraph($("companyName").value || ""),
          new Paragraph(`VAT: ${$("companyVat").value || ""}`),
          new Paragraph($("companyAddress").value || ""),
          new Paragraph(`Email: ${$("companyEmail").value || ""}`),
          new Paragraph(`Phone: ${$("companyPhone").value || ""}`),

          new Paragraph({ text: " " }),
          new Paragraph({ text: "BILL TO:", heading: HeadingLevel.HEADING_3 }),
          new Paragraph($("clientName").value || ""),
          new Paragraph(`VAT: ${$("clientVat").value || ""}`),
          new Paragraph($("clientAddress").value || ""),
          new Paragraph(`Email: ${$("clientEmail").value || ""}`),
          new Paragraph(`Phone: ${$("clientPhone").value || ""}`),

          new Paragraph({ text: " " }),

          new Table({
            width: { size: 100, type: WidthType.PERCENTAGE },
            rows: [
              new TableRow({
                tableHeader: true,
                children: ["Description","Qty","Rate","Disc%","VAT%","Excl","Incl"].map(h =>
                  new TableCell({
                    children:[new Paragraph({text:h, bold:true})],
                    borders: {
                      top: { style: BorderStyle.SINGLE, size: 1 },
                      bottom: { style: BorderStyle.SINGLE, size: 1 },
                      left: { style: BorderStyle.SINGLE, size: 1 },
                      right: { style: BorderStyle.SINGLE, size: 1 },
                    }
                  })
                )
              }),
              ...items.map(i=>{
                const base = i.qty*i.rate;
                const discAmt = base*(i.disc/100);
                const excl = Math.max(0, base-discAmt);
                const vatAmt = excl*(i.vat/100);
                const incl = excl+vatAmt;

                const cells = [
                  i.desc || "",
                  String(i.qty),
                  fmt(i.rate),
                  `${Number(i.disc||0).toFixed(2)}%`,
                  `${Number(i.vat||0).toFixed(2)}%`,
                  fmt(excl),
                  fmt(incl),
                ];

                return new TableRow({
                  children: cells.map(v => new TableCell({
                    children:[new Paragraph(String(v))],
                    borders: {
                      top: { style: BorderStyle.SINGLE, size: 1 },
                      bottom: { style: BorderStyle.SINGLE, size: 1 },
                      left: { style: BorderStyle.SINGLE, size: 1 },
                      right: { style: BorderStyle.SINGLE, size: 1 },
                    }
                  }))
                });
              })
            ]
          }),

          new Paragraph({ text: " " }),
          new Paragraph({ text: `Subtotal: ${fmt(t.subtotalExcl)}` }),
          new Paragraph({ text: `Line Discounts: ${fmt(t.lineDiscountTotal)}` }),
          new Paragraph({ text: `Overall Discount: ${fmt(t.overallDiscountAmt)}` }),
          new Paragraph({ text: `VAT: ${fmt(t.vat)}` }),
          new Paragraph({ text: `Shipping: ${fmt(t.shipping)}` }),
          new Paragraph({ text: `Grand Total: ${fmt(t.grand)}`, bold: true }),
          new Paragraph({ text: `Paid: ${fmt(t.paid)}` }),
          new Paragraph({ text: `Balance Due: ${fmt(t.balance)}`, bold: true }),

          new Paragraph({ text: " " }),
          new Paragraph({ text: "NOTES:", heading: HeadingLevel.HEADING_3 }),
          new Paragraph($("notes").value || ""),

          new Paragraph({ text: " " }),
          new Paragraph({ text: "TERMS:", heading: HeadingLevel.HEADING_3 }),
          new Paragraph($("terms").value || ""),

          new Paragraph({ text: " " }),
          new Paragraph({ text: "BANK DETAILS:", heading: HeadingLevel.HEADING_3 }),
          new Paragraph($("companyBank").value || ""),
        ]
      }]
    });

    docx.Packer.toBlob(doc)
      .then(blob => saveAs(blob, ($("invoiceNumber").value || "invoice") + ".docx"))
      .catch(err=>{
        console.error(err);
        alert("Word export failed. Check console for details.");
      });
  }

  // New Word export using HTML to doc fallback. This implementation works offline without external
  // dependencies by serializing the invoice HTML into a simple .doc file. Modern versions of
  // Microsoft Word can open HTML content saved with a .doc extension.
  function exportWord(){
    try {
      // Build the invoice template DOM
      const dom = buildTemplateDom();
      const wrapper = document.createElement('div');
      wrapper.appendChild(dom);
      // Serialize the DOM into a complete HTML document string
      const htmlContent = `<!DOCTYPE html><html lang="en-ZA"><head><meta charset="UTF-8"><title>Invoice</title></head><body>${wrapper.innerHTML}</body></html>`;
      // Create a Word document blob from the HTML content
      const blob = new Blob([htmlContent], { type: 'application/msword' });
      const filename = ($("invoiceNumber").value || 'invoice') + '.doc';
      // Trigger the download
      saveAs(blob, filename);
    } catch (err) {
      console.error(err);
      alert('Word export failed.');
    }
  }

  // ===========================
  // CSV Import
  // ===========================
  function parseCSV(text){
    // Minimal CSV parser for: Description,Qty,Rate,Disc%,VAT%
    // Handles quotes and commas in quotes.
    const rows = [];
    let i=0, field="", row=[], inQuotes=false;

    const pushField = () => { row.push(field); field=""; };
    const pushRow = () => { if(row.length) rows.push(row); row=[]; };

    while(i<text.length){
      const c = text[i];
      if(inQuotes){
        if(c === '"'){
          if(text[i+1] === '"'){ field += '"'; i++; }
          else inQuotes = false;
        } else field += c;
      } else {
        if(c === '"') inQuotes = true;
        else if(c === ','){ pushField(); }
        else if(c === '\n'){ pushField(); pushRow(); }
        else if(c !== '\r'){ field += c; }
      }
      i++;
    }
    pushField(); pushRow();
    return rows;
  }

  function importCSV(file){
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      const text = e.target.result || "";
      const rows = parseCSV(text).filter(r => r.join("").trim().length);

      // If header row present, skip if first cell is Description
      let startIdx = 0;
      if(rows[0] && rows[0][0] && rows[0][0].toLowerCase().includes("description")) startIdx = 1;

      for(let r=startIdx; r<rows.length; r++){
        const [desc, qty, rate, disc, vat] = rows[r];
        addLineItem({
          desc: (desc||"").trim(),
          qty: Number((qty||"1").trim()),
          rate: Number((rate||"0").trim()),
          disc: Number((disc||"0").toString().replace("%","").trim()),
          vat: Number((vat||$("defaultVat").value||"0").toString().replace("%","").trim()),
        });
      }
      calculateTotals();
      autosave();
    };
    reader.readAsText(file);
  }

  // ===========================
  // Save/Load templates (localStorage)
  // ===========================
  const AUTOSAVE_KEY = "easyinv.autosave.v1";
  const TEMPLATES_KEY = "easyinv.templates.v1";

  function serializeState(){
    return {
      version: 1,
      savedAt: new Date().toISOString(),
      companyLogoDataUrl,
      fields: {
        companyName: $("companyName").value,
        companyVat: $("companyVat").value,
        companyReg: $("companyReg").value,
        companyEmail: $("companyEmail").value,
        companyPhone: $("companyPhone").value,
        companyWebsite: $("companyWebsite").value,
        companyAddress: $("companyAddress").value,
        companyBank: $("companyBank").value,

        clientName: $("clientName").value,
        clientVat: $("clientVat").value,
        clientReg: $("clientReg").value,
        clientEmail: $("clientEmail").value,
        clientPhone: $("clientPhone").value,
        clientAddress: $("clientAddress").value,

        invoiceNumber: $("invoiceNumber").value,
        invoiceReference: $("invoiceReference").value,
        invoiceDate: $("invoiceDate").value,
        dueDate: $("dueDate").value,
        currency: $("currency").value,
        invoiceStatus: $("invoiceStatus").value,

        overallDiscount: $("overallDiscount").value,
        shipping: $("shipping").value,
        amountPaid: $("amountPaid").value,
        defaultVat: $("defaultVat").value,

        notes: $("notes").value,
        terms: $("terms").value,
      },
      items: readLineItems()
    };
  }

  function applyState(state){
    if(!state) return;
    companyLogoDataUrl = state.companyLogoDataUrl || null;

    // Logo preview
    const preview = $("companyLogoPreview");
    preview.innerHTML = "";
    if(companyLogoDataUrl){
      const img = document.createElement("img");
      img.src = companyLogoDataUrl;
      img.className = "h-14 object-contain";
      preview.appendChild(img);
    } else {
      preview.innerHTML = `<p class="text-sm text-slate-400">No logo uploaded</p>`;
    }

    const f = state.fields || {};

    Object.keys(f).forEach(k=>{
      if($(k)) $(k).value = f[k] ?? "";
    });

    // items
    $("itemsBody").innerHTML = "";
    (state.items || []).forEach(it => addLineItem(it));
    if(!(state.items || []).length) addLineItem();

    calculateTotals();
    setStatusBadge();
  }

  function autosave(){
    try{
      localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(serializeState()));
    } catch(e){
      console.warn("Autosave failed:", e);
    }
  }

  function loadAutosave(){
    try{
      const raw = localStorage.getItem(AUTOSAVE_KEY);
      if(!raw) return false;
      applyState(JSON.parse(raw));
      return true;
    } catch(e){
      console.warn("Autosave load failed:", e);
      return false;
    }
  }

  function saveTemplate(){
    const name = prompt("Template name (e.g., 'Skunkworks Default'):");
    if(!name) return;
    const state = serializeState();
    state.templateName = name;

    const templates = loadTemplates();
    templates.push(state);

    localStorage.setItem(TEMPLATES_KEY, JSON.stringify(templates));
    alert("Template saved: " + name);
  }

  function loadTemplates(){
    try{
      return JSON.parse(localStorage.getItem(TEMPLATES_KEY) || "[]");
    } catch {
      return [];
    }
  }

  function pickAndLoadTemplate(){
    const templates = loadTemplates();
    if(!templates.length){
      alert("No templates saved yet.");
      return;
    }
    const names = templates.map((t,i)=> `${i+1}) ${t.templateName || ("Template " + (i+1))}`).join("\n");
    const choice = prompt("Choose a template number:\n\n" + names);
    if(!choice) return;
    const idx = Number(choice) - 1;
    if(idx < 0 || idx >= templates.length){
      alert("Invalid choice.");
      return;
    }
    applyState(templates[idx]);
    autosave();
  }

  function resetForm(){
    if(!confirm("Reset the invoice form? (Templates remain saved)")) return;

    companyLogoDataUrl = null;
    $("companyLogo").value = "";
    $("companyLogoPreview").innerHTML = `<p class="text-sm text-slate-400">No logo uploaded</p>`;

    // Clear fields
    [
      "companyName","companyVat","companyReg","companyEmail","companyPhone","companyWebsite","companyAddress","companyBank",
      "clientName","clientVat","clientReg","clientEmail","clientPhone","clientAddress",
      "invoiceReference","notes","terms"
    ].forEach(id => { if($(id)) $(id).value = ""; });

    $("currency").value = "ZAR";
    $("invoiceStatus").value = "draft";
    $("overallDiscount").value = "0.00";
    $("shipping").value = "0.00";
    $("amountPaid").value = "0.00";
    $("defaultVat").value = "15.00";

    // Dates + new number
    const today = new Date();
    $("invoiceDate").value = today.toISOString().split("T")[0];
    const due = new Date();
    due.setDate(due.getDate()+10);
    $("dueDate").value = due.toISOString().split("T")[0];
    generateInvoiceNumber();

    // Items
    $("itemsBody").innerHTML = "";
    addLineItem();

    calculateTotals();
    autosave();
  }

  // ===========================
  // Print (manual)
  // ===========================
  function printManual(){
    // Build an isolated printable window to avoid UI/controls
    const dom = buildTemplateDom();
    const w = window.open("", "_blank");
    if(!w){
      alert("Pop-up blocked. Allow popups to print.");
      return;
    }

    const style = `
      <style>
        body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; margin:0; padding:20px; background:#fff;}
        .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
        table{width:100%; border-collapse:collapse;}
        th,td{border:1px solid #e5e7eb; padding:8px;}
        th{background:#f9fafb;}
      </style>
    `;

    w.document.write(`
      <html><head><title>Print Invoice</title>${style}</head><body></body></html>
    `);
    w.document.body.appendChild(dom);
    w.document.close();
    w.focus();
    w.print();
  }

  // ===========================
  // Init + Events
  // ===========================
  function bind(){
    // meta changes recalc
    ["overallDiscount","shipping","amountPaid","defaultVat","currency","invoiceStatus"].forEach(id=>{
      $(id).addEventListener("input", () => { calculateTotals(); autosave(); });
      $(id).addEventListener("change", () => { calculateTotals(); autosave(); });
    });

    // general fields autosave
    [
      "companyName","companyVat","companyReg","companyEmail","companyPhone","companyWebsite","companyAddress","companyBank",
      "clientName","clientVat","clientReg","clientEmail","clientPhone","clientAddress",
      "invoiceNumber","invoiceReference","invoiceDate","dueDate","notes","terms"
    ].forEach(id=>{
      $(id).addEventListener("input", autosave);
      $(id).addEventListener("change", autosave);
    });

    // logo
    $("companyLogo").addEventListener("change", (e)=> handleLogoUpload(e.target.files[0]));

    // buttons
    $("btnAddLine").addEventListener("click", ()=> { addLineItem(); autosave(); });
    $("btnPreview").addEventListener("click", openPreview);
    $("btnClosePreview").addEventListener("click", closePreview);
    $("btnClosePreviewBottom").addEventListener("click", closePreview);
    $("previewModal").addEventListener("click", (e)=>{ if(e.target === $("previewModal")) closePreview(); });

    $("btnPDF").addEventListener("click", exportPDF);
    $("btnPDF2").addEventListener("click", exportPDF);
    $("btnWord").addEventListener("click", exportWord);
    $("btnExcel").addEventListener("click", exportExcel);
    $("btnCSV").addEventListener("click", exportCSV);
    $("btnPrint").addEventListener("click", printManual);

    $("btnSaveTemplate").addEventListener("click", saveTemplate);
    $("btnLoadTemplate").addEventListener("click", pickAndLoadTemplate);
    $("btnReset").addEventListener("click", resetForm);

    $("btnNewNumber").addEventListener("click", ()=> { generateInvoiceNumber(); autosave(); });
    $("btnMarkPaid").addEventListener("click", ()=>{
      $("invoiceStatus").value = "paid";
      $("amountPaid").value = (calculateTotals().grand).toFixed(2);
      calculateTotals();
      autosave();
    });

    // CSV import
    $("btnImportCSV").addEventListener("click", ()=> $("csvFile").click());
    $("csvFile").addEventListener("change", (e)=>{
      importCSV(e.target.files[0]);
      e.target.value = "";
    });

    // initial line item
    if(document.querySelectorAll(".line-item").length === 0){
      addLineItem();
    }
  }

  function init(){
    // Dates default
    const today = new Date();
    $("invoiceDate").value = today.toISOString().split("T")[0];
    const due = new Date();
    due.setDate(due.getDate()+10);
    $("dueDate").value = due.toISOString().split("T")[0];

    // Number
    generateInvoiceNumber();

    // Load autosave if present
    const loaded = loadAutosave();
    if(!loaded){
      // ensure at least one row
      addLineItem();
      calculateTotals();
      autosave();
    } else {
      calculateTotals();
    }

    // Status
    setStatusBadge();
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    bind();
    init();
  });
</script>

</body>
</html>
