<!DOCTYPE html>
<html lang="en-ZA">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EasySTAT – Statement Generator</title>
  <meta name="description" content="Generate professional customer account statements with transactions, running balance, ageing, and offline-friendly exports." />

  <!-- Favicon -->
  <link rel="icon" href="icon.png" type="image/png">
  <link rel="apple-touch-icon" href="icon.png">

  <!-- Tailwind CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root{
      --primary:#2563eb;
      --primary2:#1d4ed8;
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --danger:#dc2626;
      --success:#16a34a;
      --warning:#f59e0b;
    }
    body{background:var(--bg); color:var(--text);}

    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:0 10px 25px rgba(2,6,23,.05);}
    .btn{display:inline-flex; align-items:center; justify-content:center; gap:.5rem; padding:.7rem 1rem; border-radius:10px; font-weight:800; transition: all .2s ease; border:1px solid transparent;}
    .btn:hover{transform:translateY(-1px);}
    .btn-primary{background:var(--primary); color:#fff;}
    .btn-primary:hover{background:var(--primary2);}
    .btn-outline{background:#fff; border-color:var(--border); color:var(--text);}
    .btn-outline:hover{border-color:#cbd5e1; background:#f8fafc;}
    .btn-danger{background:var(--danger); color:#fff;}
    .btn-danger:hover{filter:brightness(.95);}
    .btn-success{background:var(--success); color:#fff;}
    .btn-success:hover{filter:brightness(.95);}
    .badge{display:inline-flex; align-items:center; gap:.4rem; padding:.25rem .6rem; border-radius:999px; font-weight:900; font-size:.75rem;}
    .badge-draft{background:#eef2ff; color:#3730a3;}
    .badge-issued{background:#ecfeff; color:#155e75;}
    .badge-final{background:#dcfce7; color:#166534;}

    input:focus, textarea:focus, select:focus{
      outline:none!important;
      border-color: rgba(37, 99, 235, .8)!important;
      box-shadow:0 0 0 3px rgba(37,99,235,.15)!important;
    }

    .responsive-table {overflow-x:auto; -webkit-overflow-scrolling:touch;}
    .mono {font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    /* Print-friendly manual style */
    @media print {
      .no-print { display:none !important; }
      .print-only { display:block !important; }
      body { background:#fff !important; }
      .card { box-shadow:none !important; border:none !important; }
      .manual-print { max-width: 210mm; margin:0 auto; padding:0; }
      table { page-break-inside:auto; }
      tr { page-break-inside:avoid; page-break-after:auto; }
      thead { display:table-header-group; }
      tfoot { display:table-footer-group; }
    }
  </style>
</head>

<body class="min-h-screen flex flex-col">

  <!-- NAV -->
  <nav class="bg-blue-600 text-white py-4 no-print">
    <div class="container mx-auto px-4 flex flex-wrap items-center gap-4">
      <a data-safe-link href="index.html" class="font-black text-xl mr-4">Easy&nbsp;Suite</a>
      <a data-safe-link href="easy-quote.html" class="hover:underline">Quote</a>
      <a data-safe-link href="easy-invoice.html" class="hover:underline">Invoice</a>
      <a data-safe-link href="easy-purchase-order.html" class="hover:underline">Purchase&nbsp;Order</a>
      <a data-safe-link href="easy-sales-order.html" class="hover:underline">Sales&nbsp;Order</a>
      <a data-safe-link href="easy-receipt.html" class="hover:underline">Receipt</a>
      <a data-safe-link href="easy-statement.html" class="hover:underline">Statement</a>
      <a data-safe-link href="easy-job-card.html" class="hover:underline">Job&nbsp;Card</a>
      <a data-safe-link href="easy-payroll.html" class="hover:underline">Payroll</a>
      <a data-safe-link href="easy-inventory.html" class="hover:underline">Inventory</a>
      <a data-safe-link href="easy-crm.html" class="underline font-extrabold">CRM</a>

      <div class="ml-auto flex items-center gap-2">
        <button id="btnDark" class="btn btn-outline" title="Toggle dark mode (D)">
          <span class="mono">D</span> Dark
        </button>
        <button id="btnPrint" class="btn btn-outline" title="Print (manual style)">
          Print
        </button>
      </div>
    </div>
  </nav>

  <main class="container mx-auto px-4 py-8">

  <!-- Header -->
  <header class="bg-white border-b border-gray-200 no-print">
    <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row gap-4 sm:gap-0 items-start sm:items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-xl bg-blue-600 text-white flex items-center justify-center font-black">ES</div>
        <div>
          <h1 class="text-2xl font-extrabold text-blue-700">EasySTAT</h1>
          <p class="text-sm text-gray-500">Statement Generator (Account / Customer)</p>
        </div>
      </div>

      <div class="flex flex-wrap items-center gap-2">
        <a class="btn btn-outline" href="index.html" title="Back to dashboard">
          <i class="fa-solid fa-grid-2"></i> Dashboard
        </a>

        <button class="btn btn-outline" id="btnSaveTemplate" title="Save current statement as a template">
          <i class="fa-solid fa-floppy-disk"></i> Save
        </button>
        <button class="btn btn-outline" id="btnLoadTemplate" title="Load a saved template">
          <i class="fa-solid fa-folder-open"></i> Load
        </button>
        <button class="btn btn-outline" id="btnReset" title="Reset form (keeps templates)">
          <i class="fa-solid fa-rotate-left"></i> Reset
        </button>

        <span class="ml-0 sm:ml-4 text-xs text-gray-500">
          Autosave: <span class="font-bold" id="autosaveStatus">On</span>
        </span>
      </div>
    </div>
  </header>

  <main class="flex-grow container mx-auto px-4 py-6 md:py-8">

    <!-- Tips -->
    <div class="card p-4 mb-6 no-print">
      <div class="flex gap-3">
        <div class="text-blue-600 pt-0.5"><i class="fa-solid fa-circle-info"></i></div>
        <div class="flex-1">
          <h3 class="text-sm font-extrabold text-slate-900">Quick flow</h3>
          <div class="text-sm text-slate-600 mt-1">
            1) Company + customer → 2) Set statement period + opening balance → 3) Add/import transactions → 4) Review running balance + ageing → 5) Preview/print/export.
          </div>
        </div>
      </div>
    </div>

    <!-- Top Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
      <!-- Company -->
      <section class="card p-5">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-extrabold"><i class="fa-solid fa-building text-blue-600 mr-2"></i>Company</h2>
          <span class="text-xs text-slate-500">Issuer</span>
        </div>

        <div class="space-y-3">
          <div>
            <label class="block text-sm font-bold text-slate-700 mb-1">Company Logo</label>
            <input type="file" id="companyLogo" accept="image/*"
              class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-bold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
            <div id="companyLogoPreview" class="mt-2 h-14 flex items-center">
              <p class="text-sm text-slate-400">No logo uploaded</p>
            </div>
          </div>

          <div>
            <label class="block text-sm font-bold text-slate-700 mb-1">Company Name</label>
            <input id="companyName" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Your Company (Pty) Ltd">
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">VAT Number</label>
              <input id="companyVat" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="e.g., 4080...">
            </div>
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Reg/CK</label>
              <input id="companyReg" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Optional">
            </div>
          </div>

          <div>
            <label class="block text-sm font-bold text-slate-700 mb-1">Email</label>
            <input id="companyEmail" type="email" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="accounts@yourcompany.co.za">
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Phone</label>
              <input id="companyPhone" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="+27 ...">
            </div>
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Website</label>
              <input id="companyWebsite" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="https://...">
            </div>
          </div>

          <div>
            <label class="block text-sm font-bold text-slate-700 mb-1">Address</label>
            <textarea id="companyAddress" rows="3" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Street, City, Province, Postal Code"></textarea>
          </div>

          <div class="border-t border-gray-100 pt-3">
            <label class="block text-sm font-bold text-slate-700 mb-1">Bank Details (optional)</label>
            <textarea id="companyBank" rows="3" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Bank: ...&#10;Account: ...&#10;Branch: ...&#10;Reference: Customer Code"></textarea>
          </div>
        </div>
      </section>

      <!-- Customer -->
      <section class="card p-5">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-extrabold"><i class="fa-solid fa-user-tie text-blue-600 mr-2"></i>Customer</h2>
          <span class="text-xs text-slate-500">Account Holder</span>
        </div>

        <div class="space-y-3">
          <div>
            <label class="block text-sm font-bold text-slate-700 mb-1">Customer Name</label>
            <input id="clientName" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Customer Company / Person">
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Customer Code</label>
              <input id="clientCode" class="w-full border border-gray-200 rounded-lg px-3 py-2 mono" placeholder="ACC000123">
            </div>
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Customer VAT</label>
              <input id="clientVat" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Optional">
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Reg/ID</label>
              <input id="clientReg" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Optional">
            </div>
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Contact Person</label>
              <input id="clientContact" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Optional">
            </div>
          </div>

          <div>
            <label class="block text-sm font-bold text-slate-700 mb-1">Email</label>
            <input id="clientEmail" type="email" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="billing@customer.co.za">
          </div>

          <div>
            <label class="block text-sm font-bold text-slate-700 mb-1">Phone</label>
            <input id="clientPhone" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="+27 ...">
          </div>

          <div>
            <label class="block text-sm font-bold text-slate-700 mb-1">Address</label>
            <textarea id="clientAddress" rows="4" class="w-full border border-gray-200 rounded-lg px-3 py-2" placeholder="Street, City, Province, Postal Code"></textarea>
          </div>
        </div>
      </section>

      <!-- Statement Meta -->
      <section class="card p-5">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-extrabold"><i class="fa-solid fa-file-invoice text-blue-600 mr-2"></i>Statement</h2>
          <span id="statusBadge" class="badge badge-draft"><i class="fa-solid fa-pen"></i> DRAFT</span>
        </div>

        <div class="space-y-3">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Statement #</label>
              <input id="statementNumber" class="w-full border border-gray-200 rounded-lg px-3 py-2 mono" placeholder="STAT0000001">
            </div>
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Reference</label>
              <input id="statementReference" class="w-full border border-gray-200 rounded-lg px-3 py-2 mono" placeholder="Optional (PO / Contract)">
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Period From</label>
              <input id="periodFrom" type="date" class="w-full border border-gray-200 rounded-lg px-3 py-2">
            </div>
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Period To</label>
              <input id="periodTo" type="date" class="w-full border border-gray-200 rounded-lg px-3 py-2">
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Currency</label>
              <select id="currency" class="w-full border border-gray-200 rounded-lg px-3 py-2">
                <option value="ZAR" selected>ZAR (R)</option>
                <option value="USD">USD ($)</option>
                <option value="EUR">EUR (€)</option>
                <option value="GBP">GBP (£)</option>
              </select>
              <p class="text-xs text-slate-500 mt-1">Formatting adapts; no FX conversion.</p>
            </div>
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-1">Status</label>
              <select id="statementStatus" class="w-full border border-gray-200 rounded-lg px-3 py-2">
                <option value="draft" selected>Draft</option>
                <option value="issued">Issued</option>
                <option value="final">Final</option>
              </select>
            </div>
          </div>

          <div class="border-t border-gray-100 pt-3 space-y-3">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-1">Opening Balance</label>
                <input id="openingBalance" type="number" step="0.01" value="0.00"
                  class="w-full border border-gray-200 rounded-lg px-3 py-2">
                <p class="text-xs text-slate-500 mt-1">Balance before the period start.</p>
              </div>
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-1">Payment Terms (days)</label>
                <input id="termsDays" type="number" min="0" step="1" value="30"
                  class="w-full border border-gray-200 rounded-lg px-3 py-2">
                <p class="text-xs text-slate-500 mt-1">Used for default due dates.</p>
              </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-1">Statement Date</label>
                <input id="statementDate" type="date" class="w-full border border-gray-200 rounded-lg px-3 py-2">
              </div>
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-1">Default VAT % (optional)</label>
                <input id="defaultVat" type="number" min="0" max="100" step="0.01" value="15.00"
                  class="w-full border border-gray-200 rounded-lg px-3 py-2">
                <p class="text-xs text-slate-500 mt-1">For convenience; statement amounts usually already include VAT.</p>
              </div>
            </div>

            <div class="flex items-center justify-between gap-3">
              <button class="btn btn-outline w-full" id="btnNewNumber">
                <i class="fa-solid fa-wand-magic-sparkles"></i> New #
              </button>
              <button class="btn btn-outline w-full" id="btnSetThisMonth">
                <i class="fa-solid fa-calendar-days"></i> This Month
              </button>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- Transactions -->
    <section class="card p-5 mb-6">
      <div class="flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between mb-4">
        <div>
          <h2 class="text-lg font-extrabold"><i class="fa-solid fa-list-check text-blue-600 mr-2"></i>Transactions</h2>
          <p class="text-sm text-slate-500 mt-1">Debit increases balance (invoices/charges). Credit decreases balance (payments/credits).</p>
        </div>

        <div class="flex flex-wrap gap-2 no-print">
          <button class="btn btn-outline" id="btnImportCSV" title="Import CSV (Date,Reference,Description,Debit,Credit,DueDate(optional))">
            <i class="fa-solid fa-file-import"></i> Import CSV
          </button>
          <input type="file" id="csvFile" accept=".csv" class="hidden">
          <button class="btn btn-outline" id="btnSortDate" title="Sort by Date">
            <i class="fa-solid fa-arrow-up-wide-short"></i> Sort
          </button>
          <button class="btn btn-primary" id="btnAddTxn">
            <i class="fa-solid fa-plus"></i> Add Transaction
          </button>
        </div>
      </div>

      <div class="responsive-table">
        <table class="w-full text-sm border-collapse" id="txTable">
          <thead>
            <tr class="bg-gray-50 text-gray-600">
              <th class="border border-gray-200 p-2 text-left">Date</th>
              <th class="border border-gray-200 p-2 text-left">Reference</th>
              <th class="border border-gray-200 p-2 text-left">Description</th>
              <th class="border border-gray-200 p-2 text-left">Due Date</th>
              <th class="border border-gray-200 p-2 text-right">Debit</th>
              <th class="border border-gray-200 p-2 text-right">Credit</th>
              <th class="border border-gray-200 p-2 text-right">Running Balance</th>
              <th class="border border-gray-200 p-2 text-center no-print">Action</th>
            </tr>
          </thead>
          <tbody id="txBody"></tbody>
        </table>
      </div>
    </section>

    <!-- Notes + Contact -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
      <section class="card p-5">
        <h2 class="text-lg font-extrabold mb-3"><i class="fa-solid fa-note-sticky text-blue-600 mr-2"></i>Notes</h2>
        <textarea id="notes" rows="7" class="w-full border border-gray-200 rounded-lg px-3 py-2"
          placeholder="Optional notes to customer (banking reference, reminders, escalation contact, etc.)"></textarea>
      </section>

      <section class="card p-5">
        <h2 class="text-lg font-extrabold mb-3"><i class="fa-solid fa-shield-halved text-blue-600 mr-2"></i>Collections / Payment Instructions</h2>
        <textarea id="collections" rows="7" class="w-full border border-gray-200 rounded-lg px-3 py-2"
          placeholder="Payment instructions, collections contact, interest/penalty statement, etc."></textarea>
      </section>
    </div>

    <!-- Summary + Ageing -->
    <section class="card p-5 mb-6">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
        <div class="lg:col-span-2">
          <h2 class="text-lg font-extrabold mb-2"><i class="fa-solid fa-chart-line text-blue-600 mr-2"></i>Summary</h2>
          <p class="text-sm text-slate-500">Closing balance equals opening balance plus (debits − credits) within the period.</p>

          <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="border border-gray-200 rounded-lg p-4">
              <div class="text-xs text-slate-500 font-black mb-2">PERIOD TOTALS</div>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="font-bold text-slate-700">Opening Balance</span>
                  <span id="sOpening" class="font-extrabold mono">R0.00</span>
                </div>
                <div class="flex justify-between">
                  <span class="font-bold text-slate-700">Debits</span>
                  <span id="sDebits" class="font-extrabold mono">R0.00</span>
                </div>
                <div class="flex justify-between">
                  <span class="font-bold text-slate-700">Credits</span>
                  <span id="sCredits" class="font-extrabold mono">R0.00</span>
                </div>
                <div class="flex justify-between border-t border-gray-200 pt-2 text-lg">
                  <span class="font-black text-slate-900">Closing Balance</span>
                  <span id="sClosing" class="font-black mono">R0.00</span>
                </div>
              </div>
            </div>

            <div class="border border-gray-200 rounded-lg p-4">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <div class="text-xs text-slate-500 font-black mb-2">AGEING (EST.)</div>
                  <p class="text-xs text-slate-500">Estimated by allocating credits to oldest debits (FIFO). If you need exact invoice ageing, import invoice-level data with due dates.</p>
                </div>
                <button id="btnRecalcAgeing" class="btn btn-outline no-print" style="padding:.45rem .75rem;">
                  <i class="fa-solid fa-rotate"></i> Recalc
                </button>
              </div>

              <div class="mt-3 space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="font-bold text-slate-700">Current</span>
                  <span id="aCurrent" class="font-extrabold mono">R0.00</span>
                </div>
                <div class="flex justify-between">
                  <span class="font-bold text-slate-700">1–30</span>
                  <span id="a30" class="font-extrabold mono">R0.00</span>
                </div>
                <div class="flex justify-between">
                  <span class="font-bold text-slate-700">31–60</span>
                  <span id="a60" class="font-extrabold mono">R0.00</span>
                </div>
                <div class="flex justify-between">
                  <span class="font-bold text-slate-700">61–90</span>
                  <span id="a90" class="font-extrabold mono">R0.00</span>
                </div>
                <div class="flex justify-between">
                  <span class="font-bold text-slate-700">90+</span>
                  <span id="a120" class="font-extrabold mono">R0.00</span>
                </div>
                <div class="flex justify-between border-t border-gray-200 pt-2 text-base">
                  <span class="font-black text-slate-900">Total Outstanding</span>
                  <span id="aTotal" class="font-black mono">R0.00</span>
                </div>
              </div>
            </div>

          </div>
        </div>

        <div class="lg:col-span-1">
          <h2 class="text-lg font-extrabold mb-2"><i class="fa-solid fa-bolt text-blue-600 mr-2"></i>Actions</h2>
          <p class="text-sm text-slate-500 mb-3">Preview and export use an offline-friendly approach (native browser print & downloads).</p>

          <div class="grid grid-cols-1 gap-2 no-print">
            <button class="btn btn-outline" id="btnPreview"><i class="fa-solid fa-eye"></i> Preview</button>
            <button class="btn btn-outline" id="btnPrint"><i class="fa-solid fa-print"></i> Print (Manual)</button>
            <button class="btn btn-danger" id="btnPDF"><i class="fa-solid fa-file-pdf"></i> Export PDF</button>
            <button class="btn btn-primary" id="btnWord"><i class="fa-solid fa-file-word"></i> Export Word</button>
            <button class="btn btn-success" id="btnExcel"><i class="fa-solid fa-file-excel"></i> Export Excel</button>
            <button class="btn btn-outline" id="btnCSV"><i class="fa-solid fa-file-csv"></i> Export CSV</button>
          </div>

          <div class="mt-4 border border-gray-200 rounded-lg p-4">
            <div class="text-xs text-slate-500 font-black mb-2">VALIDATION</div>
            <div class="text-sm text-slate-600 space-y-2" id="validationBox">
              <div class="flex items-start gap-2">
                <i class="fa-solid fa-circle-check text-green-600 mt-1"></i>
                <span>Add at least 1 transaction, or keep opening balance at 0.00.</span>
              </div>
              <div class="flex items-start gap-2">
                <i class="fa-solid fa-circle-check text-green-600 mt-1"></i>
                <span>Ensure dates fall within the statement period.</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Preview Modal -->
    <div id="previewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50 no-print">
      <div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-screen overflow-y-auto">
        <div class="p-4 flex justify-between items-center border-b border-gray-200">
          <div>
            <h2 class="text-xl font-black text-slate-900">Statement Preview</h2>
            <p class="text-xs text-slate-500">This is the export/print layout.</p>
          </div>
          <button id="btnClosePreview" class="text-slate-500 hover:text-slate-800">
            <i class="fa-solid fa-xmark text-xl"></i>
          </button>
        </div>

        <div id="previewContent" class="p-6"></div>

        <div class="p-4 border-t border-gray-200 flex justify-end gap-2">
          <button class="btn btn-outline" id="btnClosePreviewBottom">Close</button>
          <button class="btn btn-danger" id="btnPDF2">
            <i class="fa-solid fa-file-pdf"></i> Export PDF
          </button>
        </div>
      </div>
    </div>

    <!-- Hidden Export Template -->
    <div id="statementTemplate" class="hidden">
      <div class="manual-print max-w-5xl mx-auto bg-white p-6">
        <div class="flex items-start justify-between gap-6 mb-6">
          <div class="flex-1">
            <div id="tplLogo" class="mb-3"></div>
            <div class="text-xl font-black" id="tplCompanyName">Company</div>
            <div class="text-sm text-slate-600 mt-1 whitespace-pre-line" id="tplCompanyAddress"></div>
            <div class="text-sm text-slate-600 mt-2">
              <div><span class="font-bold">VAT:</span> <span id="tplCompanyVat"></span></div>
              <div><span class="font-bold">Reg:</span> <span id="tplCompanyReg"></span></div>
              <div><span class="font-bold">Email:</span> <span id="tplCompanyEmail"></span></div>
              <div><span class="font-bold">Phone:</span> <span id="tplCompanyPhone"></span></div>
              <div><span class="font-bold">Website:</span> <span id="tplCompanyWebsite"></span></div>
            </div>
          </div>

          <div class="w-80 text-right">
            <div class="text-3xl font-black tracking-tight">STATEMENT</div>
            <div class="mt-2 grid grid-cols-2 gap-x-2 text-sm">
              <span class="text-right font-bold">NUMBER:</span><span class="text-left mono" id="tplStmtNumber"></span>
              <span class="text-right font-bold">REF:</span><span class="text-left mono" id="tplStmtRef"></span>
              <span class="text-right font-bold">DATE:</span><span class="text-left" id="tplStmtDate"></span>
              <span class="text-right font-bold">STATUS:</span><span class="text-left" id="tplStmtStatus"></span>
              <span class="text-right font-bold">CURRENCY:</span><span class="text-left mono" id="tplCurrency"></span>
              <span class="text-right font-bold">PERIOD:</span><span class="text-left" id="tplPeriod"></span>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-6">
          <div class="border border-gray-200 rounded-lg p-4">
            <div class="text-xs text-slate-500 font-black mb-2">CUSTOMER</div>
            <div class="text-base font-black" id="tplClientName"></div>
            <div class="text-sm text-slate-600 mt-1 whitespace-pre-line" id="tplClientAddress"></div>
            <div class="text-sm text-slate-600 mt-2">
              <div><span class="font-bold">Code:</span> <span id="tplClientCode"></span></div>
              <div><span class="font-bold">VAT:</span> <span id="tplClientVat"></span></div>
              <div><span class="font-bold">Reg/ID:</span> <span id="tplClientReg"></span></div>
              <div><span class="font-bold">Contact:</span> <span id="tplClientContact"></span></div>
              <div><span class="font-bold">Email:</span> <span id="tplClientEmail"></span></div>
              <div><span class="font-bold">Phone:</span> <span id="tplClientPhone"></span></div>
            </div>
          </div>

          <div class="border border-gray-200 rounded-lg p-4">
            <div class="text-xs text-slate-500 font-black mb-2">PAYMENT / BANK</div>
            <div class="text-sm text-slate-700 whitespace-pre-line" id="tplBank"></div>
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-5">
          <div class="border border-gray-200 rounded-lg p-4">
            <div class="text-xs text-slate-500 font-black mb-1">OPENING</div>
            <div id="tplOpening" class="text-lg font-black mono"></div>
          </div>
          <div class="border border-gray-200 rounded-lg p-4">
            <div class="text-xs text-slate-500 font-black mb-1">PERIOD NET</div>
            <div id="tplNet" class="text-lg font-black mono"></div>
          </div>
          <div class="border border-gray-200 rounded-lg p-4">
            <div class="text-xs text-slate-500 font-black mb-1">CLOSING</div>
            <div id="tplClosing" class="text-lg font-black mono"></div>
          </div>
        </div>

        <div class="responsive-table mb-5">
          <table class="w-full border-collapse text-sm">
            <thead>
              <tr class="bg-gray-50">
                <th class="border border-gray-200 p-2 text-left">Date</th>
                <th class="border border-gray-200 p-2 text-left">Reference</th>
                <th class="border border-gray-200 p-2 text-left">Description</th>
                <th class="border border-gray-200 p-2 text-left">Due</th>
                <th class="border border-gray-200 p-2 text-right">Debit</th>
                <th class="border border-gray-200 p-2 text-right">Credit</th>
                <th class="border border-gray-200 p-2 text-right">Balance</th>
              </tr>
            </thead>
            <tbody id="tplTx"></tbody>
          </table>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
          <div class="border border-gray-200 rounded-lg p-4">
            <div class="text-xs text-slate-500 font-black mb-2">NOTES</div>
            <div class="text-sm text-slate-700 whitespace-pre-line" id="tplNotes"></div>
          </div>
          <div class="border border-gray-200 rounded-lg p-4">
            <div class="text-xs text-slate-500 font-black mb-2">COLLECTIONS / INSTRUCTIONS</div>
            <div class="text-sm text-slate-700 whitespace-pre-line" id="tplCollections"></div>
          </div>
        </div>

        <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-6">
          <div class="border border-gray-200 rounded-lg p-4">
            <div class="text-xs text-slate-500 font-black mb-2">AGEING SUMMARY (EST.)</div>
            <div class="text-sm space-y-2">
              <div class="flex justify-between"><span class="font-bold text-slate-700">Current</span><span id="tplACurrent" class="mono font-extrabold"></span></div>
              <div class="flex justify-between"><span class="font-bold text-slate-700">1–30</span><span id="tplA30" class="mono font-extrabold"></span></div>
              <div class="flex justify-between"><span class="font-bold text-slate-700">31–60</span><span id="tplA60" class="mono font-extrabold"></span></div>
              <div class="flex justify-between"><span class="font-bold text-slate-700">61–90</span><span id="tplA90" class="mono font-extrabold"></span></div>
              <div class="flex justify-between"><span class="font-bold text-slate-700">90+</span><span id="tplA120" class="mono font-extrabold"></span></div>
              <div class="flex justify-between border-t border-gray-200 pt-2 text-base"><span class="font-black text-slate-900">Total</span><span id="tplATotal" class="mono font-black"></span></div>
            </div>
          </div>

          <div class="border border-gray-200 rounded-lg p-4">
            <div class="text-xs text-slate-500 font-black mb-2">DECLARATION</div>
            <div class="text-sm text-slate-700">
              This statement is provided for convenience and reflects the transactions recorded for the account.
              Please quote the customer code and statement number as your payment reference.
            </div>
          </div>
        </div>

        <div class="mt-6 text-xs text-slate-500 text-center">
          Generated with EasySTAT • Print-friendly output
        </div>
      </div>
    </div>

  </main>

<script>
  // ===========================
  // Helpers
  // ===========================
  const $ = (id) => document.getElementById(id);

  function escapeHtml(str){
    return String(str ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\\"":"&quot;","'":"&#039;"
    }[m]));
  }

  function symbolForCurrency(cur){
    switch(cur){
      case "USD": return "$";
      case "EUR": return "€";
      case "GBP": return "£";
      case "ZAR":
      default: return "R";
    }
  }

  function fmt(amount){
    const cur = $("currency").value || "ZAR";
    const sym = symbolForCurrency(cur);
    const n = Number(amount || 0);
    const fixed = n.toFixed(2);
    const withSep = fixed.replace(/\\B(?=(\\d{3})+(?!\\d))/g, ",");
    return sym + withSep;
  }

  function parseISO(d){
    // returns Date or null
    if(!d) return null;
    const dt = new Date(d + "T00:00:00");
    return Number.isNaN(dt.getTime()) ? null : dt;
  }

  function formatDateISO(iso){
    if(!iso) return "";
    const [y,m,d] = iso.split("-");
    if(!y || !m || !d) return iso;
    return `${d}/${m}/${y}`;
  }

  function todayISO(){
    const t = new Date();
    return t.toISOString().split("T")[0];
  }

  function setStatusBadge(){
    const s = $("statementStatus").value;
    const badge = $("statusBadge");
    const map = {
      draft: {cls:"badge badge-draft", icon:"fa-pen", text:"DRAFT"},
      issued: {cls:"badge badge-issued", icon:"fa-paper-plane", text:"ISSUED"},
      final: {cls:"badge badge-final", icon:"fa-check", text:"FINAL"},
    };
    const v = map[s] || map.draft;
    badge.className = v.cls;
    badge.innerHTML = `<i class="fa-solid ${v.icon}"></i> ${v.text}`;
  }

  function saveAs(blob, filename){
    try {
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.style.display = "none";
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 0);
    } catch (err) {
      console.error(err);
      alert("Download failed. Your browser may not support programmatic downloads.");
    }
  }

  function generateStatementNumber(){
    const n = Math.floor(Math.random()*10000000).toString().padStart(7,"0");
    $("statementNumber").value = "STAT" + n;
  }

  function setThisMonth(){
    const now = new Date();
    const first = new Date(now.getFullYear(), now.getMonth(), 1);
    const last = new Date(now.getFullYear(), now.getMonth()+1, 0);
    $("periodFrom").value = first.toISOString().split("T")[0];
    $("periodTo").value = last.toISOString().split("T")[0];
    autosave();
    recalcAll();
  }

  function defaultDueFromDate(dateIso){
    const dt = parseISO(dateIso);
    if(!dt) return "";
    const days = Number($("termsDays").value || 0);
    dt.setDate(dt.getDate() + Math.max(0, days));
    return dt.toISOString().split("T")[0];
  }

  // ===========================
  // Transactions
  // ===========================
  let txCounter = 0;
  let sortAsc = true;

  function addTxn(prefill={}){
    const tbody = $("txBody");
    const rowId = "tx-" + (txCounter++);

    const tr = document.createElement("tr");
    tr.id = rowId;
    tr.className = "tx-row";

    const dateVal = prefill.date || todayISO();
    const dueVal = prefill.dueDate ?? (prefill.debit && Number(prefill.debit) > 0 ? defaultDueFromDate(dateVal) : "");

    tr.innerHTML = `
      <td class="border border-gray-200 p-2">
        <input type="date" class="w-full border border-gray-200 rounded-md px-2 py-1 tx-date" value="${escapeHtml(dateVal)}">
      </td>
      <td class="border border-gray-200 p-2">
        <input type="text" class="w-full border border-gray-200 rounded-md px-2 py-1 mono tx-ref" placeholder="INV0001 / RCPT0001"
          value="${escapeHtml(prefill.ref || "")}">
      </td>
      <td class="border border-gray-200 p-2">
        <input type="text" class="w-full border border-gray-200 rounded-md px-2 py-1 tx-desc" placeholder="Invoice / Payment / Credit"
          value="${escapeHtml(prefill.desc || "")}">
      </td>
      <td class="border border-gray-200 p-2">
        <input type="date" class="w-full border border-gray-200 rounded-md px-2 py-1 tx-due" value="${escapeHtml(dueVal || "")}">
      </td>
      <td class="border border-gray-200 p-2">
        <input type="number" step="0.01" min="0" class="w-full border border-gray-200 rounded-md px-2 py-1 text-right mono tx-debit"
          value="${escapeHtml(prefill.debit ?? "0.00")}">
      </td>
      <td class="border border-gray-200 p-2">
        <input type="number" step="0.01" min="0" class="w-full border border-gray-200 rounded-md px-2 py-1 text-right mono tx-credit"
          value="${escapeHtml(prefill.credit ?? "0.00")}">
      </td>
      <td class="border border-gray-200 p-2 text-right mono tx-balance">${fmt(0)}</td>
      <td class="border border-gray-200 p-2 text-center no-print">
        <button class="text-red-600 hover:text-red-800" title="Delete transaction">
          <i class="fa-solid fa-trash-can"></i>
        </button>
      </td>
    `;

    tbody.appendChild(tr);

    // delete
    tr.querySelector("button").addEventListener("click", () => {
      tr.remove();
      recalcAll();
      autosave();
    });

    // input listeners
    tr.querySelectorAll("input").forEach(inp => {
      inp.addEventListener("input", () => {
        // Convenience: if debit entered and due date empty, auto-calc
        if (inp.classList.contains("tx-debit")) {
          const debit = Number(tr.querySelector(".tx-debit").value || 0);
          const due = tr.querySelector(".tx-due");
          if (debit > 0 && !due.value) {
            const d = tr.querySelector(".tx-date").value || todayISO();
            due.value = defaultDueFromDate(d);
          }
        }
        recalcAll();
        autosave();
      });
      inp.addEventListener("change", () => {
        recalcAll();
        autosave();
      });
    });

    recalcAll();
  }

  function readTx(){
    const rows = [];
    document.querySelectorAll(".tx-row").forEach(tr => {
      rows.push({
        date: tr.querySelector(".tx-date").value || "",
        ref: tr.querySelector(".tx-ref").value || "",
        desc: tr.querySelector(".tx-desc").value || "",
        dueDate: tr.querySelector(".tx-due").value || "",
        debit: Number(tr.querySelector(".tx-debit").value || 0),
        credit: Number(tr.querySelector(".tx-credit").value || 0),
      });
    });
    return rows;
  }

  function writeTxBalances(txWithBalances){
    const trs = Array.from(document.querySelectorAll(".tx-row"));
    txWithBalances.forEach((t, idx) => {
      const tr = trs[idx];
      if(!tr) return;
      tr.querySelector(".tx-balance").textContent = fmt(t.runningBalance);
    });
  }

  function withinPeriod(iso){
    const d = parseISO(iso);
    const pf = parseISO($("periodFrom").value);
    const pt = parseISO($("periodTo").value);
    if(!d || !pf || !pt) return true;
    // inclusive period
    return d.getTime() >= pf.getTime() && d.getTime() <= pt.getTime();
  }

  // ===========================
  // Core calculations
  // ===========================
  function compute(){
    setStatusBadge();

    const opening = Number($("openingBalance").value || 0);
    const tx = readTx();

    // validate + compute running
    let debits = 0, credits = 0;
    let running = opening;

    // keep table order as current DOM order
    const txWB = tx.map(t => {
      const d = Number(t.debit || 0);
      const c = Number(t.credit || 0);
      debits += d;
      credits += c;
      running += (d - c);
      return {
        ...t,
        debit: d,
        credit: c,
        runningBalance: running
      };
    });

    // update UI running balances
    writeTxBalances(txWB);

    const closing = running;

    $("sOpening").textContent = fmt(opening);
    $("sDebits").textContent = fmt(debits);
    $("sCredits").textContent = fmt(credits);
    $("sClosing").textContent = fmt(closing);

    // ageing estimate
    const ageing = estimateAgeing(txWB);

    $("aCurrent").textContent = fmt(ageing.current);
    $("a30").textContent = fmt(ageing.d30);
    $("a60").textContent = fmt(ageing.d60);
    $("a90").textContent = fmt(ageing.d90);
    $("a120").textContent = fmt(ageing.d120);
    $("aTotal").textContent = fmt(ageing.total);

    // validation hints
    renderValidation(opening, txWB);

    return { opening, debits, credits, closing, tx: txWB, ageing };
  }

  function renderValidation(opening, txWB){
    const box = $("validationBox");
    const issues = [];

    if (txWB.length === 0 && Math.abs(opening) < 0.00001) {
      issues.push({ type:"warn", text:"No transactions and opening balance is 0.00 — your statement will be empty." });
    }

    // date sanity checks
    let outOfPeriod = 0;
    txWB.forEach(t => { if(t.date && !withinPeriod(t.date)) outOfPeriod++; });
    if(outOfPeriod > 0){
      issues.push({ type:"warn", text:`${outOfPeriod} transaction(s) fall outside the selected period. (Preview will still show all rows; adjust dates or period.)` });
    }

    // negative debit/credit guarded by min=0 but check anyway
    const neg = txWB.some(t => t.debit < 0 || t.credit < 0);
    if(neg) issues.push({ type:"error", text:"Negative amounts detected. Use debit or credit as positive values only." });

    // debit+credit both set
    const both = txWB.filter(t => (t.debit > 0 && t.credit > 0)).length;
    if(both > 0) issues.push({ type:"warn", text:`${both} row(s) have both debit and credit values. Usually pick one per transaction.` });

    // render
    if(!issues.length){
      box.innerHTML = `
        <div class="flex items-start gap-2">
          <i class="fa-solid fa-circle-check text-green-600 mt-1"></i>
          <span>Looks good. Preview/export should be consistent.</span>
        </div>
      `;
      return;
    }

    box.innerHTML = issues.map(i => {
      const icon = i.type === "error" ? "fa-circle-xmark text-red-600" : "fa-triangle-exclamation text-amber-600";
      const label = i.type === "error" ? "Error" : "Warning";
      return `
        <div class="flex items-start gap-2">
          <i class="fa-solid ${icon} mt-1"></i>
          <span><span class="font-extrabold">${label}:</span> ${escapeHtml(i.text)}</span>
        </div>
      `;
    }).join("");
  }

  // ===========================
  // Ageing estimation (FIFO credits -> oldest debits)
  // ===========================
  function estimateAgeing(txWB){
    // Build debit "open items" with due dates. If due date missing, use tx date + terms.
    // Then allocate credits to oldest due-date items (or oldest date if due missing).
    // Return buckets based on days overdue relative to statement date (or today).

    const stmtDate = parseISO($("statementDate").value) || new Date();
    const termsDays = Number($("termsDays").value || 0);

    const debits = [];
    let totalCredits = 0;

    txWB.forEach(t => {
      if (t.debit > 0) {
        const date = parseISO(t.date) || stmtDate;
        let due = parseISO(t.dueDate);
        if(!due){
          due = new Date(date.getTime());
          due.setDate(due.getDate() + Math.max(0, termsDays));
        }
        debits.push({
          amount: t.debit,
          date,
          due,
          ref: t.ref || "",
          desc: t.desc || ""
        });
      }
      if (t.credit > 0) totalCredits += t.credit;
    });

    // sort debits by due, then date
    debits.sort((a,b) => (a.due - b.due) || (a.date - b.date));

    // allocate credits
    let remainingCredit = totalCredits;
    const open = [];

    for(const d of debits){
      if(remainingCredit <= 0){
        open.push({ ...d, openAmount: d.amount });
        continue;
      }
      const applied = Math.min(d.amount, remainingCredit);
      const openAmt = d.amount - applied;
      remainingCredit -= applied;
      if(openAmt > 0.00001){
        open.push({ ...d, openAmount: openAmt });
      }
    }

    // Buckets: current (not due yet), 1-30, 31-60, 61-90, 90+
    let current=0, d30=0, d60=0, d90=0, d120=0;

    for(const o of open){
      const daysOver = Math.floor((stmtDate - o.due) / (1000*60*60*24));
      if(daysOver <= 0) current += o.openAmount;
      else if(daysOver <= 30) d30 += o.openAmount;
      else if(daysOver <= 60) d60 += o.openAmount;
      else if(daysOver <= 90) d90 += o.openAmount;
      else d120 += o.openAmount;
    }

    const total = current + d30 + d60 + d90 + d120;
    return { current, d30, d60, d90, d120, total, openCount: open.length };
  }

  // ===========================
  // Logo
  // ===========================
  let companyLogoDataUrl = null;

  function handleLogoUpload(file){
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      companyLogoDataUrl = e.target.result;
      const preview = $("companyLogoPreview");
      preview.innerHTML = "";
      const img = document.createElement("img");
      img.src = companyLogoDataUrl;
      img.className = "h-14 object-contain";
      preview.appendChild(img);
      autosave();
    };
    reader.readAsDataURL(file);
  }

  // ===========================
  // Preview / Template fill
  // ===========================
  function buildTemplateDom(){
    const result = compute();
    const tpl = $("statementTemplate").firstElementChild.cloneNode(true);

    // logo
    const logoWrap = tpl.querySelector("#tplLogo");
    logoWrap.innerHTML = "";
    if(companyLogoDataUrl){
      const img = document.createElement("img");
      img.src = companyLogoDataUrl;
      img.style.height = "60px";
      img.style.objectFit = "contain";
      logoWrap.appendChild(img);
    }

    // company
    tpl.querySelector("#tplCompanyName").textContent = $("companyName").value || "Company";
    tpl.querySelector("#tplCompanyAddress").textContent = $("companyAddress").value || "";
    tpl.querySelector("#tplCompanyVat").textContent = $("companyVat").value || "";
    tpl.querySelector("#tplCompanyReg").textContent = $("companyReg").value || "";
    tpl.querySelector("#tplCompanyEmail").textContent = $("companyEmail").value || "";
    tpl.querySelector("#tplCompanyPhone").textContent = $("companyPhone").value || "";
    tpl.querySelector("#tplCompanyWebsite").textContent = $("companyWebsite").value || "";

    // meta
    tpl.querySelector("#tplStmtNumber").textContent = $("statementNumber").value || "";
    tpl.querySelector("#tplStmtRef").textContent = $("statementReference").value || "";
    tpl.querySelector("#tplStmtDate").textContent = formatDateISO($("statementDate").value) || "";
    tpl.querySelector("#tplStmtStatus").textContent = ($("statementStatus").value || "draft").toUpperCase();
    tpl.querySelector("#tplCurrency").textContent = $("currency").value || "ZAR";

    const pf = $("periodFrom").value;
    const pt = $("periodTo").value;
    tpl.querySelector("#tplPeriod").textContent = (pf && pt) ? `${formatDateISO(pf)} – ${formatDateISO(pt)}` : "";
    tpl.querySelector("#tplStmtRef").textContent = $("statementReference").value || "";

    // client
    tpl.querySelector("#tplClientName").textContent = $("clientName").value || "Customer";
    tpl.querySelector("#tplClientAddress").textContent = $("clientAddress").value || "";
    tpl.querySelector("#tplClientCode").textContent = $("clientCode").value || "";
    tpl.querySelector("#tplClientVat").textContent = $("clientVat").value || "";
    tpl.querySelector("#tplClientReg").textContent = $("clientReg").value || "";
    tpl.querySelector("#tplClientContact").textContent = $("clientContact").value || "";
    tpl.querySelector("#tplClientEmail").textContent = $("clientEmail").value || "";
    tpl.querySelector("#tplClientPhone").textContent = $("clientPhone").value || "";

    // bank
    tpl.querySelector("#tplBank").textContent = $("companyBank").value || "";

    // opening/net/closing
    const net = result.debits - result.credits;
    tpl.querySelector("#tplOpening").textContent = fmt(result.opening);
    tpl.querySelector("#tplNet").textContent = fmt(net);
    tpl.querySelector("#tplClosing").textContent = fmt(result.closing);

    // tx rows
    const tbody = tpl.querySelector("#tplTx");
    tbody.innerHTML = "";
    result.tx.forEach(t => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="border border-gray-200 p-2">${escapeHtml(formatDateISO(t.date) || "")}</td>
        <td class="border border-gray-200 p-2 mono">${escapeHtml(t.ref || "")}</td>
        <td class="border border-gray-200 p-2">${escapeHtml(t.desc || "")}</td>
        <td class="border border-gray-200 p-2">${escapeHtml(formatDateISO(t.dueDate) || "")}</td>
        <td class="border border-gray-200 p-2 text-right mono">${t.debit ? fmt(t.debit) : ""}</td>
        <td class="border border-gray-200 p-2 text-right mono">${t.credit ? fmt(t.credit) : ""}</td>
        <td class="border border-gray-200 p-2 text-right mono">${fmt(t.runningBalance)}</td>
      `;
      tbody.appendChild(tr);
    });

    // notes / collections
    tpl.querySelector("#tplNotes").textContent = $("notes").value || "";
    tpl.querySelector("#tplCollections").textContent = $("collections").value || "";

    // ageing in preview
    tpl.querySelector("#tplACurrent").textContent = fmt(result.ageing.current);
    tpl.querySelector("#tplA30").textContent = fmt(result.ageing.d30);
    tpl.querySelector("#tplA60").textContent = fmt(result.ageing.d60);
    tpl.querySelector("#tplA90").textContent = fmt(result.ageing.d90);
    tpl.querySelector("#tplA120").textContent = fmt(result.ageing.d120);
    tpl.querySelector("#tplATotal").textContent = fmt(result.ageing.total);

    return tpl;
  }

  function openPreview(){
    const modal = $("previewModal");
    const content = $("previewContent");
    content.innerHTML = "";
    content.appendChild(buildTemplateDom());
    modal.classList.remove("hidden");
    modal.classList.add("flex");
  }

  function closePreview(){
    const modal = $("previewModal");
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  }

  // ===========================
  // Exports (offline-friendly)
  // ===========================
  function exportPDF(){
    openPreview();
    setTimeout(() => window.print(), 100);
  }

  function exportWord(){
    try {
      const dom = buildTemplateDom();
      const wrapper = document.createElement("div");
      wrapper.appendChild(dom);

      const htmlContent = `<!DOCTYPE html><html lang="en-ZA"><head><meta charset="UTF-8"><title>Statement</title></head><body>${wrapper.innerHTML}</body></html>`;
      const blob = new Blob([htmlContent], { type: "application/msword" });
      const filename = ($("statementNumber").value || "statement") + ".doc";
      saveAs(blob, filename);
    } catch (err) {
      console.error(err);
      alert("Word export failed.");
    }
  }

  function exportExcel(){
    try {
      const dom = buildTemplateDom();
      const wrapperTable = document.createElement("table");
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.appendChild(dom);
      tr.appendChild(td);
      wrapperTable.appendChild(tr);

      const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"></head><body>${wrapperTable.outerHTML}</body></html>`;
      const blob = new Blob([html], { type: "application/vnd.ms-excel" });
      const filename = ($("statementNumber").value || "statement") + ".xls";
      saveAs(blob, filename);
    } catch (err) {
      console.error(err);
      alert("Excel export failed.");
    }
  }

  function exportCSV(){
    const tx = readTx();
    const headers = ["Date","Reference","Description","Debit","Credit","DueDate"];
    const rows = tx.map(t => [
      (t.date || ""),
      (t.ref || "").replaceAll('"','""'),
      (t.desc || "").replaceAll('"','""'),
      String(Number(t.debit||0).toFixed(2)),
      String(Number(t.credit||0).toFixed(2)),
      (t.dueDate || "")
    ]);

    const csv = [headers, ...rows]
      .map(r => r.map(v => `"${String(v ?? "")}"`).join(","))
      .join("\\n");

    const filename = ($("statementNumber").value || "statement") + ".csv";
    saveAs(new Blob([csv], {type:"text/csv;charset=utf-8;"}), filename);
  }

  function printManual(){
    const dom = buildTemplateDom();
    const w = window.open("", "_blank");
    if(!w){
      alert("Pop-up blocked. Allow popups to print.");
      return;
    }
    const style = `
      <style>
        body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; margin:0; padding:20px; background:#fff;}
        .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
        table{width:100%; border-collapse:collapse;}
        th,td{border:1px solid #e5e7eb; padding:8px;}
        th{background:#f9fafb;}
      </style>
    `;
    w.document.write(`<html><head><title>Print Statement</title>${style}</head><body></body></html>`);
    w.document.body.appendChild(dom);
    w.document.close();
    w.focus();
    w.print();
  }

  // ===========================
  // Sorting
  // ===========================
  function sortByDate(){
    const tx = readTx();
    tx.sort((a,b) => {
      const da = parseISO(a.date) || new Date(0);
      const db = parseISO(b.date) || new Date(0);
      return sortAsc ? (da - db) : (db - da);
    });
    sortAsc = !sortAsc;

    $("txBody").innerHTML = "";
    tx.forEach(t => addTxn(t));
    autosave();
    recalcAll();
  }

  // ===========================
  // CSV Import
  // ===========================
  function parseCSV(text){
    const rows = [];
    let i=0, field="", row=[], inQuotes=false;

    const pushField = () => { row.push(field); field=""; };
    const pushRow = () => { if(row.length) rows.push(row); row=[]; };

    while(i<text.length){
      const c = text[i];
      if(inQuotes){
        if(c === '"'){
          if(text[i+1] === '"'){ field += '"'; i++; }
          else inQuotes = false;
        } else field += c;
      } else {
        if(c === '"') inQuotes = true;
        else if(c === ','){ pushField(); }
        else if(c === '\\n'){ pushField(); pushRow(); }
        else if(c !== '\\r'){ field += c; }
      }
      i++;
    }
    pushField(); pushRow();
    return rows;
  }

  function importCSV(file){
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      const text = e.target.result || "";
      const rows = parseCSV(text).filter(r => r.join("").trim().length);

      // header detection
      let startIdx = 0;
      const header = (rows[0] || []).map(x => (x||"").toLowerCase());
      if(header.join(",").includes("date") && header.join(",").includes("reference")) startIdx = 1;

      for(let r=startIdx; r<rows.length; r++){
        const cols = rows[r];
        const [date, ref, desc, debit, credit, dueDate] = cols;

        addTxn({
          date: (date||"").trim() || todayISO(),
          ref: (ref||"").trim(),
          desc: (desc||"").trim(),
          debit: Number((debit||"0").toString().replace(/[^0-9.\\-]/g,"") || 0).toFixed(2),
          credit: Number((credit||"0").toString().replace(/[^0-9.\\-]/g,"") || 0).toFixed(2),
          dueDate: (dueDate||"").trim()
        });
      }

      recalcAll();
      autosave();
    };
    reader.readAsText(file);
  }

  // ===========================
  // Save/Load templates (localStorage)
  // ===========================
  const AUTOSAVE_KEY = "easystat.autosave.v1";
  const TEMPLATES_KEY = "easystat.templates.v1";

  function serializeState(){
    return {
      version: 1,
      savedAt: new Date().toISOString(),
      companyLogoDataUrl,
      fields: {
        companyName: $("companyName").value,
        companyVat: $("companyVat").value,
        companyReg: $("companyReg").value,
        companyEmail: $("companyEmail").value,
        companyPhone: $("companyPhone").value,
        companyWebsite: $("companyWebsite").value,
        companyAddress: $("companyAddress").value,
        companyBank: $("companyBank").value,

        clientName: $("clientName").value,
        clientCode: $("clientCode").value,
        clientVat: $("clientVat").value,
        clientReg: $("clientReg").value,
        clientContact: $("clientContact").value,
        clientEmail: $("clientEmail").value,
        clientPhone: $("clientPhone").value,
        clientAddress: $("clientAddress").value,

        statementNumber: $("statementNumber").value,
        statementReference: $("statementReference").value,
        periodFrom: $("periodFrom").value,
        periodTo: $("periodTo").value,
        statementDate: $("statementDate").value,
        currency: $("currency").value,
        statementStatus: $("statementStatus").value,

        openingBalance: $("openingBalance").value,
        termsDays: $("termsDays").value,
        defaultVat: $("defaultVat").value,

        notes: $("notes").value,
        collections: $("collections").value,
      },
      tx: readTx()
    };
  }

  function applyState(state){
    if(!state) return;

    companyLogoDataUrl = state.companyLogoDataUrl || null;
    const preview = $("companyLogoPreview");
    preview.innerHTML = "";
    if(companyLogoDataUrl){
      const img = document.createElement("img");
      img.src = companyLogoDataUrl;
      img.className = "h-14 object-contain";
      preview.appendChild(img);
    } else {
      preview.innerHTML = `<p class="text-sm text-slate-400">No logo uploaded</p>`;
    }

    const f = state.fields || {};
    Object.keys(f).forEach(k => { if($(k)) $(k).value = f[k] ?? ""; });

    // tx
    $("txBody").innerHTML = "";
    (state.tx || []).forEach(t => addTxn(t));

    if(!(state.tx || []).length){
      addTxn({ desc: "Opening Balance B/F", debit: "0.00", credit: "0.00", date: $("periodFrom").value || todayISO() });
    }

    recalcAll();
    setStatusBadge();
  }

  function autosave(){
    try{
      localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(serializeState()));
    } catch(e){
      console.warn("Autosave failed:", e);
    }
  }

  function loadAutosave(){
    try{
      const raw = localStorage.getItem(AUTOSAVE_KEY);
      if(!raw) return false;
      applyState(JSON.parse(raw));
      return true;
    } catch(e){
      console.warn("Autosave load failed:", e);
      return false;
    }
  }

  function loadTemplates(){
    try { return JSON.parse(localStorage.getItem(TEMPLATES_KEY) || "[]"); }
    catch { return []; }
  }

  function saveTemplate(){
    const name = prompt("Template name (e.g., 'Standard Statement'):");
    if(!name) return;
    const state = serializeState();
    state.templateName = name;
    const templates = loadTemplates();
    templates.push(state);
    localStorage.setItem(TEMPLATES_KEY, JSON.stringify(templates));
    alert("Template saved: " + name);
  }

  function pickAndLoadTemplate(){
    const templates = loadTemplates();
    if(!templates.length){
      alert("No templates saved yet.");
      return;
    }
    const names = templates.map((t,i)=> `${i+1}) ${t.templateName || ("Template " + (i+1))}`).join("\\n");
    const choice = prompt("Choose a template number:\\n\\n" + names);
    if(!choice) return;
    const idx = Number(choice) - 1;
    if(idx < 0 || idx >= templates.length){
      alert("Invalid choice.");
      return;
    }
    applyState(templates[idx]);
    autosave();
  }

  function resetForm(){
    if(!confirm("Reset the statement form? (Templates remain saved)")) return;

    companyLogoDataUrl = null;
    $("companyLogo").value = "";
    $("companyLogoPreview").innerHTML = `<p class="text-sm text-slate-400">No logo uploaded</p>`;

    [
      "companyName","companyVat","companyReg","companyEmail","companyPhone","companyWebsite","companyAddress","companyBank",
      "clientName","clientCode","clientVat","clientReg","clientContact","clientEmail","clientPhone","clientAddress",
      "statementReference","notes","collections"
    ].forEach(id => { if($(id)) $(id).value = ""; });

    $("currency").value = "ZAR";
    $("statementStatus").value = "draft";
    $("openingBalance").value = "0.00";
    $("termsDays").value = "30";
    $("defaultVat").value = "15.00";

    // dates + new number
    $("statementDate").value = todayISO();
    setThisMonth();
    generateStatementNumber();

    // tx
    $("txBody").innerHTML = "";
    addTxn({ desc: "Invoice example", ref: "INV0001", debit: "1500.00", credit: "0.00", date: $("periodFrom").value || todayISO() });
    addTxn({ desc: "Payment example", ref: "RCPT0001", debit: "0.00", credit: "500.00", date: $("periodFrom").value || todayISO() });

    recalcAll();
    autosave();
  }

  // ===========================
  // Wiring
  // ===========================
  function recalcAll(){ compute(); }

  function bind(){
    // meta changes recalc
    ["openingBalance","termsDays","currency","statementStatus","periodFrom","periodTo","statementDate"].forEach(id=>{
      $(id).addEventListener("input", () => { recalcAll(); autosave(); });
      $(id).addEventListener("change", () => { recalcAll(); autosave(); });
    });

    // general fields autosave
    [
      "companyName","companyVat","companyReg","companyEmail","companyPhone","companyWebsite","companyAddress","companyBank",
      "clientName","clientCode","clientVat","clientReg","clientContact","clientEmail","clientPhone","clientAddress",
      "statementNumber","statementReference","notes","collections","defaultVat"
    ].forEach(id=>{
      $(id).addEventListener("input", autosave);
      $(id).addEventListener("change", autosave);
    });

    // logo
    $("companyLogo").addEventListener("change", (e)=> handleLogoUpload(e.target.files[0]));

    // buttons
    $("btnAddTxn").addEventListener("click", ()=> { addTxn(); autosave(); });
    $("btnSortDate").addEventListener("click", sortByDate);
    $("btnPreview").addEventListener("click", openPreview);
    $("btnClosePreview").addEventListener("click", closePreview);
    $("btnClosePreviewBottom").addEventListener("click", closePreview);
    $("previewModal").addEventListener("click", (e)=>{ if(e.target === $("previewModal")) closePreview(); });

    $("btnPDF").addEventListener("click", exportPDF);
    $("btnPDF2").addEventListener("click", exportPDF);
    $("btnWord").addEventListener("click", exportWord);
    $("btnExcel").addEventListener("click", exportExcel);
    $("btnCSV").addEventListener("click", exportCSV);
    $("btnPrint").addEventListener("click", printManual);

    $("btnSaveTemplate").addEventListener("click", saveTemplate);
    $("btnLoadTemplate").addEventListener("click", pickAndLoadTemplate);
    $("btnReset").addEventListener("click", resetForm);

    $("btnNewNumber").addEventListener("click", ()=> { generateStatementNumber(); autosave(); });
    $("btnSetThisMonth").addEventListener("click", setThisMonth);
    $("btnRecalcAgeing").addEventListener("click", ()=> { recalcAll(); });

    // CSV import
    $("btnImportCSV").addEventListener("click", ()=> $("csvFile").click());
    $("csvFile").addEventListener("change", (e)=>{
      importCSV(e.target.files[0]);
      e.target.value = "";
    });
  }

  function init(){
    // sensible defaults
    $("statementDate").value = todayISO();
    setThisMonth();
    generateStatementNumber();

    // Load autosave if present
    const loaded = loadAutosave();
    if(!loaded){
      // seed with one row
      addTxn({ desc: "Invoice example", ref: "INV0001", debit: "1500.00", credit: "0.00", date: $("periodFrom").value || todayISO() });
      addTxn({ desc: "Payment example", ref: "RCPT0001", debit: "0.00", credit: "500.00", date: $("periodFrom").value || todayISO() });
      recalcAll();
      autosave();
    } else {
      recalcAll();
    }
    setStatusBadge();
  }

  document.addEventListener("DOMContentLoaded", ()=>{ bind(); init(); });
</script>

</body>
</html>
